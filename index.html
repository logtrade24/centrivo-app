<!--
‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è UWAGA - WERSJA PRODUKCYJNA ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

üö´ NIE EDYTUJ TEGO PLIKU BEZPO≈öREDNIO!

üìù Kopia robocza (do edycji):
https://script.google.com/https://docs.google.com/spreadsheets/d/12HgcCifzhbhf_V6dunBbcrxSsWezBKo6NUizDQT9q8Q/edit?gid=0#gid=0/edit

Ostatnia aktualizacja: 2025-10-23
Wersja: 2.0
-->

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base target="_top">
    <title>System Magazynowy - Rejestrator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .status-bar{
          background: #f8f9fa;
          padding: 15px 25px;
          border-bottom: 1px solid #e9ecef;
          font-size: 14px;
          color: #495057;
        
          display:flex;
          align-items:center;
          gap: 12px;
          flex-wrap: nowrap;        /* wa≈ºne: 3 kolumny w jednym wierszu */
        }

        .status-left{
          display:flex;
          gap: 20px;
          align-items:center;
          flex: 0 0 auto;          /* lewa czƒô≈õƒá nie rozpycha ≈õrodka */
          flex-wrap: wrap;
        }

        .status-right{
          display:flex;
          align-items:center;
          gap: 15px;
          flex: 0 0 auto;          /* prawa czƒô≈õƒá nie nachodzi na ≈õrodek */
          margin-left: auto;       /* dopycha do prawej krawƒôdzi */
        }

        .session-info{
          flex: 1 1 auto;          /* ≈õrodek bierze dostƒôpne miejsce */
          display:flex;
          flex-direction:column;
          align-items:center;
          justify-content:center;
          text-align:center;
          white-space: nowrap;
          min-width: 220px;
        }

        .status-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            min-width: 100px;
        }

        .session-info{ position: relative; z-index: 2; }
        .status-right{ position: relative; z-index: 1; }

.status-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
}

.status-button:active {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

/* Przycisk Wstecz */
.status-button.back-btn {
    background: linear-gradient(45deg, #6c757d, #495057);
    min-width: 80px;
}

.status-button.back-btn:hover {
    background: linear-gradient(45deg, #5a6268, #3d4246);
    box-shadow: 0 6px 15px rgba(108, 117, 125, 0.4);
}

/* Przycisk Planowanie urlop√≥w */
.status-button.vacation-btn {
    background: linear-gradient(45deg, #e91e63, #9c27b0);
    min-width: 170px;
}

.status-button.vacation-btn:hover {
    background: linear-gradient(45deg, #c2185b, #7b1fa2);
    box-shadow: 0 6px 15px rgba(156, 39, 176, 0.4);
}

/* Przycisk Zwolnienia L4 */
.status-button.l4-btn {
    background: linear-gradient(45deg, #ff5722, #ff9800);
    min-width: 150px;
}

.status-button.l4-btn:hover {
    background: linear-gradient(45deg, #e64a19, #f57c00);
    box-shadow: 0 6px 15px rgba(255, 87, 34, 0.4);
}

/* Przycisk Zg≈Ço≈õ problem */
.status-button.ticket-btn {
    background: linear-gradient(45deg, #9c27b0, #673ab7);
    min-width: 150px;
}

.status-button.ticket-btn:hover {
    background: linear-gradient(45deg, #7b1fa2, #512da8);
    box-shadow: 0 6px 15px rgba(156, 39, 176, 0.4);
}

/* Przycisk Otw√≥rz Dashboard */
.dashboard-btn {
    display: inline-block;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 40px;
    text-decoration: none;
    border-radius: 12px;
    font-size: 1.1em;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
}

.dashboard-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
}

.dashboard-btn:active {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.vacation-btn-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    animation: pulse 2s infinite;
}

        .code-input {
            padding: 4px 8px;
            border: 2px solid #007bff;
            border-radius: 4px;
            width: 120px;
            font-size: 14px;
        }

        .code-input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 5px rgba(40, 167, 69, 0.3);
        }

        .scan-wrapper {
    display: flex;
    align-items: center;   /* wyr√≥wnanie w pionie */
    gap: 12px;
}
        /* Zegar + data: bez przesuwania right/top, zawsze w obrƒôbie paska */
        .session-info{
          display:flex;
          flex-direction:column;
          align-items:center;
          justify-content:center;
          text-align:center;
          white-space: nowrap;
          flex: 0 0 auto;
        }
        
        .current-time{
          font-weight: 900;
          font-size: 20px;
          display:flex;
          align-items:center;
          gap: 8px;
          color: inherit; /* wa≈ºne: w jasnym trybie ma byƒá widoczny */
        }
        
        .current-date{
          opacity: .85;
          color: inherit; /* wa≈ºne: w jasnym trybie ma byƒá widoczny */
        }

        .main-container {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 40px;
            background: #28a745;
            color: white;
            padding: 20px;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            display: none;
        }

        .welcome-header.show {
            display: block;
        }

        .view-container {
            width: 100%;
            max-width: 1200px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .view-title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            color: #333;
        }

        .tiles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    padding: 20px 0;
}

.tile {
    background: white;
    padding: 32px 24px;
    border-radius: 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    color: white;
    font-weight: 600;
    font-size: 17px;
    min-height: 130px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    position: relative;
    overflow: hidden;
}

.tile::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 50%);
    pointer-events: none;
}

.tile:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
}

.tile:active {
    transform: translateY(-4px) scale(1.01);
}

.tile-icon {
    font-size: 36px;
    line-height: 1;
}

.tile-text {
    font-size: 16px;
    line-height: 1.3;
}

        .tile.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: auto;
            background: #9e9e9e !important;
            color: #666 !important;
            position: relative;
        }

        .tile.disabled::after {
            content: 'üö´';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
        }

        .tile.disabled:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tile.przyjecie { background: linear-gradient(45deg, #17a2b8, #138496); }
        .tile.rozladunek { background: linear-gradient(45deg, #795548, #5d4037); }
        .tile.zaladunek { background: linear-gradient(45deg, #8d6e63, #6d4c41); }
        .tile.relokacja { background: linear-gradient(45deg, #00897b, #00695c); }
        .tile.kompletacja { background: linear-gradient(45deg, #007bff, #6f42c1); }
        .tile.weryfikacja { background: linear-gradient(45deg, #43a047, #2e7d32); }
        .tile.co-packing { background: linear-gradient(45deg, #e53935, #c62828); }
        .tile.operacje-porzadkowe { background: linear-gradient(45deg, #fd7e14, #ffc107); }
        .tile.inwentaryzacja { background: linear-gradient(45deg, #212121, #000000); }
        .tile.user { background: linear-gradient(45deg, #20c997, #17a2b8); }
        .tile.wchodzi { background: linear-gradient(45deg, #28a745, #20c997); }
        .tile.wychodzi-przerwa { background: linear-gradient(45deg, #ffc107, #fd7e14); }
        .tile.wychodzi-pracy { background: linear-gradient(45deg, #dc3545, #c82333); }
        .tile.wracam { background: linear-gradient(45deg, #6c757d, #495057); }
        .tile.zmieniam-operacje { background: linear-gradient(45deg, #17a2b8, #138496); }

        .user-notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: #495057;
            transform: translateY(-2px);
        }

        .verification-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .verification-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }

        .verification-user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }

        .verification-user-info strong {
            color: #007bff;
        }

        .verification-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
        }

        .verification-input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 5px rgba(40, 167, 69, 0.3);
        }

        .confirmation-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .confirmation-overlay.show {
            display: flex;
        }

        .confirmation-modal {
            background: white;
            border-radius: 8px;
            padding: 0;
            max-width: 90%;
            width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .confirmation-header {
            background: #6cb63f;
            color: white;
            padding: 15px 25px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .confirmation-content {
            background: #6cb63f;
            color: white;
            padding: 40px 30px;
            text-align: center;
            font-size: 16px;
            line-height: 1.6;
        }

        .confirmation-content .timestamp {
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
        }

        .confirmation-message {
            margin: 20px 0;
            font-size: 14px;
        }

        .confirmation-blue-section {
            background: #4a90e2;
            color: white;
            padding: 30px;
            text-align: center;
            font-size: 36px;
            font-weight: bold;
            margin: 20px 30px;
            border-radius: 8px;
        }

        .confirmation-buttons {
            padding: 30px;
            text-align: center;
            background: #6cb63f;
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .confirmation-btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirmation-btn.cancel {
            background: #dc3545;
        }

        .confirmation-btn:hover {
            background: #357abd;
            transform: translateY(-2px);
        }

        .confirmation-btn.cancel:hover {
            background: #c82333;
        }

        .vacation-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }

        .vacation-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .date-input, .form-input {
            padding: 12px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 6px;
        }

        .vacation-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }

        .collision-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .collision-error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        .vacation-balance {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .vacation-requests-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
        }

        .vacation-request-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }

        .vacation-request-item.approved {
            border-left: 4px solid #28a745;
            background: #f8fff8;
        }

        .vacation-request-item.rejected {
            border-left: 4px solid #dc3545;
            background: #fff8f8;
        }

        .vacation-request-item.pending {
            border-left: 4px solid #ffc107;
            background: #fffef8;
        }

        .manager-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .manager-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .manager-btn.approve {
            background: #28a745;
            color: white;
        }

        .manager-btn.reject {
            background: #dc3545;
            color: white;
        }

        .form-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .form-btn.primary {
            background: #28a745;
            color: white;
        }

        .form-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .vacation-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .vacation-type-option {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .vacation-type-option.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .notification-panel {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .auto-refresh-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 123, 255, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
        }

        .auto-refresh-indicator.show {
            display: block;
        }

        @media (max-width: 768px) {
    .tiles-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .tile {
        min-height: 90px;
        flex-direction: row;
        padding: 20px 24px;
        gap: 16px;
    }
    
    .tile-icon {
        font-size: 28px;
    }
    
    .tile-text {
        font-size: 15px;
        text-align: left;
    }
}

#themeToggle {
    position: fixed;
    top: 10px;
    right: 20px;
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 25px;
    z-index: 2000;
    background: linear-gradient(45deg, #3b82f6, #60a5fa);
    border: none;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

#themeToggle:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
}

.live-stats {
    display: flex;
    gap: 15px;
    align-items: center;
    font-size: 14px;
    font-weight: 600;
    position: absolute;
    top: 18px;
    right: 180px;
    z-index: 100;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 18px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    transition: all 0.3s ease;
    font-size: 16px;
}

.stat-value.working { color: #10b981; }
.stat-value.break { color: #f59e0b; }

body.dark-mode {
    background: #1a1a2e;
}

.vacation-last-title {
  font-weight: bold;
  margin-bottom: 10px;
  color: #333;
}

body.dark-mode .vacation-last-title {
  color: #e2e8f0;
}


body.dark-mode .status-bar {
    background: #16213e;
    border-bottom: 1px solid #0f3460;
    color: #e2e8f0;
}

body.dark-mode .tile {
    background: #16213e;
    color: #e2e8f0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    border: 2px solid transparent;
}

body.dark-mode .tile.przyjecie { border-color: #17a2b8; }
body.dark-mode .tile.rozladunek { border-color: #795548; }
body.dark-mode .tile.zaladunek { border-color: #8d6e63; }
body.dark-mode .tile.relokacja { border-color: #00897b; }
body.dark-mode .tile.kompletacja { border-color: #007bff; }
body.dark-mode .tile.weryfikacja { border-color: #43a047; }
body.dark-mode .tile.co-packing { border-color: #e53935; }
body.dark-mode .tile.operacje-porzadkowe { border-color: #fd7e14; }
body.dark-mode .tile.inwentaryzacja { border-color: #212121; }
body.dark-mode .tile.user { border-color: #20c997; }
body.dark-mode .tile.wchodzi { border-color: #28a745; }
body.dark-mode .tile.wychodzi-przerwa { border-color: #ffc107; }
body.dark-mode .tile.wychodzi-pracy { border-color: #dc3545; }
body.dark-mode .tile.wracam { border-color: #6c757d; }
body.dark-mode .tile.zmieniam-operacje { border-color: #17a2b8; }

body.dark-mode .stat-item {
    background: rgba(255, 255, 255, 0.05);
}

body.dark-mode .stat-value.working { color: #34d399; }
body.dark-mode .stat-value.break { color: #fbbf24; }

body.dark-mode .modal-overlay {
    background: rgba(0, 0, 0, 0.8);
}

body.dark-mode .modal-content,
body.dark-mode .vacation-modal {
    background: #16213e;
    color: #e2e8f0;
    border: 1px solid #0f3460;
}

body.dark-mode .modal-content h2,
body.dark-mode .vacation-modal h2 {
    color: #e2e8f0;
}

body.dark-mode .input-group input,
body.dark-mode .input-group select,
body.dark-mode .input-group textarea {
    background: #1a1a2e;
    color: #e2e8f0;
    border: 1px solid #0f3460;
}

body.dark-mode .input-group label {
    color: #cbd5e1;
}

body.dark-mode .info-box {
    background: #1a1a2e;
    border-left: 4px solid #3b82f6;
    color: #cbd5e1;
}

body.dark-mode .button-primary {
    background: linear-gradient(45deg, #3b82f6, #60a5fa);
}

body.dark-mode .button-secondary {
    background: #1a1a2e;
    border: 2px solid #3b82f6;
    color: #e2e8f0;
}

body.dark-mode .login-screen {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
}

body.dark-mode .login-card {
    background: #16213e;
    color: #e2e8f0;
    border: 1px solid #0f3460;
}

body.dark-mode .login-title {
    color: #e2e8f0;
}

body.dark-mode .login-subtitle {
    color: #cbd5e1;
}

body.dark-mode .login-input {
    background: #1a1a2e;
    color: #e2e8f0;
    border: 2px solid #0f3460;
}

body.dark-mode .login-input:focus {
    border-color: #3b82f6;
}

body.dark-mode .login-button {
    background: linear-gradient(45deg, #3b82f6, #60a5fa);
}

body.dark-mode .identity-card {
    background: #1a1a2e;
    border-left: 4px solid #3b82f6;
}

body.dark-mode .identity-label {
    color: #94a3b8;
}

body.dark-mode .identity-value {
    color: #e2e8f0;
}

body.dark-mode .operation-prompt {
    background: #16213e;
    border: 1px solid #0f3460;
    color: #e2e8f0;
}

body.dark-mode .operation-title {
    color: #e2e8f0;
}

body.dark-mode .operation-input {
    background: #1a1a2e;
    color: #e2e8f0;
    border: 2px solid #0f3460;
}

body.dark-mode .operation-note {
    color: #94a3b8;
}

body.dark-mode .footer-text {
    color: #64748b;
}

body.dark-mode .view {
    background: transparent;
}

body.dark-mode .view-title {
    color: #e2e8f0;
}

body.dark-mode .back-button {
    background: #1a1a2e;
    color: #e2e8f0;
    border: 2px solid #3b82f6;
}

body.dark-mode .back-button:hover {
    background: #3b82f6;
}

body.dark-mode .verification-container {
    background: #1e293b;
    border: 1px solid #334155;
}

body.dark-mode .verification-title {
    color: #e2e8f0;
}

body.dark-mode .verification-user-info {
    background: #0f172a !important;
    color: #e2e8f0;
    border-left: 4px solid #3b82f6 !important;
}

body.dark-mode .verification-input {
    background: #1a1a2e;
    color: #e2e8f0;
    border: 2px solid #0f3460;
}

body.dark-mode .verification-input:focus {
    border-color: #3b82f6;
}

body.dark-mode .welcome-header {
    background: #16213e;
    color: #e2e8f0;
}

body.dark-mode #welcomeMessage {
    color: #e2e8f0;
}

body.dark-mode .vacation-container {
    background: #1e293b;
    border: 1px solid #334155;
}

body.dark-mode .vacation-form {
    color: #e2e8f0;
}

body.dark-mode .vacation-form label {
    color: #cbd5e1;
}

body.dark-mode .date-input,
body.dark-mode .form-input {
    background: #0f172a;
    color: #e2e8f0;
    border: 2px solid #334155;
}

body.dark-mode .date-input:focus,
body.dark-mode .form-input:focus {
    border-color: #3b82f6;
}

body.dark-mode textarea.form-input {
    background: #0f172a;
    color: #e2e8f0;
    border: 2px solid #334155;
}

body.dark-mode select.form-input {
    background: #0f172a;
    color: #e2e8f0;
    border: 2px solid #334155;
}

body.dark-mode .vacation-type-option {
    background: #0f172a;
    border: 2px solid #334155;
    color: #e2e8f0;
}

body.dark-mode .vacation-type-option.selected {
    background: #1e40af;
    border-color: #3b82f6;
    color: white;
}

body.dark-mode .form-btn.primary {
    background: linear-gradient(45deg, #10b981, #059669);
}

body.dark-mode .form-btn.secondary {
    background: #475569;
    color: #e2e8f0;
}

body.dark-mode .vacation-balance {
    background: #0f172a;
    border: 1px solid #334155;
    color: #e2e8f0;
}

body.dark-mode .vacation-info {
    background: #0f172a;
    color: #e2e8f0;
}

body.dark-mode h2,
body.dark-mode h3,
body.dark-mode h4 {
    color: #e2e8f0;
}

body.dark-mode p {
    color: #cbd5e1;
}

body.dark-mode strong {
    color: #e2e8f0;
}

body.dark-mode small {
    color: #94a3b8;
}

body.dark-mode .vacation-container {
    background: #1e293b !important;
    border: 1px solid #334155;
}

body.dark-mode .vacation-form {
    color: #e2e8f0;
}

body.dark-mode .vacation-form > div {
    background: transparent !important;
}

body.dark-mode .vacation-form label {
    color: #cbd5e1 !important;
}

body.dark-mode .date-input,
body.dark-mode .form-input {
    background: #0f172a !important;
    color: #e2e8f0 !important;
    border: 2px solid #334155 !important;
}

body.dark-mode textarea.form-input {
    background: #0f172a !important;
    color: #e2e8f0 !important;
}

body.dark-mode select.form-input {
    background: #0f172a !important;
    color: #e2e8f0 !important;
}

body.dark-mode .vacation-type-option {
    background: #0f172a !important;
    border: 2px solid #334155 !important;
    color: #e2e8f0 !important;
}

body.dark-mode .vacation-type-option.selected {
    background: #1e40af !important;
    border-color: #3b82f6 !important;
}

body.dark-mode .form-btn.primary {
    background: linear-gradient(45deg, #10b981, #059669) !important;
}

body.dark-mode .form-btn.secondary {
    background: #475569 !important;
    color: #e2e8f0 !important;
}

body.dark-mode .who-is-working-modal {
    background: #1e293b !important;
}

body.dark-mode .who-is-working-content {
    background: #1e293b !important;
    color: #e2e8f0;
}

body.dark-mode .who-is-working-employee {
    background: #0f172a !important;
    color: #e2e8f0 !important;
}

body.dark-mode .who-is-working-employee:hover {
    background: #1e293b !important;
}

body.dark-mode .who-is-working-employee-name {
    color: #e2e8f0 !important;
}

body.dark-mode .who-is-working-employee-operation {
    color: #94a3b8 !important;
}

body.dark-mode .who-is-working-employee-time {
    color: #64748b !important;
}

body.dark-mode .who-is-working-empty {
    color: #94a3b8 !important;
}

body.dark-mode .vacation-request-item {
    background: #0f172a !important;
    border-color: #334155 !important;
    color: #e2e8f0 !important;
}

body.dark-mode .vacation-request-item.approved {
    background: #0f2e1a !important;
}

body.dark-mode .vacation-request-item.rejected {
    background: #2e0f14 !important;
}

body.dark-mode .vacation-request-item.pending {
    background: #2e250f !important;
}

body.dark-mode .vacation-request-item div {
    color: #e2e8f0 !important;
}

body.dark-mode .vacation-request-item strong {
    color: #f1f5f9 !important;
}

body.dark-mode .vacation-balance,
body.dark-mode .vacation-info {
    background: #0f172a !important;
    color: #e2e8f0 !important;
    border-color: #334155 !important;
}

body.dark-mode .vacation-stats-summary {
    background: #0f172a !important;
    color: #e2e8f0 !important;
}

body.dark-mode .vacation-request-item p[style*="background: #f8f9fa"] {
    background: #0f172a !important;
    color: #e2e8f0 !important;
}

body.dark-mode span[style*="background: #e3f2fd"] {
    background: #1e3a5f !important;
    color: #93c5fd !important;
}

body.dark-mode div[style*="background: #f5f5f5"] {
    background: #0f172a !important;
    color: #e2e8f0 !important;
}

body.dark-mode #yearPlanBalance {
    background: #0f172a !important;
    color: #e2e8f0 !important;
}

body.dark-mode .vacation-info[style*="#fff3e0"] {
    background: #1e2a0f !important;
}

body.dark-mode .vacation-container div[style*="display: flex"][style*="gap: 20px"] > div {
    color: #e2e8f0 !important;
}

body.dark-mode .announcements-panel {
    background: #1e293b !important;
}

body.dark-mode .announcements-panel-tabs {
    border-bottom-color: #334155;
}

body.dark-mode .announcements-panel-tab {
    color: #94a3b8;
}

body.dark-mode .announcements-panel-tab:hover {
    background: #0f172a;
}

body.dark-mode .announcements-panel-tab.active {
    color: #60a5fa;
    border-bottom-color: #60a5fa;
}

body.dark-mode .announcements-panel-content {
    background: #1e293b;
    color: #e2e8f0;
}

body.dark-mode .announcement-form-group label {
    color: #cbd5e1;
}

body.dark-mode .announcement-form-group input,
body.dark-mode .announcement-form-group select,
body.dark-mode .announcement-form-group textarea {
    background: #0f172a !important;
    color: #e2e8f0 !important;
    border: 2px solid #334155 !important;
}

body.dark-mode .recipients-checkboxes {
    background: #0f172a;
    color: #e2e8f0;
}

body.dark-mode .announcements-list {
    color: #e2e8f0;
}

body.dark-mode .current-time {
    color: #60a5fa;
    font-size: 20px;
    font-weight: bold;
}

body.dark-mode .current-date {
    color: #94a3b8;
    font-size: 14px;
}

/* === DARK MODE: ZarzƒÖdzanie nieobecno≈õciami (kierownik) === */
body.dark-mode #managerVacationView [style*="background: #f5f5f5"]{
  background: #0f172a !important;
  color: #e2e8f0 !important;
  border: 1px solid #334155 !important;
}

body.dark-mode #managerVacationView [style*="background: #fafafa"]{
  background: #0f172a !important;
  border-color: #334155 !important;
}

body.dark-mode #managerVacationView [style*="background: #f8f9fa"]{
  background: #0f172a !important;
}

body.dark-mode #managerVacationView [style*="background: #e9ecef"]{
  background: #1e293b !important;
}

body.dark-mode #managerVacationView [style*="background: #e8f5e9"]{
  background: #14532d !important;
  color: #e2e8f0 !important;
}

body.dark-mode #managerVacationView [style*="background: #fff3e0"]{
  background: #3b2f1d !important;
  color: #e2e8f0 !important;
}

body.dark-mode #managerVacationView [style*="color: #666"]{
  color: #cbd5e1 !important;
}

body.dark-mode #managerVacationView [style*="color: #333"]{
  color: #e2e8f0 !important;
}

/* === DARK MODE: Okoliczno≈õciowe ‚Äì badge typu urlopu (bia≈Çy prostokƒÖt) === */
body.dark-mode #managerVacationView span[style*="background"] {
  background: #1e293b !important;
  color: #e2e8f0 !important;
  border: 1px solid #334155 !important;
}

/* ===== BADGE LICZBY PRACUJƒÑCYCH NA DZIALE ===== */
#departmentView .tile {
  position: relative;
}

.dept-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  min-width: 26px;
  height: 26px;
  padding: 0 8px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 13px;
  background: #ff3b30;
  color: #ffffff;
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  z-index: 5;
}

body.dark-mode .dept-badge {
  box-shadow: 0 6px 14px rgba(16, 185, 129, 0.25);
}

.dept-badge {
  line-height: 1;
}

/* Ikonka kalendarza w input type=date ‚Äì na bia≈Ço */
body.dark-mode input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(1);
  opacity: 0.9;
  cursor: pointer;
}

/* Ikonka "poka≈º has≈Ço" w polu password ‚Äì DARK MODE */
body.dark-mode input[type="password"]::-ms-reveal,
body.dark-mode input[type="password"]::-ms-clear {
  filter: invert(1);
}

/* Chrome / Edge */
body.dark-mode input[type="password"]::-webkit-textfield-decoration-container {
  filter: invert(1);
}

/* ===== PLANOWANIE OBSADY (ETAP 1) ===== */
.workforce-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 20px;
}

.workforce-modal{
  width: min(1250px, 96vw);
  max-height: 90vh;
  overflow: auto;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.35);
  padding: 18px;
}

body.dark-mode .workforce-modal{
  background: #0f172a;
  color: #e2e8f0;
}

.workforce-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  margin-bottom: 12px;
}

.workforce-close{
  border:none;
  background: transparent;
  font-size: 22px;
  cursor: pointer;
  opacity: 0.75;
}
body.dark-mode .workforce-close{ color:#e2e8f0; }

.workforce-grid{
  display:grid;
  grid-template-columns: 1fr 1fr; /* ‚úÖ DOK≈ÅADNIE 2 KOLUMNY */
  gap: 12px;
  align-items: start;
}

@media (max-width: 1100px){
  .workforce-grid{
    grid-template-columns: 1fr;
  }
}

.workforce-card{
  border: 1px solid rgba(0,0,0,0.08);
  border-radius: 14px;
  padding: 12px;
  background: rgba(0,0,0,0.02);
}
body.dark-mode .workforce-card{
  border-color: rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.04);
}

.workforce-row{
  display:flex;
  gap: 10px;
  align-items:center;
  margin: 8px 0;
}

.workforce-row label{
  min-width: 210px;
  font-weight: 600;
  font-size: 13px;
  opacity: 0.9;
}

.workforce-input{
  flex: 1;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,0.15);
  outline: none;
  font-size: 14px;
}
body.dark-mode .workforce-input{
  background:#0b1220;
  border-color: rgba(255,255,255,0.18);
  color:#e2e8f0;
}

.workforce-mini{
  font-size: 12px;
  opacity: 0.8;
  margin-top: 6px;
}

.workforce-btn{
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  cursor: pointer;
  font-weight: 700;
  background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
  color: #06261d;
}

.workforce-table{
  width:100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 13px;
}
.workforce-table th, .workforce-table td{
  padding: 10px 8px;
  border-bottom: 1px solid rgba(0,0,0,0.10);
  text-align: left;
}
body.dark-mode .workforce-table th, body.dark-mode .workforce-table td{
  border-bottom-color: rgba(255,255,255,0.12);
}

.workforce-badge-ok{
  display:inline-block;
  padding: 3px 8px;
  border-radius: 999px;
  background: rgba(16,185,129,0.18);
  color: #10b981;
  font-weight: 800;
}

.workforce-badge-bad{
  display:inline-block;
  padding: 3px 8px;
  border-radius: 999px;
  background: rgba(239,68,68,0.18);
  color: #ef4444;
  font-weight: 800;
}

/* Wiersze z dniami tygodnia - wƒÖskie etykiety */
.workforce-row.compact label{
  min-width: 55px;
}

/* PODGLƒÑD LIVE ‚Äì ≈ºeby nie ucina≈Ço ostatniego wiersza */
#workforceLiveList{
  padding-bottom: 14px;
}

/* ===== PODGLƒÑD LIVE ‚Äì DARK MODE (g√≥rne liczniki) ===== */
body.dark-mode #workforceLiveModal div[style*="background:#e8f5e9"],
body.dark-mode #workforceLiveModal div[style*="background:#fff3e0"],
body.dark-mode #workforceLiveModal div[style*="background:#fff7ed"],
body.dark-mode #workforceLiveModal div[style*="background:#ffebee"]{
  background: rgba(255,255,255,0.08) !important;
  color: #e5e7eb !important;
  border: 1px solid rgba(255,255,255,0.14);
}

body.dark-mode #workforceLiveModal div[style*="background:#e8f5e9"] *,
body.dark-mode #workforceLiveModal div[style*="background:#fff3e0"] *,
body.dark-mode #workforceLiveModal div[style*="background:#fff7ed"] *,
body.dark-mode #workforceLiveModal div[style*="background:#ffebee"] *{
  color: #e5e7eb !important;
}

/* ===== PODGLƒÑD LIVE ‚Äì kafelki w DARK MODE ===== */

body.dark-mode #liveTileWorking,
body.dark-mode #liveTileBreak,
body.dark-mode #liveTileAlerts,
body.dark-mode #liveTileAbsent {
  background: rgba(255,255,255,0.06) !important;
  color: #e2e8f0 !important;
  border: 1px solid rgba(255,255,255,0.12) !important;
}

/* LIVE kafelki ‚Äì aktywny w DARK MODE (musi wygraƒá z border:... !important) */
body.dark-mode #liveTileWorking.live-tile-active,
body.dark-mode #liveTileBreak.live-tile-active,
body.dark-mode #liveTileAlerts.live-tile-active,
body.dark-mode #liveTileAbsent.live-tile-active{
  border: 2px solid #60a5fa !important;
  box-shadow: 0 0 0 3px rgba(96,165,250,0.35), 0 16px 30px rgba(0,0,0,0.55) !important;
  transform: translateY(-1px);
  background: rgba(255,255,255,0.10) !important; /* delikatnie ja≈õniej, ≈ºeby by≈Ço widaƒá r√≥≈ºnicƒô */
}

body.dark-mode #liveTileWorking span,
body.dark-mode #liveTileBreak span,
body.dark-mode #liveTileAlerts span,
body.dark-mode #liveTileAbsent span {
  color: #ffffff !important;
}

/* ===== LIVE kafelki ‚Äì stan aktywny ===== */
#liveTileWorking,
#liveTileBreak,
#liveTileAlerts,
#liveTileAbsent{
  transition: box-shadow .15s ease, transform .15s ease, border-color .15s ease;
}

/* aktywny (light mode) */
.live-tile-active{
  border: 2px solid rgba(59,130,246,0.95) !important;
  box-shadow: 0 0 0 3px rgba(59,130,246,0.22), 0 14px 26px rgba(0,0,0,0.18) !important;
  transform: translateY(-1px);
}

/* ===== PODGLƒÑD LIVE ‚Äì wiƒôkszy modal ===== */
#workforceLiveModal .who-is-working-modal{
  width: min(1200px, 96vw) !important;
  max-width: 96vw !important;
  max-height: 92vh !important;
}

/* PODGLƒÑD LIVE ‚Äì wiƒôkszy modal */
#workforceLiveModal .who-is-working-modal{
  width: min(1200px, 96vw) !important;
  max-width: 96vw !important;
  max-height: 92vh !important;
}

/* lista ‚Äì nie ucinaj ostatniego wiersza */
#workforceLiveModal #workforceLiveList{
  max-height: none !important;
  padding-bottom: 16px;
}

#workforceLiveList{
  overflow: auto !important;
  max-height: none !important;
}

/* ===== PODGLƒÑD LIVE ‚Äì sta≈Çy rozmiar modala + scroll tylko w kolumnach ===== */

/* overlay nie przewija ca≈Çego modala */
#workforceLiveModal{
  align-items: center !important;
  justify-content: center !important;
  overflow: hidden !important;
  padding: 18px 14px; /* zostawiamy oddech */
}

/* modal: sta≈Ça wysoko≈õƒá, flex w pionie */
#workforceLiveModal .who-is-working-modal{
  display: flex !important;
  flex-direction: column !important;
  height: 92vh !important;
  max-height: 92vh !important;
  overflow: hidden !important;
}

/* content: musi umieƒá siƒô ‚Äúskurczyƒá‚Äù, inaczej scroll idzie na rodzica */
#workforceLiveModal .who-is-working-content{
  flex: 1 !important;
  min-height: 0 !important;
  display: flex !important;
  flex-direction: column !important;
  overflow: hidden !important;
}

/* grid dw√≥ch kolumn: ma wype≈Çniaƒá resztƒô modala */
#workforceLiveGrid{
  flex: 1 !important;
  min-height: 0 !important;
}

/* karty po lewej i prawej: te≈º muszƒÖ mieƒá min-height:0 */
#workforceLiveListCard,
#workforceLiveDetailsCard{
  min-height: 0 !important;
  display: flex !important;
  flex-direction: column !important;
  overflow: hidden !important;
}

/* przewija siƒô TYLKO lista po lewej */
#workforceLiveList{
  flex: 1 !important;
  min-height: 0 !important;
  overflow: auto !important;
  max-height: none !important;
  padding-bottom: 16px;
}

/* prawa kolumna: jak bƒôdzie du≈ºo tre≈õci, przewijaj wewnƒÖtrz, nie ca≈Çy modal */
#workforceLiveDetails{
  flex: 1 !important;
  min-height: 0 !important;
  overflow: auto !important;
}

/* gdy modal otwarty, nie przewijaj strony pod spodem */
body.modal-open{
  overflow: hidden !important;
}

    </style>
</head>
<body>
<!-- ===== EKRAN LOGOWANIA ===== -->
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  
  .login-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }
  
  .login-card {
    background: white;
    padding: 50px 40px;
    border-radius: 20px;
    box-shadow: 
      0 20px 60px rgba(0,0,0,0.3),
      0 0 0 1px rgba(255,255,255,0.1);
    max-width: 420px;
    width: 90%;
    animation: slideUp 0.5s ease-out;
  }
  
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .login-logo {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .login-logo img {
    max-width: 180px;
    height: auto;
  }
  
  .login-logo-placeholder {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    font-size: 36px;
  }
  
  .login-title {
    text-align: center;
    font-size: 26px;
    font-weight: 700;
    margin-bottom: 8px;
    color: #1a1a2e;
  }
  
  .login-subtitle {
    text-align: center;
    color: #6b7280;
    margin-bottom: 35px;
    font-size: 15px;
    font-weight: 500;
  }
  
  .input-group {
    position: relative;
    margin-bottom: 20px;
  }
  
  .input-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    opacity: 0.5;
  }
  
  .login-input {
    width: 100%;
    padding: 16px 16px 16px 48px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 16px;
    font-family: 'Inter', sans-serif;
    box-sizing: border-box;
    transition: all 0.3s ease;
    background: #f9fafb;
  }
  
  .login-input:focus {
    outline: none;
    border-color: #667eea;
    background: white;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
  }
  
  .login-input::placeholder {
    color: #9ca3af;
  }
  
  .login-button {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 17px;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    box-sizing: border-box;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  
  .login-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
  }
  
  .login-button:active {
    transform: translateY(0);
  }
  
  .login-error {
    color: #dc2626;
    margin-top: 20px;
    font-weight: 600;
    text-align: center;
    display: none;
    padding: 12px;
    background: #fef2f2;
    border-radius: 8px;
    font-size: 14px;
  }

  .who-is-working-btn {
    width: 100%;
    padding: 14px;
    background: transparent;
    color: #667eea;
    border: 2px solid #667eea;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 15px;
}

.who-is-working-btn:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.who-is-working-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.who-is-working-overlay.show {
    display: flex;
}

/* PODGLƒÑD LIVE ‚Äì overlay NIE scrolluje, scrolluje tylko ≈õrodek (lista) */
#workforceLiveModal{
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

#workforceLiveModal .who-is-working-modal{
  width: min(1200px, 96vw) !important;
  max-width: 96vw !important;
  max-height: 92vh !important;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* content wype≈Çnia wysoko≈õƒá modala (bez w≈Çasnego scrolla) */
#workforceLiveModal .who-is-working-content{
  flex: 1;
  max-height: none !important;
  overflow: hidden !important;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

/* grid ma siƒô rozciƒÖgaƒá w d√≥≈Ç */
#workforceLiveGrid{
  flex: 1;
  min-height: 0;
}

/* karta listy jako kolumna: nag≈Ç√≥wek sta≈Çy, lista przewijana */
#workforceLiveListCard{
  display: flex;
  flex-direction: column;
  min-height: 0;
}

#workforceLiveList{
  flex: 1;
  min-height: 0;
  max-height: none !important;   /* zabija 55vh */
  overflow: auto !important;
  padding-bottom: 16px;
}

.who-is-working-modal {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease-out;
}

.who-is-working-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.who-is-working-header h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
}

.who-is-working-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.who-is-working-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.who-is-working-content {
    padding: 20px 25px;
    max-height: 50vh;
    overflow-y: auto;
}

.who-is-working-section {
    margin-bottom: 20px;
}

.who-is-working-section-title {
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #eee;
}

.who-is-working-section-title.working {
    color: #28a745;
    border-bottom-color: #28a745;
}

.who-is-working-section-title.on-break {
    color: #ffc107;
    border-bottom-color: #ffc107;
}

.who-is-working-section-title.absent {
    color: #6c757d;
    border-bottom-color: #6c757d;
}

.who-is-working-employee {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.who-is-working-employee:hover {
    background: #e9ecef;
    transform: translateX(5px);
}

.who-is-working-employee-icon {
    font-size: 24px;
    margin-right: 15px;
}

.who-is-working-employee-info {
    flex: 1;
}

.who-is-working-employee-name {
    font-weight: 600;
    font-size: 15px;
    color: #333;
}

.who-is-working-employee-operation {
    font-size: 13px;
    color: #666;
    margin-top: 2px;
}

.who-is-working-employee-time {
    font-size: 13px;
    color: #667eea;
    font-weight: 600;
}

.who-is-working-footer {
    background: #f8f9fa;
    padding: 15px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid #eee;
}

.who-is-working-footer span {
    font-size: 13px;
    color: #666;
}

.who-is-working-refresh {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.who-is-working-refresh:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.who-is-working-empty {
    text-align: center;
    padding: 20px;
    color: #999;
    font-style: italic;
}
  
  .login-footer {
    text-align: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb;
    color: #9ca3af;
    font-size: 13px;
  }

  /* ===== SYSTEM OG≈ÅOSZE≈É ===== */

/* Ekran wy≈õwietlania og≈Çoszenia dla pracownika */
.announcement-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    padding: 20px;
    box-sizing: border-box;
}

.announcement-screen.show {
    display: flex;
}

.announcement-card {
    background: white;
    border-radius: 20px;
    max-width: 500px;
    width: 100%;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    animation: slideUp 0.4s ease-out;
}

.announcement-card-header {
    padding: 25px;
    text-align: center;
    color: white;
}

.announcement-card-header.info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.announcement-card-header.wazne {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.announcement-card-header.pilne {
    background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
    animation: pulse-urgent 1.5s infinite;
}

@keyframes pulse-urgent {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.85; }
}

.announcement-card-header h2 {
    margin: 0;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.announcement-card-body {
    padding: 30px 25px;
}

.announcement-card-body .message {
    font-size: 1.2rem;
    line-height: 1.6;
    color: #333;
    text-align: center;
    margin-bottom: 20px;
}

.announcement-card-body .meta {
    font-size: 0.85rem;
    color: #888;
    text-align: center;
}

.announcement-card-footer {
    padding: 20px 25px 25px;
    text-align: center;
}

.announcement-read-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    padding: 15px 50px;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
}

.announcement-read-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5);
}

.announcement-counter {
    background: rgba(255, 255, 255, 0.2);
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.9rem;
    margin-top: 10px;
    display: inline-block;
}

/* Panel og≈Çosze≈Ñ kierownika */
.announcements-panel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2500;
    padding: 20px;
    box-sizing: border-box;
}

.announcements-panel-overlay.show {
    display: flex;
}

.announcements-panel {
    background: white;
    border-radius: 20px;
    max-width: 700px;
    width: 100%;
    max-height: 85vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    animation: slideUp 0.3s ease-out;
    display: flex;
    flex-direction: column;
}

.announcements-panel-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px 25px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.announcements-panel-header h2 {
    margin: 0;
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.announcements-panel-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.announcements-panel-close:hover {
    background: rgba(255, 255, 255, 0.3);
}

.announcements-panel-tabs {
    display: flex;
    border-bottom: 1px solid #eee;
}

.announcements-panel-tab {
    flex: 1;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    font-weight: 500;
    color: #666;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
}

.announcements-panel-tab:hover {
    background: #f8f9fa;
}

.announcements-panel-tab.active {
    color: #667eea;
    border-bottom-color: #667eea;
}

.announcements-panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Formularz nowego og≈Çoszenia */
.announcement-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.announcement-form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.announcement-form-group label {
    font-weight: 600;
    color: #333;
    font-size: 0.95rem;
}

.announcement-form-group select,
.announcement-form-group input,
.announcement-form-group textarea {
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    font-family: inherit;
}

.announcement-form-group select:focus,
.announcement-form-group input:focus,
.announcement-form-group textarea:focus {
    outline: none;
    border-color: #667eea;
}

.announcement-form-group textarea {
    min-height: 100px;
    resize: vertical;
}

.recipients-checkboxes {
    max-height: 150px;
    overflow-y: auto;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 10px;
}

.recipients-checkboxes label {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    cursor: pointer;
    border-radius: 8px;
    font-weight: normal;
}

.recipients-checkboxes label:hover {
    background: #f0f0f0;
}

.recipients-checkboxes input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.announcement-submit-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    padding: 15px;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.announcement-submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
}

/* Lista og≈Çosze≈Ñ */
.announcements-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.announcement-item {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 15px;
    border-left: 4px solid #667eea;
}

.announcement-item.wazne {
    border-left-color: #f5576c;
}

.announcement-item.pilne {
    border-left-color: #eb3349;
}

.announcement-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.announcement-item-type {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    padding: 4px 10px;
    border-radius: 20px;
    color: white;
}

.announcement-item-type.info {
    background: #667eea;
}

.announcement-item-type.wazne {
    background: #f5576c;
}

.announcement-item-type.pilne {
    background: #eb3349;
}

.announcement-item-delete {
    background: #dc3545;
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.announcement-item-delete:hover {
    background: #c82333;
    transform: scale(1.1);
}

.announcement-item-text {
    font-size: 1rem;
    color: #333;
    margin-bottom: 10px;
    line-height: 1.5;
}

.announcement-item-meta {
    font-size: 0.8rem;
    color: #888;
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
}

.announcement-item-readers {
    color: #28a745;
    font-weight: 500;
}

.announcements-empty {
    text-align: center;
    padding: 40px;
    color: #888;
}
</style>

<div id="loginScreen" style="display: none;">
  <div class="login-screen">
    <div class="login-card">
      
      <!-- LOGO DBK -->
<div class="login-logo">Logo Twojej firmy</h1>
</div>
      
      <h1 class="login-title">Logowanie</h1>
      <p class="login-subtitle">Centrum dowodzenia</p>
      
      <div class="input-group">
        <span class="input-icon">üë§</span>
        <input 
          type="text" 
          id="loginInput" 
          class="login-input"
          placeholder="Login" 
          autocomplete="username"
        >
      </div>
      
      <div class="input-group">
        <span class="input-icon">üîí</span>
        <input 
          type="password" 
          id="passwordInput" 
          class="login-input"
          placeholder="Has≈Ço" 
          autocomplete="current-password"
        >
      </div>
      
      <button onclick="handleLogin()" class="login-button">
        <span>üîì</span>
        <span>Zaloguj siƒô</span>
      </button>
      
      <div id="loginError" class="login-error"></div>

      <button onclick="showWhoIsWorking()" class="who-is-working-btn">
        üë• Kto jest na magazynie?
      </button>
      
      <div class="login-footer">
        ¬© 2026 CENTRIVO | System Rejestratora v1.0
      </div>
      
    </div>
  </div>
</div>

<!-- ===== G≈Å√ìWNY INTERFEJS (po zalogowaniu) ===== -->
<div id="mainInterface" style="display: none;">

  <!-- PRZE≈ÅƒÑCZNIK MOTYWU -->
<button id="themeToggle" onclick="toggleTheme()">
    <span id="themeIcon">üåô</span> <span id="themeText">Tryb ciemny</span>
</button>

    <div class="status-bar">
    <div class="status-left">
        <button class="status-button back-btn" onclick="handleTopBarBack()" id="topBarBackBtn">üö™ Wyloguj</button>
        <button class="status-button vacation-btn" onclick="showVacationPlanning()" title="System planowania urlop√≥w" id="vacationBtn">
            üìÖ Planowanie urlop√≥w
        </button>
        <button class="status-button l4-btn" onclick="openL4Registration()" title="Rejestracja zwolnie≈Ñ lekarskich">
            üè• Zwolnienia L4
        </button>
        <button class="status-button ticket-btn" onclick="openTicketSystem()" title="Zg≈Ço≈õ problem lub pomys≈Ç">
            üé´ Zg≈Ço≈õ problem
        </button>
        <label style="margin-left: 10px;">Zeskanuj kod:</label>
        <input type="text" class="code-input" id="codeInput" placeholder="Kod" autocomplete="off" autofocus>
    </div>

    <!-- STATYSTYKI NA ≈ªYWO -->
<div class="live-stats">
    <div class="stat-item" title="PracujƒÖcy">
        <span class="stat-icon">üë∑</span>
        <span class="stat-value working" id="workingCount">0</span>
    </div>
    <div class="stat-item" title="Na przerwie">
        <span class="stat-icon">‚òï</span>
        <span class="stat-value break" id="breakCount">0</span>
    </div>
</div>
    <div class="session-info">
        <div class="current-time" id="currentTime">10:21:45</div>
        <div class="current-date" id="currentDate">PiƒÖtek, 6 lutego 2026</div>
    </div>
</div>

    <div class="main-container">
        <div class="welcome-header" id="welcomeHeader">
            <div id="welcomeMessage"></div>
        </div>

        <div class="view-container">
            <!-- WIDOK G≈Å√ìWNY -->
            <div class="view active" id="departmentView">
                <h2 class="view-title">Wybierz dzia≈Ç/operacjƒô</h2>
                <div class="tiles-grid">
    <div class="tile przyjecie" onclick="selectDepartment('przyjecie')">
        <span class="tile-icon">üì¶</span>
        <span class="tile-text">Przyjƒôcie dostaw</span>
    </div>
    <div class="tile rozladunek" onclick="selectDepartment('rozladunek')">
        <span class="tile-icon">üöõ</span>
        <span class="tile-text">Roz≈Çadunek rƒôczny kontenera</span>
    </div>
    <div class="tile zaladunek" onclick="selectDepartment('zaladunek')">
        <span class="tile-icon">üì§</span>
        <span class="tile-text">Za≈Çadunek rƒôczny kontenera</span>
    </div>
    <div class="tile relokacja" onclick="selectDepartment('relokacja')">
        <span class="tile-icon">üîÑ</span>
        <span class="tile-text">Relokacja</span>
    </div>
    <div class="tile kompletacja" onclick="selectDepartment('kompletacja')">
        <span class="tile-icon">üìã</span>
        <span class="tile-text">Kompletacja zam√≥wie≈Ñ</span>
    </div>
    <div class="tile weryfikacja" onclick="selectDepartment('weryfikacja')">
        <span class="tile-icon">‚úÖ</span>
        <span class="tile-text">Weryfikacja zam√≥wie≈Ñ</span>
    </div>
    <div class="tile co-packing" onclick="selectDepartment('co-packing')">
        <span class="tile-icon">üéÅ</span>
        <span class="tile-text">Co-packing</span>
    </div>
    <div class="tile operacje-porzadkowe" onclick="selectDepartment('operacje-porzadkowe')">
        <span class="tile-icon">üßπ</span>
        <span class="tile-text">Operacje porzƒÖdkowe</span>
    </div>
    <div class="tile inwentaryzacja" onclick="selectDepartment('inwentaryzacja')">
        <span class="tile-icon">üìä</span>
        <span class="tile-text">Inwentaryzacja</span>
    </div>
</div>
            <div style="text-align: center; margin-top: 30px;">
              <a href="#"
                target="_blank"
                class="dashboard-btn"
                id="dashboardBtn"
                style="display: none;"
                onclick="openDashboard(); return false;">
                üìä Otw√≥rz Dashboard
              </a>

              <button id="announcementsBtn"
                      onclick="openAnnouncementsPanel()"
                      class="dashboard-btn"
                      style="display: none; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin-left: 15px;">
                üì¢ Og≈Çoszenia
              </button>

              <button id="workforcePlannerBtn"
                      onclick="openWorkforcePlanner()"
                      class="dashboard-btn"
                      style="display:none; background: linear-gradient(135deg, #34d399 0%, #10b981 100%); margin-left: 15px;">
                üë• Planowanie obsady
              </button>

              <button id="workforceLiveBtn"
                      onclick="openWorkforceLiveModal()"
                      class="dashboard-btn"
                      style="display:none; background: linear-gradient(135deg, #6633FF 0%, #3b82f6 100%); margin-left: 15px;">
                üëÅÔ∏è PodglƒÖd LIVE
              </button>
            </div>

            </div> <!-- zamkniƒôcie: #departmentView -->

            <!-- WIDOK WYBORU PRACOWNIKA -->
            <div class="view" id="userView">

                <button class="back-button" onclick="goBack()">‚Üê Powr√≥t do wyboru dzia≈Çu</button>
                <h2 class="view-title" id="userViewTitle">Wybierz pracownika</h2>
                <div class="tiles-grid" id="userTiles"></div>
            </div>

            <!-- WIDOK WERYFIKACJI -->
            <div class="view" id="verificationView">
                <button class="back-button" onclick="goBack()">‚Üê Powr√≥t do wyboru operacji</button>
                <div class="verification-container">
                    <h2 class="verification-title">Potwierd≈∫ swojƒÖ to≈ºsamo≈õƒá</h2>
                    <div class="verification-user-info" id="verificationUserInfo">
                        <p><strong>Wybrano:</strong> <span id="selectedUserName"></span></p>
                        <p><strong>Dzia≈Ç:</strong> <span id="selectedDepartmentName"></span></p>
                    </div>
                    <p style="margin-bottom: 15px; font-size: 18px; color: #28a745; font-weight: bold;">
                        Zeskanuj sw√≥j kod EAN aby potwierdziƒá operacjƒô
                    </p>
                    <input type="text" class="verification-input" id="verificationCodeInput" 
                           placeholder="Zeskanuj kod EAN" autocomplete="off" autofocus>
                    <div style="margin-top: 15px; color: #666; font-size: 14px;">
                        Kod zostanie automatycznie zatwierdzony po zeskanowaniu
                    </div>
                </div>
            </div>

            <!-- WIDOK WERYFIKACJI URLOPU -->
            <div class="view" id="vacationVerificationView">
                <button class="back-button" onclick="goBack()">‚Üê Powr√≥t do menu g≈Ç√≥wnego</button>
                <div class="verification-container">
                    <h2 class="verification-title">Potwierd≈∫ to≈ºsamo≈õƒá dla urlopu</h2>
                    <div class="verification-user-info" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                        <p style="font-size: 18px; color: #2e7d32;"><strong>üìÖ Planowanie nieobecno≈õci</strong></p>
                    </div>
                    <p style="margin-bottom: 15px; font-size: 18px; color: #e91e63; font-weight: bold;">
                        Zeskanuj sw√≥j kod EAN aby przej≈õƒá do formularza urlopu
                    </p>
                    <input type="text" class="verification-input" id="vacationVerificationCodeInput" 
                           placeholder="Zeskanuj kod EAN" autocomplete="off" autofocus>
                    <div style="margin-top: 15px; color: #666; font-size: 14px;">
                        Kod zostanie automatycznie zatwierdzony po zeskanowaniu
                    </div>
                </div>
            </div>

            <!-- WIDOK PANELU OPERATORA -->
            <div class="view" id="actionView">
                <button class="back-button" onclick="goBack()">‚Üê Powr√≥t do wyboru pracownika</button>
                <h2 class="view-title" id="actionViewTitle">Panel operatora</h2>
                <div style="text-align: center; margin-bottom: 20px;">
                     <p>Operacje pracownika</p>
                </div>
                <div class="tiles-grid">
                    <div class="tile wychodzi-pracy" id="wychodzi-pracy-btn" onclick="handleAction('wychodzi-pracy')">
                        Wychodzƒô z pracy
                    </div>
                    <div class="tile wchodzi" id="wchodzi-btn" onclick="handleAction('wchodzi')">
                        Wchodzƒô do pracy
                    </div>
                    <div class="tile wychodzi-przerwa" id="wychodzi-przerwa-btn" onclick="handleAction('wychodzi-przerwa')">
                        Wychodzƒô na przerwƒô
                    </div>
                    <div class="tile wracam" id="wracam-btn" onclick="handleAction('wracam')">
                        Wracam z przerwy
                    </div>
                    <div class="tile zmieniam-operacje" id="zmieniam-operacje-btn" onclick="handleAction('zmieniam-operacje')">
                        Zmieniam operacjƒô
                    </div>
                    
                    <!-- KAFELEK "MOJE ZG≈ÅOSZENIA" (tylko dla pracownik√≥w) -->
                    <div class="tile" id="my-tickets-btn" onclick="showMyTicketsView()" 
                        style="background: linear-gradient(45deg, #9c27b0, #673ab7); position: relative; display: none;">
                        üé´ Moje zg≈Çoszenia
                    </div>
                    <!-- KAFELEK "ZARZƒÑDZANIE ZG≈ÅOSZENIAMI" (tylko dla kierownika) -->
                    <div class="tile" id="manager-tickets-btn" onclick="showManagerTicketsView()" 
                        style="background: linear-gradient(45deg, #dc3545, #c82333); position: relative; display: none;">
                        üé´ ZarzƒÖdzaj zg≈Çoszeniami
                    </div>
                </div>
                <div style="text-align: center; margin-top: 30px; color: #666; font-size: 14px;">
                    <p>Status: <span style="color: #007bff; font-weight: bold;" id="statusInfo">Nie zalogowany</span></p>
                    <p>Ostatnia aktywno≈õƒá: <span id="lastActivity">--:--:--</span></p>
                    <p>Po≈ÇƒÖczenie z arkuszem: <span style="color: #ffc107; font-weight: bold;" id="connectionStatus">≈Åadowanie...</span></p>
                </div>
            </div>

            <!-- WIDOK WERYFIKACJI L4 (TYLKO KIEROWNIK) -->
            <div class="view" id="l4VerificationView">
                <button class="back-button" onclick="goBack()">‚Üê Powr√≥t do menu g≈Ç√≥wnego</button>
                <div class="verification-container">
                    <h2 class="verification-title">üè• Rejestracja zwolnienia lekarskiego</h2>
                    <div class="verification-user-info" style="background: #fff3e0; border-left: 4px solid #ff9800;">
                        <p style="font-size: 18px; color: #e65100;"><strong>‚ö†Ô∏è Dostƒôp tylko dla kierownika</strong></p>
                        <p>Operacja: Rejestracja L4</p>
                    </div>
                    <p style="margin-bottom: 15px; font-size: 18px; color: #ff5722; font-weight: bold;">
                        Zeskanuj kod EAN kierownika aby kontynuowaƒá
                    </p>
                    <input type="text" class="verification-input" id="l4VerificationCodeInput" 
                          placeholder="Zeskanuj kod EAN kierownika" autocomplete="off" autofocus>
                    <div style="margin-top: 15px; color: #666; font-size: 14px;">
                        Tylko kod kierownika (jerzyd) jest akceptowany
                    </div>
                </div>
            </div>

            <!-- WIDOK FORMULARZA L4 -->
            <div class="view" id="l4FormView">
                <button class="back-button" onclick="goBack()">‚Üê Powr√≥t do menu g≈Ç√≥wnego</button>
                <h2 class="view-title">üè• Rejestracja zwolnienia lekarskiego</h2>
                
                <div class="vacation-container">
                    <div class="vacation-form">
                        <div>
                            <label>Wybierz pracownika:</label>
                            <select id="l4EmployeeSelect" class="form-input" style="padding: 12px; font-size: 16px;">
                                <option value="">-- Wybierz pracownika --</option>
                            </select>
                        </div>
                        
                        <div>
                            <label>Data od:</label>
                            <input type="date" class="date-input" id="l4StartDate">
                        </div>
                        
                        <div>
                            <label>Data do:</label>
                            <input type="date" class="date-input" id="l4EndDate">
                        </div>
                        
                        <div class="vacation-info" id="l4Info" style="display: none;">
                            <p>Dni kalendarzowe (L4 obejmuje te≈º weekendy): <strong><span id="l4WorkingDaysCount">0</span></strong></p>
                        </div>
                        
                        <div>
                            <label>Typ zwolnienia:</label>
                            <select id="l4Type" class="form-input" style="padding: 12px; font-size: 16px;">
                                <option value="Choroba">ü§í Choroba w≈Çasna</option>
                                <option value="Opieka nad dzieckiem">üë∂ Opieka nad dzieckiem</option>
                                <option value="Oddanie krwi">ü©∏ Oddanie krwi</option>
                                <option value="Wypadek">üöë Wypadek</option>
                                <option value="CiƒÖ≈ºa">ü§∞ CiƒÖ≈ºa</option>
                                <option value="Rehabilitacja">üè• Rehabilitacja</option>
                                <option value="Inne">üìã Inne</option>
                            </select>
                        </div>
                        
                        <div>
                            <label>Notatka (opcjonalnie):</label>
                            <textarea id="l4Note" placeholder="Dodatkowe informacje..." rows="3" class="form-input"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 15px;">
                            <button onclick="submitL4Registration()" class="form-btn primary" style="background: #ff5722;">
                                ‚úÖ Zarejestruj L4
                            </button>
                            <button onclick="goBack()" class="form-btn secondary">
                                ‚ùå Anuluj
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WIDOK WERYFIKACJI TICKETU -->
            <div class="view" id="ticketVerificationView">
                <button class="back-button" onclick="goBack()">‚Üê Powr√≥t do menu g≈Ç√≥wnego</button>
                <div class="verification-container">
                    <h2 class="verification-title">üé´ Zg≈Çoszenie problemu/pomys≈Çu</h2>
                    <div class="verification-user-info" style="background: #f3e5f5; border-left: 4px solid #9c27b0;">
                        <p style="font-size: 18px; color: #6a1b9a;"><strong>üìã Potwierd≈∫ swojƒÖ to≈ºsamo≈õƒá</strong></p>
                        <p>Operacja: Zg≈Çoszenie ticketu</p>
                    </div>
                    <p style="margin-bottom: 15px; font-size: 18px; color: #9c27b0; font-weight: bold;">
                        Zeskanuj sw√≥j kod EAN aby przej≈õƒá do formularza
                    </p>
                    <input type="text" class="verification-input" id="ticketVerificationCodeInput" 
                           placeholder="Zeskanuj kod EAN" autocomplete="off" autofocus>
                    <div style="margin-top: 15px; color: #666; font-size: 14px;">
                        Kod zostanie automatycznie zatwierdzony po zeskanowaniu
                    </div>
                </div>
            </div>

            <!-- WIDOK ZG≈ÅOSZENIA TICKETU -->
            <div class="view" id="ticketView">
                <button class="back-button" onclick="goBack()">‚Üê Powr√≥t do menu g≈Ç√≥wnego</button>
                <h2 class="view-title">üé´ Nowe zg≈Çoszenie</h2>
                
                <div class="vacation-container">
                    <div class="vacation-form">
                        <div>
                            <label>Twoje dane:</label>
                            <div class="verification-user-info" style="background: #f0f0f0; border-left: 4px solid #9c27b0;">
                                <p><strong>Pracownik:</strong> <span id="ticketUserName">-</span></p>
                            </div>
                        </div>
                        
                        <div>
                            <label>Wybierz kategoriƒô:</label>
                            <div class="vacation-type-selector">
                                <div class="vacation-type-option selected" onclick="selectTicketCategory('pomys≈Ç')" id="cat-pomys≈Ç">
                                    <strong>üí° Pomys≈Ç</strong><br>
                                    <small>Usprawnienia proces√≥w</small>
                                </div>
                                <div class="vacation-type-option" onclick="selectTicketCategory('problem')" id="cat-problem">
                                    <strong>‚ö†Ô∏è Problem</strong><br>
                                    <small>Trudno≈õci operacyjne</small>
                                </div>
                                <div class="vacation-type-option" onclick="selectTicketCategory('usterka')" id="cat-usterka">
                                    <strong>üîß Usterka</strong><br>
                                    <small>Awarie techniczne</small>
                                </div>
                                <div class="vacation-type-option" onclick="selectTicketCategory('pilne')" id="cat-pilne">
                                    <strong>üÜò PILNE</strong><br>
                                    <small>BHP / Krytyczne</small>
                                </div>
                            </div>
                            <input type="hidden" id="ticketCategory" value="pomys≈Ç">
                        </div>
                        
                        <div>
                            <label>Tytu≈Ç zg≈Çoszenia (kr√≥tki opis):</label>
                            <input type="text" class="form-input" id="ticketTitle" placeholder="np. Skaner #5 nie dzia≈Ça" maxlength="100">
                        </div>
                        
                        <div>
                            <label>Szczeg√≥≈Çowy opis:</label>
                            <textarea id="ticketDescription" placeholder="Opisz szczeg√≥≈Çowo problem, pomys≈Ç lub usterkƒô..." rows="5" class="form-input"></textarea>
                        </div>
                        
                        <div>
                            <label>Lokalizacja (dzia≈Ç/strefa):</label>
                            <input type="text" class="form-input" id="ticketLocation" placeholder="np. Przyjƒôcie, Strefa A-12">
                        </div>
                        
                        <div>
                            <label>Priorytet:</label>
                            <select id="ticketPriority" class="form-input" style="padding: 12px; font-size: 16px;">
                                <option value="NISKI">‚ö™ Niski - mo≈ºe poczekaƒá</option>
                                <option value="≈öREDNI" selected>üü° ≈öredni - wa≈ºne</option>
                                <option value="WYSOKI">üü† Wysoki - pilne</option>
                                <option value="KRYTYCZNY">üî¥ KRYTYCZNY - natychmiast!</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 15px;">
                            <button onclick="submitTicket()" class="form-btn primary" style="background: #9c27b0;">
                                ‚úÖ Wy≈õlij zg≈Çoszenie
                            </button>
                            <button onclick="goBack()" class="form-btn secondary">
                                ‚ùå Anuluj
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WIDOK WYBORU TYPU NIEOBECNO≈öCI -->
            <div class="view" id="absenceTypeView">
                <button class="back-button" onclick="goBack()">‚Üê Powr√≥t do menu g≈Ç√≥wnego</button>
                <h2 class="view-title">üìÖ Planowanie nieobecno≈õci</h2>
                
                <div class="vacation-container">
                    <!-- SALDO URLOPOWE -->
                    <div class="vacation-balance" id="absenceTypeBalance">
                        <h4>Tw√≥j stan urlopowy:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 10px;">
                            <div>Przys≈ÇugujƒÖcy: <strong id="absTypePrzys≈ÇugujƒÖcy">-</strong> dni</div>
                            <div>Zaleg≈Çy: <strong id="absTypeZaleg≈Çy">-</strong> dni</div>
                            <div>Wykorzystany: <strong id="absTypeWykorzystany">-</strong> dni</div>
                            <div>Pozosta≈Çy: <strong id="absTypePozosta≈Çy">-</strong> dni</div>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <p style="text-align: center; font-size: 16px; color: #666;">
                            Pracownik: <strong id="absenceTypeUserName">-</strong>
                        </p>
                    </div>
                    
                    <h3 style="text-align: center; margin-bottom: 20px;">Wybierz rodzaj nieobecno≈õci:</h3>
                    
                    <div class="tiles-grid" style="max-width: 800px; margin: 0 auto;">
                        <!-- Urlop wypoczynkowy -->
                        <div class="tile" onclick="selectAbsenceType('vacation')" 
                            style="background: linear-gradient(45deg, #2196f3, #1976d2); min-height: 140px; flex-direction: column; padding: 20px;">
                            <div style="font-size: 40px; margin-bottom: 10px;">üèñÔ∏è</div>
                            <div style="font-size: 18px; font-weight: bold;">Urlop wypoczynkowy</div>
                            <div style="font-size: 12px; margin-top: 8px; opacity: 0.9;">Planowany / Na ≈ºƒÖdanie / Wsteczny</div>
                        </div>
                        
                        <!-- Dzie≈Ñ wolny -->
                        <div class="tile" onclick="selectAbsenceType('dayoff')" 
                            style="background: linear-gradient(45deg, #4caf50, #388e3c); min-height: 140px; flex-direction: column; padding: 20px;">
                            <div style="font-size: 40px; margin-bottom: 10px;">üìÖ</div>
                            <div style="font-size: 18px; font-weight: bold;">Dzie≈Ñ wolny</div>
                            <div style="font-size: 12px; margin-top: 8px; opacity: 0.9;">Odbi√≥r za nadgodziny / ≈õwiƒôto</div>
                        </div>
                        
                        <!-- Urlop okoliczno≈õciowy -->
                        <div class="tile" onclick="selectAbsenceType('occasional')" 
                            style="background: linear-gradient(45deg, #9c27b0, #7b1fa2); min-height: 140px; flex-direction: column; padding: 20px;">
                            <div style="font-size: 40px; margin-bottom: 10px;">üéä</div>
                            <div style="font-size: 18px; font-weight: bold;">Urlop okoliczno≈õciowy</div>
                            <div style="font-size: 12px; margin-top: 8px; opacity: 0.9;">≈ölub / Narodziny / Zgon</div>
                        </div>
                        
                        <!-- Plan roczny -->
                        <div class="tile" onclick="selectAbsenceType('yearplan')" 
                            style="background: linear-gradient(45deg, #ff9800, #f57c00); min-height: 140px; flex-direction: column; padding: 20px;">
                            <div style="font-size: 40px; margin-bottom: 10px;">üìÜ</div>
                            <div style="font-size: 18px; font-weight: bold;">Plan roczny</div>
                            <div style="font-size: 12px; margin-top: 8px; opacity: 0.9;">Zaplanuj urlopy na ca≈Çy rok</div>
                        </div>
                    </div>
                    
                    <hr style="margin: 30px 0;">
                    
                    <h3>Historia Twoich wniosk√≥w</h3>
                    <div class="vacation-requests-list" id="absenceTypeRequests" style="max-height: 300px;">
                        ≈Åadowanie wniosk√≥w...
                    </div>
                </div>
            </div>

            <!-- WIDOK FORMULARZA DZIE≈É WOLNY -->
            <div class="view" id="dayOffView">
                <button class="back-button" onclick="goBackFromDayOff()">‚Üê Powr√≥t do wyboru typu</button>
                <h2 class="view-title">üìÖ Dzie≈Ñ wolny</h2>
                
                <div class="vacation-container">
                    <div class="vacation-info" style="background: #e8f5e9; border-left: 4px solid #4caf50; margin-bottom: 20px;">
                        <p style="margin: 0;">
                            <strong>‚ÑπÔ∏è Informacja:</strong> Dzie≈Ñ wolny <u>nie odejmuje</u> dni z puli urlopowej.
                        </p>
                    </div>
                    
                    <div class="vacation-form">
                        <div>
                            <label>Pracownik: <strong id="dayOffUserName">-</strong></label>
                        </div>
                        
                        <!-- TYP DNIA WOLNEGO -->
                        <div>
                            <label>Rodzaj dnia wolnego:</label>
                            <select id="dayOffType" class="form-input" style="padding: 12px; font-size: 16px;" onchange="onDayOffTypeChange()">
                                <option value="">-- Wybierz rodzaj --</option>
                                <option value="nadgodziny">üïê Odbi√≥r za nadgodziny</option>
                                <option value="swieto">üéå Dzie≈Ñ wolny za ≈õwiƒôto w sobotƒô</option>
                                <option value="opieka">üë∂ Opieka nad dzieckiem (Art. 188 KP) - 2 dni/rok</option>
                                <option value="sila_wyzsza">‚ö° Si≈Ça wy≈ºsza (Art. 148¬π KP) - 2 dni/rok</option>
                                <option value="wyjscie_prywatne">üö∂ Wyj≈õcie prywatne (do odpracowania)</option>
                                <option value="inny">üìã Inny (opisz poni≈ºej)</option>
                            </select>
                        </div>
                        
                        <!-- INFORMACJA O LIMICIE (dla opieki i si≈Çy wy≈ºszej) -->
                        <div id="dayOffLimitInfo" style="display: none;" class="vacation-info">
                            <p id="dayOffLimitText">-</p>
                        </div>
                        
                        <div>
                            <label>Data:</label>
                            <input type="date" class="date-input" id="dayOffDate">
                        </div>
                        
                        <!-- GODZINY (dla wyj≈õcia prywatnego) -->
                        <div id="dayOffHoursSection" style="display: none;">
                            <label>Godziny wyj≈õcia:</label>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <input type="time" class="form-input" id="dayOffTimeFrom" style="flex: 1;">
                                <span>do</span>
                                <input type="time" class="form-input" id="dayOffTimeTo" style="flex: 1;">
                            </div>
                        </div>
                        
                        <!-- OPIS (dla typu "inny" lub dodatkowe uwagi) -->
                        <div>
                            <label>Pow√≥d / uwagi <span id="dayOffReasonRequired" style="color: red; display: none;">*</span>:</label>
                            <textarea id="dayOffReason" placeholder="Opisz pow√≥d dnia wolnego..." rows="3" class="form-input"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button onclick="submitDayOff()" class="form-btn primary" style="background: #4caf50;">
                                ‚úÖ Z≈Ç√≥≈º wniosek
                            </button>
                            <button onclick="goBackFromDayOff()" class="form-btn secondary">
                                ‚ùå Anuluj
                            </button>
                        </div>
                    </div>
                    
                    <hr style="margin: 30px 0;">
                    
                    <h3>Twoje wnioski o dzie≈Ñ wolny</h3>
                    <div class="vacation-requests-list" id="dayOffRequests" style="max-height: 300px;">
                        <p style="text-align: center; color: #666;">Brak wniosk√≥w</p>
                    </div>
                </div>
            </div>

            <!-- WIDOK FORMULARZA URLOP OKOLICZNO≈öCIOWY -->
            <div class="view" id="occasionalLeaveView">
                <button class="back-button" onclick="goBackFromOccasional()">‚Üê Powr√≥t do wyboru typu</button>
                <h2 class="view-title">üéä Urlop okoliczno≈õciowy</h2>
                
                <div class="vacation-container">
                    <div class="vacation-info" style="background: #f3e5f5; border-left: 4px solid #9c27b0; margin-bottom: 20px;">
                        <p style="margin: 0;">
                            <strong>‚ÑπÔ∏è Informacja:</strong> Urlop okoliczno≈õciowy to <u>p≈Çatne</u> dni wolne przys≈ÇugujƒÖce z mocy prawa (Art. 188 KP).
                            <br>Nie odejmuje dni z puli urlopowej.
                        </p>
                    </div>
                    
                    <div class="vacation-form">
                        <div>
                            <label>Pracownik: <strong id="occasionalUserName">-</strong></label>
                        </div>
                        
                        <!-- TYP URLOPU OKOLICZNO≈öCIOWEGO -->
                        <div>
                            <label>Rodzaj urlopu okoliczno≈õciowego:</label>
                            <select id="occasionalType" class="form-input" style="padding: 12px; font-size: 16px;" onchange="onOccasionalTypeChange()">
                                <option value="">-- Wybierz rodzaj --</option>
                                <optgroup label="≈ölub">
                                    <option value="slub_wlasny">üíí ≈ölub w≈Çasny - 2 dni</option>
                                    <option value="slub_dziecka">üíç ≈ölub dziecka - 1 dzie≈Ñ</option>
                                </optgroup>
                                <optgroup label="Narodziny">
                                    <option value="narodziny">üë∂ Narodziny dziecka - 2 dni</option>
                                </optgroup>
                                <optgroup label="Zgon">
                                    <option value="zgon_malzonka">üïØÔ∏è Zgon ma≈Ç≈ºonka/dziecka/rodzica - 2 dni</option>
                                    <option value="zgon_inny">üïØÔ∏è Zgon rodze≈Ñstwa/te≈õci√≥w/dziadk√≥w - 1 dzie≈Ñ</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <!-- INFORMACJA O DNIACH -->
                        <div id="occasionalDaysInfo" style="display: none;" class="vacation-info" style="background: #e8f5e9;">
                            <p id="occasionalDaysText" style="font-size: 16px; font-weight: bold;">-</p>
                        </div>
                        
                        <div>
                            <label>Data rozpoczƒôcia:</label>
                            <input type="date" class="date-input" id="occasionalDateStart">
                        </div>
                        
                        <div id="occasionalDateEndSection">
                            <label>Data zako≈Ñczenia:</label>
                            <input type="date" class="date-input" id="occasionalDateEnd">
                            <p id="occasionalDateHelp" style="font-size: 12px; color: #666; margin-top: 5px;">
                                Dla 2-dniowego urlopu wybierz datƒô ko≈ÑcowƒÖ
                            </p>
                        </div>
                        
                        <!-- DODATKOWE INFORMACJE -->
                        <div>
                            <label>Dodatkowe informacje (opcjonalnie):</label>
                            <textarea id="occasionalNote" placeholder="Np. relacja do osoby, szczeg√≥≈Çy..." rows="2" class="form-input"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button onclick="submitOccasionalLeave()" class="form-btn primary" style="background: #9c27b0;">
                                ‚úÖ Z≈Ç√≥≈º wniosek
                            </button>
                            <button onclick="goBackFromOccasional()" class="form-btn secondary">
                                ‚ùå Anuluj
                            </button>
                        </div>
                    </div>
                    
                    <hr style="margin: 30px 0;">
                    
                    <h3>Twoje wnioski o urlop okoliczno≈õciowy</h3>
                    <div class="vacation-requests-list" id="occasionalRequests" style="max-height: 300px;">
                        <p style="text-align: center; color: #666;">Brak wniosk√≥w</p>
                    </div>
                </div>
            </div>

            <!-- WIDOK PLANU ROCZNEGO -->
            <div class="view" id="yearPlanView">
                <button class="back-button" onclick="goBackFromYearPlan()">‚Üê Powr√≥t do wyboru typu</button>
                <h2 class="view-title">üìÜ Plan urlopowy na rok <span id="yearPlanYear">2025</span></h2>
                
                <div class="vacation-container">
                    <div class="vacation-info" style="background: #fff3e0; border-left: 4px solid #ff9800; margin-bottom: 20px;">
                        <p style="margin: 0;">
                            <strong>‚ÑπÔ∏è Planowanie:</strong> Zaznacz dni urlopowe klikajƒÖc na kalendarz. 
                            Plan jest wstƒôpny i wymaga zatwierdzenia przez kierownika.
                        </p>
                    </div>
                    
                    <!-- SALDO -->
                    <div id="yearPlanBalance" style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                        <div><strong>Pracownik:</strong> <span id="yearPlanUserName">-</span></div>
                        <div><strong>Dni do wykorzystania:</strong> <span id="yearPlanRemaining" style="color: #4caf50; font-weight: bold;">-</span></div>
                        <div><strong>Zaplanowane:</strong> <span id="yearPlanSelected" style="color: #2196f3; font-weight: bold;">0</span> dni</div>
                    </div>
                    
                    <!-- NAWIGACJA ROK -->
                    <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px;">
                        <button onclick="changeYearPlanYear(-1)" class="form-btn secondary" style="padding: 8px 16px;">
                            ‚óÄ Poprzedni rok
                        </button>
                        <span style="font-size: 24px; font-weight: bold;" id="yearPlanYearDisplay">2025</span>
                        <button onclick="changeYearPlanYear(1)" class="form-btn secondary" style="padding: 8px 16px;">
                            Nastƒôpny rok ‚ñ∂
                        </button>
                    </div>
                    
                    <!-- LEGENDA -->
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px; font-size: 14px;">
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #4caf50; border-radius: 4px; vertical-align: middle;"></span> Zaplanowany urlop</div>
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #2196f3; border-radius: 4px; vertical-align: middle;"></span> Zatwierdzony</div>
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #f44336; border-radius: 4px; vertical-align: middle;"></span> Odrzucony</div>
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #9e9e9e; border-radius: 4px; vertical-align: middle;"></span> Weekend/≈öwiƒôto</div>
                    </div>
                    
                    <!-- KALENDARZ ROCZNY -->
                    <div id="yearPlanCalendar" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <!-- Generowany przez JS -->
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center;">
                        <button onclick="submitYearPlan()" class="form-btn primary" style="background: #ff9800; min-width: 200px;">
                            üíæ Zapisz plan urlopowy
                        </button>
                        <button onclick="clearYearPlan()" class="form-btn secondary">
                            üóëÔ∏è Wyczy≈õƒá zaznaczenia
                        </button>
                    </div>
                </div>
            </div>

            <!-- WIDOK PLANOWANIA URLOPU -->
            <div class="view" id="vacationView">
                <button class="back-button" onclick="goBack()">‚Üê Powr√≥t do menu g≈Ç√≥wnego</button>
                <h2 class="view-title">Planowanie urlopu</h2>
                
                <div class="vacation-container">
                    <!-- SALDO URLOPOWE -->
                    <div class="vacation-balance" id="vacationBalance" style="display: none;">
                        <h4>Tw√≥j stan urlopowy:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 10px;">
                            <div>Przys≈ÇugujƒÖcy: <strong id="urlopPrzys≈ÇugujƒÖcy">-</strong> dni</div>
                            <div>Zaleg≈Çy: <strong id="urlopZaleg≈Çy">-</strong> dni</div>
                            <div>Wykorzystany: <strong id="urlopWykorzystany">-</strong> dni</div>
                            <div>Pozosta≈Çy: <strong id="urlopPozosta≈Çy">-</strong> dni</div>
                        </div>
                    </div>

                    <div class="vacation-form">
                        <div>
                            <label>Pracownik: <strong id="vacationUserName">-</strong></label>
                        </div>
                        
                        <!-- TYP URLOPU -->
                        <div>
                            <label>Typ urlopu:</label>
                            <div class="vacation-type-selector">
                                <div class="vacation-type-option selected" onclick="selectVacationType('planowany')" id="type-planowany">
                                    <strong>Planowany</strong><br>
                                    <small>Min. 1 dzie≈Ñ wyprzedzenia</small>
                                </div>
                                <div class="vacation-type-option" onclick="selectVacationType('na-zadanie')" id="type-na-zadanie">
                                    <strong>Na ≈ºƒÖdanie</strong><br>
                                    <small>Mo≈ºliwy od dzi≈õ</small>
                                </div>
                                <div class="vacation-type-option" onclick="selectVacationType('wsteczny')" id="type-wsteczny">
                                    <strong>Wsteczny</strong><br>
                                    <small>Data w przesz≈Ço≈õci</small>
                                </div>
                            </div>
                            <input type="hidden" id="vacationType" value="planowany">
                        </div>
                        
                        <div>
                            <label>Data od:</label>
                            <input type="date" class="date-input" id="vacationStartDate">
                        </div>
                        
                        <div>
                            <label>Data do:</label>
                            <input type="date" class="date-input" id="vacationEndDate">
                        </div>
                        
                        <div class="vacation-info" id="vacationInfo" style="display: none;">
                            <p>Dni robocze (bez weekend√≥w i ≈õwiƒÖt): <span id="workingDaysCount">0</span></p>
                            <p>Status urlop√≥w w okresie: <span id="collisionStatus">-</span></p>
                        </div>
                        
                        <div>
                            <label>Komentarz (opcjonalny):</label>
                            <textarea id="vacationComment" placeholder="Pow√≥d urlopu..." rows="3" class="form-input"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 15px;">
                            <button onclick="submitVacation()" class="form-btn primary">Z≈Ç√≥≈º wniosek</button>
                            <button onclick="goBack()" class="form-btn secondary">Anuluj</button>
                        </div>
                    </div>
                    
                    <hr style="margin: 30px 0;">
                    
                    <h3>Twoje wnioski urlopowe</h3>
                    <div class="vacation-requests-list" id="userVacationRequests">
                        ≈Åadowanie wniosk√≥w...
                    </div>
                </div>
            </div>

            <!-- WIDOK ZARZƒÑDZANIA URLOPAMI (kierownik) -->
            <div class="view" id="managerVacationView">
                <button class="back-button" onclick="goBack()">‚Üê Powr√≥t do menu g≈Ç√≥wnego</button>
                <h2 class="view-title">ZarzƒÖdzanie nieobecno≈õciami</h2>
                
                <div class="vacation-container">
                    <div class="notification-panel" id="managerNotifications" style="display: none;">
                        <strong>Uwaga!</strong> <span id="notificationText"></span>
                    </div>
                    
                    <!-- ZAK≈ÅADKI TYP√ìW WNIOSK√ìW -->
                    <div class="vacation-type-selector" style="margin-bottom: 20px;">
                        <div class="vacation-type-option selected" onclick="switchAbsenceTab('vacation')" id="tab-vacation">
                            <strong>üèñÔ∏è Urlopy</strong><br>
                            <small id="count-vacation">0</small>
                        </div>
                        <div class="vacation-type-option" onclick="switchAbsenceTab('dayoff')" id="tab-dayoff">
                            <strong>üìÖ Dni wolne</strong><br>
                            <small id="count-dayoff">0</small>
                        </div>
                        <div class="vacation-type-option" onclick="switchAbsenceTab('occasional')" id="tab-occasional">
                            <strong>üéä Okoliczno≈õciowe</strong><br>
                            <small id="count-occasional">0</small>
                        </div>
                        <div class="vacation-type-option" onclick="switchAbsenceTab('yearplan')" id="tab-yearplan">
                            <strong>üìÜ Plan roczny</strong><br>
                            <small id="count-yearplan">0</small>
                        </div>
                    </div>
                    
                    <h3>Wnioski do zatwierdzenia (<span id="pendingCount">0</span>)</h3>
                    <div class="vacation-requests-list" id="managerVacationRequests">
                        ≈Åadowanie wniosk√≥w...
                    </div>
                </div>
            </div>

           <!-- WIDOK ZARZƒÑDZANIA ZG≈ÅOSZENIAMI (kierownik) -->
            <div class="view" id="managerTicketsView">
                <button class="back-button" onclick="goBack()">‚Üê Powr√≥t do menu g≈Ç√≥wnego</button>
                <h2 class="view-title">üé´ ZarzƒÖdzanie zg≈Çoszeniami</h2>
                
                <div class="vacation-container">
                    <!-- FILTRY STATUS√ìW -->
                    <div class="vacation-type-selector" style="margin-bottom: 20px;">
                        <div class="vacation-type-option selected" onclick="filterTickets('all')" id="filter-all">
                            <strong>Wszystkie</strong><br>
                            <small id="count-all">0</small>
                        </div>
                        <div class="vacation-type-option" onclick="filterTickets('Nowe')" id="filter-nowe">
                            <strong>üîµ Nowe</strong><br>
                            <small id="count-nowe">0</small>
                        </div>
                        <div class="vacation-type-option" onclick="filterTickets('W trakcie')" id="filter-wtrakcie">
                            <strong>üü° W trakcie</strong><br>
                            <small id="count-wtrakcie">0</small>
                        </div>
                        <div class="vacation-type-option" onclick="filterTickets('Zamkniƒôte')" id="filter-zamkniete">
                            <strong>üü¢ Zamkniƒôte</strong><br>
                            <small id="count-zamkniete">0</small>
                        </div>
                        <div class="vacation-type-option" onclick="filterTickets('Odrzucone')" id="filter-odrzucone">
                            <strong>üî¥ Odrzucone</strong><br>
                            <small id="count-odrzucone">0</small>
                        </div>
                    </div>
                    
                    <!-- LISTA ZG≈ÅOSZE≈É -->
                    <div class="vacation-requests-list" id="managerTicketsList" style="max-height: 600px;">
                        ≈Åadowanie zg≈Çosze≈Ñ...
                    </div>
                </div>
            </div>

            <!-- WIDOK "MOJE ZG≈ÅOSZENIA" (pracownik) -->
            <div class="view" id="myTicketsView">
                <button class="back-button" onclick="goBack()">‚Üê Powr√≥t do menu g≈Ç√≥wnego</button>
                <h2 class="view-title">üé´ Moje zg≈Çoszenia</h2>
                
                <div class="vacation-container">
                    <!-- FILTRY STATUS√ìW -->
                    <div class="vacation-type-selector" style="margin-bottom: 20px;">
                        <div class="vacation-type-option selected" onclick="filterMyTickets('all')" id="my-filter-all">
                            <strong>Wszystkie</strong><br>
                            <small id="my-count-all">0</small>
                        </div>
                        <div class="vacation-type-option" onclick="filterMyTickets('Nowe')" id="my-filter-nowe">
                            <strong>üîµ Nowe</strong><br>
                            <small id="my-count-nowe">0</small>
                        </div>
                        <div class="vacation-type-option" onclick="filterMyTickets('W trakcie')" id="my-filter-wtrakcie">
                            <strong>üü° W trakcie</strong><br>
                            <small id="my-count-wtrakcie">0</small>
                        </div>
                        <div class="vacation-type-option" onclick="filterMyTickets('Zamkniƒôte')" id="my-filter-zamkniete">
                            <strong>üü¢ Zamkniƒôte</strong><br>
                            <small id="my-count-zamkniete">0</small>
                        </div>
                        <div class="vacation-type-option" onclick="filterMyTickets('Odrzucone')" id="my-filter-odrzucone">
                            <strong>üî¥ Odrzucone</strong><br>
                            <small id="my-count-odrzucone">0</small>
                        </div>
                    </div>
                    
                    <!-- LISTA MOICH ZG≈ÅOSZE≈É -->
                    <div class="vacation-requests-list" id="myTicketsList" style="max-height: 600px;">
                        ≈Åadowanie zg≈Çosze≈Ñ...
                    </div>
                </div>
            </div>

        </div> <!-- Koniec view-container -->
    </div> <!-- Koniec main-container -->

    <!-- MODAL NIEODCZYTANYCH ODPOWIEDZI (dla pracownika) -->
    <div class="confirmation-overlay" id="unreadTicketsModal">
        <div class="confirmation-modal">
            <div class="confirmation-header" style="background: #9c27b0;">
                üîî MASZ NOWE ODPOWIEDZI!
            </div>
            <div class="confirmation-content" style="background: #9c27b0;">
                <div style="font-size: 20px; margin: 20px 0;">
                    <strong id="unreadTicketsUserName">Pracownik</strong>, 
                    masz <strong id="unreadTicketsCount">0</strong> nieprzeczytanych odpowiedzi od kierownika!
                </div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin: 15px 0;">
                    Twoje zg≈Çoszenia zosta≈Çy rozpatrzone
                </div>
            </div>
            <div class="confirmation-buttons" style="background: #9c27b0;">
                <button class="confirmation-btn" onclick="showMyTicketsView()" style="background: #4a90e2;">
                    üì¨ Zobacz teraz
                </button>
                <button class="confirmation-btn" onclick="closeUnreadTicketsModal()" style="background: #6c757d;">
                    ‚è≠Ô∏è P√≥≈∫niej
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL KRYTYCZNYCH TICKET√ìW (dla kierownika) -->
    <div class="confirmation-overlay" id="criticalTicketsModal">
        <div class="confirmation-modal">
            <div class="confirmation-header" style="background: #dc3545;">
                üÜò UWAGA! KRYTYCZNE ZG≈ÅOSZENIE!
            </div>
            <div class="confirmation-content" style="background: #dc3545;">
                <div id="criticalTicketDetails" style="font-size: 16px; margin: 20px 0;">
                    <!-- Szczeg√≥≈Çy wype≈Çniane dynamicznie -->
                </div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin: 15px 0;">
                    Wymaga natychmiastowej reakcji!
                </div>
            </div>
            <div class="confirmation-buttons" style="background: #dc3545;">
                <button class="confirmation-btn" onclick="showManagerTicketsView()" style="background: #ffc107; color: #000;">
                    üîß Obs≈Çu≈º teraz
                </button>
                <button class="confirmation-btn" onclick="closeCriticalTicketsModal()" style="background: #6c757d;">
                    ‚è≠Ô∏è Panel operatora
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL SZCZEG√ì≈Å√ìW ZG≈ÅOSZENIA -->
    <div class="confirmation-overlay" id="ticketDetailsModal">
        <div class="confirmation-modal" style="max-width: 800px;">
            <div class="confirmation-header" style="background: #9c27b0;">
                üé´ Szczeg√≥≈Çy zg≈Çoszenia
            </div>
            <div style="background: white; padding: 30px; max-height: 70vh; overflow-y: auto;">
                <div id="ticketDetailsContent">
                    <!-- Wype≈Çniane dynamicznie -->
                </div>
                
                <!-- POLE KOMENTARZA -->
                <div style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">Tw√≥j komentarz:</label>
                    <textarea id="managerCommentInput" rows="4" 
                              placeholder="Dodaj komentarz do zg≈Çoszenia..." 
                              style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;"></textarea>
                </div>
                
                <!-- PRZYCISKI AKCJI -->
                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                    <button onclick="changeTicketStatus('W trakcie')" 
                            class="manager-btn" 
                            style="background: #ffc107; color: #000; padding: 12px 20px; flex: 1; min-width: 150px;">
                        üü° We≈∫ w trakcie
                    </button>
                    <button onclick="changeTicketStatus('Zamkniƒôte')" 
                            class="manager-btn approve" 
                            style="padding: 12px 20px; flex: 1; min-width: 150px;">
                        ‚úÖ Zamknij
                    </button>
                    <button onclick="changeTicketStatus('Odrzucone')" 
                            class="manager-btn reject" 
                            style="padding: 12px 20px; flex: 1; min-width: 150px;">
                        ‚ùå Odrzuƒá
                    </button>
                    <button onclick="closeTicketDetailsModal()" 
                            class="manager-btn" 
                            style="background: #6c757d; color: white; padding: 12px 20px; flex: 1; min-width: 150px;">
                        üîô Wr√≥ƒá do listy
                    </button>
                </div>
            </div>
        </div>
    </div>

</div> <!-- koniec mainInterface -->

    <!-- MODAL POTWIERDZENIA -->
    <div class="confirmation-overlay" id="confirmationModal">
        <div class="confirmation-modal">
            <div class="confirmation-header" id="confirmationTitle">BRAWO!</div>
            <div class="confirmation-content">
                <div id="confirmationMessage">Operacja zosta≈Ça zapisana.</div>
                <div class="timestamp" id="confirmationTimestamp">czas: 2025-01-21 10:21:00</div>
                <div class="confirmation-blue-section" id="confirmationAction">Akcja</div>
                <div class="confirmation-message">
                    Je≈ºeli co≈õ posz≈Ço nie tak, mo≈ºesz cofnƒÖƒá operacjƒô
                </div>
                <div class="confirmation-buttons">
                    <button class="confirmation-btn" id="confirmationOkBtn">OK</button>
                    <button class="confirmation-btn cancel" id="confirmationCancelBtn">COFNƒÑƒÜ OPERACJƒò</button>
                </div>
            </div>
        </div>
    </div>

    <!-- WSKA≈πNIK AUTOMATYCZNEGO OD≈öWIE≈ªANIA -->
    <div class="auto-refresh-indicator" id="autoRefreshIndicator">
        üîÑ Sprawdzam aktualizacje...
    </div>

<script>
  // ===== API (Cloudflare Pages -> Render) =====
const API_BASE = 'https://api.centrivo.pl';

function formatPlDateTime(ts){
  if (!ts) return '';
  const d = new Date(ts);
  if (isNaN(d.getTime())) return String(ts);
  return d.toLocaleString('pl-PL', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
}

function showConfirmationModalApi(payload) {
  const modal = document.getElementById('confirmationModal');
  const title = document.getElementById('confirmationTitle');
  const message = document.getElementById('confirmationMessage');
  const timestampEl = document.getElementById('confirmationTimestamp');
  const actionEl = document.getElementById('confirmationAction');

  if (!modal || !title || !message || !timestampEl || !actionEl) return;

  const who =
    payload?.name ||
    payload?.employeeName ||
    payload?.employeeId ||
    payload?.user?.login ||
    payload?.user ||
    payload?.login ||
    'OK';

  const rawAction = payload?.action || payload?.type || payload?.event || payload?.lastAction || 'scan';
  const actionKey = String(rawAction).trim().toUpperCase();


  const humanActionMap = {
    // kody z API / arkusza
    'ENTRY': 'Wchodzƒô',
    'EXIT': 'Wychodzƒô z pracy',
    'BREAK_START': 'Wychodzƒô na przerwƒô',
    'BREAK_END': 'Wracam z przerwy',
  };

  const tsRaw = payload?.timestamp || payload?.time || payload?.dateTime || '';
  const ts = formatPlDateTime(tsRaw);

  title.textContent = `BRAWO ${String(who).toUpperCase()}!`;
  message.textContent = payload?.message || 'Zapisano.';
  timestampEl.textContent = ts ? `czas: ${ts}` : 'czas: -';
  actionEl.textContent = humanActionMap[actionKey] || String(rawAction);
  modal.setAttribute('data-action', String(actionKey));
  modal.classList.add('show');
}

async function apiScan(code){
  const r = await fetch(`${API_BASE}/scan`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ code })
  });

  const data = await r.json().catch(() => ({}));
  if (!r.ok) {
    throw new Error(data?.message || `HTTP ${r.status}`);
  }
  return data;
}

    async function apiScanIntent(intent, extra){
  const code = sessionStorage.getItem('currentEmployeeCode');

  if (!code) {
    throw new Error('Brak kodu pracownika. Zeskanuj identyfikator jeszcze raz.');
  }

  const payload = {
    code,
    intent,
    ...(extra && typeof extra === 'object' ? extra : {})
  };

  const r = await fetch(`${API_BASE}/scan`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const data = await r.json().catch(() => ({}));
  if (!r.ok) {
    throw new Error(data?.message || `HTTP ${r.status}`);
  }
  return data;
}

    async function apiGetUnreadAnnouncements(login){
  const r = await fetch(`${API_BASE}/announcements/unread`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ login })
  });

  const data = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(data?.message || `HTTP ${r.status}`);

  return data.announcements || [];
}

    async function apiLookupEmployeeByCode(code){
  const r = await fetch(`${API_BASE}/employee/by-code`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ code })
  });

  const data = await r.json().catch(() => ({}));
  if (!r.ok) {
    throw new Error(data?.message || `HTTP ${r.status}`);
  }
  return data;
}

async function apiMarkAnnouncementAsRead(id, login){
  const r = await fetch(`${API_BASE}/announcements/mark-read`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, login })
  });

  const data = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(data?.message || `HTTP ${r.status}`);

  return data;
}

    async function apiListAnnouncementsForManager(login){
  const r = await fetch(`${API_BASE}/announcements/list`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ login })
  });

  const data = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(data?.message || `HTTP ${r.status}`);

  return data.announcements || [];
}

    async function apiAddTimeEntry(payload){
  const r = await fetch(`${API_BASE}/time-entry`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const data = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(data?.message || `HTTP ${r.status}`);
  return data;
}

    async function apiGetEmployeesForRecipients(login){
  const r = await fetch(`${API_BASE}/announcements/employees`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ login })
  });
  const data = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(data?.message || `HTTP ${r.status}`);
  return data.employees || [];
}

async function apiCreateAnnouncement(login, typ, tresc, dataWaznosci, odbiorcy, autor){
  const r = await fetch(`${API_BASE}/announcements/create`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ login, typ, tresc, dataWaznosci, odbiorcy, autor })
  });
  const data = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(data?.message || `HTTP ${r.status}`);
  return data;
}

  // ===== OPTYMALIZACJA - NATYCHMIASTOWA REAKCJA UI =====

/**
 * Wykonuje akcjƒô z natychmiastowƒÖ reakcjƒÖ UI
 * @param {Function} uiAction - Co zrobiƒá NATYCHMIAST (zmiana widoku, notyfikacja)
 * @param {Function} backendAction - Co zrobiƒá W TLE (zapis do arkusza)
 * @param {Function} onError - Co zrobiƒá gdy backend zwr√≥ci b≈ÇƒÖd (opcjonalne)
 */
function openDashboard() {
  google.script.run
    .withSuccessHandler(function(url) {
      window.open(url + '?page=dashboard', '_blank');
    })
    .getAppUrl();
}

function liveAutoFitModal(rowsCount){
  // WY≈ÅƒÑCZONE ‚Äì modal ma sta≈Çy rozmiar, a przewija siƒô tylko lista
  const modal = document.querySelector('#workforceLiveModal .who-is-working-modal');
  const list = document.getElementById('workforceLiveList');
  if (modal) {
    modal.style.removeProperty('height');
    modal.style.removeProperty('max-height');
  }
  if (list) {
    list.style.removeProperty('max-height');
    list.style.removeProperty('padding-bottom');
  }
  return;
}

function closeWorkforceLiveModal(){
  document.getElementById('workforceLiveModal').classList.remove('show');
  document.body.classList.remove('modal-open');

  if (liveRefreshTimer) {
    clearInterval(liveRefreshTimer);
    liveRefreshTimer = null;
  }
}

let liveAllRowsCache = [];
let liveFilter = 'ALL';
let liveSelectedLogin = null;
let liveRefreshTimer = null;

// domy≈õlny widok szczeg√≥≈Ç√≥w
function liveResetDetails(){
  const details = document.getElementById('workforceLiveDetails');
  if (!details) return;

  details.innerHTML = `
    <div style="padding:12px; border-radius:12px; background: rgba(0,0,0,0.18); opacity:0.9;">
      Kliknij pracownika z listy po lewej.
    </div>
  `;
}

function liveSetFilter(filter){
  liveFilter = (liveFilter === filter) ? 'ALL' : filter;
  liveRender();
  liveUpdateTileActive();
}

function liveUpdateTileActive(){
  const setActive = (id, active) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle('live-tile-active', !!active);
  };

  setActive('liveTileWorking', liveFilter === 'WORKING');
  setActive('liveTileBreak',   liveFilter === 'BREAK');
  setActive('liveTileAlerts',  liveFilter === 'ALERTS');
  setActive('liveTileAbsent',  liveFilter === 'ABSENT');
}

function openWorkforceLiveModal(){
  document.body.classList.add('modal-open');
  document.getElementById('workforceLiveModal').classList.add('show');

  // przy otwarciu: szczeg√≥≈Çy puste i brak zaznaczenia
  liveSelectedLogin = null;
  liveResetDetails();

  refreshWorkforceLiveUI();
  liveUpdateTileActive();
    
  if (liveRefreshTimer) clearInterval(liveRefreshTimer);
  liveRefreshTimer = setInterval(refreshWorkforceLiveUI, 300000);

}

function refreshWorkforceLiveUI(){
  const list = document.getElementById('workforceLiveList');
  if (list) list.innerHTML = '<div style="padding:18px; text-align:center; opacity:.8;">‚è≥ ≈Åadowanie.</div>';

  const login = sessionStorage.getItem('loggedInUser') || '';

  fetch(`${API_BASE}/workforce/live-snapshot`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ login })
  })
  .then(r => r.json().then(data => ({ ok: r.ok, data })))
  .then(({ ok, data }) => {
    if (!ok || !data || !data.success) {
      if (list) list.innerHTML = '<div style="padding:18px; text-align:center; color:#ef4444;">‚ùå B≈ÇƒÖd danych</div>';
      return;
    }

    liveAllRowsCache = Array.isArray(data.rows) ? data.rows : [];

    liveRender();
    liveUpdateTileActive();

    if (liveSelectedLogin && liveAllRowsCache.some(x => x.login === liveSelectedLogin)) {
      liveShowDetails(liveSelectedLogin);
    }
  })
  .catch(err => {
    if (list) list.innerHTML = '<div style="padding:18px; text-align:center; color:#ef4444;">‚ùå B≈ÇƒÖd: ' + (err && err.message ? err.message : err) + '</div>';
  });
}

function liveRender(){
  const cntWorking = liveAllRowsCache.filter(r => r.status === 'PRACUJE').length;
  const cntBreak   = liveAllRowsCache.filter(r => r.status === 'PRZERWA').length;
  const cntAbsent  = liveAllRowsCache.filter(r => r.alertType === 'ABSENT').length;
  const cntAlerts  = liveAllRowsCache.filter(r => r.alertType === 'LATE' || r.alertType === 'ABSENT').length;

  const elW = document.getElementById('liveCntWorking');
  const elB = document.getElementById('liveCntBreak');
  const elA = document.getElementById('liveCntAbsent');
  const elAl = document.getElementById('liveCntAlerts');

  if (elW) elW.textContent = String(cntWorking);
  if (elB) elB.textContent = String(cntBreak);
  if (elA) elA.textContent = String(cntAbsent);
  if (elAl) elAl.textContent = String(cntAlerts);

  // baza do filtrowania listy
  let rows = liveAllRowsCache.slice();

  // Filtrujemy zawsze wed≈Çug liveFilter (≈ºeby "NIEOBECNI" nie ≈Çapa≈Ç sp√≥≈∫nie≈Ñ)
if (liveFilter === 'WORKING') rows = rows.filter(r => r.status === 'PRACUJE');
if (liveFilter === 'BREAK')   rows = rows.filter(r => r.status === 'PRZERWA');
if (liveFilter === 'ABSENT')  rows = rows.filter(r => r.alertType === 'ABSENT');
if (liveFilter === 'ALERTS')  rows = rows.filter(r => r.alertType === 'LATE' || r.alertType === 'ABSENT');

// Checkbox "poka≈º tylko alerty" dzia≈Ça tylko jako skr√≥t do ALERTS (ustawia liveFilter w liveApplyOnlyAlerts),
// wiƒôc tutaj ju≈º nic dodatkowo nie dok≈Çadamy.

  // Lista
  const list = document.getElementById('workforceLiveList');
  if (!list) return;

  if (!rows.length){
    list.innerHTML = '<div style="padding:16px; opacity:0.9;">Brak pozycji do wy≈õwietlenia.</div>';
    return;
  }

  let html = '';
  rows.forEach(r => {
    const bg =
      r.alertType === 'ABSENT' ? 'rgba(220, 38, 38, 0.22)' :
      r.alertType === 'LATE'   ? 'rgba(245, 158, 11, 0.22)' :
      'rgba(0,0,0,0.12)';

    const chipBg =
      r.status === 'PRACUJE' ? 'rgba(34,197,94,0.22)' :
      r.status === 'PRZERWA' ? 'rgba(234,179,8,0.22)' :
      (r.status || '').startsWith('START') ? 'rgba(59,130,246,0.22)' :
      'rgba(148,163,184,0.18)';

    html += `
      <div onclick="liveShowDetails('${r.login.replace(/'/g, "\\'")}')"
           style="cursor:pointer; padding:10px 12px; display:grid; grid-template-columns: 1.4fr 1fr 0.9fr 0.9fr 1fr; gap:10px; border-top:1px solid rgba(255,255,255,0.08); background:${bg};">
        <div style="font-weight:900;">${r.name}</div>
        <div style="opacity:0.9;">${r.dept}</div>
        <div style="opacity:0.9;">${r.shift}</div>
        <div>
          <span style="display:inline-block; padding:4px 10px; border-radius:999px; background:${chipBg}; font-weight:900; font-size:12px;">
            ${r.status}
          </span>
        </div>
        <div style="opacity:0.9;">${r.startInfo}</div>
      </div>
    `;
  });

  list.innerHTML = html;
}

function liveShowDetails(login){
  const r = liveAllRowsCache.find(x => x.login === login);
  if (!r) return;

  liveSelectedLogin = login;

  const details = document.getElementById('workforceLiveDetails');
  if (!details) return;

  const lateLine = (r.alertType === 'LATE' && Number(r.lateMinutes || 0) > 0)
    ? `<div><strong>Sp√≥≈∫nienie:</strong> ${Number(r.lateMinutes)} min</div>`
    : '';

  const absentLine = (r.alertType === 'ABSENT')
    ? `<div><strong>Alert:</strong> ‚òÅ Nieobecno≈õƒá</div>`
    : '';

  details.innerHTML = `
    <div style="padding:12px; border-radius:12px; background: rgba(0,0,0,0.18);">
      <div style="font-size:18px; font-weight:1000; margin-bottom:10px;">${r.name}</div>

      <div style="display:grid; gap:8px;">
        <div><strong>Aktualny dzia≈Ç:</strong> ${r.dept}</div>
        <div><strong>Zmiana:</strong> ${r.shift}</div>
        <div><strong>Status:</strong> ${r.status}</div>
        ${lateLine}
        ${absentLine}
        ${(() => {
          let info = r.startInfo || '';

          // usu≈Ñ ko≈Ñc√≥wkƒô "‚Ä¢ Praca: ...", je≈õli istnieje
          info = info.replace(/\s*‚Ä¢\s*Praca:\s*\d+h\s*\d+m/, '');

          return `<div><strong>${info.startsWith('Start') ? 'Od kiedy pracuje:' : 'Info:'}</strong> ${info}</div>`;
        })()}
        ${r.workInfo ? `<div><strong>Czas pracy dzi≈õ:</strong> ${r.workInfo}</div>` : ''}
        <div><strong>Czas przerwy dzi≈õ:</strong> ${r.breakInfo}</div>
        <div style="opacity:0.85;"><strong>Login:</strong> ${r.login}</div>
      </div>
    </div>
  `;
}

// ===== PLANOWANIE OBSADY (ETAP 1/2) =====
function openWorkforcePlanner(){
  const modal = document.getElementById('workforcePlannerModal');
  if (!modal) return;

  modal.style.display = 'flex';

  if (document.activeElement) document.activeElement.blur();

  setTimeout(() => {
    if (typeof wfSetMondayToCurrentWeek === 'function') wfSetMondayToCurrentWeek();
    if (typeof wfApplyMode === 'function') wfApplyMode();

    // najpierw do≈Çaduj dzia≈Çy, potem pobierz dane (≈ºeby fetch bra≈Ç w≈Ça≈õciwy wyb√≥r)
    if (typeof wfLoadDeptOptions === 'function') {
      wfLoadDeptOptions(() => {
        if (typeof wfFetchFromSystem === 'function') wfFetchFromSystem(true);
      });
    } else {
      if (typeof wfFetchFromSystem === 'function') wfFetchFromSystem(true);
    }

    const first = document.getElementById('wf_weeklyOrders');
    if (first) {
      first.focus();
      first.select();
    }

    wfBindLive();
    wfUpdateIndicators();
    wfRecalc();
  }, 50);
}

function closeWorkforcePlanner(){
  const modal = document.getElementById('workforcePlannerModal');
  if (!modal) return;
  modal.style.display = 'none';

  // oddaj focus na pole skanu (podstaw ID swojego inputa je≈õli inne)
  setTimeout(() => {
    const scan = document.getElementById('codeInput'); // <- je≈õli u Ciebie ma inne id, podmie≈Ñ
    if (scan) scan.focus();
  }, 50);
}

function wfGetNumber(id){
  const el = document.getElementById(id);
  if (!el) return 0;
  const v = parseFloat(String(el.value).replace(',', '.'));
  return Number.isFinite(v) ? v : 0;
}

// ===== PLANOWANIE OBSADY (ETAP 1.2 ‚Äì godziny + live walidacja) =====
let wfLiveBound = false;

function wfClamp(n, min, max){
  if (!Number.isFinite(n)) return min;
  return Math.min(max, Math.max(min, n));
}

function wfHours(n){
  // czytelnie, bez przesady z miejscami po przecinku
  return (Math.round(n * 10) / 10).toFixed(1);
}

// ===== AUTO DOB√ìR GODZIN (ETAP 1.3) =====
const WF_MAX_DAY_HOURS = 11;
const WF_MAX_WEEK_HOURS = 40;
const WF_STEP = 0.5;        // krok planowania
const WF_DAILY_TOL = 1.0;   // tolerancja dzienna (¬±1h)

function wfRoundStep(x, step){
  if (!Number.isFinite(x)) return 0;
  return Math.round(x / step) * step;
}

function wfDayReqHours(weeklyOrders, productivity, percent){
  const dayOrders = Math.round(weeklyOrders * (percent / 100));
  return dayOrders / productivity; // wymagane roboczogodziny
}

function wfSetHoursInputsFromMap(h){
  const set = (id, val) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = wfHours(val || 0);
  };
  set('wf_h_mon', h.Pon);
  set('wf_h_tue', h.Wt);
  set('wf_h_wed', h['≈ör']);
  set('wf_h_thu', h.Czw);
  set('wf_h_fri', h.Pt);
}

function wfAutoComputeHours(weeklyOrders, productivity, p, a){
  const days = ['Pon','Wt','≈ör','Czw','Pt'];

  const req = {};
  const h = {};
  const diff = {};

  // START: ustawiamy godziny blisko "idealnych"
  days.forEach(day => {
    const reqH = wfDayReqHours(weeklyOrders, productivity, p[day] || 0);
    req[day] = reqH;

    const av = Math.max(0, a[day] || 0);
    if (av <= 0){
      h[day] = 0;
      diff[day] = -reqH;
      return;
    }

    let hh = wfRoundStep(reqH / av, WF_STEP);
    hh = wfClamp(hh, 0, WF_MAX_DAY_HOURS);
    h[day] = hh;

    diff[day] = (av * hh) - reqH;
  });

  const sumWeek = () => days.reduce((s,d)=>s+(h[d]||0),0);

  // 1) Je≈õli przekraczamy 40h tygodniowo ‚Üí MUSIMY dociƒÖƒá do 40
while (sumWeek() > WF_MAX_WEEK_HOURS + 1e-9){
  let bestDay = null;
  let bestSlack = -Infinity;

  // (A) najpierw tnij tam gdzie jest zapas (najmniej boli)
  days.forEach(day => {
    const av = Math.max(0, a[day] || 0);
    if (av <= 0) return;
    if ((h[day] || 0) - WF_STEP < 0) return;

    const slack = (diff[day] || 0) + WF_DAILY_TOL; // zapas ponad tolerancjƒô
    if (slack > bestSlack && slack > 0.0001){
      bestSlack = slack;
      bestDay = day;
    }
  });

  // (B) fallback: jak nie ma zapasu, to i tak tnij ‚Äì limit 40 jest twardy
  if (!bestDay){
    let maxH = -Infinity;
    days.forEach(day => {
      const av = Math.max(0, a[day] || 0);
      if (av <= 0) return;
      if ((h[day] || 0) - WF_STEP < 0) return;

      if ((h[day] || 0) > maxH){
        maxH = (h[day] || 0);
        bestDay = day;
      }
    });
  }

  if (!bestDay) break; // ju≈º nic nie da siƒô uciƒÖƒá

  const av = Math.max(0, a[bestDay] || 0);
  h[bestDay] = wfRoundStep((h[bestDay] || 0) - WF_STEP, WF_STEP);
  diff[bestDay] = (av * h[bestDay]) - req[bestDay];
}

  // 2) Je≈õli mamy braki dzienne i jeszcze bud≈ºet tygodniowy ‚Üí dok≈Çadamy tam gdzie najwiƒôkszy brak
  while (sumWeek() + WF_STEP <= WF_MAX_WEEK_HOURS + 1e-9){
    let worstDay = null;
    let worstDef = 0;

    days.forEach(day => {
      const av = Math.max(0, a[day] || 0);
      if (av <= 0) return;
      if ((h[day] || 0) + WF_STEP > WF_MAX_DAY_HOURS + 1e-9) return;

      const def = -(diff[day] || 0); // brak jako dodatnia liczba
      if (def > worstDef + 1e-9){
        worstDef = def;
        worstDay = day;
      }
    });

    if (!worstDay) break;
    if (worstDef <= WF_DAILY_TOL + 1e-9) break; // ju≈º w tolerancji ¬±1h

    const av = Math.max(0, a[worstDay] || 0);
    h[worstDay] = wfRoundStep((h[worstDay] || 0) + WF_STEP, WF_STEP);
    diff[worstDay] = (av * h[worstDay]) - req[worstDay];
  }

  // To co zostanie na minus po tym etapie = realny sygna≈Ç "agencja jako ostateczno≈õƒá"
  return {
    Pon: h.Pon, Wt: h.Wt, '≈ör': h['≈ör'], Czw: h.Czw, Pt: h.Pt
  };
}

function wfGetPercentMap(){
  return {
    'Pon': wfGetNumber('wf_p_mon'),
    'Wt': wfGetNumber('wf_p_tue'),
    '≈ör': wfGetNumber('wf_p_wed'),
    'Czw': wfGetNumber('wf_p_thu'),
    'Pt': wfGetNumber('wf_p_fri')
  };
}

function wfGetHoursMap(){
  return {
    'Pon': wfClamp(wfGetNumber('wf_h_mon'), 0, 11),
    'Wt': wfClamp(wfGetNumber('wf_h_tue'), 0, 11),
    '≈ör': wfClamp(wfGetNumber('wf_h_wed'), 0, 11),
    'Czw': wfClamp(wfGetNumber('wf_h_thu'), 0, 11),
    'Pt': wfClamp(wfGetNumber('wf_h_fri'), 0, 11)
  };
}

function wfGetAvailMap(){
  return {
    'Pon': Math.max(0, Math.floor(wfGetNumber('wf_av_mon'))),
    'Wt': Math.max(0, Math.floor(wfGetNumber('wf_av_tue'))),
    '≈ör': Math.max(0, Math.floor(wfGetNumber('wf_av_wed'))),
    'Czw': Math.max(0, Math.floor(wfGetNumber('wf_av_thu'))),
    'Pt': Math.max(0, Math.floor(wfGetNumber('wf_av_fri')))
  };
}

//const WF_DEPT_NAME = 'ALL';

function wfGetMondayISOFromInput(){
  const el = document.getElementById('wf_weekMonday');
  if (!el || !el.value) return null;
  return el.value; // yyyy-mm-dd
}

function wfSetMondayToCurrentWeek(){
  const el = document.getElementById('wf_weekMonday');
  if (!el) return;

  const today = new Date();
  today.setHours(0,0,0,0);

  const day = today.getDay(); // nd=0, pon=1
  const diffToMonday = (day === 0) ? 6 : (day - 1);

  const monday = new Date(today);
  monday.setDate(monday.getDate() - diffToMonday);

  const yyyy = monday.getFullYear();
  const mm = String(monday.getMonth() + 1).padStart(2,'0');
  const dd = String(monday.getDate()).padStart(2,'0');
  el.value = `${yyyy}-${mm}-${dd}`;
}

function wfApplyMode(){
  const auto = document.getElementById('wf_autoMode')?.checked;

  // AUTO: blokujemy dostƒôpno≈õƒá i godziny
  // MANUAL: odblokowujemy oba (≈ºeby≈õ m√≥g≈Ç wpisaƒá rƒôcznie)
  const ids = [
    'wf_av_mon','wf_av_tue','wf_av_wed','wf_av_thu','wf_av_fri',
    'wf_h_mon','wf_h_tue','wf_h_wed','wf_h_thu','wf_h_fri'
  ];

  ids.forEach(id => {
    const inp = document.getElementById(id);
    if (!inp) return;

    if (auto){
      inp.setAttribute('readonly','readonly');
      inp.style.opacity = '0.9';
      inp.style.cursor = 'not-allowed';
    } else {
      inp.removeAttribute('readonly');
      inp.style.opacity = '1';
      inp.style.cursor = 'text';
    }
  });

  // Pobieranie z systemu ma sens g≈Ç√≥wnie w AUTO
  const fetchBtn = document.getElementById('wf_fetchBtn');
  if (fetchBtn){
    fetchBtn.disabled = !auto;
    fetchBtn.style.opacity = fetchBtn.disabled ? '0.55' : '1';
    fetchBtn.style.cursor = fetchBtn.disabled ? 'not-allowed' : 'pointer';
  }

  wfUpdateIndicators();
}

function wfRunAutoHoursOnly(){
  const auto = !!document.getElementById('wf_autoMode')?.checked;
  if (!auto) return;

  const weeklyOrders = Math.max(0, wfGetNumber('wf_weeklyOrders'));
  const productivity = Math.max(1, wfGetNumber('wf_productivity'));

  const p = wfGetPercentMap();
  const a = wfGetAvailMap();

  const autoH = wfAutoComputeHours(weeklyOrders, productivity, p, a);
  wfSetHoursInputsFromMap(autoH);

  // po podmianie godzin od≈õwie≈º liczniki i stan przycisku
  wfUpdateIndicators();
}

function wfSetAvailFieldsFromDays(days, useConservative){
  const map = {
    'Pon': 'wf_av_mon',
    'Wto': 'wf_av_tue',
    '≈öro': 'wf_av_wed',
    'Czw': 'wf_av_thu',
    'PiƒÖ': 'wf_av_fri'
  };

  Object.keys(map).forEach(k => {
    const id = map[k];
    const inp = document.getElementById(id);
    if (!inp) return;

    const d = days?.[k];
    if (!d) return;

    const v = useConservative ? d.availableConservative : d.availableConfirmed;
    inp.value = Number.isFinite(v) ? v : 0;
  });

  wfRecalc();
}

function wfBuildInfo(result, useConservative){
  const info = document.getElementById('wf_sysInfo');
  if (!info) return;

  const d = result?.days;
  if (!d){
    info.innerHTML = '';
    return;
  }

  const lines = ['Pon','Wto','≈öro','Czw','PiƒÖ'].map(day => {
    const x = d[day];
    if (!x) return '';

    const absent = useConservative ? x.absentConservative : x.absentConfirmed;

    const vb = x.absentBreakdown || {};
    const pb = x.pendingBreakdown || {};

    const vac = vb.vac || 0;
    const l4 = vb.l4 || 0;
    const dayoff = vb.dayoff || 0;
    const occ = vb.occ || 0;

    const pendingTotal = useConservative ? (pb.totalPending || 0) : 0;
    const pendingTxt = useConservative ? `; oczekujƒÖce ${pendingTotal}` : '';

    return `${day}: nieobecno≈õci ${absent} (urlop ${vac}; L4 ${l4}; wolne ${dayoff}; okolicz ${occ}${pendingTxt})`;
  }).filter(Boolean);

  info.innerHTML =
    `<div style="font-weight:800; margin-bottom:4px;">
      ≈πr√≥d≈Ço: arkusz (dzia≈Ç: ${result.deptName}, razem: ${result.totals?.totalEmployees || 0})
     </div>` +
    lines.map(t => `<div>‚Ä¢ ${t}</div>`).join('');
}

function wfFetchFromSystem(silent=false){
  const auto = document.getElementById('wf_autoMode')?.checked;
  if (!auto) return; // w manual nie nadpisujemy

  const mondayISO = wfGetMondayISOFromInput();
  if (!mondayISO) {
    if (!silent) alert('Wybierz poniedzia≈Çek tygodnia.');
    return;
  }

  const includePending = document.getElementById('wf_includePending')?.checked;
  const useConservative = !!includePending;

  // NOWE: dzia≈Ç z dropdownu (domy≈õlnie ALL)
  const dept = document.getElementById('wf_deptSelect')?.value || 'ALL';

  const btn = document.getElementById('wf_fetchBtn');
  if (btn){
    btn.disabled = true;
    btn.textContent = 'Pobieram...';
  }

  google.script.run
    .withSuccessHandler(function(res){
      wfSetAvailFieldsFromDays(res.days, useConservative);
      wfBuildInfo(res, useConservative);
      if (btn){
        btn.disabled = false;
        btn.textContent = 'Pobierz z systemu';
      }
    })
    .withFailureHandler(function(err){
      console.error(err);
      if (!silent) alert('B≈ÇƒÖd pobierania danych z systemu.');
      if (btn){
        btn.disabled = false;
        btn.textContent = 'Pobierz z systemu';
      }
    })
    .getWorkforceAvailabilityWeek(dept, mondayISO);
}

function wfLoadDeptOptions(callback){
  const sel = document.getElementById('wf_deptSelect');
  if (!sel) {
    if (callback) callback();
    return;
  }

  const current = sel.value || 'ALL';

  // tymczasowy stan
  sel.innerHTML = '<option value="ALL">Wszyscy (magazyn)</option>';
  sel.disabled = true;

  google.script.run
    .withSuccessHandler(function(list){
      // list spodziewane: ["ALL", "Kompletacja...", ...]
      const arr = Array.isArray(list) && list.length ? list : ['ALL'];

      sel.innerHTML = '';
      arr.forEach((d) => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = (d === 'ALL') ? 'Wszyscy (magazyn)' : d;
        sel.appendChild(opt);
      });

      // przywr√≥ƒá poprzedni wyb√≥r (je≈õli dalej istnieje)
      const exists = Array.from(sel.options).some(o => o.value === current);
      sel.value = exists ? current : 'ALL';

      sel.disabled = false;

      if (callback) callback();
    })
    .withFailureHandler(function(err){
      console.error(err);
      sel.value = 'ALL';
      sel.disabled = false;
      if (callback) callback();
    })
    .getWorkforceDepartments();
}

function wfUpdateIndicators(){
  const p = wfGetPercentMap();
  const h = wfGetHoursMap();

  const percentSum = Object.values(p).reduce((a,b)=>a+b,0);
  const hoursSum = Object.values(h).reduce((a,b)=>a+b,0);

  const percentInfo = document.getElementById('wf_percentInfo');
  if (percentInfo){
    const ok = (Math.round(percentSum * 100) / 100) === 100;
    percentInfo.innerHTML = ok
      ? `‚úì Suma procent√≥w: <b>${percentSum}</b>`
      : `‚ö† Suma procent√≥w: <b>${percentSum}</b> (powinno byƒá 100)`;
  }

  const hoursInfo = document.getElementById('wf_hoursInfo');
  if (hoursInfo){
    const ok = hoursSum <= 40;
    hoursInfo.innerHTML = ok
      ? `‚úì Suma godzin tygodniowo: <b>${wfHours(hoursSum)}</b> / 40`
      : `‚ö† Suma godzin tygodniowo: <b>${wfHours(hoursSum)}</b> / 40 (przekroczone!)`;
  }

  const btn = document.getElementById('wf_calcBtn');
  if (btn){
    const percentOk = (Math.round(percentSum * 100) / 100) === 100;
    const hoursOk = hoursSum <= 40;
    btn.disabled = !(percentOk && hoursOk);
    btn.style.opacity = btn.disabled ? '0.55' : '1';
    btn.style.cursor = btn.disabled ? 'not-allowed' : 'pointer';
  }
}

function wfBindLive(){
  if (wfLiveBound) return;
  wfLiveBound = true;

  const ids = [
    'wf_p_mon','wf_p_tue','wf_p_wed','wf_p_thu','wf_p_fri',
    'wf_h_mon','wf_h_tue','wf_h_wed','wf_h_thu','wf_h_fri'
  ];

  ids.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', wfUpdateIndicators);
    el.addEventListener('change', wfUpdateIndicators);
    el.addEventListener('blur', wfUpdateIndicators);
  });
}

function wfRecalc(){
  wfBindLive();
  wfUpdateIndicators();

  const weeklyOrders = Math.max(0, wfGetNumber('wf_weeklyOrders'));
  const productivity = Math.max(1, wfGetNumber('wf_productivity'));

  const p = wfGetPercentMap();
  const a = wfGetAvailMap();

  // AUTO: najpierw dobierz godziny/os, dopiero potem licz tabelƒô
  const auto = !!document.getElementById('wf_autoMode')?.checked;
  if (auto){
    const autoH = wfAutoComputeHours(weeklyOrders, productivity, p, a);
    wfSetHoursInputsFromMap(autoH);
  }

  const h = wfGetHoursMap();

  // od≈õwie≈º liczniki po ewentualnym AUTO ustawieniu godzin
  wfUpdateIndicators();

  const percentSum = Object.values(p).reduce((x,y)=>x+y,0);
  const hoursSum = Object.values(h).reduce((x,y)=>x+y,0);

  // twarde zasady
  if ((Math.round(percentSum * 100) / 100) !== 100) {
    const summary = document.getElementById('wf_summary');
    if (summary) summary.innerHTML = `‚ö† Popraw rozk≈Çad procent√≥w (musi byƒá 100)`;
    return;
  }
  if (hoursSum > 40) {
    const summary = document.getElementById('wf_summary');
    if (summary) summary.innerHTML = `‚ö† Popraw godziny (suma tygodnia max 40)`;
    return;
  }

  const tbody = document.getElementById('wf_resultBody');
  if (!tbody) return;
  tbody.innerHTML = '';

  let shortageHours = 0;
  let surplusHours = 0;
  let balanceHours = 0;

  const rowsForAlerts = [];
  const dayBalances = {}; // per-dzie≈Ñ do agencji

  Object.keys(p).forEach(day => {
    const dayOrders = Math.round(weeklyOrders * (p[day] / 100));

    const requiredHours = dayOrders / productivity;
    const availableHours = a[day] * h[day];
    const diffHours = availableHours - requiredHours;

    dayBalances[day] = diffHours;

    balanceHours += diffHours;
    if (diffHours < 0) shortageHours += Math.abs(diffHours);
    if (diffHours > 0) surplusHours += diffHours;

    const statusHtml = (diffHours >= 0)
      ? `<span class="workforce-badge-ok">OK</span>`
      : `<span class="workforce-badge-bad">BRAK</span>`;

    const diffText = (diffHours >= 0) ? `+${wfHours(diffHours)}` : `-${wfHours(Math.abs(diffHours))}`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><b>${day}</b></td>
      <td>${dayOrders}</td>
      <td>${wfHours(requiredHours)}</td>
      <td>${a[day]}</td>
      <td>${wfHours(h[day])}</td>
      <td>${wfHours(availableHours)}</td>
      <td><b>${diffText}</b></td>
      <td>${statusHtml}</td>
    `;

    tbody.appendChild(tr);
    rowsForAlerts.push({ day, diffHours });
  });

  const summary = document.getElementById('wf_summary');
  if (summary){
    if (balanceHours < 0) summary.innerHTML = `‚ö† Brak: <b>${wfHours(Math.abs(balanceHours))}h</b>`;
    else if (balanceHours > 0) summary.innerHTML = `‚úì Nadwy≈ºka: <b>${wfHours(balanceHours)}h</b>`;
    else summary.innerHTML = `‚úì Bilans: <b>${wfHours(0)}h</b>`;
  }

  const netShortage = Math.max(0, -balanceHours);
  const netSurplus  = Math.max(0,  balanceHours);

  wfLastCalc = {
    balanceHours: balanceHours,
    shortageHours: netShortage,
    surplusHours: netSurplus,
    dayBalances: dayBalances
  };

  wfCheckStaffingAlerts(rowsForAlerts);
}

function wfCheckStaffingAlerts(rows){
  const alerts = document.getElementById('wf_alerts');
  if (!alerts) return;

  alerts.innerHTML = '';

  if (!Array.isArray(rows) || !rows.length) return;

  const problems = rows
    .filter(r => r.diffHours < 0)
    .map(r => `‚Ä¢ ${r.day}: brakuje ${wfHours(Math.abs(r.diffHours))}h`);

  if (!problems.length) {
    alerts.innerHTML = `<div style="color:#16a34a;font-weight:800;">‚úî Obsada OK na ca≈Çy tydzie≈Ñ</div>`;
    return;
  }

  alerts.innerHTML = `
    <div style="color:#b91c1c;font-weight:900;margin-bottom:4px;">‚ö† Braki w obsadzie</div>
    ${problems.map(p => `<div>${p}</div>`).join('')}
  `;
}

// ===== PLANOWANIE OBSADY (ETAP 3) ‚Äî UI: zapis / wczytaj / kopiuj =====

let wfLastCalc = null;

function wfBuildPlanPayload(){
  const dept = document.getElementById('wf_deptSelect')?.value || 'ALL';
  const weekMonday = wfGetMondayISOFromInput();

  return {
    dept: dept,
    weekMonday: weekMonday,

    mode: (document.getElementById('wf_autoMode')?.checked ? 'AUTO' : 'MANUAL'),
    includePending: !!document.getElementById('wf_includePending')?.checked,

    weeklyOrders: Math.max(0, wfGetNumber('wf_weeklyOrders')),
    productivity: Math.max(1, wfGetNumber('wf_productivity')),

    percent: wfGetPercentMap(),
    hours: wfGetHoursMap(),
    avail: wfGetAvailMap(),

    balanceHours: wfLastCalc ? wfLastCalc.balanceHours : 0,
    shortageHours: wfLastCalc ? wfLastCalc.shortageHours : 0,
    surplusHours: wfLastCalc ? wfLastCalc.surplusHours : 0
  };
}

function wfToast(msg, ok){
  const el = document.getElementById('wf_sysInfo');
  if (!el) return;
  el.innerHTML = `<div style="font-weight:800; color:${ok ? '#16a34a' : '#b91c1c'}">${msg}</div>`;
}

function wfSaveSnapshot(){
  const weekMonday = wfGetMondayISOFromInput();
  if (!weekMonday) { wfToast('Ustaw najpierw tydzie≈Ñ (poniedzia≈Çek).', false); return; }
  if (!wfLastCalc) { wfToast('Najpierw kliknij ‚ÄûPrzelicz‚Äù.', false); return; }

  const payload = wfBuildPlanPayload();

  wfToast('‚è≥ Zapisujƒô plan...', true);

  google.script.run
    .withSuccessHandler(function(res){
      wfToast(`‚úÖ Zapisano (${res && res.action ? res.action : 'OK'})`, true);
    })
    .withFailureHandler(function(err){
      wfToast('‚ùå B≈ÇƒÖd zapisu: ' + (err && err.message ? err.message : err), false);
    })
    .saveWorkforcePlan(payload);
}

function wfApplyPlanToInputs(plan, applyAvail){
  if (!plan) return;

  // parametry
  if (typeof plan.weeklyOrders !== 'undefined') document.getElementById('wf_weeklyOrders').value = plan.weeklyOrders;
  if (typeof plan.productivity !== 'undefined') document.getElementById('wf_productivity').value = plan.productivity;

  const p = plan.percent || {};
  const h = plan.hours || {};
  const a = plan.avail || {};

  // percenty
  if (document.getElementById('wf_p_mon')) document.getElementById('wf_p_mon').value = p.Pon ?? 0;
  if (document.getElementById('wf_p_tue')) document.getElementById('wf_p_tue').value = p.Wt ?? 0;
  if (document.getElementById('wf_p_wed')) document.getElementById('wf_p_wed').value = p['≈ör'] ?? 0;
  if (document.getElementById('wf_p_thu')) document.getElementById('wf_p_thu').value = p.Czw ?? 0;
  if (document.getElementById('wf_p_fri')) document.getElementById('wf_p_fri').value = p.Pt ?? 0;

  // godziny
  if (document.getElementById('wf_h_mon')) document.getElementById('wf_h_mon').value = h.Pon ?? 0;
  if (document.getElementById('wf_h_tue')) document.getElementById('wf_h_tue').value = h.Wt ?? 0;
  if (document.getElementById('wf_h_wed')) document.getElementById('wf_h_wed').value = h['≈ör'] ?? 0;
  if (document.getElementById('wf_h_thu')) document.getElementById('wf_h_thu').value = h.Czw ?? 0;
  if (document.getElementById('wf_h_fri')) document.getElementById('wf_h_fri').value = h.Pt ?? 0;

  // dostƒôpni (opcjonalnie)
  if (applyAvail){
    if (document.getElementById('wf_av_mon')) document.getElementById('wf_av_mon').value = a.Pon ?? 0;
    if (document.getElementById('wf_av_tue')) document.getElementById('wf_av_tue').value = a.Wt ?? 0;
    if (document.getElementById('wf_av_wed')) document.getElementById('wf_av_wed').value = a['≈ör'] ?? 0;
    if (document.getElementById('wf_av_thu')) document.getElementById('wf_av_thu').value = a.Czw ?? 0;
    if (document.getElementById('wf_av_fri')) document.getElementById('wf_av_fri').value = a.Pt ?? 0;
  }
}

function wfLoadSnapshot(){
  const dept = document.getElementById('wf_deptSelect')?.value || 'ALL';
  const weekMonday = wfGetMondayISOFromInput();
  if (!weekMonday) { wfToast('Ustaw najpierw tydzie≈Ñ (poniedzia≈Çek).', false); return; }

  wfToast('‚è≥ Szukam zapisanego planu...', true);

  google.script.run
    .withSuccessHandler(function(plan){
      if (!plan) { wfToast('Brak zapisu dla tego tygodnia i dzia≈Çu.', false); return; }

      // Snapshot = wczytujemy parametry + availability z zapisu (bo to ma byƒá "to samo co by≈Ço")
      wfApplyPlanToInputs(plan, true);
      wfToast('‚úÖ Wczytano zapis. Przeliczam...', true);
      wfRecalc();
    })
    .withFailureHandler(function(err){
      wfToast('‚ùå B≈ÇƒÖd wczytania: ' + (err && err.message ? err.message : err), false);
    })
    .getWorkforcePlan(dept, weekMonday);
}

function wfCopyFromPreviousWeek(){
  const dept = document.getElementById('wf_deptSelect')?.value || 'ALL';
  const weekMonday = wfGetMondayISOFromInput();
  if (!weekMonday) { wfToast('Ustaw najpierw tydzie≈Ñ (poniedzia≈Çek).', false); return; }

  wfToast('‚è≥ Szukam poprzedniego planu...', true);

  google.script.run
    .withSuccessHandler(function(plan){
      if (!plan) { wfToast('Nie znaleziono poprzedniego planu dla tego dzia≈Çu.', false); return; }

      // 3.2 = kopiujemy tylko parametry (bez dostƒôpnych)
      wfApplyPlanToInputs(plan, false);
      wfToast('‚úÖ Skopiowano parametry. Przeliczam...', true);
      wfRecalc();
    })
    .withFailureHandler(function(err){
      wfToast('‚ùå B≈ÇƒÖd kopiowania: ' + (err && err.message ? err.message : err), false);
    })
    .getPreviousWorkforcePlan(dept, weekMonday);
}

function wfOpenAgencyModal(){
  const overlay = document.getElementById('wfAgencyOverlay');
  if (overlay) overlay.style.display = 'block';

  // domy≈õlny tryb wg bilansu tygodnia
  const bal = (wfLastCalc && typeof wfLastCalc.balanceHours === 'number') ? wfLastCalc.balanceHours : 0;
  const action = bal < 0 ? 'NEED' : (bal > 0 ? 'RELEASE' : 'NEED');
  wfSetAgencyAction(action);

  // domy≈õlne zaznaczenia dni wg brak√≥w / nadwy≈ºek
  wfCheckDaysByDefault(action);

  wfLoadAgenciesToSelect();

  // przeliczenie po ustawieniu dni
  setTimeout(wfAgencyRecalc, 0);
}

function wfCloseAgencyModal(){
  const overlay = document.getElementById('wfAgencyOverlay');
  if (overlay) overlay.style.display = 'none';
}

function executeWithInstantUI(uiAction, backendAction, onError) {
    // 1. NATYCHMIAST wykonaj akcjƒô UI
    if (uiAction) {
        uiAction();
    }
    
    // 2. W TLE wykonaj backend (nie blokuje UI)
    if (backendAction) {
        setTimeout(() => {
            try {
                backendAction();
            } catch (error) {
                console.error('B≈ÇƒÖd backendu:', error);
                if (onError) onError(error);
            }
        }, 10);
    }
}

let wfAgenciesCache = [];

function wfAgencyStatus(msg, ok){
  const el = document.getElementById('wfAgencyStatus');
  if (!el) return;
  el.innerHTML = `<span style="color:${ok ? '#16a34a' : '#b91c1c'}">${msg}</span>`;
}

function wfLoadAgenciesToSelect(){
  const select = document.getElementById('wfAgencySelect');
  const note = document.getElementById('wfAgencyNote');
  if (!select) return;

  select.innerHTML = '<option>‚è≥ ≈Åadujƒô...</option>';
  if (note) note.innerHTML = '';
  wfAgencyStatus('', true);

  google.script.run
    .withSuccessHandler(function(list){
      wfAgenciesCache = Array.isArray(list) ? list : [];

      if (!wfAgenciesCache.length){
        select.innerHTML = '<option>Brak aktywnych agencji (sprawd≈∫ arkusz Agencje)</option>';
        return;
      }

      select.innerHTML = wfAgenciesCache
        .map(a => `<option value="${a.name}">${a.name}</option>`)
        .join('');

      select.onchange = wfAgencyFillNote;
      wfAgencyFillNote();
    })
    .withFailureHandler(function(err){
      select.innerHTML = '<option>B≈ÇƒÖd wczytania agencji</option>';
      wfAgencyStatus('‚ùå B≈ÇƒÖd wczytania agencji: ' + (err?.message || err), false);
    })
    .wfGetActiveAgencies();
}

function wfAgencyFillNote(){
  const select = document.getElementById('wfAgencySelect');
  const note = document.getElementById('wfAgencyNote');
  if (!select || !note) return;

  const ag = wfAgenciesCache.find(a => a.name === select.value);
  note.innerHTML = ag && ag.note ? `‚Ñπ ${ag.note}` : '';
}

function wfGetAgencyAction(){
  const el = document.querySelector('input[name="wfAgencyAction"]:checked');
  return el ? el.value : 'NEED';
}

function wfSetAgencyAction(v){
  const el = document.querySelector(`input[name="wfAgencyAction"][value="${v}"]`);
  if (el) el.checked = true;
}

function wfHalfUp(n){
  return Math.floor(n + 0.5); // od po≈Çowy w g√≥rƒô
}

function wfGetDayCheckboxes(){
  return Array.from(document.querySelectorAll('.wfAgencyDay'));
}

function wfCheckDaysByDefault(action){
  const boxes = wfGetDayCheckboxes();
  const balances = (wfLastCalc && wfLastCalc.dayBalances) ? wfLastCalc.dayBalances : {};

  boxes.forEach(ch => {
    const day = ch.value;
    const v = Number(balances[day] || 0);
    if (action === 'NEED') ch.checked = (v < 0);
    if (action === 'RELEASE') ch.checked = (v > 0);
  });
}

function wfAgencyGetDayHoursMap(){
  // bierzemy z p√≥l planowania obsady
  const h = wfGetHoursMap(); // {Pon,Wt,≈ör,Czw,Pt}
  return h || {};
}

function wfAgencyRecalc(){
  const balances = (wfLastCalc && wfLastCalc.dayBalances) ? wfLastCalc.dayBalances : {};
  const action = wfGetAgencyAction();
  const hMap = wfAgencyGetDayHoursMap();

  const selectedDays = wfGetDayCheckboxes().filter(ch => ch.checked).map(ch => ch.value);

  let hoursTotal = 0;
  let peopleMax = 0;

  const lines = [];

  selectedDays.forEach(day => {
    const diff = Number(balances[day] || 0);
    const dayHours = Math.max(1, Number(hMap[day] || 0));

    let hoursToCover = 0;
    if (action === 'NEED') hoursToCover = Math.max(0, -diff);
    if (action === 'RELEASE') hoursToCover = Math.max(0, diff);

    if (hoursToCover <= 0){
      lines.push(`‚Ä¢ <b>${day}</b>: 0h (nie dotyczy)`);
      return;
    }

    const peopleDay = wfHalfUp(hoursToCover / dayHours);

    hoursTotal += hoursToCover;
    if (peopleDay > peopleMax) peopleMax = peopleDay;

    lines.push(`‚Ä¢ <b>${day}</b>: ${wfHours(hoursToCover)}h ‚Üí ok. <b>${peopleDay}</b> os. (przy ${wfHours(dayHours)}h/os.)`);
  });

  const hoursEl = document.getElementById('wfAgencyHoursTotal');
  if (hoursEl) hoursEl.value = Number(hoursTotal.toFixed(2));

  const peopleEl = document.getElementById('wfAgencyPeople');
  if (peopleEl) peopleEl.value = peopleMax;

  const info = document.getElementById('wfAgencyAutoInfo');
  if (info){
    info.innerHTML = `Tryb: <b>${action === 'NEED' ? 'POTRZEBUJEMY' : 'ODDAJEMY'}</b> | Dni zaznaczone: <b>${selectedDays.length}</b> | MAX os√≥b: <b>${peopleMax}</b>`;
  }

  const br = document.getElementById('wfAgencyBreakdown');
  if (br){
    br.innerHTML = lines.length
      ? `<div style="font-weight:900; margin-bottom:6px;">Rozpiska per dzie≈Ñ</div>${lines.map(x=>`<div>${x}</div>`).join('')}`
      : `<div style="opacity:0.9;">Zaznacz dni, kt√≥re majƒÖ wej≈õƒá do zam√≥wienia.</div>`;
  }
}

function wfAgencyBuildBreakdownText(){
  const br = document.getElementById('wfAgencyBreakdown');
  if (!br) return '';
  // wyciƒÖgamy tekst bez HTML
  return br.innerText || '';
}

function wfAgencySend(){
  const weekMonday = wfGetMondayISOFromInput();
  const dept = document.getElementById('wf_deptSelect')?.value || 'ALL';
  if (!weekMonday){ wfAgencyStatus('‚ùå Ustaw tydzie≈Ñ (poniedzia≈Çek).', false); return; }

  const agencyName = document.getElementById('wfAgencySelect')?.value || '';
  const action = wfGetAgencyAction();

  const days = Array.from(document.querySelectorAll('.wfAgencyDay'))
    .filter(ch => ch.checked)
    .map(ch => ch.value);

  const hoursTotal = Number(document.getElementById('wfAgencyHoursTotal')?.value || 0);
  const peopleMax = Number(document.getElementById('wfAgencyPeople')?.value || 0);

  const note = String(document.getElementById('wfAgencyNoteInput')?.value || '').trim();
  const breakdownText = wfAgencyBuildBreakdownText();

  const plan = wfBuildPlanPayload();

  const req = {
    weekMonday,
    dept,
    agencyName,
    action,
    days,
    hoursTotal,
    peopleMax,
    breakdownText,
    note,

    weeklyOrders: plan.weeklyOrders,
    productivity: plan.productivity,
    includePending: plan.includePending
  };

  wfAgencyStatus('‚è≥ Wysy≈Çam...', true);

  google.script.run
    .withSuccessHandler(function(){
      wfAgencyStatus('‚úÖ Wys≈Çano i zapisano w logu.', true);
    })
    .withFailureHandler(function(err){
      wfAgencyStatus('‚ùå B≈ÇƒÖd: ' + (err?.message || err), false);
    })
    .wfSendAgencyRequest(req);
}

/**
 * Wrapper dla sendToSpreadsheet - nie blokuje UI
 */
function sendToSpreadsheetAsync(login, department, action, callback) {
  const data = {
    login: login,
    department: department,
    action: action,
    timestamp: new Date().toISOString()
  };

  console.log('üì§ Wysy≈Çanie async:', data);

  const hasAppsScript = (typeof google !== 'undefined' && google.script && google.script.run);

  // ===== TRYB CLOUDFLARE PAGES (API) =====
  if (!hasAppsScript) {
    apiAddTimeEntry(data)
      .then((result) => {
        console.log('‚úÖ Zapisano przez API:', result);

        // ‚úÖ dopiero po sukcesie zmieniamy UI (≈ºeby COFNIJ dzia≈Ça≈Ço logicznie)
        optimisticUpdateLiveWorkforce(data);

        if (callback) callback(result);

        // dosynchronizuj ‚Äúlive‚Äù
        setTimeout(refreshLiveWorkforce, 200);
        setTimeout(refreshLiveWorkforce, 1500);
      })
      .catch((error) => {
        console.error('‚ùå B≈ÇƒÖd API zapisu:', error);
        if (callback) callback({ success: false, message: (error && error.message) ? error.message : 'B≈ÇƒÖd zapisu API' });

        // jak siƒô nie uda≈Ço, nie robimy optimistic update
        setTimeout(refreshLiveWorkforce, 400);
      });

    return;
  }

  // ===== TRYB APPS SCRIPT (stary DBK) =====
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('‚úÖ Zapisano w arkuszu:', result);

      // ‚úÖ dopiero po sukcesie zmieniamy UI
      optimisticUpdateLiveWorkforce(data);

      if (callback) callback(result);

      setTimeout(refreshLiveWorkforce, 200);
      setTimeout(refreshLiveWorkforce, 1500);

      google.script.run
        .withSuccessHandler(function(updatedData) {
          departments = updatedData;
        })
        .withFailureHandler(function(err) {
          console.log('getDepartmentsData error:', err);
        })
        .getDepartmentsData();
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå B≈ÇƒÖd zapisu:', error);
      if (callback) callback({ success: false, message: (error && error.message) ? error.message : 'B≈ÇƒÖd zapisu' });

      setTimeout(refreshLiveWorkforce, 400);
    })
    .addTimeEntry(data.login, data.department, data.action, data.timestamp);
}
// ===== SYSTEM LOGOWANIA =====

let isLoggedIn = false;

// Sprawd≈∫ sesjƒô przy za≈Çadowaniu strony
window.addEventListener('DOMContentLoaded', function() {
  checkSession();
});

function checkSession() {
  const sessionLogin = sessionStorage.getItem('isLoggedIn');
  const loggedInUser = sessionStorage.getItem('loggedInUser');

  var loginScreen = document.getElementById('loginScreen');
  var mainInterface = document.getElementById('mainInterface');

  if (sessionLogin === 'true') {
    isLoggedIn = true;

    if (loginScreen) loginScreen.style.display = 'none';
    if (mainInterface) mainInterface.style.display = 'block';

    // kafelki kierownika
    setManagerButtons(String(loggedInUser || '').trim() === 'jerzyd');

    if (typeof showView === 'function') showView('department');
    setTimeout(() => { try { focusEanInput(); } catch(e){} }, 100);

  } else {
    isLoggedIn = false;

    if (loginScreen) loginScreen.style.display = 'block';
    if (mainInterface) mainInterface.style.display = 'none';

    // fokus na login
    setTimeout(() => {
      const li = document.getElementById('loginInput');
      if (li) li.focus();
    }, 100);
  }
}

    function setManagerButtons(isManager){
  const dash = document.getElementById('dashboardBtn');
  const ann  = document.getElementById('announcementsBtn');
  const wf   = document.getElementById('workforcePlannerBtn');
  const live = document.getElementById('workforceLiveBtn');

  const show = isManager ? 'inline-block' : 'none';
  if (dash) dash.style.display = show;
  if (ann)  ann.style.display = show;
  if (wf)   wf.style.display = show;
  if (live) live.style.display = show;
}

    function localLogin(login){
  sessionStorage.setItem('isLoggedIn', 'true');
  if (login) sessionStorage.setItem('loggedInUser', login);

  isLoggedIn = true;

  const ls = document.getElementById('loginScreen');
  const mi = document.getElementById('mainInterface');

  if (ls) ls.style.display = 'none';
  if (mi) mi.style.display = 'block';

  // poka≈º/ukryj kafelki kierownika
  const isManager = (String(login || '').trim() === 'jerzyd');
  setManagerButtons(isManager);

  if (typeof showView === 'function') showView('department');
  setTimeout(() => { try { focusEanInput(); } catch(e){} }, 100);

  const err = document.getElementById('loginError');
  if (err) { err.textContent = ''; err.style.display = 'none'; }
}

function handleLogin() {
  // Je≈õli jeste≈õmy na Pages (brak Apps Script) -> logowanie lokalne
  const hasAppsScript = (typeof google !== 'undefined' && google.script && google.script.run);
  if (!hasAppsScript) {
  const login = document.getElementById('loginInput').value.trim();
  const password = document.getElementById('passwordInput').value; // na razie nie weryfikujemy w Pages
  if (!login || !password) {
    const errorDiv = document.getElementById('loginError');
    if (errorDiv) {
      errorDiv.textContent = '‚ö†Ô∏è Wype≈Çnij wszystkie pola!';
      errorDiv.style.display = 'block';
    }
    return;
  }

  localLogin(login);
  return;
}

  const login = document.getElementById('loginInput').value.trim();
  const password = document.getElementById('passwordInput').value;
  const errorDiv = document.getElementById('loginError');

  if (!login || !password) {
    errorDiv.textContent = '‚ö†Ô∏è Wype≈Çnij wszystkie pola!';
    errorDiv.style.display = 'block';
    return;
  }

  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {

        // Zalogowano pomy≈õlnie
        sessionStorage.setItem('isLoggedIn', 'true');
        sessionStorage.setItem('loggedInUser', login);
        isLoggedIn = true;

        // Schowaj ekran logowania, poka≈º interfejs
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainInterface').style.display = 'block';
        errorDiv.style.display = 'none';

        // Za≈Çaduj dane + UI
        loadDepartmentsFromSpreadsheet();
        updateTime();
        updateTicketsNotificationBadge();
        startAutoRefresh();

        // Poka≈º przyciski tylko dla kierownika
        if (response.isManager) {
          document.getElementById('dashboardBtn').style.display = 'inline-block';
          document.getElementById('announcementsBtn').style.display = 'inline-block';
          document.getElementById('workforcePlannerBtn').style.display = 'inline-block';
          document.getElementById('workforceLiveBtn').style.display = 'inline-block';
        } else {
          document.getElementById('dashboardBtn').style.display = 'none';
          document.getElementById('announcementsBtn').style.display = 'none';
          document.getElementById('workforcePlannerBtn').style.display = 'none';
          document.getElementById('workforceLiveBtn').style.display = 'none';
        }

        // Fokus na pole skanowania EAN
        focusEanInput();

      } else {
        errorDiv.textContent = response.message;
        errorDiv.style.display = 'block';
      }
    })
    .withFailureHandler(function(error) {
      errorDiv.textContent = '‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message;
      errorDiv.style.display = 'block';
    })
    .authenticateUser(login, password);
}

// Pozw√≥l na Enter w polach logowania
document.addEventListener('DOMContentLoaded', function() {
  const loginInput = document.getElementById('loginInput');
  const passwordInput = document.getElementById('passwordInput');
  
  if (loginInput) {
    loginInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') handleLogin();
    });
  }
  
  if (passwordInput) {
    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') handleLogin();
    });
  }
});

function focusEanInput(retries = 20, delay = 150) {
  let attempt = 0;

  const tryFocus = () => {
    const el = document.getElementById('codeInput');
    const main = document.getElementById('mainInterface');

    // mainInterface musi byƒá pokazany
    const mainVisible = main && main.style.display !== 'none';

    if (el && !el.disabled && mainVisible) {
      el.focus({ preventScroll: true });
      if (typeof el.select === 'function') el.select();
      return;
    }

    attempt++;
    if (attempt < retries) setTimeout(tryFocus, delay);
  };

  // fokus od razu + ‚Äúdrugi strza≈Ç‚Äù po renderze
  tryFocus();
  setTimeout(tryFocus, 300);
}

// ===== GLOBALNE ZMIENNE =====
        let departments = {};
        let currentView = 'department';
        let currentDepartment = null;
        let currentUser = null;
        let selectedUserForVerification = null;
        let selectedUserForVacation = null;
        let workerState = 'not-logged-in';
        let userStatuses = {};
        let pendingVacationCount = 0;
        let selectedVacationType = 'planowany';
        let autoRefreshInterval = null;
        let lastRefreshTime = 0;
        let userVacationBalances = {};
        let currentUserVacationRequests = [];
        let openTicketsCount = 0;
        let unreadTicketRepliesCount = 0;  // Nieodczytane odpowiedzi dla pracownika
        let criticalTicketsCount = 0;      // Krytyczne tickety dla kierownika
        // ===== CACHE OG≈ÅOSZE≈É =====
        let announcementsCache = {};
        let announcementsCacheLoaded = false;
        let announcementsCacheTimestamp = 0;

        // ===== PRE-LOAD OG≈ÅOSZE≈É DLA WSZYSTKICH PRACOWNIK√ìW =====
        let allAnnouncementsPreloaded = {};
        let preloadInProgress = false;

        function preloadAllAnnouncementsCache() {
            if (preloadInProgress) return;
            preloadInProgress = true;
            
            console.log('üîÑ Pre-loading og≈Çosze≈Ñ dla wszystkich pracownik√≥w...');
            
            if (typeof google === 'undefined' || !google.script) {
                preloadInProgress = false;
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success && result.announcementsByUser) {
                        allAnnouncementsPreloaded = result.announcementsByUser;
                        console.log('‚úÖ Pre-loaded og≈Çoszenia dla', Object.keys(allAnnouncementsPreloaded).length, 'pracownik√≥w');
                    }
                    preloadInProgress = false;
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå B≈ÇƒÖd pre-loading og≈Çosze≈Ñ:', error);
                    preloadInProgress = false;
                })
                .getAllUnreadAnnouncementsGrouped();
        }
        
        window.isChangingOperation = false;
        window.vacationMode = false;

        // ===== LICZNIK OTWARTYCH TICKET√ìW =====
        function updateTicketsNotificationBadge() {
            console.log('üîÑ Sprawdzam liczbƒô otwartych ticket√≥w...');
            
            if (typeof google === 'undefined' || !google.script) {
                console.log('‚ö†Ô∏è Brak po≈ÇƒÖczenia z backendem (tryb testowy)');
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(count) {
                    console.log('‚úÖ Otrzymano liczbƒô ticket√≥w:', count);
                    openTicketsCount = count;
                    
                    // Znajd≈∫ przycisk "Zg≈Ço≈õ problem"
                    const ticketBtn = document.querySelector('button[onclick="openTicketSystem()"]');
                    
                    if (!ticketBtn) {
                        console.log('‚ö†Ô∏è Nie znaleziono przycisku ticket√≥w');
                        return;
                    }
                    
                    let badge = ticketBtn.querySelector('.vacation-btn-badge');
                    
                    if (count > 0) {
                        console.log('üìä Tworzƒô/aktualizujƒô badge z liczbƒÖ:', count);
                        
                        if (!badge) {
                            badge = document.createElement('div');
                            badge.className = 'vacation-btn-badge';
                            ticketBtn.style.position = 'relative';
                            ticketBtn.appendChild(badge);
                        }
                        badge.textContent = count;
                    } else {
                        console.log('‚ÑπÔ∏è Brak otwartych ticket√≥w - usuwam badge');
                        if (badge) {
                            badge.remove();
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå B≈ÇƒÖd pobierania liczby ticket√≥w:', error);
                })
                .getOpenTicketsCount();
        }

        // ===== LICZNIK NIEODCZYTANYCH ODPOWIEDZI (dla pracownika) =====
        function updateUnreadTicketRepliesBadge(userLogin) {
            if (!userLogin) {
                console.log('‚ö†Ô∏è Brak loginu u≈ºytkownika - pomijam sprawdzanie odpowiedzi');
                return;
            }
            
            console.log('üîÑ Sprawdzam nieodczytane odpowiedzi dla:', userLogin);
            
            if (typeof google === 'undefined' || !google.script) {
                console.log('‚ö†Ô∏è Brak po≈ÇƒÖczenia z backendem (tryb testowy)');
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(count) {
                    console.log('‚úÖ Nieodczytane odpowiedzi dla', userLogin, ':', count);
                    unreadTicketRepliesCount = count;
                    
                    // Aktualizuj badge w panelu operatora (je≈õli jeste≈õmy w tym widoku)
                    if (currentView === 'action') {
                        updateMyTicketsTileInActionView();
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå B≈ÇƒÖd pobierania nieodczytanych odpowiedzi:', error);
                })
                .getUnreadTicketRepliesCount(userLogin);
        }

        // ===== LICZNIK KRYTYCZNYCH TICKET√ìW (dla kierownika) =====
        function updateCriticalTicketsBadge() {
            console.log('üîÑ Sprawdzam krytyczne tickety...');
            
            if (typeof google === 'undefined' || !google.script) {
                console.log('‚ö†Ô∏è Brak po≈ÇƒÖczenia z backendem (tryb testowy)');
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(count) {
                    console.log('üî¥ Liczba krytycznych ticket√≥w:', count);
                    criticalTicketsCount = count;
                    
                    // Aktualizuj badge na przycisku zg≈Çosze≈Ñ w status bar
                    updateTicketsButtonStyle();
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå B≈ÇƒÖd pobierania krytycznych ticket√≥w:', error);
                })
                .getCriticalTicketsCount();
            }

            // ===== CACHE OG≈ÅOSZE≈É - ≈ÅADOWANIE =====
            function loadAnnouncementsCache(loginPracownika) {
                if (!loginPracownika) return;
                
                if (typeof google === 'undefined' || !google.script) {
                    announcementsCacheLoaded = true;
                    return;
                }
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            announcementsCache = {
                                visibleAnnouncements: result.announcements || [],
                                loginPracownika: loginPracownika
                            };
                            announcementsCacheLoaded = true;
                            announcementsCacheTimestamp = Date.now();
                        }
                    })
                    .withFailureHandler(function(error) {
                        announcementsCacheLoaded = true;
                    })
                    .getUnreadAnnouncements(loginPracownika);
            }

            function checkForAnnouncementsFast(loginPracownika, afterCallback) {
                if (!announcementsCacheLoaded || announcementsCache.loginPracownika !== loginPracownika) {
                    checkForAnnouncements(loginPracownika, afterCallback);
                    return;
                }
                
                const unreadAnnouncements = announcementsCache.visibleAnnouncements || [];
                
                if (unreadAnnouncements.length > 0) {
                    pendingAnnouncements = unreadAnnouncements;
                    currentAnnouncementIndex = 0;
                    pendingRegistrationData = afterCallback;
                    showCurrentAnnouncement();
                } else {
                    if (afterCallback) afterCallback();
                }
            }

            /**
             * Sprawdza og≈Çoszenia w tle - pokazuje modal je≈õli sƒÖ nieprzeczytane
             */
            function checkAnnouncementsInBackground(loginPracownika) {
                // U≈ºyj cache je≈õli dostƒôpny
                if (announcementsCacheLoaded && announcementsCache.loginPracownika === loginPracownika) {
                    const unreadAnnouncements = announcementsCache.visibleAnnouncements || [];
                    if (unreadAnnouncements.length > 0) {
                        pendingAnnouncements = unreadAnnouncements;
                        currentAnnouncementIndex = 0;
                        pendingRegistrationData = null;
                        showCurrentAnnouncement();
                    }
                    return;
                }
                
                // Pobierz z backendu
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success && result.announcements && result.announcements.length > 0) {
                            pendingAnnouncements = result.announcements;
                            currentAnnouncementIndex = 0;
                            pendingRegistrationData = null;
                            showCurrentAnnouncement();
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå B≈ÇƒÖd sprawdzania og≈Çosze≈Ñ:', error);
                    })
                    .getUnreadAnnouncements(loginPracownika);
            }

            function removeAnnouncementFromCache(announcementId) {
                if (announcementsCache.visibleAnnouncements) {
                    announcementsCache.visibleAnnouncements = announcementsCache.visibleAnnouncements.filter(
                        ann => ann.id !== announcementId
                    );
                }
            }

            function refreshAnnouncementsCache() {
                const login = sessionStorage.getItem('currentEmployeeLogin');
                if (login) {
                    loadAnnouncementsCache(login);
                }
            }

          // ===== AKTUALIZUJ STYL PRZYCISKU ZG≈ÅOSZE≈É (czerwony je≈õli krytyczne) =====
          function updateTicketsButtonStyle() {
              loadSavedTheme(); // Zastosuj dark mode
              const ticketBtn = document.querySelector('button[onclick="openTicketSystem()"]');
              
              if (!ticketBtn) return;
              
              if (criticalTicketsCount > 0) {
                  // Czerwony pulsujƒÖcy badge dla krytycznych
                  ticketBtn.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
                  ticketBtn.style.animation = 'pulse 2s infinite';
                  
                  let badge = ticketBtn.querySelector('.vacation-btn-badge');
                  if (badge) {
                      badge.style.background = '#ff0000';
                      badge.style.animation = 'pulse 1s infinite';
                  }
              } else {
                  // Normalny styl
                  ticketBtn.style.background = 'linear-gradient(45deg, #9c27b0, #673ab7)';
                  ticketBtn.style.animation = 'none';
              }
          }

          // ===== AKTUALIZUJ KAFELKI W PANELU OPERATORA =====
          function updateMyTicketsTileInActionView() {
              const myTicketsBtn = document.getElementById('my-tickets-btn');
              const managerTicketsBtn = document.getElementById('manager-tickets-btn');
              
              if (!currentUser || !currentUser.login) {
                  if (myTicketsBtn) myTicketsBtn.style.display = 'none';
                  if (managerTicketsBtn) managerTicketsBtn.style.display = 'none';
                  return;
              }
              
              // KIEROWNIK - poka≈º kafelek zarzƒÖdzania
              if (currentUser.login === 'jerzyd') {
                  if (myTicketsBtn) myTicketsBtn.style.display = 'none';
                  
                  if (managerTicketsBtn) {
                      managerTicketsBtn.style.display = 'flex';
                      
                      // Usu≈Ñ stary badge
                      let badge = managerTicketsBtn.querySelector('.user-notification-badge');
                      if (badge) badge.remove();
                      
                      // Dodaj badge z liczbƒÖ nowych
                      if (openTicketsCount > 0) {
                          badge = document.createElement('div');
                          badge.className = 'user-notification-badge';
                          badge.textContent = openTicketsCount;
                          badge.style.background = '#ffc107';
                          managerTicketsBtn.appendChild(badge);
                      }
                  }
              } 
              // PRACOWNIK - poka≈º kafelek moich zg≈Çosze≈Ñ
              else {
                  if (managerTicketsBtn) managerTicketsBtn.style.display = 'none';
                  
                  if (myTicketsBtn) {
                      myTicketsBtn.style.display = 'flex';
                      
                      // Usu≈Ñ stary badge
                      let badge = myTicketsBtn.querySelector('.user-notification-badge');
                      if (badge) badge.remove();
                      
                      // Dodaj badge z nieodczytanymi odpowiedziami
                      if (unreadTicketRepliesCount > 0) {
                          badge = document.createElement('div');
                          badge.className = 'user-notification-badge';
                          badge.textContent = unreadTicketRepliesCount;
                          badge.style.background = '#dc3545';
                          myTicketsBtn.appendChild(badge);
                      }
                  }
              }
          }

            // ===== ZAMKNIJ MODAL NIEODCZYTANYCH =====
            function closeUnreadTicketsModal() {
                document.getElementById('unreadTicketsModal').classList.remove('show');
                
                // ‚úÖ POPRAWKA: U≈ºyj danych aktualnie zeskanowanego u≈ºytkownika
                // currentUser i currentDepartment sƒÖ ju≈º ustawione w handleCodeScan()
                
                if (!currentUser || !currentDepartment) {
                    console.error('‚ùå Brak danych u≈ºytkownika po zamkniƒôciu modalu');
                    showView('department');
                    ensureCodeInputFocus();
                    return;
                }
                
                // Ustaw w≈Ça≈õciwy tytu≈Ç panelu dla TEGO u≈ºytkownika
                const departmentNames = {
                    'przyjecie': 'Przyjƒôcie dostaw',
                    'rozladunek': 'Roz≈Çadunek rƒôczny kontenera',
                    'zaladunek': 'Za≈Çadunek rƒôczny kontenera',
                    'relokacja': 'Relokacja',
                    'kompletacja': 'Kompletacja zam√≥wie≈Ñ',
                    'weryfikacja': 'Weryfikacja zam√≥wie≈Ñ',
                    'co-packing': 'Co-packing',
                    'operacje-porzadkowe': 'Operacje porzƒÖdkowe',
                    'inwentaryzacja': 'Inwentaryzacja'
                };
                
                const deptName = departmentNames[currentDepartment] || currentDepartment;
                
                document.getElementById('actionViewTitle').textContent = 
                    `Panel operatora - ${currentUser.login} (${deptName})`;
                
                // Ustaw w≈Ça≈õciwy stan
                if (currentUser.status === 'Pracuje') {
                    workerState = 'logged-in-working';
                    userStatuses[currentUser.login] = 'logged-in-working';
                } else if (currentUser.status === 'Na przerwie') {
                    workerState = 'logged-in-on-break';
                    userStatuses[currentUser.login] = 'logged-in-on-break';
                } else {
                    workerState = 'not-logged-in';
                    userStatuses[currentUser.login] = 'not-logged-in';
                }
                
                isLoggedIn = true;
                
                // Przejd≈∫ do panelu operatora
                showView('action');
                updateButtonStates();
                updateMyTicketsTileInActionView();
                
                showNotification(`${currentUser.login} - mo≈ºesz sprawdziƒá odpowiedzi p√≥≈∫niej`, 'info');
            }

            // ===== ZAMKNIJ MODAL KRYTYCZNYCH =====
function closeCriticalTicketsModal() {
    document.getElementById('criticalTicketsModal').classList.remove('show');
    
    // ‚úÖ POPRAWKA: U≈ºyj danych aktualnie zeskanowanego kierownika
    // currentUser i currentDepartment sƒÖ ju≈º ustawione w handleCodeScan()
    
    if (!currentUser || !currentDepartment) {
        console.error('‚ùå Brak danych u≈ºytkownika po zamkniƒôciu modalu');
        showView('department');
        ensureCodeInputFocus();
        return;
    }
    
    // Ustaw w≈Ça≈õciwy tytu≈Ç panelu dla KIEROWNIKA
    const departmentNames = {
        'przyjecie': 'Przyjƒôcie dostaw',
        'rozladunek': 'Roz≈Çadunek rƒôczny kontenera',
        'zaladunek': 'Za≈Çadunek rƒôczny kontenera',
        'relokacja': 'Relokacja',
        'kompletacja': 'Kompletacja zam√≥wie≈Ñ',
        'weryfikacja': 'Weryfikacja zam√≥wie≈Ñ',
        'co-packing': 'Co-packing',
        'operacje-porzadkowe': 'Operacje porzƒÖdkowe',
        'inwentaryzacja': 'Inwentaryzacja'
    };
    
    const deptName = departmentNames[currentDepartment] || currentDepartment;
    
    document.getElementById('actionViewTitle').textContent = 
        `Panel operatora - ${currentUser.login} (${deptName})`;
    
    // Ustaw w≈Ça≈õciwy stan
    if (currentUser.status === 'Pracuje') {
        workerState = 'logged-in-working';
        userStatuses[currentUser.login] = 'logged-in-working';
    } else if (currentUser.status === 'Na przerwie') {
        workerState = 'logged-in-on-break';
        userStatuses[currentUser.login] = 'logged-in-on-break';
    } else {
        workerState = 'not-logged-in';
        userStatuses[currentUser.login] = 'not-logged-in';
    }
    
    isLoggedIn = true;
    
    // Przejd≈∫ do panelu operatora kierownika
    showView('action');
    updateButtonStates();
    updateMyTicketsTileInActionView();
    
    showNotification(`${currentUser.login} - panel operatora`, 'info');
}

            // ===== PLACEHOLDER - WIDOK MOICH ZG≈ÅOSZE≈É (zrobimy w nastƒôpnym kroku) =====
            function showMyTicketsView() {
                document.getElementById('unreadTicketsModal').classList.remove('show');
                showNotification('Funkcja "Moje zg≈Çoszenia" - wkr√≥tce!', 'info');
                // TODO: Implementacja w nastƒôpnym kroku
            }

            // ===== PLACEHOLDER - WIDOK MANAGERA ZG≈ÅOSZE≈É (zrobimy w nastƒôpnym kroku) =====
            function showManagerTicketsView() {
                document.getElementById('criticalTicketsModal').classList.remove('show');
                showNotification('Panel zg≈Çosze≈Ñ kierownika - wkr√≥tce!', 'info');
                // TODO: Implementacja w nastƒôpnym kroku
            }

            // ===== POKA≈ª MODAL NIEODCZYTANYCH ODPOWIEDZI =====
            function showUnreadTicketsModal(userName, count) {
                document.getElementById('unreadTicketsUserName').textContent = userName;
                document.getElementById('unreadTicketsCount').textContent = count;
                document.getElementById('unreadTicketsModal').classList.add('show');
                
                console.log('üì¨ Pokazujƒô modal nieodczytanych dla:', userName, 'liczba:', count);
            }

            // ===== POKA≈ª MODAL KRYTYCZNYCH TICKET√ìW =====
            function showCriticalTicketsModal() {
                // Pobierz szczeg√≥≈Çy pierwszego krytycznego ticketu
                if (typeof google !== 'undefined' && google.script) {
                    google.script.run
                        .withSuccessHandler(function(criticalTickets) {
                            if (criticalTickets && criticalTickets.length > 0) {
                                const ticket = criticalTickets[0]; // Pierwszy krytyczny
                                
                                const detailsHTML = `
                                    <div style="text-align: left; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                        <p style="margin: 8px 0;"><strong>ID:</strong> #${ticket.id}</p>
                                        <p style="margin: 8px 0;"><strong>Tytu≈Ç:</strong> ${ticket.title}</p>
                                        <p style="margin: 8px 0;"><strong>Zg≈ÇaszajƒÖcy:</strong> ${ticket.name} (${ticket.login})</p>
                                        <p style="margin: 8px 0;"><strong>Data:</strong> ${ticket.date}</p>
                                        <p style="margin: 8px 0;"><strong>Lokalizacja:</strong> ${ticket.location || 'Nie podano'}</p>
                                    </div>
                                    ${criticalTickets.length > 1 ? `<p style="margin-top: 15px; font-size: 14px;">+ jeszcze ${criticalTickets.length - 1} krytycznych zg≈Çosze≈Ñ</p>` : ''}
                                `;
                                
                                document.getElementById('criticalTicketDetails').innerHTML = detailsHTML;
                                document.getElementById('criticalTicketsModal').classList.add('show');
                                
                                console.log('üî¥ Pokazujƒô modal krytycznych ticket√≥w');
                            } else {
                                // Brak krytycznych - normalny flow
                                proceedToActionView();
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('‚ùå B≈ÇƒÖd pobierania krytycznych ticket√≥w:', error);
                            proceedToActionView();
                        })
                        .getCriticalTickets();
                } else {
                    proceedToActionView();
                }
            }

        // ===== AUTOMATYCZNE OD≈öWIE≈ªANIE =====
        function startAutoRefresh() {
    console.log('üîÑ Uruchamiam auto-refresh (co 30 sekund)...');
    
    autoRefreshInterval = setInterval(() => {
        console.log('‚è∞ Auto-refresh wykonany o:', new Date().toLocaleTimeString());
        
        if (typeof google !== 'undefined' && google.script) {
            
            // Zawsze sprawdzaj licznik ticket√≥w (niezale≈ºnie od widoku)
            updateTicketsNotificationBadge();
            updateCriticalTicketsBadge();
            
            // ‚úÖ NOWE: Od≈õwie≈ºaj cache og≈Çosze≈Ñ dla wszystkich pracownik√≥w
            preloadAllAnnouncementsCache();
                  
                  // Je≈õli u≈ºytkownik jest zalogowany - sprawd≈∫ jego nieodczytane odpowiedzi
                  if (currentUser && currentUser.login) {
                      updateUnreadTicketRepliesBadge(currentUser.login); // ‚Üê DODANE
                  }
                  
                  // Inne od≈õwie≈ºania w zale≈ºno≈õci od widoku
                  if (currentView === 'vacation' && currentUser) {
                      showAutoRefreshIndicator();
                      loadUserVacationRequests(currentUser.login);
                      loadVacationBalance();
                  } 
                  else if (currentView === 'managerVacation') {
                      // Wy≈ÇƒÖczone auto-od≈õwie≈ºanie w panelu kierownika
                      // ≈ºeby nie przeszkadza≈Ço przy zatwierdzaniu wniosk√≥w
                      updateAbsenceTabCounts(); // tylko liczniki, bez prze≈Çadowania listy
                  }
                  else if (currentUser && currentUser.login === 'jerzyd') {
                      updateManagerNotificationBadge();
                  }
              }
          }, 60000);
      }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function showAutoRefreshIndicator() {
            const indicator = document.getElementById('autoRefreshIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // ===== FUNKCJA WYBORU DZIA≈ÅU =====
window.selectDepartment = function(deptId) {
    loadSavedTheme(); // Zastosuj dark mode
    console.log('selectDepartment wywo≈Çane z:', deptId);
    
    // Wsp√≥lna mapa nazw dzia≈Ç√≥w - PRZENIESIONA NA POCZƒÑTEK
    const departmentNames = {
        'przyjecie': 'Przyjƒôcie dostaw',
        'rozladunek': 'Roz≈Çadunek rƒôczny kontenera',
        'zaladunek': 'Za≈Çadunek rƒôczny kontenera',
        'relokacja': 'Relokacja',
        'kompletacja': 'Kompletacja zam√≥wie≈Ñ',
        'weryfikacja': 'Weryfikacja zam√≥wie≈Ñ',
        'co-packing': 'Co-packing',
        'operacje-porzadkowe': 'Operacje porzƒÖdkowe',
        'inwentaryzacja': 'Inwentaryzacja'
    };
    
    if (!departments || Object.keys(departments).length === 0) {
        showNotification('≈Åadowanie danych z arkusza...', 'info');
        setTimeout(() => selectDepartment(deptId), 1000);
        return;
    }
    
    // ZMIANA OPERACJI - u≈ºytkownik ju≈º zalogowany
    if (window.isChangingOperation && currentUser) {
        const deptName = departmentNames[deptId] || deptId;
        
        // 1. NATYCHMIAST - poka≈º sukces
        showNotification(`‚úÖ ${currentUser.login}: Zmieniono operacjƒô na ${deptName}`, 'success');
        
        const userToSave = currentUser.login;
        
        // 2. NATYCHMIAST - reset i powr√≥t do g≈Ç√≥wnego widoku
        setTimeout(() => {
            window.isChangingOperation = false;
            isLoggedIn = false;
            workerState = 'not-logged-in';
            currentUser = null;
            currentDepartment = null;
            
            document.getElementById('departmentView').querySelector('.view-title').textContent = 
                'Wybierz dzia≈Ç/operacjƒô';
            
            document.getElementById('welcomeHeader').classList.remove('show');
            showView('department');
            ensureCodeInputFocus();
        }, 300);
        
        // 3. W TLE - zapis (Pages: API /scan + intent, GS: stary zapis)
        const hasAppsScript = (typeof google !== 'undefined' && google.script && google.script.run);
        
        if (!hasAppsScript) {
          apiScanIntent('CHANGE_DEPT', { department: deptId })
            .catch(err => {
              console.error('‚ùå CHANGE_DEPT API error:', err);
              showNotification('‚ùå B≈ÇƒÖd zapisu zmiany operacji: ' + (err?.message || err), 'error');
            });
        } else {
          sendToSpreadsheetAsync(userToSave, deptId, 'zmieniam-operacje');
        }
        
        return;
    }
    
    currentDepartment = deptId;
    
    // Je≈õli u≈ºytkownik jest zalogowany - zmie≈Ñ operacjƒô
    if (isLoggedIn && currentUser) {
        currentDepartment = deptId;
        
        const deptName = departmentNames[deptId] || deptId;
        
        const hasAppsScript = (typeof google !== 'undefined' && google.script && google.script.run);

        if (!hasAppsScript) {
          apiScanIntent('CHANGE_DEPT', { department: deptId })
            .catch(err => {
              console.error('‚ùå CHANGE_DEPT API error:', err);
              showNotification('‚ùå B≈ÇƒÖd zapisu zmiany operacji: ' + (err?.message || err), 'error');
            });
        } else {
          sendToSpreadsheet(currentUser.login, deptId, 'zmieniam-operacje');
        }
        showNotification(`Zmieniono operacjƒô: ${deptName}`, 'success');
        
        setTimeout(() => {
            isLoggedIn = false;
            workerState = 'not-logged-in';
            currentUser = null;
            currentDepartment = null;
            document.getElementById('welcomeHeader').classList.remove('show');
            showView('department');
            ensureCodeInputFocus();
            showNotification('Gotowy do kolejnej operacji', 'info');
        }, 1500);
        
        return;
    }

    // Poka≈º widok weryfikacji EAN
    const deptName = departmentNames[deptId] || deptId;

    document.getElementById('selectedUserName').textContent = '(zeskanuj kod)';
    document.getElementById('selectedDepartmentName').textContent = deptName;

    // Ustaw placeholder - flaga ≈ºe czekamy na kod EAN
    selectedUserForVerification = { 
        login: null, 
        name: '(zeskanuj kod)', 
        waitingForScan: true
    };

    showView('verification');

    setTimeout(() => {
        const verificationInput = document.getElementById('verificationCodeInput');
        if (verificationInput) {
            verificationInput.value = '';
            verificationInput.focus();
        }
    }, 100);

    showNotification(`${deptName} - zeskanuj kod EAN`, 'info');
};

        // ===== FUNKCJA PLANOWANIA URLOP√ìW =====
            window.showVacationPlanning = function() {
                loadSavedTheme(); // Zastosuj dark mode
                console.log('Otwieranie planowania nieobecno≈õci...');
                
                // Wyczy≈õƒá poprzednie dane
                window.vacationMode = true;
                selectedUserForVacation = null;
                
                // Poka≈º widok weryfikacji
                showView('vacationVerification');
                
                // ‚úÖ IDENTYCZNIE JAK W L4:
                setTimeout(() => {
                    const input = document.getElementById('vacationVerificationCodeInput');
                    if (input) {
                        input.value = '';
                        input.focus();
                    }
                }, 100);
                
                showNotification('Zeskanuj sw√≥j kod EAN', 'info');
            };

        // ===== FUNKCJA WYBORU U≈ªYTKOWNIKA =====
        window.selectUser = function(userLogin) {
            if (window.vacationMode) {
                showVacationPlanning(userLogin);
                return;
            }

            if (userLogin === 'jerzyd') {
                console.log('üîÑ Sprawdzam wnioski dla kierownika...');
                
                if (typeof google !== 'undefined' && google.script) {
                    google.script.run
                        .withSuccessHandler(function(count) {
                            pendingVacationCount = count;
                            console.log('üìä Licznik zaktualizowany:', count);
                            
                            if (count > 0) {
                                console.log('‚úÖ SƒÖ oczekujƒÖce wnioski - panel kierownika');
                                selectedUserForVerification = { 
                                    login: userLogin, 
                                    name: 'Jerzy Dwurznik', 
                                    isManagerAccess: true 
                                };
                                
                                document.getElementById('selectedUserName').textContent = 'Jerzy Dwurznik';
                                document.getElementById('selectedDepartmentName').textContent = 'Panel Kierownika';
                                
                                showView('verification');
                                
                                setTimeout(() => {
                                    const verificationInput = document.getElementById('verificationCodeInput');
                                    if (verificationInput) {
                                        verificationInput.value = '';
                                        verificationInput.focus();
                                    }
                                }, 100);
                                
                                showNotification('Zweryfikuj to≈ºsamo≈õƒá aby zarzƒÖdzaƒá urlopami', 'info');
                                return;
                            } else {
                                console.log('‚ÑπÔ∏è Brak oczekujƒÖcych wniosk√≥w - normalny przep≈Çyw');
                                proceedWithNormalUserFlow(userLogin);
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('‚ùå B≈ÇƒÖd sprawdzania wniosk√≥w:', error);
                            proceedWithNormalUserFlow(userLogin);
                        })
                        .getPendingVacationCount();
                    
                    return;
                }
            }

            proceedWithNormalUserFlow(userLogin);
        };

        function proceedWithNormalUserFlow(userLogin) {
            let foundUser = null;
            let foundDepartment = null;

            for (const [deptId, dept] of Object.entries(departments)) {
                const user = dept.users.find(u => u.login === userLogin);
                if (user) {
                    foundUser = user;
                    foundDepartment = deptId;
                    break;
                }
            }
            
            if (foundUser) {
                selectedUserForVerification = foundUser;
                
                const departmentNames = {
                    'przyjecie': 'Przyjƒôcie dostaw',
                    'rozladunek': 'Roz≈Çadunek rƒôczny kontenera',
                    'zaladunek': 'Za≈Çadunek rƒôczny kontenera',
                    'relokacja': 'Relokacja',
                    'kompletacja': 'Kompletacja zam√≥wie≈Ñ',
                    'weryfikacja': 'Weryfikacja zam√≥wie≈Ñ',
                    'co-packing': 'Co-packing',
                    'operacje-porzadkowe': 'Operacje porzƒÖdkowe',
                    'inwentaryzacja': 'Inwentaryzacja'
                };
                
                const targetDepartment = currentDepartment || foundDepartment;
                const deptName = departmentNames[targetDepartment] || targetDepartment;
                
                document.getElementById('selectedUserName').textContent = foundUser.name;
                document.getElementById('selectedDepartmentName').textContent = deptName;
                
                showView('verification');
                
                setTimeout(() => {
                    const verificationInput = document.getElementById('verificationCodeInput');
                    if (verificationInput) {
                        verificationInput.value = '';
                        verificationInput.focus();
                    }
                }, 100);
                
                showNotification('Potwierd≈∫ swojƒÖ to≈ºsamo≈õƒá kodem EAN', 'info');
            }
        }

        // ===== WERYFIKACJA KODU U≈ªYTKOWNIKA =====
        window.confirmUserCode = function() {
    const inputCode = document.getElementById('verificationCodeInput').value.trim();
    
    if (!inputCode) {
        showNotification('Wpisz kod EAN', 'error');
        return;
    }
    
    if (!selectedUserForVerification) {
        showNotification('B≈ÇƒÖd: brak wybranego u≈ºytkownika', 'error');
        return;
    }

    const cleanInputCode = inputCode.replace(/^~+/, '').replace(/~+$/, '').trim();
    
    console.log('üîµ confirmUserCode - cleanInputCode:', cleanInputCode);
    console.log('üîµ confirmUserCode - selectedUserForVerification:', selectedUserForVerification);

    // ===== KIEROWNIK - PANEL URLOP√ìW =====
    if (selectedUserForVerification.isManagerAccess === true) {
        console.log('üü¢ Tryb kierownika - sprawdzam kod...');
        
        if (cleanInputCode === '1236737459372') {
            console.log('üü¢ Kod kierownika poprawny');
            
            // Pobierz dane zapisane przy pierwszym skanie
            const managerData = selectedUserForVerification.managerData;
            const foundDepartment = selectedUserForVerification.foundDepartment;
            
            selectedUserForVerification = null;
            
            // Sprawd≈∫ czy sƒÖ urlopy (dane ju≈º powinny byƒá za≈Çadowane w tle)
            if (pendingVacationCount > 0) {
                console.log('üìÖ SƒÖ oczekujƒÖce urlopy - otwieram panel urlop√≥w');
                showManagerVacation();
                showNotification('Panel urlop√≥w (' + pendingVacationCount + ' oczekujƒÖcych)', 'success');
            } else {
                console.log('‚ÑπÔ∏è Brak urlop√≥w - kontynuujƒô normalny flow');
                continueManagerFlowAfterVacationCheck(managerData, foundDepartment);
            }
            return;
        } else {
            showNotification('Nieprawid≈Çowy kod - tylko kierownik ma dostƒôp', 'error');
            document.getElementById('verificationCodeInput').value = '';
            document.getElementById('verificationCodeInput').focus();
            return;
        }
    }
    
    // ===== BEZPO≈öREDNI SKAN PO WYBRANIU KAFELKA OPERACJI =====
    if (selectedUserForVerification.waitingForScan === true) {
        console.log('üîµ Tryb bezpo≈õredniego skanu - szukam u≈ºytkownika po kodzie EAN');
                const hasAppsScript = (typeof google !== 'undefined' && google.script && google.script.run);

        // ‚úÖ TRYB API: szukamy pracownika po kodzie przez API (a nie w lokalnym departments)
        if (!hasAppsScript) {
            sessionStorage.setItem('currentEmployeeCode', cleanInputCode);

            apiLookupEmployeeByCode(cleanInputCode)
              .then(data => {
                if (!data || !data.success || !data.login) throw new Error('Nieprawid≈Çowy kod EAN');

                const foundUser = { login: data.login, name: data.name, status: data.status };
                console.log('‚úÖ Znaleziono u≈ºytkownika (API):', foundUser.login);

                currentUser = foundUser;

                const targetDepartment = currentDepartment;
                const userCurrentStatus = foundUser.status || 'Nieaktywny';
                const actionToSend = (userCurrentStatus === 'Pracuje' || userCurrentStatus === 'Na przerwie')
                  ? 'zmieniam-operacje'
                  : 'wchodzi';

                const intent = (actionToSend === 'zmieniam-operacje') ? 'CHANGE_DEPT' : 'ENTRY';

                apiScanIntent(intent, { department: targetDepartment })
                  .then(() => {
                    refreshLiveWorkforce();                // od razu
                    setTimeout(refreshLiveWorkforce, 600); // dogrywka
                  })
                  .catch(err => {
                    console.error('‚ùå Direct scan API error:', err);
                    showNotification('‚ùå B≈ÇƒÖd zapisu: ' + (err?.message || err), 'error');
                  });

                const departmentNames = {
                    'przyjecie': 'Przyjƒôcie dostaw',
                    'rozladunek': 'Roz≈Çadunek rƒôczny kontenera',
                    'zaladunek': 'Za≈Çadunek rƒôczny kontenera',
                    'relokacja': 'Relokacja',
                    'kompletacja': 'Kompletacja zam√≥wie≈Ñ',
                    'weryfikacja': 'Weryfikacja zam√≥wie≈Ñ',
                    'co-packing': 'Co-packing',
                    'operacje-porzadkowe': 'Operacje porzƒÖdkowe',
                    'inwentaryzacja': 'Inwentaryzacja'
                };

                const deptName = departmentNames[targetDepartment] || targetDepartment;

                if (actionToSend === 'zmieniam-operacje') {
                    showNotification(foundUser.login + ' zmieniono operacjƒô na: ' + deptName, 'success');
                } else {
                    showNotification(foundUser.login + ' zalogowany do: ' + deptName, 'success');
                }

                setTimeout(function() {
                    currentUser = null;
                    selectedUserForVerification = null;
                    showView('department');
                    ensureCodeInputFocus();
                    showNotification('Gotowy do kolejnej operacji', 'info');
                }, 2000);
              })
              .catch(err => {
                showNotification('Nieprawid≈Çowy kod EAN', 'error');
                document.getElementById('verificationCodeInput').value = '';
                document.getElementById('verificationCodeInput').focus();
              });

            return;
        }
        
        // Znajd≈∫ u≈ºytkownika po kodzie EAN
        let foundUser = null;
        for (const [deptId, dept] of Object.entries(departments)) {
            const user = dept.users.find(u => {
                const storedCode = u.code.toString().replace(/^~+/, '').replace(/~+$/, '').trim();
                return storedCode === cleanInputCode;
            });
            if (user) {
                foundUser = user;
                break;
            }
        }
        
        if (!foundUser) {
            showNotification('Nieprawid≈Çowy kod EAN', 'error');
            document.getElementById('verificationCodeInput').value = '';
            document.getElementById('verificationCodeInput').focus();
            return;
        }
        
        console.log('‚úÖ Znaleziono u≈ºytkownika:', foundUser.login);
        
        // Ustaw u≈ºytkownika
        currentUser = foundUser;
        
        const targetDepartment = currentDepartment;
        const userCurrentStatus = foundUser.status || 'Nieaktywny';
        let actionToSend = 'wchodzi';
        
        if (userCurrentStatus === 'Pracuje' || userCurrentStatus === 'Na przerwie') {
            actionToSend = 'zmieniam-operacje';
        }
        
        // Wy≈õlij do arkusza
        if (typeof google !== 'undefined' && google.script) {
            sendToSpreadsheet(currentUser.login, targetDepartment, actionToSend);
        }
        
        const departmentNames = {
            'przyjecie': 'Przyjƒôcie dostaw',
            'rozladunek': 'Roz≈Çadunek rƒôczny kontenera',
            'zaladunek': 'Za≈Çadunek rƒôczny kontenera',
            'relokacja': 'Relokacja',
            'kompletacja': 'Kompletacja zam√≥wie≈Ñ',
            'weryfikacja': 'Weryfikacja zam√≥wie≈Ñ',
            'co-packing': 'Co-packing',
            'operacje-porzadkowe': 'Operacje porzƒÖdkowe',
            'inwentaryzacja': 'Inwentaryzacja'
        };
        
        const deptName = departmentNames[targetDepartment] || targetDepartment;
        
        if (actionToSend === 'zmieniam-operacje') {
            showNotification(currentUser.login + ' zmieniono operacjƒô na: ' + deptName, 'success');
        } else {
            showNotification(currentUser.login + ' zalogowany do: ' + deptName, 'success');
        }
        
        // Reset i powr√≥t do g≈Ç√≥wnego widoku
        setTimeout(function() {
            currentUser = null;
            selectedUserForVerification = null;
            showView('department');
            ensureCodeInputFocus();
            showNotification('Gotowy do kolejnej operacji', 'info');
        }, 2000);
        
        return;
    }
    
    // ===== NORMALNY U≈ªYTKOWNIK (wybrany z listy) =====
    console.log('üîµ Normalny u≈ºytkownik - weryfikacja kodu');
    
    if (typeof google === 'undefined' || !google.script) {
        // Tryb testowy
        const cleanStoredCode = selectedUserForVerification.code.toString().replace(/^~+/, '').replace(/~+$/, '').trim();
        
        if (cleanInputCode === cleanStoredCode) {
            currentUser = selectedUserForVerification;
            showNotification(currentUser.login + ' - weryfikacja pomy≈õlna (tryb testowy)', 'success');
            
            setTimeout(function() {
                currentUser = null;
                selectedUserForVerification = null;
                showView('department');
                ensureCodeInputFocus();
            }, 2000);
        } else {
            showNotification('Nieprawid≈Çowy kod EAN', 'error');
            document.getElementById('verificationCodeInput').value = '';
            document.getElementById('verificationCodeInput').focus();
        }
        return;
    }
    
    // Wywo≈Çanie backendu
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                currentUser = result.user;
                const targetDepartment = currentDepartment;
                
                const userCurrentStatus = result.user.status;
                let actionToSend = 'wchodzi';
                
                if (userCurrentStatus === 'Pracuje' || userCurrentStatus === 'Na przerwie') {
                    actionToSend = 'zmieniam-operacje';
                }
                
                sendToSpreadsheet(currentUser.login, targetDepartment, actionToSend);
                
                const departmentNames = {
                    'przyjecie': 'Przyjƒôcie dostaw',
                    'rozladunek': 'Roz≈Çadunek rƒôczny kontenera',
                    'zaladunek': 'Za≈Çadunek rƒôczny kontenera',
                    'relokacja': 'Relokacja',
                    'kompletacja': 'Kompletacja zam√≥wie≈Ñ',
                    'weryfikacja': 'Weryfikacja zam√≥wie≈Ñ',
                    'co-packing': 'Co-packing',
                    'operacje-porzadkowe': 'Operacje porzƒÖdkowe',
                    'inwentaryzacja': 'Inwentaryzacja'
                };
                
                const deptName = departmentNames[targetDepartment] || targetDepartment;
                
                if (actionToSend === 'zmieniam-operacje') {
                    showNotification(currentUser.login + ' zmieniono operacjƒô na: ' + deptName, 'success');
                } else {
                    showNotification(currentUser.login + ' zalogowany do: ' + deptName, 'success');
                }
                
                setTimeout(function() {
                    currentUser = null;
                    selectedUserForVerification = null;
                    showView('department');
                    ensureCodeInputFocus();
                    showNotification('Gotowy do kolejnej operacji', 'info');
                }, 2000);
            } else {
                showNotification(result.message, 'error');
                document.getElementById('verificationCodeInput').value = '';
                document.getElementById('verificationCodeInput').focus();
            }
        })
        .withFailureHandler(function(error) {
            console.error('B≈ÇƒÖd weryfikacji kodu:', error);
            showNotification('B≈ÇƒÖd weryfikacji kodu', 'error');
        })
        .verifyUserCode(selectedUserForVerification.login, inputCode);
};
        
        // Funkcja ko≈ÑczƒÖca rejestracjƒô (po og≈Çoszeniach)
        function completeRegistration() {
            const targetDepartment = currentDepartment;
            
            const userCurrentStatus = currentUser.status;
            let actionToSend = 'wchodzi';
            
            if (userCurrentStatus === 'Pracuje' || userCurrentStatus === 'Na przerwie') {
                actionToSend = 'zmieniam-operacje';
            }
            
            sendToSpreadsheet(currentUser.login, targetDepartment, actionToSend);
            
            const departmentNames = {
                'przyjecie': 'Przyjƒôcie dostaw',
                'rozladunek': 'Roz≈Çadunek rƒôczny kontenera',
                'zaladunek': 'Za≈Çadunek rƒôczny kontenera',
                'relokacja': 'Relokacja',
                'kompletacja': 'Kompletacja zam√≥wie≈Ñ',
                'weryfikacja': 'Weryfikacja zam√≥wie≈Ñ',
                'co-packing': 'Co-packing',
                'operacje-porzadkowe': 'Operacje porzƒÖdkowe',
                'inwentaryzacja': 'Inwentaryzacja'
            };
            
            const deptName = departmentNames[targetDepartment] || targetDepartment;
            
            if (actionToSend === 'zmieniam-operacje') {
                showNotification(`${currentUser.login} zmieniono operacjƒô na: ${deptName}`, 'success');
            } else {
                showNotification(`${currentUser.login} zalogowany do: ${deptName}`, 'success');
            }
            
            setTimeout(() => {
                currentUser = null;
                selectedUserForVerification = null;
                showView('department');
                ensureCodeInputFocus();
                showNotification('Gotowy do kolejnej operacji', 'info');
            }, 500);
        }

        // ===== WERYFIKACJA KODU URLOPOWEGO =====
        window.confirmVacationUserCode = function() {
            const inputCode = document.getElementById('vacationVerificationCodeInput').value.trim();
            
            if (!inputCode) {
                showNotification('Wpisz kod EAN', 'error');
                return;
            }
            
            const cleanInputCode = inputCode.replace(/^~+/, '').replace(/~+$/, '').trim();
            
            console.log('Weryfikacja urlopu - kod po oczyszczeniu:', cleanInputCode);
            
            // ‚úÖ ZMIANA: Znajd≈∫ u≈ºytkownika po kodzie EAN (bez wcze≈õniejszego wyboru)
            let foundUser = null;
            for (const [deptId, dept] of Object.entries(departments)) {
                const user = dept.users.find(u => {
                    const storedCode = u.code.toString().replace(/^~+/, '').replace(/~+$/, '').trim();
                    return storedCode === cleanInputCode;
                });
                if (user) {
                    foundUser = user;
                    break;
                }
            }
            
            if (foundUser) {
                currentUser = foundUser;
                selectedUserForVacation = null;
                
                // Poka≈º wyb√≥r typu nieobecno≈õci
                showAbsenceTypeSelection();
                showNotification('Weryfikacja pomy≈õlna - wybierz rodzaj nieobecno≈õci', 'success');
            } else {
                showNotification('Nieprawid≈Çowy kod EAN', 'error');
                document.getElementById('vacationVerificationCodeInput').value = '';
                document.getElementById('vacationVerificationCodeInput').focus();
            }
        };

        // ===== FUNKCJA OBS≈ÅUGI AKCJI =====
        window.handleAction = function(action) {
        loadSavedTheme(); // Zastosuj dark mode
        const hasAppsScript = (typeof google !== 'undefined' && google.script && google.script.run);
            
        const button = document.getElementById(action + '-btn');
        if (button && button.classList.contains('disabled')) {
            return;
        }
    
        const now = new Date();
        const timeString = now.toLocaleTimeString('pl-PL');
        
        document.getElementById('lastActivity').textContent = timeString;
    
    // ===== WCHODZƒò DO PRACY =====
    if (action === 'wchodzi') {
        if (!currentUser || !currentDepartment) return;
        
        // 1. NATYCHMIAST - poka≈º sukces i wr√≥ƒá do g≈Ç√≥wnego widoku
        showNotification('‚úÖ Zalogowano do pracy o ' + timeString, 'success');
        
        userStatuses[currentUser.login] = 'logged-in-working';
        
        const userToSave = currentUser.login;
        const deptToSave = currentDepartment;
        
        // Reset UI natychmiast
        setTimeout(() => {
            isLoggedIn = false;
            workerState = 'not-logged-in';
            currentUser = null;
            currentDepartment = null;
            document.getElementById('welcomeHeader').classList.remove('show');
            showView('department');
            ensureCodeInputFocus();
        }, 300);
        
        // 2. W TLE - zapis (Pages: API /scan + intent, GS: stary zapis)
        if (!hasAppsScript) {
          apiScanIntent('ENTRY', { department: deptToSave })
            .catch(err => {
              console.error('‚ùå ENTRY API error:', err);
              showNotification('‚ùå B≈ÇƒÖd zapisu ENTRY: ' + (err?.message || err), 'error');
            });
        } else {
          sendToSpreadsheetAsync(userToSave, deptToSave, action);
        }
        return;
    }
    
    // ===== WYCHODZƒò Z PRACY =====
    if (action === 'wychodzi-pracy') {
        if (!currentUser) return;
        
        // 1. NATYCHMIAST - poka≈º sukces
        showNotification('‚úÖ Wylogowano z pracy o ' + timeString, 'success');
        
        userStatuses[currentUser.login] = 'not-logged-in';
        
        const userToSave = currentUser.login;
        const deptToSave = currentDepartment;
        
        // Reset UI natychmiast
        setTimeout(() => {
            isLoggedIn = false;
            workerState = 'not-logged-in';
            currentUser = null;
            currentDepartment = null;
            document.getElementById('welcomeHeader').classList.remove('show');
            showView('department');
            ensureCodeInputFocus();
        }, 300);
        
        // 2. W TLE - zapis (Pages: API /scan + intent, GS: stary zapis)
        if (!hasAppsScript) {
          apiScanIntent('EXIT', { department: deptToSave })
            .catch(err => {
              console.error('‚ùå EXIT API error:', err);
              showNotification('‚ùå B≈ÇƒÖd zapisu EXIT: ' + (err?.message || err), 'error');
            });
        } else {
          sendToSpreadsheetAsync(userToSave, deptToSave, 'wychodzi-pracy');
        }
        return;
    }
    
    // ===== ZMIENIAM OPERACJƒò =====
    if (action === 'zmieniam-operacje') {
        window.isChangingOperation = true;
        
        document.getElementById('departmentView').querySelector('.view-title').textContent = 
            `${currentUser.login} - Wybierz nowƒÖ operacjƒô`;
        
        showView('department');
        showNotification('Wybierz nowƒÖ operacjƒô', 'info');
        return;
    }
    
    // ===== PRZERWA (wychodzƒô/wracam) - z modalem potwierdzenia =====
    if (action === 'wychodzi-przerwa' || action === 'wracam') {
        const fullTimeString = now.toISOString().slice(0, 19).replace('T', ' ');
        showConfirmationModal(action, fullTimeString);
        return;
    }
};

        // ===== SYSTEM NIEOBECNO≈öCI - WYB√ìR TYPU =====

        /**
         * Pokazuje widok wyboru typu nieobecno≈õci (po weryfikacji EAN)
         */
        function showAbsenceTypeSelection() {
        if (!currentUser) {
            showNotification('B≈ÇƒÖd: brak wybranego u≈ºytkownika', 'error');
            return;
        }
        
        // Ustaw nazwƒô u≈ºytkownika
        document.getElementById('absenceTypeUserName').textContent = currentUser.name;
        
        // Za≈Çaduj saldo urlopowe
        loadAbsenceTypeBalance();
        
        // Za≈Çaduj historiƒô wniosk√≥w
        loadAbsenceTypeRequests();
        
        // Poka≈º widok
        showView('absenceType');
        
        showNotification('Wybierz rodzaj nieobecno≈õci', 'info');
    }

        /**
         * ≈Åaduje saldo urlopowe dla widoku wyboru typu
         */
        function loadAbsenceTypeBalance() {
        if (typeof google === 'undefined' || !google.script) {
            document.getElementById('absTypePrzys≈ÇugujƒÖcy').textContent = '26';
            document.getElementById('absTypeZaleg≈Çy').textContent = '0';
            document.getElementById('absTypeWykorzystany').textContent = '5';
            document.getElementById('absTypePozosta≈Çy').textContent = '21';
            return;
        }
        
        google.script.run
            .withSuccessHandler(function(balance) {
                document.getElementById('absTypePrzys≈ÇugujƒÖcy').textContent = balance.przys≈ÇugujƒÖcy || 0;
                document.getElementById('absTypeZaleg≈Çy').textContent = balance.zaleg≈Çy || 0;
                document.getElementById('absTypeWykorzystany').textContent = balance.wykorzystany || 0;
                document.getElementById('absTypePozosta≈Çy').textContent = balance.pozosta≈Çy || 0;
                
                // Zapisz do cache
                userVacationBalances[currentUser.login] = balance;
                
                // ‚úÖ NOWE: Wizualnie zablokuj kafelek urlopu je≈õli 0 dni
                updateVacationTileState(balance.pozosta≈Çy);
            })
            .withFailureHandler(function(error) {
                console.error('B≈ÇƒÖd ≈Çadowania salda:', error);
            })
            .getUserVacationBalance(currentUser.login);
    }

    /**
 * Aktualizuje stan kafelka urlopu wypoczynkowego (aktywny/zablokowany)
 */
function updateVacationTileState(pozostalyDni) {
    // Znajd≈∫ kafelek urlopu wypoczynkowego
    const vacationTiles = document.querySelectorAll('#absenceTypeView .tile');
    
    vacationTiles.forEach(tile => {
        if (tile.textContent.includes('Urlop wypoczynkowy')) {
            if (pozostalyDni <= 0) {
                // Zablokuj kafelek
                tile.style.opacity = '0.5';
                tile.style.cursor = 'not-allowed';
                tile.style.position = 'relative';
                
                // Dodaj informacjƒô o braku dni
                let badge = tile.querySelector('.no-days-badge');
                if (!badge) {
                    badge = document.createElement('div');
                    badge.className = 'no-days-badge';
                    badge.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: #dc3545;
                        color: white;
                        padding: 4px 8px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: bold;
                    `;
                    badge.textContent = '0 dni';
                    tile.appendChild(badge);
                }
            } else {
                // Odblokuj kafelek
                tile.style.opacity = '1';
                tile.style.cursor = 'pointer';
                
                // Usu≈Ñ badge je≈õli istnieje
                const badge = tile.querySelector('.no-days-badge');
                if (badge) badge.remove();
            }
        }
    });
}

                    /**
             * ≈Åaduje CA≈ÅƒÑ historiƒô wniosk√≥w dla widoku wyboru typu (wszystkie typy nieobecno≈õci)
             */
            function loadAbsenceTypeRequests() {
                const container = document.getElementById('absenceTypeRequests');
                container.innerHTML = '<p style="text-align: center;">‚è≥ ≈Åadowanie historii wniosk√≥w...</p>';
                
                if (typeof google === 'undefined' || !google.script) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">Tryb testowy - brak po≈ÇƒÖczenia z backendem</p>';
                    return;
                }
                
                google.script.run
                    .withSuccessHandler(function(requests) {
                        if (!requests || requests.length === 0) {
                            container.innerHTML = '<p style="text-align: center; color: #666;">Brak z≈Ço≈ºonych wniosk√≥w</p>';
                            return;
                        }
                        
                        // Poka≈º ostatnie 10 wniosk√≥w (wszystkich typ√≥w)
                        const recentRequests = requests.slice(0, 10);
                        
                        let html = '<div class="vacation-last-title">üìã Ostatnie wnioski:</div>';
                        
                        recentRequests.forEach(request => {
                            const statusColor = getStatusColor(request.status);
                            const statusClass = request.status === 'Zatwierdzony' ? 'approved' : 
                                              request.status === 'Odrzucony' ? 'rejected' : 'pending';
                            
                            // Formatowanie daty
                            let dateDisplay = request.dateFrom;
                            if (request.dateFrom !== request.dateTo && request.type !== 'yearplan') {
                                dateDisplay = request.dateFrom + ' - ' + request.dateTo;
                            }
                            
                            // Dla planu rocznego poka≈º rok
                            if (request.type === 'yearplan') {
                                dateDisplay = request.details;
                            }
                            
                            html += `
                                <div class="vacation-request-item ${statusClass}" style="border-left: 4px solid ${getTypeColor(request.type)};">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <span style="font-size: 16px;">${request.typeIcon}</span>
                                            <strong>${request.typeName}</strong>
                                        </div>
                                        <div style="color: ${statusColor}; font-weight: bold; font-size: 12px;">
                                            ${request.status}
                                        </div>
                                    </div>
                                    <div style="margin: 5px 0;">
                                        <strong>${dateDisplay}</strong> 
                                        ${request.days ? '(' + request.days + ' dni)' : ''}
                                    </div>
                                   <div style="font-size: 11px; color: #666;">
                                      ${request.details ? request.details + ' ‚Ä¢ ' : ''}Z≈Ço≈ºony: ${request.dateSubmitted}
                                  </div>
                                </div>
                            `;
                        });
                        
                        if (requests.length > 10) {
                            html += `<p style="text-align: center; color: #666; margin-top: 10px;">
                                ... i ${requests.length - 10} wiƒôcej wniosk√≥w
                            </p>`;
                        }
                        
                        container.innerHTML = html;
                    })
                    .withFailureHandler(function(error) {
                        console.error('B≈ÇƒÖd ≈Çadowania historii:', error);
                        container.innerHTML = '<p style="color: red;">‚ùå B≈ÇƒÖd ≈Çadowania wniosk√≥w</p>';
                    })
                    .getUserAllAbsenceHistory(currentUser.login);
            }

            /**
            * Zwraca kolor dla typu wniosku (do border-left)
            */
            function getTypeColor(type) {
                const colors = {
                    'vacation': '#2196F3',    // niebieski - urlopy
                    'dayoff': '#4CAF50',      // zielony - dni wolne
                    'occasional': '#9C27B0',  // fioletowy - okoliczno≈õciowe
                    'yearplan': '#FF9800'     // pomara≈Ñczowy - plan roczny
                };
                return colors[type] || '#666';
            }

            /**
             * ≈Åaduje historiƒô wniosk√≥w o dzie≈Ñ wolny (tylko dla widoku dayOffView)
             */
            function loadDayOffHistory() {
                console.log('üîµ loadDayOffHistory() - START');
                console.log('üîµ currentUser:', currentUser);
                console.log('üîµ currentUser.login:', currentUser?.login);
                
                const container = document.getElementById('dayOffRequests');
                console.log('üîµ container znaleziony:', !!container);
                
                if (!container) {
                    console.log('‚ùå Nie znaleziono kontenera dayOffRequests');
                    return;
                }
                
                container.innerHTML = '<p style="text-align: center;">‚è≥ ≈Åadowanie historii...</p>';
                
                if (typeof google === 'undefined' || !google.script) {
                    console.log('‚ö†Ô∏è Tryb testowy - brak google.script');
                    container.innerHTML = '<p style="text-align: center; color: #666;">Tryb testowy</p>';
                    return;
                }
                
                console.log('üîµ Wywo≈Çujƒô getDayOffRequests dla:', currentUser.login);
                
                google.script.run
                    .withSuccessHandler(function(requests) {
                        console.log('‚úÖ getDayOffRequests - odpowied≈∫:', requests);
                        console.log('‚úÖ Liczba wniosk√≥w:', requests ? requests.length : 'NULL');
                        
                        if (!requests || requests.length === 0) {
                            container.innerHTML = '<p style="text-align: center; color: #666;">Brak wniosk√≥w o dzie≈Ñ wolny</p>';
                            return;
                        }
                        
                        let html = '<div style="font-weight: bold; margin-bottom: 10px;">üìÖ Twoje wnioski o dzie≈Ñ wolny:</div>';
                        
                        requests.forEach(function(request, index) {
                            console.log('üîµ Przetwarzam wniosek #' + index + ':', request);
                            
                            const statusColor = getStatusColor(request.status);
                            const statusClass = request.status === 'Zatwierdzony' ? 'approved' : 
                                              request.status === 'Odrzucony' ? 'rejected' : 'pending';
                            
                            // Formatuj datƒô
                            let dateDisplay = request.date;
                            if (typeof request.date === 'object' && request.date !== null) {
                                dateDisplay = request.date.toISOString().split('T')[0];
                            }
                            
                            // Godziny (je≈õli wyj≈õcie prywatne)
                            let timeInfo = '';
                            if (request.timeFrom && request.timeTo) {
                                timeInfo = ' (' + request.timeFrom + ' - ' + request.timeTo + ')';
                            }
                            
                            html += '<div class="vacation-request-item ' + statusClass + '">';
                            html += '<div style="display: flex; justify-content: space-between; align-items: start;">';
                            html += '<div><strong>' + dateDisplay + '</strong>' + timeInfo + '</div>';
                            html += '<div style="color: ' + statusColor + '; font-weight: bold; font-size: 12px;">' + request.status + '</div>';
                            html += '</div>';
                            html += '<div style="margin: 5px 0; font-size: 13px;">' + request.type + '</div>';
                            
                            if (request.reason) {
                                html += '<div style="font-size: 11px; color: #666;">Pow√≥d: ' + request.reason + '</div>';
                            }
                            if (request.managerComment) {
                                html += '<div style="font-size: 11px; color: #1976d2; margin-top: 5px;">üí¨ Kierownik: ' + request.managerComment + '</div>';
                            }
                            
                            if (request.status === 'Zatwierdzony') {
                                html += '<button onclick="downloadDayOffPDF(' + request.id + ')" style="margin-top: 8px; padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üìÑ Pobierz PDF</button>';
                            }
                            
                            html += '</div>';
                        });
                        
                        console.log('üîµ Ustawiam HTML...');
                        container.innerHTML = html;
                        console.log('‚úÖ Historia za≈Çadowana!');
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå B≈ÇƒÖd getDayOffRequests:', error);
                        container.innerHTML = '<p style="color: red;">‚ùå B≈ÇƒÖd ≈Çadowania: ' + error.message + '</p>';
                    })
                    .getDayOffRequests(currentUser.login);
            }

          /**
           * ≈Åaduje historiƒô wniosk√≥w o urlop okoliczno≈õciowy (tylko dla widoku occasionalLeaveView)
           */
          function loadOccasionalLeaveHistory() {
              const container = document.getElementById('occasionalRequests');
              if (!container) return;
              
              container.innerHTML = '<p style="text-align: center;">‚è≥ ≈Åadowanie historii...</p>';
              
              if (typeof google === 'undefined' || !google.script) {
                  container.innerHTML = '<p style="text-align: center; color: #666;">Tryb testowy</p>';
                  return;
              }
              
              google.script.run
                  .withSuccessHandler(function(requests) {
                      if (!requests || requests.length === 0) {
                          container.innerHTML = '<p style="text-align: center; color: #666;">Brak wniosk√≥w o urlop okoliczno≈õciowy</p>';
                          return;
                      }
                      
                      let html = '<div style="font-weight: bold; margin-bottom: 10px;">üéä Twoje wnioski o urlop okoliczno≈õciowy:</div>';
                      
                      requests.forEach(request => {
                          const statusColor = getStatusColor(request.status);
                          const statusClass = request.status === 'Zatwierdzony' ? 'approved' : 
                                            request.status === 'Odrzucony' ? 'rejected' : 'pending';
                          
                          // Formatuj daty
                          const dateFromDisplay = typeof request.dateFrom === 'object' ? 
                              request.dateFrom.toISOString().split('T')[0] : request.dateFrom;
                          const dateToDisplay = typeof request.dateTo === 'object' ? 
                              request.dateTo.toISOString().split('T')[0] : request.dateTo;
                          
                          const dateDisplay = dateFromDisplay === dateToDisplay ? 
                              dateFromDisplay : `${dateFromDisplay} - ${dateToDisplay}`;
                          
                          html += `
                              <div class="vacation-request-item ${statusClass}">
                                  <div style="display: flex; justify-content: space-between; align-items: start;">
                                      <div>
                                          <strong>${dateDisplay}</strong> (${request.days} dni)
                                      </div>
                                      <div style="color: ${statusColor}; font-weight: bold; font-size: 12px;">
                                          ${request.status}
                                      </div>
                                  </div>
                                  <div style="margin: 5px 0; font-size: 13px; background: #f3e5f5; padding: 4px 8px; border-radius: 4px; display: inline-block;">
                                      üéä ${request.type}
                                  </div>
                                  ${request.note ? `<div style="font-size: 11px; color: #666; margin-top: 5px;">Notatka: ${request.note}</div>` : ''}
                                  ${request.managerComment ? `<div style="font-size: 11px; color: #1976d2; margin-top: 5px;">üí¨ Kierownik: ${request.managerComment}</div>` : ''}
                                  
                                  ${request.status === 'Zatwierdzony' ? `
                                      <button onclick="downloadOccasionalLeavePDF(${request.id})" 
                                              style="margin-top: 8px; padding: 5px 10px; background: #9C27B0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                          üìÑ Pobierz PDF
                                      </button>
                                  ` : ''}
                              </div>
                          `;
                      });
                      
                      container.innerHTML = html;
                  })
                  .withFailureHandler(function(error) {
                      console.error('B≈ÇƒÖd:', error);
                      container.innerHTML = '<p style="color: red;">‚ùå B≈ÇƒÖd ≈Çadowania</p>';
                  })
                  .getOccasionalLeaveRequests(currentUser.login);
          }

       /**
       * Obs≈Çuga wyboru typu nieobecno≈õci
       */
          window.selectAbsenceType = function(type) {
        console.log('Wybrano typ nieobecno≈õci:', type);
        
        // Sprawd≈∫ saldo dla urlopu wypoczynkowego
        if (type === 'vacation') {
            const balance = userVacationBalances[currentUser.login];
            const pozostaly = balance ? balance.pozosta≈Çy : 0;
            
            if (pozostaly <= 0) {
                showNotification('‚ùå Nie masz dostƒôpnych dni urlopu wypoczynkowego! Pozosta≈Ço: 0 dni', 'error');
                return; // Nie otwieraj formularza
            }
        }
        
        switch(type) {
            case 'vacation':
                // Urlop wypoczynkowy - istniejƒÖcy formularz
                setupVacationForm();
                showView('vacation');
                break;
                
            case 'dayoff':
                // Dzie≈Ñ wolny - formularz
                showDayOffForm();
                setTimeout(function() {
                    loadDayOffHistory();
                }, 100);
                break;
                
            case 'occasional':
                // Urlop okoliczno≈õciowy
                showOccasionalLeaveForm();
                setTimeout(function() {
                    loadOccasionalLeaveHistory();
                }, 100);
                break;
                
            case 'yearplan':
                // Plan roczny - kalendarz
                showYearPlanView();
                break;
                
            default:
                showNotification('Nieznany typ nieobecno≈õci', 'error');
        }
    };

        // ===== FORMULARZ DZIE≈É WOLNY =====

        /**
         * Pokazuje formularz dnia wolnego
         */
        function showDayOffForm() {
            if (!currentUser) {
                showNotification('B≈ÇƒÖd: brak wybranego u≈ºytkownika', 'error');
                return;
            }
            
            // Ustaw nazwƒô u≈ºytkownika
            document.getElementById('dayOffUserName').textContent = currentUser.name;
            
            // Wyczy≈õƒá formularz
            document.getElementById('dayOffType').value = '';
            document.getElementById('dayOffDate').value = '';
            document.getElementById('dayOffTimeFrom').value = '';
            document.getElementById('dayOffTimeTo').value = '';
            document.getElementById('dayOffReason').value = '';
            document.getElementById('dayOffLimitInfo').style.display = 'none';
            document.getElementById('dayOffHoursSection').style.display = 'none';
            document.getElementById('dayOffReasonRequired').style.display = 'none';
            
            // Ustaw domy≈õlnƒÖ datƒô na dzi≈õ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dayOffDate').value = today;
            
            // Poka≈º widok
            showView('dayOff');
            
            showNotification('Wype≈Çnij formularz dnia wolnego', 'info');
            
            // ‚úÖ DODANE: Za≈Çaduj historiƒô wniosk√≥w
            console.log('üîµ Wywo≈Çujƒô loadDayOffHistory z showDayOffForm');
            loadDayOffHistory();
        }

        /**
         * Obs≈Çuga zmiany typu dnia wolnego
         */
        window.onDayOffTypeChange = function() {
            const type = document.getElementById('dayOffType').value;
            const limitInfo = document.getElementById('dayOffLimitInfo');
            const limitText = document.getElementById('dayOffLimitText');
            const hoursSection = document.getElementById('dayOffHoursSection');
            const reasonRequired = document.getElementById('dayOffReasonRequired');
            
            // Reset
            limitInfo.style.display = 'none';
            hoursSection.style.display = 'none';
            reasonRequired.style.display = 'none';
            
            switch(type) {
                case 'opieka':
                    limitInfo.style.display = 'block';
                    limitInfo.className = 'vacation-info';
                    limitText.innerHTML = 'üë∂ <strong>Opieka nad dzieckiem (Art. 188 KP)</strong><br>' +
                        'Przys≈Çuguje 2 dni w roku kalendarzowym dla pracownika wychowujƒÖcego dziecko do 14 lat.<br>' +
                        '<small>Mo≈ºna wykorzystaƒá jednorazowo lub w czƒô≈õciach (tak≈ºe jako 16 godzin).</small>';
                    break;
                    
                case 'sila_wyzsza':
                    limitInfo.style.display = 'block';
                    limitInfo.className = 'vacation-info';
                    limitText.innerHTML = '‚ö° <strong>Zwolnienie z powodu si≈Çy wy≈ºszej (Art. 148¬π KP)</strong><br>' +
                        'Przys≈Çuguje 2 dni (lub 16 godzin) w roku kalendarzowym.<br>' +
                        '<small>Z powodu pilnych spraw rodzinnych (choroba, wypadek) wymagajƒÖcych natychmiastowej obecno≈õci.</small>';
                    break;
                    
                case 'wyjscie_prywatne':
                    hoursSection.style.display = 'block';
                    limitInfo.style.display = 'block';
                    limitInfo.className = 'vacation-info collision-warning';
                    limitText.innerHTML = 'üö∂ <strong>Wyj≈õcie prywatne</strong><br>' +
                        'Wyj≈õcie prywatne wymaga odpracowania w uzgodnionym terminie.';
                    break;
                    
                case 'inny':
                    reasonRequired.style.display = 'inline';
                    limitInfo.style.display = 'block';
                    limitInfo.className = 'vacation-info';
                    limitText.innerHTML = 'üìã <strong>Inny rodzaj dnia wolnego</strong><br>' +
                        'Opisz pow√≥d w polu poni≈ºej.';
                    break;
                    
                case 'nadgodziny':
                    limitInfo.style.display = 'block';
                    limitInfo.className = 'vacation-info';
                    limitText.innerHTML = 'üïê <strong>Odbi√≥r za nadgodziny</strong><br>' +
                        'Dzie≈Ñ wolny w zamian za przepracowane godziny nadliczbowe.';
                    break;
                    
                case 'swieto':
                    limitInfo.style.display = 'block';
                    limitInfo.className = 'vacation-info';
                    limitText.innerHTML = 'üéå <strong>Dzie≈Ñ wolny za ≈õwiƒôto</strong><br>' +
                        'Dzie≈Ñ wolny w zamian za ≈õwiƒôto przypadajƒÖce w sobotƒô.';
                    break;
            }
        };

        /**
        * Wysy≈Ça wniosek o dzie≈Ñ wolny
        */
        window.submitDayOff = function() {
            const type = document.getElementById('dayOffType').value;
            const date = document.getElementById('dayOffDate').value;
            const reason = document.getElementById('dayOffReason').value.trim();
            const timeFrom = document.getElementById('dayOffTimeFrom').value;
            const timeTo = document.getElementById('dayOffTimeTo').value;
            
            // Walidacja
            if (!type) {
                showNotification('‚ùå Wybierz rodzaj dnia wolnego', 'error');
                return;
            }
            
            if (!date) {
                showNotification('‚ùå Wybierz datƒô', 'error');
                return;
            }
            
            if (type === 'inny' && !reason) {
                showNotification('‚ùå Podaj pow√≥d dnia wolnego', 'error');
                return;
            }
            
            if (type === 'wyjscie_prywatne' && (!timeFrom || !timeTo)) {
                showNotification('‚ùå Podaj godziny wyj≈õcia', 'error');
                return;
            }
            
            // Przygotuj dane
            const dayOffData = {
                login: currentUser.login,
                name: currentUser.name,
                type: type,
                date: date,
                reason: reason,
                timeFrom: timeFrom || '',
                timeTo: timeTo || ''
            };
            
            console.log('Wysy≈Çam wniosek o dzie≈Ñ wolny:', dayOffData);
            
            // Sprawd≈∫ czy backend dostƒôpny
            if (typeof google === 'undefined' || !google.script) {
                showNotification('‚úÖ Wniosek z≈Ço≈ºony (tryb testowy)', 'success');
                setTimeout(() => {
                    showView('absenceType');
                }, 2000);
                return;
            }
            
            // Poka≈º ≈Çadowanie
            showNotification('‚è≥ Wysy≈Çam wniosek...', 'info');
            
            // 1. NATYCHMIAST - poka≈º sukces
    showNotification('‚úÖ Wniosek o dzie≈Ñ wolny z≈Ço≈ºony!', 'success');
    
    // 2. NATYCHMIAST - wr√≥ƒá do wyboru typu
    setTimeout(() => {
        updateManagerNotificationBadge();
        showView('absenceType');
    }, 500);
    
    // 3. W TLE - zapisz do backendu
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                console.log('‚úÖ Dzie≈Ñ wolny zapisany');
            } else {
                showNotification('‚ö†Ô∏è ' + (result ? result.message : 'B≈ÇƒÖd zapisu'), 'error');
            }
        })
        .withFailureHandler(function(error) {
            console.error('B≈ÇƒÖd submitDayOff:', error);
            showNotification('‚ö†Ô∏è B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
        })
        .submitDayOffRequest(dayOffData);
};

        /**
        * Powr√≥t z formularza dnia wolnego
        */
        window.goBackFromDayOff = function() {
            showView('absenceType');
            showNotification('Powr√≥t do wyboru typu nieobecno≈õci', 'info');
        };

        // ===== URLOP OKOLICZNO≈öCIOWY =====

        /**
         * Pokazuje formularz urlopu okoliczno≈õciowego
         */
        function showOccasionalLeaveForm() {
          if (!currentUser) {
            showNotification('B≈ÇƒÖd: brak wybranego u≈ºytkownika', 'error');
            return;
          }

          document.getElementById('occasionalUserName').textContent = currentUser.name;

          // Wyczy≈õƒá formularz
          document.getElementById('occasionalType').value = '';
          document.getElementById('occasionalDateStart').value = '';
          document.getElementById('occasionalDateEnd').value = '';
          document.getElementById('occasionalNote').value = '';
          document.getElementById('occasionalDaysInfo').style.display = 'none';

          // Ustaw domy≈õlnƒÖ datƒô na dzi≈õ
          const today = new Date().toISOString().split('T')[0];
          const startEl = document.getElementById('occasionalDateStart');
          const endEl = document.getElementById('occasionalDateEnd');
          const typeEl = document.getElementById('occasionalType');

          if (startEl) startEl.value = today;
          if (endEl) endEl.value = today;

          // ‚úÖ Typy 1-dniowe (zgodnie z backendem)
          const oneDayTypes = new Set(['slub_dziecka', 'zgon_inny']);

          // ‚úÖ NIE NADPISUJEMY istniejƒÖcej logiki onchange ‚Äì tylko jƒÖ rozszerzamy
          const prevTypeOnChange = typeEl ? typeEl.onchange : null;
          const prevStartOnChange = startEl ? startEl.onchange : null;

          const syncEndForOneDay = () => {
            const t = typeEl ? (typeEl.value || '') : '';
            if (oneDayTypes.has(t)) {
              if (endEl && startEl) endEl.value = startEl.value;
            }
          };

          if (typeEl) {
            typeEl.onchange = function(e) {
              if (typeof prevTypeOnChange === 'function') prevTypeOnChange.call(this, e);
              syncEndForOneDay();
            };
          }

          if (startEl) {
            startEl.onchange = function(e) {
              if (typeof prevStartOnChange === 'function') prevStartOnChange.call(this, e);
              syncEndForOneDay();
            };
          }

          // od razu zsynchronizuj (jak kto≈õ ma ju≈º wybrany typ)
          syncEndForOneDay();

          showView('occasionalLeave');
          showNotification('Wybierz rodzaj urlopu okoliczno≈õciowego', 'info');

          console.log('üü£ Wywo≈Çujƒô loadOccasionalLeaveHistory z showOccasionalLeaveForm');
          loadOccasionalLeaveHistory();
        }

        /**
         * Obs≈Çuga zmiany typu urlopu okoliczno≈õciowego
         */
        window.onOccasionalTypeChange = function() {
            const type = document.getElementById('occasionalType').value;
            const daysInfo = document.getElementById('occasionalDaysInfo');
            const daysText = document.getElementById('occasionalDaysText');
            const endSection = document.getElementById('occasionalDateEndSection');
            
            // Okre≈õl liczbƒô dni
            let days = 0;
            let description = '';
            
            switch(type) {
                case 'slub_wlasny':
                    days = 2;
                    description = 'üíí ≈ölub w≈Çasny - przys≈ÇugujƒÖ 2 dni p≈Çatnego urlopu';
                    break;
                case 'slub_dziecka':
                    days = 1;
                    description = 'üíç ≈ölub dziecka - przys≈Çuguje 1 dzie≈Ñ p≈Çatnego urlopu';
                    break;
                case 'narodziny':
                    days = 2;
                    description = 'üë∂ Narodziny dziecka - przys≈ÇugujƒÖ 2 dni p≈Çatnego urlopu';
                    break;
                case 'zgon_malzonka':
                    days = 2;
                    description = 'üïØÔ∏è Zgon ma≈Ç≈ºonka/dziecka/rodzica - przys≈ÇugujƒÖ 2 dni p≈Çatnego urlopu';
                    break;
                case 'zgon_inny':
                    days = 1;
                    description = 'üïØÔ∏è Zgon rodze≈Ñstwa/te≈õci√≥w/dziadk√≥w - przys≈Çuguje 1 dzie≈Ñ p≈Çatnego urlopu';
                    break;
                default:
                    daysInfo.style.display = 'none';
                    endSection.style.display = 'block';
                    return;
            }
            
            daysInfo.style.display = 'block';
            daysText.innerHTML = description;
            
            // Poka≈º/ukryj sekcjƒô daty ko≈Ñcowej
            if (days === 1) {
                endSection.style.display = 'none';
                document.getElementById('occasionalDateEnd').value = document.getElementById('occasionalDateStart').value;
            } else {
                endSection.style.display = 'block';
                // Ustaw domy≈õlnƒÖ datƒô ko≈ÑcowƒÖ (start + 1 dzie≈Ñ)
                const startDate = document.getElementById('occasionalDateStart').value;
                if (startDate) {
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 1);
                    document.getElementById('occasionalDateEnd').value = endDate.toISOString().split('T')[0];
                }
            }
        };

        /**
         * Wysy≈Ça wniosek o urlop okoliczno≈õciowy
         */
        window.submitOccasionalLeave = function() {
          const type = document.getElementById('occasionalType').value;
          const dateStart = document.getElementById('occasionalDateStart').value;
          const dateEndRaw = document.getElementById('occasionalDateEnd').value;
          const note = document.getElementById('occasionalNote').value.trim();

          if (!type) {
            showNotification('‚ùå Wybierz rodzaj urlopu okoliczno≈õciowego', 'error');
            return;
          }

          if (!dateStart) {
            showNotification('‚ùå Wybierz datƒô rozpoczƒôcia', 'error');
            return;
          }

          // ‚úÖ dni wg backendu
          const typeDays = {
            'slub_wlasny': 2,
            'slub_dziecka': 1,
            'narodziny': 2,
            'zgon_malzonka': 2,
            'zgon_inny': 1
          };

          const days = typeDays[type] || 1;

          // ‚úÖ 1 dzie≈Ñ -> end = start
          // ‚úÖ 2 dni -> je≈õli user nie poda≈Ç end, ustaw start+1
          let dateEnd = dateEndRaw || dateStart;
          if (days === 1) {
            dateEnd = dateStart;
          } else if (!dateEndRaw) {
            const d = new Date(dateStart);
            d.setDate(d.getDate() + (days - 1));
            dateEnd = d.toISOString().split('T')[0];
          }

          const occasionalData = {
            login: currentUser.login,
            name: currentUser.name,
            type: type,
            dateStart: dateStart,
            dateEnd: dateEnd,
            note: note
          };

          console.log('Wysy≈Çam wniosek o urlop okoliczno≈õciowy:', occasionalData);

          if (typeof google === 'undefined' || !google.script) {
            showNotification('‚úÖ Wniosek z≈Ço≈ºony (tryb testowy)', 'success');
            setTimeout(() => {
              showView('absenceType');
            }, 2000);
            return;
          }

          showNotification('‚úÖ Wniosek o urlop okoliczno≈õciowy z≈Ço≈ºony!', 'success');

          setTimeout(() => {
            updateManagerNotificationBadge();
            showView('absenceType');
          }, 500);

          google.script.run
            .withSuccessHandler(function(result) {
              if (result && result.success) {
                console.log('‚úÖ Urlop okoliczno≈õciowy zapisany');
              } else {
                showNotification('‚ö†Ô∏è ' + (result ? result.message : 'B≈ÇƒÖd zapisu'), 'error');
              }
            })
            .withFailureHandler(function(error) {
              console.error('B≈ÇƒÖd submitOccasionalLeave:', error);
              showNotification('‚ö†Ô∏è B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            })
            .submitOccasionalLeaveRequest(occasionalData);
        };

        /**
         * Pomocnicza funkcja - nazwa typu urlopu okoliczno≈õciowego
         */
        function getOccasionalTypeName(type) {
            const names = {
                'slub_wlasny': '≈ölub w≈Çasny',
                'slub_dziecka': '≈ölub dziecka',
                'narodziny': 'Narodziny dziecka',
                'zgon_malzonka': 'Zgon ma≈Ç≈ºonka/dziecka/rodzica',
                'zgon_inny': 'Zgon rodze≈Ñstwa/te≈õci√≥w/dziadk√≥w'
            };
            return names[type] || type;
        }

        /**
         * Powr√≥t z formularza urlopu okoliczno≈õciowego
         */
        window.goBackFromOccasional = function() {
            showView('absenceType');
            showNotification('Powr√≥t do wyboru typu nieobecno≈õci', 'info');
        };

        // ===== PLAN ROCZNY =====

        // Zmienne globalne dla planu rocznego
        let yearPlanYear = new Date().getFullYear();
        let yearPlanSelectedDates = [];
        
        // Polskie ≈õwiƒôta (sta≈Çe)
        const polishHolidays = {
            '01-01': 'Nowy Rok',
            '01-06': 'Trzech Kr√≥li',
            '05-01': '≈öwiƒôto Pracy',
            '05-03': 'Konstytucja 3 Maja',
            '08-15': 'Wniebowziƒôcie NMP',
            '11-01': 'Wszystkich ≈öwiƒôtych',
            '11-11': '≈öwiƒôto Niepodleg≈Ço≈õci',
            '12-25': 'Bo≈ºe Narodzenie',
            '12-26': 'Drugi dzie≈Ñ ≈õwiƒÖt'
        };

        /**
         * Pokazuje widok planu rocznego
         */
        // Globalna zmienna na istniejƒÖce plany
        let yearPlanExistingDates = { planned: [], approved: [], rejected: [] };
        
        // Dni usuniƒôte z oczekujƒÖcych (do anulowania)
        let yearPlanRemovedDates = [];

        function showYearPlanView() {
            if (!currentUser) {
                showNotification('B≈ÇƒÖd: brak wybranego u≈ºytkownika', 'error');
                return;
            }
            
            document.getElementById('yearPlanUserName').textContent = currentUser.name;
            yearPlanYear = new Date().getFullYear();
            yearPlanSelectedDates = [];
            
            // Najpierw poka≈º widok z komunikatem ≈Çadowania
            showView('yearPlan');
            document.getElementById('yearPlanCalendar').innerHTML = '<div style="text-align:center; padding:50px; color:#666;">‚è≥ ≈Åadowanie kalendarza...</div>';
            
            // Pobierz istniejƒÖce plany z backendu
            loadYearPlanExistingDates();
        }
        
        /**
         * ≈Åaduje istniejƒÖce zaplanowane daty z backendu
         */
        function loadYearPlanExistingDates() {
            console.log('üîµ ≈Åadujƒô istniejƒÖce plany dla:', currentUser.login, 'rok:', yearPlanYear);
            
            if (typeof google === 'undefined' || !google.script) {
                // Tryb testowy - bez backendu
                yearPlanExistingDates = { planned: [], approved: [], rejected: [] };
                updateYearPlanDisplay();
                renderYearCalendar();
                showNotification('Kliknij na dni aby zaplanowaƒá urlop', 'info');
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('‚úÖ Otrzymano istniejƒÖce plany:', result);
                    yearPlanExistingDates = result || { planned: [], approved: [], rejected: [] };
                    yearPlanRemovedDates = [];  // Resetuj usuniƒôte przy ≈Çadowaniu
                    updateYearPlanDisplay();
                    renderYearCalendar();
                    
                    const totalExisting = yearPlanExistingDates.planned.length + 
                                         yearPlanExistingDates.approved.length + 
                                         yearPlanExistingDates.rejected.length;
                    if (totalExisting > 0) {
                        showNotification(`üìÖ Znaleziono ${totalExisting} zaplanowanych dni`, 'info');
                    } else {
                        showNotification('Kliknij na dni aby zaplanowaƒá urlop', 'info');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå B≈ÇƒÖd ≈Çadowania plan√≥w:', error);
                    yearPlanExistingDates = { planned: [], approved: [], rejected: [] };
                    updateYearPlanDisplay();
                    renderYearCalendar();
                    showNotification('Kliknij na dni aby zaplanowaƒá urlop', 'info');
                })
                .getYearPlanDatesForCalendar(currentUser.login, yearPlanYear);
        }

        /**
         * Zmienia rok w planie
         */
        window.changeYearPlanYear = function(delta) {
            yearPlanYear += delta;
            yearPlanSelectedDates = [];  // Wyczy≈õƒá nowe zaznaczenia przy zmianie roku
            yearPlanRemovedDates = [];   // Wyczy≈õƒá usuniƒôte przy zmianie roku
            
            // Prze≈Çaduj istniejƒÖce plany dla nowego roku
            document.getElementById('yearPlanCalendar').innerHTML = '<div style="text-align:center; padding:50px; color:#666;">‚è≥ ≈Åadowanie kalendarza...</div>';
            loadYearPlanExistingDates();
        };

        /**
         * Aktualizuje wy≈õwietlanie roku i salda
         */
        function updateYearPlanDisplay() {
        document.getElementById('yearPlanYear').textContent = yearPlanYear;
        document.getElementById('yearPlanYearDisplay').textContent = yearPlanYear;
        
        // Pobierz saldo z cache lub ustaw domy≈õlne
        const balance = userVacationBalances[currentUser.login];
        const totalAvailable = balance ? (balance.przys≈ÇugujƒÖcy + balance.zaleg≈Çy) : 0;
        
        document.getElementById('yearPlanRemaining').textContent = totalAvailable;
        
        // U≈ºyj dedykowanej funkcji do licznik√≥w
        updateYearPlanCounters();
        
        // Aktualizuj informacjƒô o statusach
        let infoText = '';
        if (yearPlanExistingDates.approved.length > 0) {
            infoText += `<span style="color: #2196f3;">‚úÖ Zatwierdzonych: ${yearPlanExistingDates.approved.length} dni</span>  `;
        }
        if (yearPlanExistingDates.planned.length > 0) {
            infoText += `<span style="color: #4caf50;">‚è≥ OczekujƒÖcych: ${yearPlanExistingDates.planned.length} dni</span>  `;
        }
        if (yearPlanExistingDates.rejected.length > 0) {
            infoText += `<span style="color: #f44336;">‚ùå Odrzuconych: ${yearPlanExistingDates.rejected.length} dni</span>`;
        }
        
        // Dodaj element info je≈õli nie istnieje
        let infoEl = document.getElementById('yearPlanExistingInfo');
        if (!infoEl) {
            infoEl = document.createElement('div');
            infoEl.id = 'yearPlanExistingInfo';
            infoEl.style.cssText = 'text-align: center; margin: 10px 0; font-size: 14px;';
            const headerEl = document.querySelector('#yearPlanView .absence-header');
            if (headerEl) {
                headerEl.parentNode.insertBefore(infoEl, headerEl.nextSibling);
            }
        }
        infoEl.innerHTML = infoText || '';
    }

        /**
         * Renderuje kalendarz roczny z blokadƒÖ dat wstecznych i istniejƒÖcymi planami
         */
        function renderYearCalendar() {
            const container = document.getElementById('yearPlanCalendar');
            container.innerHTML = '';
            
            const monthNames = ['Stycze≈Ñ', 'Luty', 'Marzec', 'Kwiecie≈Ñ', 'Maj', 'Czerwiec',
                               'Lipiec', 'Sierpie≈Ñ', 'Wrzesie≈Ñ', 'Pa≈∫dziernik', 'Listopad', 'Grudzie≈Ñ'];
            const dayNames = ['Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'Sb', 'Nd'];
            
            // Dzisiejsza data (bez czasu)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let month = 0; month < 12; month++) {
                const monthDiv = document.createElement('div');
                monthDiv.style.cssText = 'background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);';
                
                // Nag≈Ç√≥wek miesiƒÖca
                const header = document.createElement('div');
                header.style.cssText = 'text-align: center; font-weight: bold; margin-bottom: 10px; color: #333; font-size: 14px;';
                header.textContent = monthNames[month];
                monthDiv.appendChild(header);
                
                // Dni tygodnia
                const daysHeader = document.createElement('div');
                daysHeader.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 5px;';
                dayNames.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.style.cssText = 'text-align: center; font-size: 10px; color: #666; font-weight: bold;';
                    dayEl.textContent = day;
                    daysHeader.appendChild(dayEl);
                });
                monthDiv.appendChild(daysHeader);
                
                // Dni miesiƒÖca
                const daysGrid = document.createElement('div');
                daysGrid.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;';
                
                const firstDay = new Date(yearPlanYear, month, 1);
                let startDay = firstDay.getDay();
                startDay = startDay === 0 ? 6 : startDay - 1; // Poniedzia≈Çek = 0
                
                const daysInMonth = new Date(yearPlanYear, month + 1, 0).getDate();
                
                // Puste kom√≥rki przed pierwszym dniem
                for (let i = 0; i < startDay; i++) {
                    const emptyEl = document.createElement('div');
                    daysGrid.appendChild(emptyEl);
                }
                
                // Dni miesiƒÖca
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(yearPlanYear, month, day);
                    date.setHours(0, 0, 0, 0);
                    
                    const dateStr = formatDateForPlan(yearPlanYear, month + 1, day);
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const monthDayStr = String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                    const isHoliday = polishHolidays[monthDayStr];
                    
                    // ‚úÖ NOWE: Sprawd≈∫ czy data jest w przesz≈Ço≈õci
                    const isPast = date < today;
                    
                    // ‚úÖ NOWE: Sprawd≈∫ status istniejƒÖcego planu
                    const isApproved = yearPlanExistingDates.approved.includes(dateStr);
                    const isPlanned = yearPlanExistingDates.planned.includes(dateStr);
                    const isRejected = yearPlanExistingDates.rejected.includes(dateStr);
                    
                    // Sprawd≈∫ czy nowo zaznaczony
                    const isNewlySelected = yearPlanSelectedDates.includes(dateStr);
                    
                    const dayEl = document.createElement('div');
                    dayEl.textContent = day;
                    dayEl.dataset.date = dateStr;
                    
                    let bgColor = 'white';
                    let textColor = '#333';
                    let cursor = 'pointer';
                    let border = 'none';
                    let opacity = '1';
                    let title = '';
                    
                    // Ustal wyglƒÖd dnia
                    if (isWeekend || isHoliday) {
                        // Weekend lub ≈õwiƒôto
                        bgColor = '#e0e0e0';
                        textColor = '#999';
                        cursor = 'default';
                        title = isHoliday || 'Weekend';
                    } else if (isPast) {
                        // ‚úÖ NOWE: Data w przesz≈Ço≈õci - nieaktywna
                        bgColor = '#f5f5f5';
                        textColor = '#bbb';
                        cursor = 'not-allowed';
                        opacity = '0.6';
                        title = 'Data w przesz≈Ço≈õci';
                    } else if (isApproved) {
                        // ‚úÖ NOWE: Zatwierdzony - niebieski
                        bgColor = '#2196f3';
                        textColor = 'white';
                        cursor = 'default';
                        title = 'Zatwierdzony urlop';
                    } else if (isPlanned) {
                        // ‚úÖ NOWE: OczekujƒÖcy - zielony z obramowaniem
                        bgColor = '#4caf50';
                        textColor = 'white';
                        border = '2px dashed #2e7d32';
                        cursor = 'default';
                        title = 'Urlop oczekuje na zatwierdzenie';
                    } else if (isRejected) {
                        // ‚úÖ NOWE: Odrzucony - czerwony
                        bgColor = '#f44336';
                        textColor = 'white';
                        cursor = 'pointer';  // Mo≈ºna ponownie zaplanowaƒá
                        title = 'Urlop odrzucony - mo≈ºna zaplanowaƒá ponownie';
                    } else if (isNewlySelected) {
                        // Nowo zaznaczony przez u≈ºytkownika
                        bgColor = '#81c784';  // Ja≈õniejszy zielony
                        textColor = 'white';
                        border = '2px solid #4caf50';
                        title = 'Nowo zaplanowany - kliknij aby odznaczyƒá';
                    }
                    
                    dayEl.style.cssText = `
                        text-align: center;
                        padding: 4px 2px;
                        font-size: 12px;
                        border-radius: 4px;
                        cursor: ${cursor};
                        background: ${bgColor};
                        color: ${textColor};
                        border: ${border};
                        opacity: ${opacity};
                        transition: all 0.2s;
                    `;
                    
                    if (title) {
                        dayEl.title = title;
                    }
                    
                    // ‚úÖ Klikniƒôcie dla dni kt√≥re mo≈ºna edytowaƒá
                    // Mo≈ºna klikaƒá: wolne dni, odrzucone, ORAZ oczekujƒÖce (≈ºeby je usunƒÖƒá)
                    const canClick = !isWeekend && !isHoliday && !isPast && !isApproved;
                    
                    if (canClick) {
                        dayEl.addEventListener('click', function() {
                            toggleYearPlanDate(this.dataset.date, this);
                        });
                        dayEl.addEventListener('mouseenter', function() {
                            const dateStr = this.dataset.date;
                            const isSelected = yearPlanSelectedDates.includes(dateStr);
                            const isPending = yearPlanExistingDates.planned.includes(dateStr);
                            const isRemovedPending = yearPlanRemovedDates && yearPlanRemovedDates.includes(dateStr);
                            
                            // Nie zmieniaj hover dla zaznaczonych lub oczekujƒÖcych (chyba ≈ºe usuniƒôte)
                            if (!isSelected && !isPending) {
                                this.style.background = '#e3f2fd';
                            } else if (isPending && !isRemovedPending) {
                                this.style.background = '#388e3c';  // Ciemniejszy zielony na hover
                            }
                        });
                        dayEl.addEventListener('mouseleave', function() {
                            const dateStr = this.dataset.date;
                            const isSelected = yearPlanSelectedDates.includes(dateStr);
                            const isPending = yearPlanExistingDates.planned.includes(dateStr);
                            const isRej = yearPlanExistingDates.rejected.includes(dateStr);
                            const isRemovedPending = yearPlanRemovedDates && yearPlanRemovedDates.includes(dateStr);
                            
                            if (isSelected) {
                                // Nowo zaznaczony - jasnozielony
                                this.style.background = '#81c784';
                            } else if (isPending && !isRemovedPending) {
                                // OczekujƒÖcy (nie usuniƒôty) - zielony
                                this.style.background = '#4caf50';
                            } else if (isRemovedPending) {
                                // Usuniƒôty z oczekujƒÖcych - szary z przekre≈õleniem
                                this.style.background = '#ffcdd2';
                            } else if (isRej) {
                                // Odrzucony
                                this.style.background = '#f44336';
                                this.style.color = 'white';
                            } else {
                                // Zwyk≈Çy dzie≈Ñ
                                this.style.background = 'white';
                                this.style.color = '#333';
                            }
                        });
                    }
                    
                    daysGrid.appendChild(dayEl);
                }
                
                monthDiv.appendChild(daysGrid);
                container.appendChild(monthDiv);
            }
        }

        /**
         * Formatuje datƒô dla planu
         */
        function formatDateForPlan(year, month, day) {
            return year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        }

        /**
         * Prze≈ÇƒÖcza zaznaczenie daty
         */
        /**
         * Prze≈ÇƒÖcza zaznaczenie daty
         * Obs≈Çuguje: nowe zaznaczenia, odznaczanie, usuwanie oczekujƒÖcych
         */
        function toggleYearPlanDate(dateStr, element) {
            const isNewlySelected = yearPlanSelectedDates.includes(dateStr);
            const isPending = yearPlanExistingDates.planned.includes(dateStr);
            const isRejected = yearPlanExistingDates.rejected.includes(dateStr);
            const isRemovedPending = yearPlanRemovedDates.includes(dateStr);
            
            if (isPending) {
                // Klikniƒôto na dzie≈Ñ OCZEKUJƒÑCY
                if (isRemovedPending) {
                    // Przywr√≥ƒá do oczekujƒÖcych (anuluj usuniƒôcie)
                    const idx = yearPlanRemovedDates.indexOf(dateStr);
                    yearPlanRemovedDates.splice(idx, 1);
                    
                    element.style.background = '#4caf50';
                    element.style.color = 'white';
                    element.style.border = '2px dashed #2e7d32';
                    element.style.textDecoration = 'none';
                    element.title = 'Urlop oczekuje na zatwierdzenie - kliknij aby anulowaƒá';
                    
                    showNotification(`üìÖ Przywr√≥cono ${dateStr} do planu`, 'info');
                } else {
                    // Oznacz do usuniƒôcia
                    yearPlanRemovedDates.push(dateStr);
                    
                    element.style.background = '#ffcdd2';
                    element.style.color = '#c62828';
                    element.style.border = '2px solid #ef5350';
                    element.style.textDecoration = 'line-through';
                    element.title = 'Do usuniƒôcia - kliknij aby przywr√≥ciƒá';
                    
                    showNotification(`üóëÔ∏è ${dateStr} oznaczony do usuniƒôcia`, 'warning');
                }
            } else if (isNewlySelected) {
                // Odznacz nowo zaznaczony dzie≈Ñ
                const idx = yearPlanSelectedDates.indexOf(dateStr);
                yearPlanSelectedDates.splice(idx, 1);
                
                // Przywr√≥ƒá oryginalny wyglƒÖd
                if (isRejected) {
                    element.style.background = '#f44336';
                    element.style.color = 'white';
                    element.style.border = 'none';
                    element.style.textDecoration = 'none';
                } else {
                    element.style.background = 'white';
                    element.style.color = '#333';
                    element.style.border = 'none';
                    element.style.textDecoration = 'none';
                }
            } else {
                // Zaznacz nowy dzie≈Ñ
                yearPlanSelectedDates.push(dateStr);
                
                element.style.background = '#81c784';
                element.style.color = 'white';
                element.style.border = '2px solid #4caf50';
                element.style.textDecoration = 'none';
            }
            
            yearPlanSelectedDates.sort();
            yearPlanRemovedDates.sort();
            
            updateYearPlanCounters();
        }
        
        /**
         * Aktualizuje liczniki w nag≈Ç√≥wku
         */
        function updateYearPlanCounters() {
        const approvedCount = yearPlanExistingDates.approved.length;
        const pendingCount = yearPlanExistingDates.planned.length - yearPlanRemovedDates.length;
        const newCount = yearPlanSelectedDates.length;
        const removedCount = yearPlanRemovedDates.length;
        
        const totalPlanned = approvedCount + pendingCount + newCount;
        
        // Aktualizuj g≈Ç√≥wny licznik
        let displayText = '';
        if (totalPlanned > 0) {
            displayText = String(totalPlanned);
            if (removedCount > 0) {
                displayText += ` (‚àí${removedCount})`;
            }
            if (newCount > 0 && (approvedCount + pendingCount) > 0) {
                displayText = `${approvedCount + pendingCount} + ${newCount} nowych`;
            }
        } else {
            displayText = '0';
        }
        
        document.getElementById('yearPlanSelected').textContent = displayText;
        
        // Aktualizuj pozosta≈Çe dni - pobierz z salda
        const balance = userVacationBalances[currentUser.login];
        const totalAvailable = balance ? (balance.przys≈ÇugujƒÖcy + balance.zaleg≈Çy) : 0;
        const remaining = Math.max(0, totalAvailable - totalPlanned);
        document.getElementById('yearPlanRemaining').textContent = remaining;
    }

        /**
         * Zapisuje plan roczny
         */
        window.submitYearPlan = function() {
            // Sprawd≈∫ czy sƒÖ jakiekolwiek zmiany
            const hasNewDates = yearPlanSelectedDates.length > 0;
            const hasRemovedDates = yearPlanRemovedDates.length > 0;
            
            if (!hasNewDates && !hasRemovedDates) {
                showNotification('‚ùå Nie wprowadzono ≈ºadnych zmian', 'error');
                return;
            }
            
            // Przygotuj dane do wys≈Çania
            const planData = {
                login: currentUser.login,
                name: currentUser.name,
                year: yearPlanYear,
                newDates: yearPlanSelectedDates,           // Nowe dni do dodania
                removedDates: yearPlanRemovedDates,        // Dni do usuniƒôcia z oczekujƒÖcych
                // Dla kompatybilno≈õci wstecznej - wszystkie aktywne daty
                dates: [
                    ...yearPlanExistingDates.approved,                                          // Zatwierdzone (niezmienne)
                    ...yearPlanExistingDates.planned.filter(d => !yearPlanRemovedDates.includes(d)),  // OczekujƒÖce minus usuniƒôte
                    ...yearPlanSelectedDates                                                    // Nowo dodane
                ]
            };
            
            console.log('Zapisujƒô plan roczny:', planData);
            
            // Sprawd≈∫ czy backend dostƒôpny
            if (typeof google === 'undefined' || !google.script) {
                let msg = '‚úÖ Plan urlopowy zapisany (tryb testowy):\n';
                if (hasNewDates) msg += `  + ${yearPlanSelectedDates.length} nowych dni\n`;
                if (hasRemovedDates) msg += `  - ${yearPlanRemovedDates.length} usuniƒôtych dni`;
                showNotification(msg, 'success');
                setTimeout(() => {
                    showView('absenceType');
                }, 2000);
                return;
            }
            
            // Poka≈º ≈Çadowanie
            let loadingMsg = '‚è≥ Zapisujƒô zmiany w planie...';
            if (hasNewDates && hasRemovedDates) {
                loadingMsg = `‚è≥ Dodajƒô ${yearPlanSelectedDates.length} dni, usuwam ${yearPlanRemovedDates.length} dni...`;
            } else if (hasNewDates) {
                loadingMsg = `‚è≥ Dodajƒô ${yearPlanSelectedDates.length} nowych dni...`;
            } else if (hasRemovedDates) {
                loadingMsg = `‚è≥ Usuwam ${yearPlanRemovedDates.length} dni z planu...`;
            }
            showNotification(loadingMsg, 'info');
            
            // Wywo≈Çanie backendu
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Odpowied≈∫ backendu:', result);
                    if (result && result.success) {
                        showNotification('‚úÖ ' + result.message, 'success');
                        
                        // Wyczy≈õƒá zaznaczenia
                        yearPlanSelectedDates = [];
                        yearPlanRemovedDates = [];
                        
                        setTimeout(() => {
                            updateManagerNotificationBadge();
                            showView('absenceType');
                        }, 2000);
                    } else {
                        showNotification('‚ùå ' + (result ? result.message : 'B≈ÇƒÖd zapisu'), 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('B≈ÇƒÖd submitYearPlan:', error);
                    showNotification('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message, 'error');
                })
                .submitYearPlanRequest(planData);
        };

        /**
         * Powr√≥t z planu rocznego
         */
        window.goBackFromYearPlan = function() {
            showView('absenceType');
            showNotification('Powr√≥t do wyboru typu nieobecno≈õci', 'info');
        };

        // ===== TYP URLOPU =====
        window.selectVacationType = function(type) {
            selectedVacationType = type;
            document.getElementById('vacationType').value = type;
            
            document.querySelectorAll('.vacation-type-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById('type-' + type).classList.add('selected');
            
            updateDateConstraints();
            showNotification('Wybrano typ: ' + getVacationTypeName(type), 'info');
        };

        // ===== ZARZƒÑDZANIE URLOPAMI (KIEROWNIK) =====
        window.showManagerVacation = function() {
            showView('managerVacation');
            
            // Resetuj zak≈Çadkƒô na "Urlopy"
            currentAbsenceTab = 'vacation';
            document.querySelectorAll('#managerVacationView .vacation-type-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById('tab-vacation').classList.add('selected');
            
            // Za≈Çaduj liczniki i wnioski
            updateAbsenceTabCounts();
            loadPendingVacationRequests();
        };

        // ===== OBLICZANIE INFORMACJI O URLOPIE =====
        window.calculateVacationInfo = function() {
            const startDate = document.getElementById('vacationStartDate').value;
            const endDate = document.getElementById('vacationEndDate').value;
            
            if (!startDate || !endDate) {
                document.getElementById('vacationInfo').style.display = 'none';
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                document.getElementById('vacationInfo').style.display = 'none';
                return;
            }
            
            const workingDays = calculateWorkingDaysLocal(startDate, endDate);
            document.getElementById('workingDaysCount').textContent = workingDays;
            
            const infoDiv = document.getElementById('vacationInfo');
            const collisionDiv = document.getElementById('collisionStatus');
            
            const balance = userVacationBalances[currentUser.login];
            
            if (workingDays > 10) {
                infoDiv.className = 'vacation-info collision-error';
                collisionDiv.textContent = 'B≈ÅƒÑD: Max 10 dni roboczych!';
            } else if (balance) {
                const maxDostepne = balance.przys≈ÇugujƒÖcy + balance.zaleg≈Çy;
                
                if (workingDays > maxDostepne) {
                    infoDiv.className = 'vacation-info collision-error';
                    collisionDiv.innerHTML = `
                        <strong>‚ùå B≈ÅƒÑD: NiewystarczajƒÖca liczba dni!</strong><br>
                        Pr√≥bujesz wystawiƒá: ${workingDays} dni<br>
                        Dostƒôpne: ${maxDostepne} dni (przys≈ÇugujƒÖcy ${balance.przys≈ÇugujƒÖcy} + zaleg≈Çy ${balance.zaleg≈Çy})
                    `;
                } else if (workingDays === maxDostepne) {
                    infoDiv.className = 'vacation-info';
                    infoDiv.style.borderLeftColor = '#ffc107';
                    infoDiv.style.backgroundColor = '#fff8e1';
                    collisionDiv.innerHTML = `
                        <strong>‚ö†Ô∏è UWAGA: Wykorzystasz wszystkie dostƒôpne dni!</strong><br>
                        Po zatwierdzeniu tego wniosku Urlop_pozosta≈Çy bƒôdzie wynosi≈Ç 0 dni
                    `;
                } else {
                    infoDiv.className = 'vacation-info';
                    collisionDiv.innerHTML = `
                        ‚úÖ OK - Pozostanie Ci: ${balance.pozosta≈Çy - workingDays} dni<br>
                        <small>Sprawdzanie kolizji przy sk≈Çadaniu wniosku</small>
                    `;
                }
            } else {
                infoDiv.className = 'vacation-info';
                collisionDiv.textContent = 'Sprawdzanie kolizji przy sk≈Çadaniu wniosku';
            }
            
            document.getElementById('vacationInfo').style.display = 'block';
        };

        // ===== SK≈ÅADANIE WNIOSKU =====
        function checkDateCollision(newStartDate, newEndDate) {
    const newStart = new Date(newStartDate);
    const newEnd = new Date(newEndDate);
    
    // Sprawd≈∫ tylko zatwierdzone wnioski
    const approvedRequests = currentUserVacationRequests.filter(req => 
        req.status === 'Zatwierdzony'
    );
    
    for (const request of approvedRequests) {
        const existingStart = new Date(request.dateFrom);
        const existingEnd = new Date(request.dateTo);
        
        // Sprawd≈∫ czy zakresy dat siƒô nak≈ÇadajƒÖ
        // Nak≈Çadanie wystƒôpuje gdy:
        // (nowy_start <= istniejƒÖcy_koniec) AND (nowy_koniec >= istniejƒÖcy_start)
        if (newStart <= existingEnd && newEnd >= existingStart) {
            return {
                hasCollision: true,
                conflictingRequest: request
            };
        }
    }
    
    return { hasCollision: false };
}

        window.submitVacation = function() {
            if (!currentUser) {
                showNotification('B≈ÇƒÖd: brak wybranego u≈ºytkownika', 'error');
                return;
            }
            
            const startDate = document.getElementById('vacationStartDate').value;
            const endDate = document.getElementById('vacationEndDate').value;
            const comment = document.getElementById('vacationComment').value;
            const vacationType = document.getElementById('vacationType').value;
            
            if (!startDate || !endDate) {
                showNotification('Wybierz daty urlopu', 'error');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showNotification('Data ko≈Ñcowa musi byƒá p√≥≈∫niejsza ni≈º poczƒÖtkowa', 'error');
                return;
            }

            // WALIDACJA: SPRAWD≈π KOLIZJE DAT
            const collisionCheck = checkDateCollision(startDate, endDate);
            if (collisionCheck.hasCollision) {
                const conflicting = collisionCheck.conflictingRequest;
                showNotification(
                    `‚ùå B≈ÅƒÑD: Nak≈ÇadajƒÖce siƒô daty urlopu!\n\n` +
                    `Masz ju≈º zatwierdzony urlop w tym okresie:\n` +
                    `${conflicting.dateFrom} - ${conflicting.dateTo} (${conflicting.workingDays} dni)\n\n` +
                    `Nie mo≈ºesz z≈Ço≈ºyƒá kolejnego wniosku na te same lub nak≈ÇadajƒÖce siƒô daty.`,
                    'error'
                );
                return;
            }
            
            const workingDays = calculateWorkingDaysLocal(startDate, endDate);
            const balance = userVacationBalances[currentUser.login];
            
            if (balance) {
                const maxDostepne = balance.przys≈ÇugujƒÖcy + balance.zaleg≈Çy;
                
                console.log('Walidacja frontendu:');
                console.log('- Dni robocze wniosku:', workingDays);
                console.log('- Dostƒôpne dni:', maxDostepne);
                
                if (workingDays > maxDostepne) {
                    showNotification(
                        `Nie masz wystarczajƒÖcej liczby dni urlopu!\nDostƒôpne: ${maxDostepne} dni, pr√≥bujesz wystawiƒá: ${workingDays} dni`, 
                        'error'
                    );
                    return;
                }
                
                if (workingDays === maxDostepne) {
                    const confirmation = confirm(
                        `Uwaga! Ten wniosek wykorzysta wszystkie dostƒôpne dni urlopu (${maxDostepne} dni).\n\n` +
                        `Po zatwierdzeniu tego wniosku:\n` +
                        `- Urlop pozosta≈Çy bƒôdzie wynosi≈Ç: 0 dni\n` +
                        `- Nie bƒôdziesz m√≥g≈Ç z≈Ço≈ºyƒá kolejnych wniosk√≥w\n\n` +
                        `Czy na pewno chcesz kontynuowaƒá?`
                    );
                    
                    if (!confirmation) {
                        showNotification('Anulowano sk≈Çadanie wniosku', 'info');
                        return;
                    }
                }
            }
            
            // Tryb testowy
            if (typeof google === 'undefined' || !google.script) {
                showNotification('Wniosek z≈Ço≈ºony (tryb testowy)', 'success');
                setTimeout(() => {
                    updateManagerNotificationBadge();
                    showView('absenceType');
                    loadAbsenceTypeRequests();
                }, 2000);
                return;
            }
            
            // 1. NATYCHMIAST - poka≈º sukces i wyczy≈õƒá formularz
    showNotification('‚úÖ Wniosek urlopowy z≈Ço≈ºony! Oczekuje na zatwierdzenie.', 'success');
    
    // Wyczy≈õƒá formularz
    document.getElementById('vacationStartDate').value = '';
    document.getElementById('vacationEndDate').value = '';
    document.getElementById('vacationComment').value = '';
    document.getElementById('vacationInfo').style.display = 'none';
    
    // 2. NATYCHMIAST - wr√≥ƒá do wyboru typu
    setTimeout(() => {
        showView('absenceType');
        loadAbsenceTypeRequests();
    }, 500);
    
    // 3. W TLE - zapisz do backendu
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                console.log('‚úÖ Wniosek zapisany w bazie');
                updateManagerNotificationBadge();
            } else {
                console.error('‚ùå B≈ÇƒÖd zapisu:', result.message);
                showNotification('‚ö†Ô∏è Uwaga: ' + result.message, 'error');
            }
        })
        .withFailureHandler(function(error) {
            console.error('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia:', error);
            showNotification('‚ö†Ô∏è B≈ÇƒÖd po≈ÇƒÖczenia - sprawd≈∫ czy wniosek zosta≈Ç zapisany', 'error');
        })
        .submitVacationRequest(currentUser.login, startDate, endDate, comment, vacationType);
};

        window.processVacation = function(requestId, decision) {
        const comment = prompt(`${decision === 'Zatwierdzony' ? 'Zatwierd≈∫' : 'Odrzuƒá'} wniosek - komentarz (opcjonalny):`);
        if (comment === null) return;
        
        if (typeof google === 'undefined' || !google.script) {
            showNotification('Operacja wykonana (tryb testowy)', 'success');
            return;
        }
        
        // 1. NATYCHMIAST znajd≈∫ i ukryj kartƒô wniosku
        const allCards = document.querySelectorAll('.vacation-request-item');
        let targetCard = null;
        
        allCards.forEach(card => {
            // Szukaj karty kt√≥ra ma przycisk z tym requestId
            const approveBtn = card.querySelector(`button[onclick*="processVacation('${requestId}'"]`) ||
                              card.querySelector(`button[onclick*="processVacation(${requestId},"]`) ||
                              card.querySelector(`button[onclick*="processVacation(${requestId})"]`);
            if (approveBtn) {
                targetCard = card;
            }
        });
        
        if (targetCard) {
            targetCard.style.transition = 'opacity 0.3s, transform 0.3s, max-height 0.3s';
            targetCard.style.opacity = '0';
            targetCard.style.transform = 'translateX(-20px)';
            targetCard.style.maxHeight = targetCard.offsetHeight + 'px';
            setTimeout(() => {
                targetCard.style.maxHeight = '0';
                targetCard.style.padding = '0';
                targetCard.style.margin = '0';
                targetCard.style.overflow = 'hidden';
            }, 200);
            setTimeout(() => targetCard.remove(), 400);
        }
        
        // 2. NATYCHMIAST zaktualizuj licznik
        const pendingCountEl = document.getElementById('pendingCount');
        const currentCount = parseInt(pendingCountEl.textContent) || 0;
        pendingCountEl.textContent = Math.max(0, currentCount - 1);
        
        // Zaktualizuj te≈º licznik w zak≈Çadce
        const tabCountEl = document.getElementById('count-vacation');
        if (tabCountEl) {
            const tabCount = parseInt(tabCountEl.textContent) || 0;
            tabCountEl.textContent = Math.max(0, tabCount - 1);
        }
        
        // 3. NATYCHMIAST poka≈º sukces
        const actionText = decision === 'Zatwierdzony' ? 'Zatwierdzono' : 'Odrzucono';
        showNotification(`‚úÖ ${actionText} wniosek`, 'success');
        
        // 4. Sprawd≈∫ czy to by≈Ç ostatni wniosek
        setTimeout(function() {
            const remainingCards = document.querySelectorAll('#managerVacationRequests .vacation-request-item');
            if (remainingCards.length === 0) {
                document.getElementById('managerVacationRequests').innerHTML = 
                    '<p style="text-align: center; color: #666;">‚úÖ Brak wniosk√≥w do zatwierdzenia</p>';
            }
        }, 450);

        // 6. NATYCHMIAST zaktualizuj badge na przycisku urlop√≥w
        pendingVacationCount = Math.max(0, pendingVacationCount - 1);
        const vacationBtn = document.getElementById('vacationBtn');
        if (vacationBtn) {
            let badge = vacationBtn.querySelector('.vacation-btn-badge');
            if (pendingVacationCount > 0) {
                if (!badge) {
                    badge = document.createElement('div');
                    badge.className = 'vacation-btn-badge';
                    vacationBtn.appendChild(badge);
                }
                badge.textContent = pendingVacationCount;
            } else {
                if (badge) badge.remove();
            }
        }
        
        // 5. W TLE zapisz do bazy
        google.script.run
            .withSuccessHandler(function(result) {
                if (result.success) {
                    console.log('‚úÖ Wniosek zapisany w bazie');
                    updateManagerNotificationBadge();
                } else {
                    console.error('‚ùå B≈ÇƒÖd zapisu:', result.message);
                    showNotification('‚ö†Ô∏è B≈ÇƒÖd: ' + result.message + ' - od≈õwie≈ºam', 'error');
                    loadPendingVacationRequests();
                }
            })
            .withFailureHandler(function(error) {
                console.error('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia:', error);
                showNotification('‚ö†Ô∏è B≈ÇƒÖd po≈ÇƒÖczenia - od≈õwie≈ºam', 'error');
                loadPendingVacationRequests();
            })
            .processVacationRequest(requestId, decision, comment);
    };

        // ===== OBS≈ÅUGA PRZYCISKU G√ìRNEGO PASKA =====
function handleTopBarBack() {
    if (currentView === 'department') {
        // Na g≈Ç√≥wnym ekranie - wyloguj
        logoutUser();
    } else {
        // W innych widokach - wr√≥ƒá
        goBack();
    }
}

function logoutUser() {
    if (confirm('Czy na pewno chcesz siƒô wylogowaƒá?')) {
        // Wyczy≈õƒá sesjƒô
        sessionStorage.removeItem('isLoggedIn');
        sessionStorage.removeItem('loggedInUser');
        
        // Resetuj zmienne
        isLoggedIn = false;
        currentUser = null;
        currentDepartment = null;
        
        // Zatrzymaj auto-refresh
        stopAutoRefresh();
        
        // Ukryj przycisk Dashboard
        document.getElementById('dashboardBtn').style.display = 'none';
        document.getElementById('announcementsBtn').style.display = 'none';
        document.getElementById('workforcePlannerBtn').style.display = 'none';
        document.getElementById('workforceLiveBtn').style.display = 'none';
        
        // Poka≈º ekran logowania
        document.getElementById('mainInterface').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'block';
        
        // Wyczy≈õƒá pola logowania
        document.getElementById('loginInput').value = '';
        document.getElementById('passwordInput').value = '';
        
        showNotification('Wylogowano pomy≈õlnie', 'success');
    }
}

function updateTopBarButton() {
    const btn = document.getElementById('topBarBackBtn');
    if (currentView === 'department') {
        btn.innerHTML = 'üö™ Wyloguj';
    } else {
        btn.innerHTML = '‚Üê Wstecz';
    }
}

        // ===== FUNKCJA POWROTU =====
        window.goBack = function() {
    console.log('goBack wywo≈Çane, currentView:', currentView);
    
    // ‚úÖ DODAJ TEN FRAGMENT NA SAMYM POCZƒÑTKU:
    // Powr√≥t z panelu zg≈Çosze≈Ñ kierownika
    if (currentView === 'managerTickets') {
        currentUser = null;
        showView('department');
        showNotification('Powr√≥t do menu g≈Ç√≥wnego', 'info');
        ensureCodeInputFocus();
        return;
    }

    // Powr√≥t z panelu zg≈Çosze≈Ñ pracownika
    if (currentView === 'myTickets') {
        showView('action');
        showNotification('Powr√≥t do panelu operatora', 'info');
        return;
    }
    
    // Powr√≥t z weryfikacji ticketu
    if (currentView === 'ticketVerification') {
        showView('department');
        showNotification('Anulowano zg≈Çoszenie', 'info');
        ensureCodeInputFocus();
        return;
    }
    
    // Powr√≥t z formularza ticketu
    if (currentView === 'ticket') {
        currentUser = null;
        showView('department');
        showNotification('Anulowano zg≈Çoszenie', 'info');
        ensureCodeInputFocus();
        return;
    }
        
        // ===== DODAJ TO: =====
        // Powr√≥t z weryfikacji L4
        if (currentView === 'l4Verification') {
            showView('department');
            showNotification('Anulowano rejestracjƒô L4', 'info');
            ensureCodeInputFocus();
            return;
        }
        
        // Powr√≥t z formularza L4
        if (currentView === 'l4Form') {
            showView('department');
            showNotification('Anulowano rejestracjƒô L4', 'info');
            ensureCodeInputFocus();
            return;
        }
                
        if (window.isChangingOperation) {
            // ... reszta funkcji
                window.isChangingOperation = false;
                
                document.getElementById('departmentView').querySelector('.view-title').textContent = 
                    'Wybierz dzia≈Ç/operacjƒô';
                
                if (currentUser && currentDepartment) {
                    const departmentNames = {
                        'przyjecie': 'Przyjƒôcie dostaw',
                        'rozladunek': 'Roz≈Çadunek rƒôczny kontenera',
                        'zaladunek': 'Za≈Çadunek rƒôczny kontenera',
                        'relokacja': 'Relokacja',
                        'kompletacja': 'Kompletacja zam√≥wie≈Ñ',
                        'weryfikacja': 'Weryfikacja zam√≥wie≈Ñ',
                        'co-packing': 'Co-packing',
                        'operacje-porzadkowe': 'Operacje porzƒÖdkowe',
                        'inwentaryzacja': 'Inwentaryzacja'
                    };
                    
                    const deptName = departmentNames[currentDepartment] || currentDepartment;
                    document.getElementById('actionViewTitle').textContent = 
                        `Panel operatora - ${currentUser.login} (${deptName})`;
                }
                
                showView('action');
                showNotification('Anulowano zmianƒô operacji', 'info');
                return;
            }
            
            if (currentView === 'vacationVerification') {
                selectedUserForVacation = null;
                window.vacationMode = false;
                showView('department');
                showNotification('Powr√≥t do menu g≈Ç√≥wnego', 'info');
                ensureCodeInputFocus();
                return;
            }

            // Powr√≥t z wyboru typu nieobecno≈õci
            if (currentView === 'absenceType') {
                currentUser = null;
                window.vacationMode = false;
                showView('department');
                showNotification('Powr√≥t do menu g≈Ç√≥wnego', 'info');
                ensureCodeInputFocus();
                return;
            }

            // Powr√≥t z formularza urlopu do wyboru typu
            if (currentView === 'vacation') {
                showView('absenceType');
                showNotification('Powr√≥t do wyboru typu nieobecno≈õci', 'info');
                return;
            }

            // Powr√≥t z formularza dnia wolnego do wyboru typu
            if (currentView === 'dayOff') {
                showView('absenceType');
                showNotification('Powr√≥t do wyboru typu nieobecno≈õci', 'info');
                return;
            }

            // Powr√≥t z formularza urlopu okoliczno≈õciowego do wyboru typu
            if (currentView === 'occasionalLeave') {
                showView('absenceType');
                showNotification('Powr√≥t do wyboru typu nieobecno≈õci', 'info');
                return;
            }

            // Powr√≥t z planu rocznego do wyboru typu
            if (currentView === 'yearPlan') {
                showView('absenceType');
                showNotification('Powr√≥t do wyboru typu nieobecno≈õci', 'info');
                return;
            }
            
            if (currentView === 'managerVacation') {
                currentUser = null;
                window.vacationMode = false;
                showView('department');
                showNotification('Powr√≥t do menu g≈Ç√≥wnego', 'info');
                return;
            }
            
            if (currentView === 'verification') {
            selectedUserForVerification = null;
            currentDepartment = null;
            showView('department');
            ensureCodeInputFocus();
            showNotification('Anulowano weryfikacjƒô', 'info');
            return;
        }
            
            if (currentUser) {
                isLoggedIn = false;
                workerState = 'not-logged-in';
                currentUser = null;
                currentDepartment = null;
                document.getElementById('welcomeHeader').classList.remove('show');
            }
            
            if (currentView === 'user') {
                window.vacationMode = false;
                showView('department');
                showNotification('Powr√≥t do wyboru dzia≈Çu', 'info');
                ensureCodeInputFocus();
            } else if (currentView === 'action') {
                showView('department');
                showNotification('Sesja zako≈Ñczona - powr√≥t do g≈Ç√≥wnego menu', 'info');
                ensureCodeInputFocus();
            } else {
                showNotification('Ju≈º jeste≈õ w g≈Ç√≥wnym menu', 'info');
                ensureCodeInputFocus();
            }
        };

        // ===== FUNKCJE POMOCNICZE =====
        function setupVacationForm() {
            document.getElementById('vacationUserName').textContent = currentUser.name;
            
            updateDateConstraints();
            
            document.getElementById('vacationStartDate').value = '';
            document.getElementById('vacationEndDate').value = '';
            document.getElementById('vacationComment').value = '';
            document.getElementById('vacationInfo').style.display = 'none';
            
            if (typeof google !== 'undefined' && google.script) {
                google.script.run
                    .withSuccessHandler(function(balance) {
                        console.log('Saldo u≈ºytkownika:', balance);
                        
                        document.getElementById('urlopPrzys≈ÇugujƒÖcy').textContent = balance.przys≈ÇugujƒÖcy || 0;
                        document.getElementById('urlopZaleg≈Çy').textContent = balance.zaleg≈Çy || 0;
                        document.getElementById('urlopWykorzystany').textContent = balance.wykorzystany || 0;
                        document.getElementById('urlopPozosta≈Çy').textContent = balance.pozosta≈Çy || 0;
                        document.getElementById('vacationBalance').style.display = 'block';
                        
                        if (balance.przys≈ÇugujƒÖcy === 0 && balance.pozosta≈Çy === 0) {
                            showNotification('Nie masz dostƒôpnych dni urlopu. Nie mo≈ºesz z≈Ço≈ºyƒá wniosku.', 'error');
                            
                            const formElements = document.querySelectorAll('.vacation-form input, .vacation-form textarea, .vacation-form button');
                            formElements.forEach(el => {
                                el.disabled = true;
                            });
                            
                            const warningDiv = document.createElement('div');
                            warningDiv.className = 'vacation-info collision-error';
                            warningDiv.innerHTML = `
                                <strong>‚ö†Ô∏è Brak dostƒôpnych dni urlopu</strong><br>
                                Nie mo≈ºesz z≈Ço≈ºyƒá nowego wniosku urlopowego.<br>
                                Przys≈ÇugujƒÖcy: ${balance.przys≈ÇugujƒÖcy} dni | Pozosta≈Çy: ${balance.pozosta≈Çy} dni
                            `;
                            document.querySelector('.vacation-form').insertBefore(
                                warningDiv, 
                                document.querySelector('.vacation-form').firstChild
                            );
                        } else {
                            const formElements = document.querySelectorAll('.vacation-form input, .vacation-form textarea, .vacation-form button');
                            formElements.forEach(el => {
                                el.disabled = false;
                            });
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('B≈ÇƒÖd ≈Çadowania saldo:', error);
                        showNotification('B≈ÇƒÖd sprawdzania dostƒôpnych dni urlopu', 'error');
                    })
                    .getUserVacationBalance(currentUser.login);
            }
            
            loadUserVacationRequests(currentUser.login);
        }

        function getVacationTypeName(type) {
            const names = {
                'planowany': 'Planowany',
                'na-zadanie': 'Na ≈ºƒÖdanie', 
                'wsteczny': 'Wsteczny'
            };
            return names[type] || type;
        }

        function updateDateConstraints() {
            const startInput = document.getElementById('vacationStartDate');
            const endInput = document.getElementById('vacationEndDate');
            const today = new Date();
            
            if (selectedVacationType === 'planowany') {
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const minDate = tomorrow.toISOString().split('T')[0];
                startInput.min = minDate;
                endInput.min = minDate;
            } else if (selectedVacationType === 'na-zadanie') {
                const todayStr = today.toISOString().split('T')[0];
                startInput.min = todayStr;
                endInput.min = todayStr;
            } else if (selectedVacationType === 'wsteczny') {
                startInput.removeAttribute('min');
                endInput.removeAttribute('min');
            }
        }

        function calculateWorkingDaysLocal(startDate, endDate) {
            const holidays = [
                '2025-01-01', '2025-01-06', '2025-04-20', '2025-04-21', 
                '2025-05-01', '2025-05-03', '2025-06-08', '2025-06-19',
                '2025-08-15', '2025-11-01', '2025-11-11', '2025-12-25', '2025-12-26'
            ];
            let count = 0;
            let current = new Date(startDate);
            const end = new Date(endDate);
            
            while (current <= end) {
                const dayOfWeek = current.getDay();
                const dateStr = current.toISOString().split('T')[0];
                
                if (dayOfWeek !== 0 && dayOfWeek !== 6 && !holidays.includes(dateStr)) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            
            return count;
        }

        function loadUserVacationRequests(login) {
    const container = document.getElementById('userVacationRequests');
    container.innerHTML = '≈Åadowanie wniosk√≥w...';
    
    if (typeof google === 'undefined' || !google.script) {
        container.innerHTML = '<p style="text-align: center; color: #666;">Tryb testowy - brak danych</p>';
        currentUserVacationRequests = []; // Resetuj w trybie testowym
        return;
    }
    
    google.script.run
        .withSuccessHandler(function(requests) {
            // ‚úÖ ZAPISZ WNIOSKI DO GLOBALNEJ ZMIENNEJ
            currentUserVacationRequests = requests || [];
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Brak z≈Ço≈ºonych wniosk√≥w</p>';
                return;
            }
            
            let html = '';
            requests.forEach(request => {
                const statusColor = getStatusColor(request.status);
                const typeLabel = getVacationTypeName(request.vacationType || 'planowany');
                const statusClass = request.status === 'Zatwierdzony' ? 'approved' : 
                                  request.status === 'Odrzucony' ? 'rejected' : 'pending';
                
                html += `
          <div class="vacation-request-item ${statusClass}">
              <div style="display: flex; justify-content: space-between;">
                  <div>
                      <strong>${request.dateFrom} - ${request.dateTo}</strong> 
                      (${request.workingDays} dni)
                      <span style="background: #e3f2fd; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-left: 10px;">${typeLabel}</span>
                  </div>
                  <div style="color: ${statusColor}; font-weight: bold;">
                      ${request.status}
                  </div>
              </div>
              ${request.commentEmployee ? `<p><em>"${request.commentEmployee}"</em></p>` : ''}
              <small>Z≈Ço≈ºony: ${request.dateSubmitted}</small>
              ${request.commentManager ? `<p style="margin-top: 10px; color: #666; padding: 8px; background: #f8f9fa; border-radius: 4px;"><strong>Komentarz kierownika:</strong> ${request.commentManager}</p>` : ''}
              
              ${request.status === 'Zatwierdzony' ? `
                  <div style="margin-top: 15px;">
                      <button onclick="downloadVacationPDF(${request.id})" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">
                          üìÑ Pobierz PDF do podpisu
                      </button>
                  </div>
              ` : ''}
          </div>
`;
            });
            
            container.innerHTML = html;
        })
        .withFailureHandler(function(error) {
            console.error('B≈ÇƒÖd:', error);
            container.innerHTML = '<p style="color: red;">B≈ÇƒÖd ≈Çadowania wniosk√≥w</p>';
            currentUserVacationRequests = []; // Resetuj przy b≈Çƒôdzie
        })
        .getVacationRequests(login);
}

// ===== ZARZƒÑDZANIE NIEOBECNO≈öCIAMI - ZAK≈ÅADKI =====
        
        let currentAbsenceTab = 'vacation';
        
        /**
         * Prze≈ÇƒÖcza zak≈Çadkƒô w panelu kierownika
         */
        window.switchAbsenceTab = function(tab) {
            currentAbsenceTab = tab;
            
            // Aktualizuj wyglƒÖd zak≈Çadek
            document.querySelectorAll('.vacation-type-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById('tab-' + tab).classList.add('selected');
            
            // Za≈Çaduj odpowiednie wnioski
            loadAbsenceRequestsForTab(tab);
        };
        
        /**
         * ≈Åaduje wnioski dla wybranej zak≈Çadki
         */
        function loadAbsenceRequestsForTab(tab) {
            const container = document.getElementById('managerVacationRequests');
            container.innerHTML = '<p style="text-align: center;">‚è≥ ≈Åadowanie wniosk√≥w...</p>';
            
            if (typeof google === 'undefined' || !google.script) {
                container.innerHTML = '<p>Tryb testowy</p>';
                return;
            }
            
            switch(tab) {
                case 'vacation':
                    loadPendingVacationRequests();
                    break;
                case 'dayoff':
                    loadPendingDayOffRequests();
                    break;
                case 'occasional':
                    loadPendingOccasionalRequests();
                    break;
                case 'yearplan':
                    loadPendingYearPlanRequests();
                    break;
            }
        }
        
        /**
         * Aktualizuje liczniki na zak≈Çadkach
         */
        function updateAbsenceTabCounts() {
            if (typeof google === 'undefined' || !google.script) {
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(counts) {
                    document.getElementById('count-vacation').textContent = counts.vacation || 0;
                    document.getElementById('count-dayoff').textContent = counts.dayoff || 0;
                    document.getElementById('count-occasional').textContent = counts.occasional || 0;
                    document.getElementById('count-yearplan').textContent = counts.yearplan || 0;
                    
                    const total = (counts.vacation || 0) + (counts.dayoff || 0) + (counts.occasional || 0) + (counts.yearplan || 0);
                    document.getElementById('pendingCount').textContent = total;
                })
                .withFailureHandler(function(error) {
                    console.error('B≈ÇƒÖd ≈Çadowania licznik√≥w:', error);
                })
                .getPendingAbsenceCountsByType();
        }
        
        /**
         * ≈Åaduje oczekujƒÖce wnioski o dzie≈Ñ wolny
         */
        function loadPendingDayOffRequests() {
            google.script.run
                .withSuccessHandler(function(requests) {
                    const container = document.getElementById('managerVacationRequests');
                    
                    if (!requests || requests.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666;">Brak wniosk√≥w o dzie≈Ñ wolny do zatwierdzenia</p>';
                        return;
                    }
                    
                    let html = '';
                    requests.forEach(request => {
                        const timeInfo = request.timeFrom && request.timeTo ? 
                            `<br><small>Godziny: ${request.timeFrom} - ${request.timeTo}</small>` : '';
                        
                        html += `
                            <div class="vacation-request-item">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <strong>${request.name}</strong> (${request.login})
                                        <span style="background: #e8f5e9; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-left: 10px;">üìÖ Dzie≈Ñ wolny</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <strong>${request.date}</strong>
                                    </div>
                                </div>
                                <p style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                                    <strong>Typ:</strong> ${request.type}${timeInfo}
                                </p>
                                ${request.reason ? `<p><em>"${request.reason}"</em></p>` : ''}
                                <small>Z≈Ço≈ºony: ${request.dateSubmitted}</small>
                                
                                <div class="manager-controls">
                                    <button class="manager-btn approve" onclick="processDayOff(${request.id}, 'Zatwierdzony')">
                                        Zatwierd≈∫
                                    </button>
                                    <button class="manager-btn reject" onclick="processDayOff(${request.id}, 'Odrzucony')">
                                        Odrzuƒá
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    console.error('B≈ÇƒÖd:', error);
                    document.getElementById('managerVacationRequests').innerHTML = '<p style="color: red;">B≈ÇƒÖd ≈Çadowania wniosk√≥w</p>';
                })
                .getPendingDayOffRequests();
        }
        
        /**
         * ≈Åaduje oczekujƒÖce wnioski o urlop okoliczno≈õciowy
         */
        function loadPendingOccasionalRequests() {
            google.script.run
                .withSuccessHandler(function(requests) {
                    const container = document.getElementById('managerVacationRequests');
                    
                    if (!requests || requests.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666;">Brak wniosk√≥w o urlop okoliczno≈õciowy do zatwierdzenia</p>';
                        return;
                    }
                    
                    let html = '';
                    requests.forEach(request => {
                        html += `
                            <div class="vacation-request-item">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <strong>${request.name}</strong> (${request.login})
                                        <span style="background: #f3e5f5; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-left: 10px;">üéä Okoliczno≈õciowy</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <strong>${request.dateFrom}</strong> - <strong>${request.dateTo}</strong>
                                        <br><small>(${request.days} dni)</small>
                                    </div>
                                </div>
                                <p style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                                    <strong>Pow√≥d:</strong> ${request.type}
                                </p>
                                ${request.note ? `<p><em>"${request.note}"</em></p>` : ''}
                                <small>Z≈Ço≈ºony: ${request.dateSubmitted}</small>
                                
                                <div class="manager-controls">
                                    <button class="manager-btn approve" onclick="processOccasionalLeave(${request.id}, 'Zatwierdzony')">
                                        Zatwierd≈∫
                                    </button>
                                    <button class="manager-btn reject" onclick="processOccasionalLeave(${request.id}, 'Odrzucony')">
                                        Odrzuƒá
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    console.error('B≈ÇƒÖd:', error);
                    document.getElementById('managerVacationRequests').innerHTML = '<p style="color: red;">B≈ÇƒÖd ≈Çadowania wniosk√≥w</p>';
                })
                .getPendingOccasionalLeaveRequests();
        }
        
        /**
         * ≈Åaduje oczekujƒÖce plany roczne
         */
        function loadPendingYearPlanRequests() {
            google.script.run
                .withSuccessHandler(function(requests) {
                    const container = document.getElementById('managerVacationRequests');
                    
                    if (!requests || requests.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666;">Brak plan√≥w rocznych do zatwierdzenia</p>';
                        return;
                    }
                    
                    let html = '';
                    requests.forEach(request => {
                        // Parsuj daty z JSON
                        let dates = [];
                        try {
                            dates = typeof request.dates === 'string' ? JSON.parse(request.dates) : request.dates;
                        } catch(e) {
                            dates = [];
                        }
                        
                        // Generuj listƒô dat z checkboxami
                        let datesHtml = '';
                        if (dates && dates.length > 0) {
                            datesHtml = '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin: 10px 0; background: #fafafa;">';
                            datesHtml += '<div style="margin-bottom: 8px;"><label><input type="checkbox" onchange="toggleAllYearPlanDates(this, ' + request.id + ')" checked> <strong>Zaznacz/Odznacz wszystkie</strong></label></div>';
                            datesHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 5px;">';
                            
                            dates.forEach((date, index) => {
                                const dayName = getDayNameShort(date);
                                datesHtml += `
                                    <label style="display: flex; align-items: center; gap: 5px; padding: 3px 6px; background: #e8f5e9; border-radius: 4px; font-size: 12px;">
                                        <input type="checkbox" name="yearplan-${request.id}-dates" value="${date}" checked>
                                        ${date} <span style="color: #666;">(${dayName})</span>
                                    </label>
                                `;
                            });
                            
                            datesHtml += '</div></div>';
                        }
                        
                        html += `
                            <div class="vacation-request-item" id="yearplan-item-${request.id}">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <strong>${request.name}</strong> (${request.login})
                                        <span style="background: #fff3e0; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-left: 10px;">üìÜ Plan roczny</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <strong>Rok ${request.year}</strong>
                                        <br><small>(${request.daysCount} dni zaplanowanych)</small>
                                    </div>
                                </div>
                                
                                <p style="margin: 10px 0 5px 0;"><strong>Zaplanowane daty:</strong></p>
                                ${datesHtml}
                                
                                <div style="background: #fff3e0; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 13px;">
                                    <strong>‚ÑπÔ∏è Informacja:</strong> Plan roczny jest tylko poglƒÖdowy. Zatwierdzenie nie rezerwuje urlopu - pracownik musi z≈Ço≈ºyƒá osobny wniosek urlopowy.
                                </div>
                                
                                <small>Z≈Ço≈ºony: ${request.dateSubmitted}</small>
                                
                                <div class="manager-controls" style="margin-top: 15px;">
                                    <button class="manager-btn approve" onclick="processYearPlanSelected(${request.id}, 'Zatwierdzony')">
                                        ‚úÖ Zatwierd≈∫ zaznaczone
                                    </button>
                                    <button class="manager-btn" onclick="processYearPlanSelected(${request.id}, 'Czƒô≈õciowo zatwierdzony')" style="background: #ff9800;">
                                        ‚ö° Zatwierd≈∫ czƒô≈õciowo
                                    </button>
                                    <button class="manager-btn reject" onclick="processYearPlan(${request.id}, 'Odrzucony')">
                                        ‚ùå Odrzuƒá ca≈Çy plan
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    console.error('B≈ÇƒÖd:', error);
                    document.getElementById('managerVacationRequests').innerHTML = '<p style="color: red;">B≈ÇƒÖd ≈Çadowania wniosk√≥w</p>';
                })
                .getPendingYearPlanRequests();
        }
        
        /**
         * Prze≈ÇƒÖcza wszystkie checkboxy dat w planie rocznym
         */
        window.toggleAllYearPlanDates = function(masterCheckbox, requestId) {
            const checkboxes = document.querySelectorAll('input[name="yearplan-' + requestId + '-dates"]');
            checkboxes.forEach(cb => {
                cb.checked = masterCheckbox.checked;
            });
        };
        
        /**
         * Pobiera skr√≥conƒÖ nazwƒô dnia tygodnia
         */
        function getDayNameShort(dateStr) {
            const days = ['Nd', 'Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'Sb'];
            const date = new Date(dateStr);
            return days[date.getDay()];
        }
        
        /**
         * Przetwarza plan roczny z zaznaczonymi datami
         */
        window.processYearPlanSelected = function(requestId, decision) {
            // Pobierz zaznaczone daty
            const checkboxes = document.querySelectorAll('input[name="yearplan-' + requestId + '-dates"]:checked');
            const selectedDates = [];
            checkboxes.forEach(cb => {
                selectedDates.push(cb.value);
            });
            
            if (selectedDates.length === 0) {
                showNotification('‚ùå Zaznacz przynajmniej jednƒÖ datƒô', 'error');
                return;
            }
            
            // Pobierz wszystkie daty aby por√≥wnaƒá
            const allCheckboxes = document.querySelectorAll('input[name="yearplan-' + requestId + '-dates"]');
            const allDates = [];
            allCheckboxes.forEach(cb => {
                allDates.push(cb.value);
            });
            
            // Okre≈õl czy zatwierdzono wszystkie czy czƒô≈õƒá
            let finalDecision = decision;
            let comment = '';
            
            if (selectedDates.length === allDates.length) {
                finalDecision = 'Zatwierdzony';
                comment = 'Zatwierdzono wszystkie ' + selectedDates.length + ' dni';
            } else {
                finalDecision = 'Czƒô≈õciowo zatwierdzony';
                const rejectedDates = allDates.filter(d => !selectedDates.includes(d));
                comment = 'Zatwierdzono ' + selectedDates.length + '/' + allDates.length + ' dni. Odrzucone daty: ' + rejectedDates.join(', ');
            }
            
            showNotification('‚è≥ Przetwarzanie...', 'info');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result && result.success) {
                        showNotification('‚úÖ ' + result.message, 'success');
                        loadPendingYearPlanRequests();
                        updateAbsenceTabCounts();
                        updateManagerNotificationBadge();
                    } else {
                        showNotification('‚ùå ' + (result ? result.message : 'B≈ÇƒÖd'), 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showNotification('‚ùå B≈ÇƒÖd: ' + error.message, 'error');
                })
                .processYearPlanWithDates(requestId, finalDecision, comment, selectedDates);
        };
        
        /**
         * Przetwarza wniosek o dzie≈Ñ wolny
         */
        /**
         * Przetwarza wniosek o dzie≈Ñ wolny
         */
        window.processDayOff = function(requestId, decision) {
    const comment = decision === 'Odrzucony' ? prompt('Podaj pow√≥d odrzucenia (opcjonalnie):') || '' : '';
    
    // NATYCHMIAST ukryj kartƒô
    const allCards = document.querySelectorAll('#managerVacationRequests .vacation-request-item');
    allCards.forEach(card => {
        const btn = card.querySelector(`button[onclick*="processDayOff(${requestId},"]`);
        if (btn) {
            card.style.transition = 'opacity 0.3s, transform 0.3s';
            card.style.opacity = '0';
            card.style.transform = 'translateX(-20px)';
            setTimeout(() => card.remove(), 300);
        }
    });
    
    // Zaktualizuj licznik
    const tabCountEl = document.getElementById('count-dayoff');
    if (tabCountEl) {
        const count = parseInt(tabCountEl.textContent) || 0;
        tabCountEl.textContent = Math.max(0, count - 1);
    }
    
    showNotification(`‚úÖ ${decision === 'Zatwierdzony' ? 'Zatwierdzono' : 'Odrzucono'} wniosek`, 'success');
    
    // W TLE zapisz
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                updateAbsenceTabCounts();
                updateManagerNotificationBadge();
                if (decision === 'Zatwierdzony') {
                    setTimeout(() => {
                        if (confirm('Wniosek zatwierdzony!\n\nCzy chcesz pobraƒá PDF do podpisu?')) {
                            downloadDayOffPDF(requestId);
                        }
                    }, 300);
                }
            } else {
                showNotification('‚ùå ' + result.message, 'error');
                loadPendingDayOffRequests();
            }
        })
        .withFailureHandler(function(error) {
            showNotification('‚ùå B≈ÇƒÖd: ' + error.message, 'error');
            loadPendingDayOffRequests();
        })
        .processDayOffRequest(requestId, decision, comment);
};
        
        /**
         * Przetwarza wniosek o urlop okoliczno≈õciowy
         */
        /**
         * Przetwarza wniosek o urlop okoliczno≈õciowy
         */
        window.processOccasionalLeave = function(requestId, decision) {
    const comment = decision === 'Odrzucony' ? prompt('Podaj pow√≥d odrzucenia (opcjonalnie):') || '' : '';
    
    // NATYCHMIAST ukryj kartƒô
    const allCards = document.querySelectorAll('#managerVacationRequests .vacation-request-item');
    allCards.forEach(card => {
        const btn = card.querySelector(`button[onclick*="processOccasionalLeave(${requestId},"]`);
        if (btn) {
            card.style.transition = 'opacity 0.3s, transform 0.3s';
            card.style.opacity = '0';
            card.style.transform = 'translateX(-20px)';
            setTimeout(() => card.remove(), 300);
        }
    });
    
    // Zaktualizuj licznik
    const tabCountEl = document.getElementById('count-occasional');
    if (tabCountEl) {
        const count = parseInt(tabCountEl.textContent) || 0;
        tabCountEl.textContent = Math.max(0, count - 1);
    }
    
    showNotification(`‚úÖ ${decision === 'Zatwierdzony' ? 'Zatwierdzono' : 'Odrzucono'} wniosek`, 'success');
    
    // W TLE zapisz
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                updateAbsenceTabCounts();
                updateManagerNotificationBadge();
                if (decision === 'Zatwierdzony') {
                    setTimeout(() => {
                        if (confirm('Wniosek zatwierdzony!\n\nCzy chcesz pobraƒá PDF do podpisu?')) {
                            downloadOccasionalLeavePDF(requestId);
                        }
                    }, 300);
                }
            } else {
                showNotification('‚ùå ' + result.message, 'error');
                loadPendingOccasionalRequests();
            }
        })
        .withFailureHandler(function(error) {
            showNotification('‚ùå B≈ÇƒÖd: ' + error.message, 'error');
            loadPendingOccasionalRequests();
        })
        .processOccasionalLeaveRequest(requestId, decision, comment);
};
        
        /**
         * Przetwarza plan roczny
         */
        window.processYearPlan = function(requestId, decision) {
            const comment = decision === 'Odrzucony' ? prompt('Podaj pow√≥d odrzucenia (opcjonalnie):') || '' : '';
            
            showNotification('‚è≥ Przetwarzanie...', 'info');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result && result.success) {
                        showNotification('‚úÖ ' + result.message, 'success');
                        loadPendingYearPlanRequests();
                        updateAbsenceTabCounts();
                        updateManagerNotificationBadge();
                    } else {
                        showNotification('‚ùå ' + (result ? result.message : 'B≈ÇƒÖd'), 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showNotification('‚ùå B≈ÇƒÖd: ' + error.message, 'error');
                })
                .processYearPlanRequest(requestId, decision, comment);
        };

        function loadPendingVacationRequests() {
    const container = document.getElementById('managerVacationRequests');
    
    // 1. NATYCHMIAST poka≈º skeleton loading (nie blokuj UI)
    container.innerHTML = `
        <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; margin-bottom: 10px; animation: pulse 1.5s infinite;">
            <div style="height: 20px; background: #e9ecef; border-radius: 4px; width: 60%; margin-bottom: 10px;"></div>
            <div style="height: 14px; background: #e9ecef; border-radius: 4px; width: 40%;"></div>
        </div>
        <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; margin-bottom: 10px; animation: pulse 1.5s infinite; animation-delay: 0.2s;">
            <div style="height: 20px; background: #e9ecef; border-radius: 4px; width: 70%; margin-bottom: 10px;"></div>
            <div style="height: 14px; background: #e9ecef; border-radius: 4px; width: 35%;"></div>
        </div>
    `;
    
    if (typeof google === 'undefined' || !google.script) {
        container.innerHTML = '<p style="text-align: center; color: #666;">Tryb testowy</p>';
        document.getElementById('pendingCount').textContent = '0';
        return;
    }
    
    // 2. Pobierz dane z backendu
    google.script.run
        .withSuccessHandler(function(requests) {
            document.getElementById('pendingCount').textContent = requests.length;
            
            // Zaktualizuj licznik w zak≈Çadce
            const tabCountEl = document.getElementById('count-vacation');
            if (tabCountEl) tabCountEl.textContent = requests.length;
            
            if (requests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">‚úÖ Brak wniosk√≥w do zatwierdzenia</p>';
                return;
            }
            
            // 3. Renderuj wnioski
            let html = '';
            requests.forEach(request => {
                const collisionClass = request.collisions && request.collisions.canApprove ? 'vacation-info' : 'collision-error';
                const collisionText = request.collisions ? 
                    (request.collisions.canApprove ? 
                        `${request.collisions.conflicts}/3 os√≥b na urlopie ‚úì` : 
                        `KOLIZJA: ${request.collisions.conflicts}/3 - brak miejsc!`) :
                    'Sprawdzanie kolizji...';
                const typeLabel = getVacationTypeName(request.vacationType || 'planowany');
                
                html += `
                    <div class="vacation-request-item">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>${request.name}</strong> (${request.login})
                                <span style="background: #e3f2fd; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-left: 10px;">${typeLabel}</span>
                            </div>
                            <div>
                                ${request.dateFrom} - ${request.dateTo} (${request.workingDays} dni)
                            </div>
                        </div>
                        ${request.commentEmployee ? `<p><em>"${request.commentEmployee}"</em></p>` : ''}
                        <div class="${collisionClass}" style="margin: 10px 0; padding: 10px;">
                            ${collisionText}
                        </div>
                        <small>Z≈Ço≈ºony: ${request.dateSubmitted}</small>
                        
                        <div class="manager-controls">
                            <button class="manager-btn approve" onclick="processVacation('${request.id}', 'Zatwierdzony')">
                                Zatwierd≈∫
                            </button>
                            <button class="manager-btn reject" onclick="processVacation('${request.id}', 'Odrzucony')">
                                Odrzuƒá
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        })
        .withFailureHandler(function(error) {
            console.error('B≈ÇƒÖd:', error);
            container.innerHTML = '<p style="color: red; text-align: center;">‚ùå B≈ÇƒÖd ≈Çadowania wniosk√≥w</p>';
        })
        .getPendingVacationRequests();
}

        function loadDepartmentsFromSpreadsheet() {
            console.log('≈Åadowanie pracownik√≥w z arkusza...');
            
            //const departmentTiles = document.querySelectorAll('#departmentView .tile');
            //departmentTiles.forEach(tile => tile.style.opacity = '0.3');
            
           if (typeof google === 'undefined' || !google.script) {
              departments = {
                'przyjecie': {
                  name: 'Przyjƒôcie dostaw',
                  users: [
                    { login: 'rafalk5', code: '1233727088163', name: 'Rafa≈Ç test' },
                    { login: 'jerzyd', code: '1236737459372', name: 'Jerzy Dwurznik' }
                  ]
                }
              };
            
              const cs = document.getElementById('connectionStatus');
              if (cs) {
                cs.textContent = 'Tryb Pages (API)';
                cs.style.color = '#fbbf24';
              }
            
              showNotification('Tryb testowy', 'info');
              return;
            }
            
            google.script.run 
                .withSuccessHandler(function(data) {
                    departments = data;
                    console.log('Za≈Çadowano pracownik√≥w z arkusza:', departments);
                    
                    for (const [deptId, dept] of Object.entries(departments)) {
                        dept.users.forEach(user => {
                            if (user.status) {
                                if (user.status === 'Pracuje') {
                                    userStatuses[user.login] = 'logged-in-working';
                                } else if (user.status === 'Na przerwie') {
                                    userStatuses[user.login] = 'logged-in-on-break';
                                } else {
                                    userStatuses[user.login] = 'not-logged-in';
                                }
                            } else {
                                userStatuses[user.login] = 'not-logged-in';
                            }
                        });
                    }
                    console.log('Za≈Çadowano statusy u≈ºytkownik√≥w:', userStatuses);
                    
                    google.script.run
                        .withSuccessHandler(function(departmentsList) {
                            console.log('Za≈Çadowano dzia≈Çy z arkusza:', departmentsList);
                            generateDepartmentTiles(departmentsList);
                            
                            const allTiles = document.querySelectorAll('#departmentView .tile');
                            //allTiles.forEach(tile => tile.style.opacity = '1');
                            
                            document.getElementById('connectionStatus').textContent = 'Dane za≈Çadowane';
                            document.getElementById('connectionStatus').style.color = '#28a745';

                            updateTicketsNotificationBadge();

                            if (isLoggedIn) {
                              setTimeout(focusEanInput, 50);
                              setTimeout(focusEanInput, 250);
                              setTimeout(focusEanInput, 800);
                            }

                        })
                        .withFailureHandler(function(error) {
                            console.error('B≈ÇƒÖd ≈Çadowania dzia≈Ç√≥w:', error);
                            const allTiles = document.querySelectorAll('#departmentView .tile');
                            //allTiles.forEach(tile => tile.style.opacity = '1');
                        })
                        .getDepartmentsList();
                })
                .withFailureHandler(function(error) {
                    console.error('B≈ÇƒÖd ≈Çadowania danych:', error);
                    document.getElementById('connectionStatus').textContent = 'B≈ÇƒÖd ≈Çadowania';
                    document.getElementById('connectionStatus').style.color = '#dc3545';
                    
                    const allTiles = document.querySelectorAll('#departmentView .tile');
                    //allTiles.forEach(tile => tile.style.opacity = '1');
                })
                .getDepartmentsData();
        }

        function generateDepartmentTiles(departmentsList) {
  console.log('generateDepartmentTiles wywo≈Çane z:', departmentsList);

  if (!departmentsList || departmentsList.length === 0) {
    console.log('Brak danych dzia≈Ç√≥w - zostawiam hardcoded kafelki');
    return;
  }

  const container = document.querySelector('#departmentView .tiles-grid');
  if (!container) {
    console.warn('Brak kontenera #departmentView .tiles-grid');
    return;
  }

  const departmentIcons = {
    'przyjecie': 'üì¶',
    'rozladunek': 'üöõ',
    'zaladunek': 'üì§',
    'relokacja': 'üîÑ',
    'kompletacja': 'üìã',
    'weryfikacja': '‚úÖ',
    'co-packing': 'üéÅ',
    'operacje-porzadkowe': 'üßπ',
    'inwentaryzacja': 'üìä'
  };

  container.querySelectorAll('.tile').forEach(tile => tile.remove());

  departmentsList.forEach(dept => {
    const deptId = dept.id || dept.id_operacji;
    const deptName = dept.name || dept.nazwa_operacji;

    if (!deptId) return;

    const tile = document.createElement('div');
    tile.className = `tile ${deptId}`;
    tile.dataset.deptId = deptId;

    const icon = departmentIcons[deptId] || 'üìÅ';

    const iconEl = document.createElement('span');
    iconEl.className = 'tile-icon';
    iconEl.textContent = icon;

    const textEl = document.createElement('span');
    textEl.className = 'tile-text';
    textEl.textContent = deptName || deptId;

    tile.appendChild(iconEl);
    tile.appendChild(textEl);

    tile.onclick = () => selectDepartment(deptId);

    container.appendChild(tile);
  });

  // po wygenerowaniu kafelk√≥w od razu do≈Ç√≥≈º badge + od≈õwie≈º liczby
  setupDepartmentTileBadges();

  // je≈õli ju≈º mamy dane, od razu je na≈Ç√≥≈º na nowe kafelki (bez czekania i bez drugiego requestu)
  if (liveWorkforceCache && liveWorkforceCache.loaded) {
    applyLiveWorkforceToUI(liveWorkforceCache);
  } else {
    refreshLiveWorkforce();
  }
}

        function generateUserTiles() {
            const container = document.getElementById('userTiles');
            container.innerHTML = '';
            
            if (!departments || Object.keys(departments).length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666;">≈Åadowanie pracownik√≥w...</div>';
                return;
            }
            
            const allUsers = [];
            for (const [deptId, dept] of Object.entries(departments)) {
                dept.users.forEach(user => {
                    allUsers.push(user);
                });
            }
            
            allUsers.sort((a, b) => a.login.localeCompare(b.login));
            
            if (window.vacationMode && typeof google !== 'undefined' && google.script) {
                loadAllUserBalances(allUsers);
            } else {
                renderUserTiles(allUsers);
            }
        }

        function loadAllUserBalances(users) {
            const container = document.getElementById('userTiles');
            container.innerHTML = '<div style="text-align: center; color: #666;">Sprawdzam dostƒôpno≈õƒá urlop√≥w...</div>';
            
            let loadedCount = 0;
            const totalUsers = users.length;
            
            users.forEach(user => {
                google.script.run
                    .withSuccessHandler(function(balance) {
                        userVacationBalances[user.login] = balance;
                        loadedCount++;
                        
                        if (loadedCount === totalUsers) {
                            renderUserTiles(users);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('B≈ÇƒÖd pobierania saldo dla:', user.login, error);
                        userVacationBalances[user.login] = { przys≈ÇugujƒÖcy: 0, pozosta≈Çy: 0, zaleg≈Çy: 0, wykorzystany: 0 };
                        loadedCount++;
                        
                        if (loadedCount === totalUsers) {
                            renderUserTiles(users);
                        }
                    })
                    .getUserVacationBalance(user.login);
            });
        }

        function renderUserTiles(users) {
            const container = document.getElementById('userTiles');
            container.innerHTML = '';
            
            users.forEach(user => {
                const tile = document.createElement('div');
                tile.className = 'tile user';
                
                if (window.vacationMode) {
                    const balance = userVacationBalances[user.login];
                    
                    if (balance && balance.pozosta≈Çy === 0) {
                        tile.classList.add('disabled');
                        tile.innerHTML = `
                            ${user.login}
                            <div style="font-size: 11px; margin-top: 5px; color: rgba(255,255,255,0.7);">
                                Brak dostƒôpnych dni
                            </div>
                        `;
                        tile.onclick = function() {
                            showNotification('Ten pracownik nie ma dostƒôpnych dni urlopu', 'error');
                        };
                    } else {
                        tile.textContent = user.login;
                        tile.onclick = () => selectUser(user.login);
                        
                        if (balance) {
                            const availableDays = balance.pozosta≈Çy;
                            const infoDiv = document.createElement('div');
                            infoDiv.style.cssText = 'font-size: 11px; margin-top: 8px; color: rgba(255,255,255,0.9); border-top: 1px solid rgba(255,255,255,0.3); padding-top: 5px;';
                            infoDiv.textContent = `Dostƒôpne: ${availableDays} dni`;
                            tile.appendChild(infoDiv);
                        }
                    }
                } else {
                    tile.textContent = user.login;
                    tile.onclick = () => selectUser(user.login);
                }
                
                if (user.login === 'jerzyd' && pendingVacationCount > 0) {
                    const badge = document.createElement('div');
                    badge.className = 'user-notification-badge';
                    badge.textContent = pendingVacationCount;
                    tile.appendChild(badge);
                }
                
                container.appendChild(tile);
            });
        }

        function sendToSpreadsheet(login, department, action, timestamp) {
  const data = {
    login: login,
    department: department,
    action: action,
    timestamp: timestamp || new Date().toISOString()
  };

  // NATYCHMIAST w UI (Sprint-style)
  optimisticUpdateLiveWorkforce(data);

  console.log('Wysy≈Çanie do arkusza:', data);

  if (typeof google === 'undefined' || !google.script) {
    showNotification('Zapisano (tryb testowy): ' + action, 'success');
    refreshLiveWorkforce();
    return;
  }

  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.success) {
        console.log('Zapisano w arkuszu:', result.message);
        showNotification('Zapisano: ' + result.message, 'success');

        // dosynchronizuj z backendem (inni pracownicy/stanowiska)
        setTimeout(refreshLiveWorkforce, 200);
        setTimeout(refreshLiveWorkforce, 1500);

        const cs = document.getElementById('connectionStatus');
        if (cs) {
          cs.textContent = 'Aktywne';
          cs.style.color = '#28a745';
        }

        google.script.run
          .withSuccessHandler(function(updatedData) {
            departments = updatedData;
            console.log('Od≈õwie≈ºono dane po operacji:', departments);

            if (currentUser) {
              for (const [deptId, dept] of Object.entries(departments || {})) {
                const users = (dept && dept.users) ? dept.users : [];
                const user = users.find(u => u.login === currentUser.login);
                if (user) {
                  currentUser = user;
                  console.log('Zaktualizowano currentUser:', currentUser);

                  setTimeout(() => {
                    updateButtonStates();
                  }, 100);
                  break;
                }
              }
            }
          })
          .withFailureHandler(function(error) {
            console.error('B≈ÇƒÖd od≈õwie≈ºania danych:', error);
          })
          .getDepartmentsData();

      } else {
        console.error('B≈ÇƒÖd zapisu:', result);
        showNotification('B≈ÇƒÖd zapisu', 'error');

        const cs = document.getElementById('connectionStatus');
        if (cs) {
          cs.textContent = 'B≈ÇƒÖd';
          cs.style.color = '#dc3545';
        }
      }
    })
    .withFailureHandler(function(error) {
      console.error('B≈ÇƒÖd po≈ÇƒÖczenia:', error);
      showNotification('B≈ÇƒÖd po≈ÇƒÖczenia', 'error');

      const cs = document.getElementById('connectionStatus');
      if (cs) {
        cs.textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia';
        cs.style.color = '#dc3545';
      }
    })
    .addTimeEntry(data.login, data.department, data.action, data.timestamp);
}


        function showView(viewName) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.getElementById(viewName + 'View').classList.add('active');
        currentView = viewName;
        updateTopBarButton();
    }

        function loginUser(user, departmentId) {
            const now = new Date();
            const timeString = now.toISOString().slice(0, 19).replace('T', ' ');
            
            document.getElementById('welcomeHeader').classList.add('show');
            
            const departmentNames = {
                'przyjecie': 'Przyjƒôcie dostaw',
                'rozladunek': 'Roz≈Çadunek rƒôczny kontenera',
                'zaladunek': 'Za≈Çadunek rƒôczny kontenera',
                'relokacja': 'Relokacja',
                'kompletacja': 'Kompletacja zam√≥wie≈Ñ',
                'weryfikacja': 'Weryfikacja zam√≥wie≈Ñ',
                'co-packing': 'Co-packing',
                'operacje-porzadkowe': 'Operacje porzƒÖdkowe',
                'inwentaryzacja': 'Inwentaryzacja'
            };
            
            const deptName = departmentNames[departmentId] || departments[departmentId]?.name || departmentId;
            
            document.getElementById('welcomeMessage').textContent = 
                `Witaj ${user.login}! Zalogowano ${timeString} - ${deptName}`;
        }

        function updateButtonStates() {
            console.log('=== updateButtonStates WYWO≈ÅANE ===');
            console.log('currentUser:', currentUser);
            console.log('workerState:', workerState);
            
            const wchodziBtn = document.getElementById('wchodzi-btn');
            const wychodziPrzerwaBtn = document.getElementById('wychodzi-przerwa-btn');
            const wracamBtn = document.getElementById('wracam-btn');
            const wychodziPracyBtn = document.getElementById('wychodzi-pracy-btn');
            const zmieniamOperacjeBtn = document.getElementById('zmieniam-operacje-btn');

            [wchodziBtn, wychodziPrzerwaBtn, wracamBtn, wychodziPracyBtn, zmieniamOperacjeBtn].forEach(btn => {
                if (btn) btn.classList.remove('disabled');
            });

            const userRealStatus = currentUser ? currentUser.status : 'Nieaktywny';
            console.log('userRealStatus z arkusza:', userRealStatus);

            if (userRealStatus === 'Nieaktywny' || !currentUser) {
                wchodziBtn && wchodziBtn.classList.remove('disabled');
                wychodziPrzerwaBtn && wychodziPrzerwaBtn.classList.add('disabled');
                wracamBtn && wracamBtn.classList.add('disabled');
                wychodziPracyBtn && wychodziPracyBtn.classList.add('disabled');
                zmieniamOperacjeBtn && zmieniamOperacjeBtn.classList.add('disabled');
                document.getElementById('statusInfo').textContent = 'Nie zalogowany';
            } else if (userRealStatus === 'Pracuje') {
                wchodziBtn && wchodziBtn.classList.add('disabled');
wychodziPrzerwaBtn && wychodziPrzerwaBtn.classList.remove('disabled');
                wracamBtn && wracamBtn.classList.add('disabled');
                wychodziPracyBtn && wychodziPracyBtn.classList.remove('disabled');
                zmieniamOperacjeBtn && zmieniamOperacjeBtn.classList.remove('disabled');
                document.getElementById('statusInfo').textContent = 'Zalogowany - Pracuje';
            } else if (userRealStatus === 'Na przerwie') {
                wchodziBtn && wchodziBtn.classList.add('disabled');
                wychodziPrzerwaBtn && wychodziPrzerwaBtn.classList.add('disabled');
                wracamBtn && wracamBtn.classList.remove('disabled');
                wychodziPracyBtn && wychodziPracyBtn.classList.remove('disabled');
                zmieniamOperacjeBtn && zmieniamOperacjeBtn.classList.add('disabled');
                document.getElementById('statusInfo').textContent = 'Zalogowany - Na przerwie';
            }
        }

        function showConfirmationModal(action, timestamp) {
            const modal = document.getElementById('confirmationModal');
            const title = document.getElementById('confirmationTitle');
            const message = document.getElementById('confirmationMessage');
            const timestampEl = document.getElementById('confirmationTimestamp');
            const actionEl = document.getElementById('confirmationAction');
            
            modal.setAttribute('data-action', action);
            
            if (action === 'wychodzi-przerwa') {
                title.textContent = `BRAWO ${currentUser.login}!`;
                message.textContent = 'Twoje wyj≈õcie na przerwƒô zosta≈Ço zapisane.';
                timestampEl.textContent = `wyj≈õcie na przerwƒô: ${timestamp}`;
                actionEl.textContent = 'Wychodzƒô na przerwƒô';
            } else if (action === 'wracam') {
                title.textContent = `BRAWO ${currentUser.login}!`;
                message.textContent = 'Tw√≥j powr√≥t z przerwy zosta≈Ç zapisany.';
                timestampEl.textContent = `powr√≥t z przerwy: ${timestamp}`;
                actionEl.textContent = 'Wracam z przerwy';
            }
            
            modal.classList.add('show');
        }

    function showConfirmationModalApi(data) {
  const modal = document.getElementById('confirmationModal');
  const title = document.getElementById('confirmationTitle');
  const message = document.getElementById('confirmationMessage');
  const timestampEl = document.getElementById('confirmationTimestamp');
  const actionEl = document.getElementById('confirmationAction');

  if (!modal || !title || !message || !timestampEl || !actionEl) return;

  const userLogin =
    (data && data.user && typeof data.user === 'object' ? data.user.login : null) ||
    (data && data.user ? data.user : null) ||
    data?.login ||
    data?.userLogin ||
    'OK';

  const action = data?.action || data?.type || data?.event || 'scan';
  const ts = data?.timestamp || data?.time || data?.dateTime || '';

  const humanActionMap = {
    'wychodzi-przerwa': 'Wychodzƒô na przerwƒô',
    'wracam': 'Wracam z przerwy',
    'wchodzi': 'Wchodzƒô',
    'wychodzi-pracy': 'Wychodzƒô z pracy',
    'zmieniam-operacje': 'Zmieniam operacjƒô',
    // je≈õli backend zwraca inne kody:
    'BREAK_START': 'Wychodzƒô na przerwƒô',
    'BREAK_END': 'Wracam z przerwy',
    'IN': 'Wchodzƒô',
    'OUT': 'Wychodzƒô z pracy'
  };

  title.textContent = `BRAWO ${userLogin}!`;
  message.textContent = data?.message || 'Zapisano.';
  timestampEl.textContent = ts ? `czas: ${ts}` : 'czas: -';
  actionEl.textContent = humanActionMap[action] || String(action);

  modal.setAttribute('data-action', String(action));
  modal.classList.add('show');
}

    function showConfirmationModalApi(data) {
  const modal = document.getElementById('confirmationModal');
  const title = document.getElementById('confirmationTitle');
  const message = document.getElementById('confirmationMessage');
  const timestampEl = document.getElementById('confirmationTimestamp');
  const actionEl = document.getElementById('confirmationAction');
  if (!modal || !title || !message || !timestampEl || !actionEl) return;

  const userLogin =
    (data && data.user && typeof data.user === 'object' ? data.user.login : null) ||
    (data && typeof data.user === 'string' ? data.user : null) ||
    data?.employeeId ||
    data?.login ||
    'OK';

  const action = data?.type || data?.action || data?.event || 'SCAN';
  const iso = data?.timestamp || data?.time || '';
  const ts = iso ? new Date(iso).toLocaleString('pl-PL') : '-';

  const map = {
    IN: 'Wchodzƒô',
    OUT: 'Wychodzƒô z pracy',
    BREAK_START: 'Wychodzƒô na przerwƒô',
    BREAK_END: 'Wracam z przerwy'
  };

  title.textContent = `BRAWO ${userLogin}!`;
  message.textContent = data?.message || 'Zapisano.';
  timestampEl.textContent = `czas: ${ts}`;
  actionEl.textContent = map[action] || String(action);

  modal.setAttribute('data-action', String(action));
  modal.classList.add('show');
}

        function getStatusColor(status) {
            switch(status) {
                case 'Zatwierdzony': return '#28a745';
                case 'Odrzucony': return '#dc3545';
                case 'OczekujƒÖcy': return '#ffc107';
                default: return '#6c757d';
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? '#28a745' : type === 'info' ? '#007bff' : '#dc3545'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 1001;
                font-weight: 600;
                max-width: 300px;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 1500);
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pl-PL', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            const dateString = now.toLocaleDateString('pl-PL', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('currentTime').textContent = timeString;
            document.getElementById('currentDate').textContent = dateString.charAt(0).toUpperCase() + dateString.slice(1);
        }

        function handleKeyPress(e) {
            console.log('Klawisz:', e.key, 'Warto≈õƒá:', this.value);
            
            if (e.key === 'Enter') {
                e.preventDefault();
                const code = this.value.trim();
                console.log('Enter - kod do skanowania:', code);
                
                if (code) {
                    const cleanCode = code.replace(/^~/, '').replace(/~$/, '').trim();
                    console.log('Kod po oczyszczeniu:', cleanCode);
                    handleCodeScan(cleanCode);
                    this.value = '';
                    this.focus();
                }
            }
        }

        function handleInput(e) {
        }

        function handleCodeScan(code) {
            console.log('=== ROZPOCZƒòCIE SKANOWANIA ===');
            console.log('Otrzymany kod:', code);
            
            const cleanCode = code.toString().replace(/^~+/, '').replace(/~+$/, '').trim();
            console.log('Kod po oczyszczeniu:', cleanCode);
            
            sessionStorage.setItem('currentEmployeeCode', cleanCode);

            // ===== TRYB API (bez Google Apps Script) =====
            showNotification('‚è≥ Wysy≈Çam do API...', 'info');
            
            apiLookupEmployeeByCode(cleanCode)
              .then((data) => {
                const statusEl = document.getElementById('statusInfo');
            
                // Info w pasku (zostawiamy, bo ju≈º dzia≈Ça)
                const line =
                  (data.login ? data.login : '') +
                  (data.name ? ` ‚Ä¢ ${data.name}` : '') +
                  (data.status ? ` ‚Ä¢ ${data.status}` : '');
                if (statusEl) statusEl.textContent = line || (data.message || 'OK');

                // Je≈õli API zwr√≥ci b≈ÇƒÖd ‚Äî ko≈Ñczymy
                if (data.success === false) {
                  showNotification(data.message || '‚ùå Odrzucono', 'error');
                  return;
                }
            
                // ‚úÖ SUKCES: skan ma tylko ustawiƒá kontekst + sprawdziƒá og≈Çoszenia + wej≈õƒá w panel operatora
                // Oczekujemy po tym kroku: data.login, data.name, data.status, data.currentDepartment
                currentUser = {
                  login: data.login,
                  name: data.name,
                  status: data.status // wa≈ºne, bo proceedToActionView w DBK mapuje status
                };
            
                currentDepartment = data.currentDepartment || null;
            
                // Potrzebne do systemu og≈Çosze≈Ñ (markAsReadAndContinue u≈ºywa tego loginu)
                sessionStorage.setItem('currentEmployeeLogin', currentUser.login);
            
                // Funkcja 1:1 jak DBK ‚Äî wej≈õcie do panelu operatora
                function proceedToActionViewApi() {
                  // mapowanie statusu na workerState (1:1 jak w proceedToActionView w pliku)
                  if (currentUser.status === 'Pracuje') {
                    workerState = 'logged-in-working';
                    userStatuses[currentUser.login] = 'logged-in-working';
                  } else if (currentUser.status === 'Na przerwie') {
                    workerState = 'logged-in-on-break';
                    userStatuses[currentUser.login] = 'logged-in-on-break';
                  } else {
                    workerState = 'not-logged-in';
                    userStatuses[currentUser.login] = 'not-logged-in';
                  }
            
                  isLoggedIn = true;
            
                  document.getElementById('welcomeHeader').classList.remove('show');
            
                  const deptLabel = (data.departmentName || currentDepartment || '').toString().trim();
                  document.getElementById('actionViewTitle').textContent =
                    `Panel operatora - ${currentUser.login}${deptLabel ? ` (${deptLabel})` : ''}`;
            
                  showView('action');
                  updateButtonStates();
                  updateMyTicketsTileInActionView();
            
                  showNotification(`${currentUser.login} - wybierz akcjƒô (${currentUser.status})`, 'success');
                }
            
                // ‚úÖ Og≈Çoszenia przed panelem
                // Je≈õli API zwr√≥ci announcements[] -> u≈ºyjemy tego bez dodatkowego calla
                if (Array.isArray(data.announcements)) {
                  if (data.announcements.length > 0) {
                    pendingAnnouncements = data.announcements;
                    currentAnnouncementIndex = 0;
                    pendingRegistrationData = proceedToActionViewApi;
                    showCurrentAnnouncement();
                  } else {
                    proceedToActionViewApi();
                  }
                  return;
                }
            
                // Je≈õli API NIE zwraca announcements -> u≈ºyj istniejƒÖcej funkcji checkForAnnouncements (przerobimy jƒÖ w kroku 2)
                checkForAnnouncements(currentUser.login, proceedToActionViewApi);
              })
              .catch((err) => {
                console.error(err);
                showNotification('‚ùå B≈ÇƒÖd API: ' + (err?.message || err), 'error');
              });
            
            return; // <- zostaje! dalej nie wchodzimy w starƒÖ logikƒô departments/google.script.run
            let foundUser = null;
            let foundDepartment = null;

            for (const [deptId, dept] of Object.entries(departments)) {
                const userCode = dept.users.find(u => {
                    const storedCode = u.code.toString().replace(/^~+/g, '').replace(/~+$/g, '').trim();
                    return storedCode === cleanCode;
                });
                if (userCode) {
                    foundUser = userCode;
                    foundDepartment = deptId;
                    console.log('ZNALEZIONO u≈ºytkownika:', userCode);
                    break;
                }
            }

            if (foundUser) {
                // Pre-load cache og≈Çosze≈Ñ dla tego u≈ºytkownika
                if (!announcementsCacheLoaded || announcementsCache.loginPracownika !== foundUser.login) {
                    loadAnnouncementsCache(foundUser.login);
                }
                
                // ===== KIEROWNIK - ZOPTYMALIZOWANY FLOW =====
            if (foundUser.login === 'jerzyd') {
                console.log('üöÄ Kierownik zeskanowany - NATYCHMIAST pokazujƒô weryfikacjƒô');
                
                const managerDataForVacation = {
                    login: foundUser.login,
                    name: foundUser.name,
                    status: foundUser.status,
                    currentDepartment: foundUser.currentDepartment || foundUser.department || foundDepartment
                };
                
                // 1. NATYCHMIAST poka≈º okno weryfikacji
                selectedUserForVerification = { 
                    login: managerDataForVacation.login, 
                    name: managerDataForVacation.name, 
                    isManagerAccess: true,
                    managerData: managerDataForVacation,
                    foundDepartment: foundDepartment
                };
                
                document.getElementById('selectedUserName').textContent = managerDataForVacation.name;
                document.getElementById('selectedDepartmentName').textContent = 'Panel Kierownika';
                showView('verification');
                
                setTimeout(function() {
                    const verificationInput = document.getElementById('verificationCodeInput');
                    if (verificationInput) {
                        verificationInput.value = '';
                        verificationInput.focus();
                    }
                }, 100);
                
                showNotification('Zweryfikuj to≈ºsamo≈õƒá (≈Çadowanie danych...)', 'info');
                
                // 2. W TLE pobierz dane o urlopach
                if (typeof google !== 'undefined' && google.script) {
                    google.script.run
                        .withSuccessHandler(function(liveCount) {
                            console.log('üìä Urlopy za≈Çadowane w tle:', liveCount);
                            pendingVacationCount = liveCount;
                            updateManagerNotificationBadge();
                            
                            // Zaktualizuj powiadomienie
                            if (liveCount > 0) {
                                showNotification('Zweryfikuj to≈ºsamo≈õƒá (' + liveCount + ' oczekujƒÖcych wniosk√≥w)', 'info');
                            } else {
                                showNotification('Zweryfikuj to≈ºsamo≈õƒá aby kontynuowaƒá', 'info');
                            }
                        })
                        .withFailureHandler(function(error) {
                            console.error('‚ùå B≈ÇƒÖd sprawdzania urlop√≥w:', error);
                        })
                        .getPendingAbsenceRequestsCount();
                }
                
                return; // Zako≈Ñcz - czekamy na weryfikacjƒô
            }
            // ===== KONIEC KIEROWNIK =====
                
                const userCurrentStatus = foundUser.status || 'Nieaktywny';
                console.log('Status u≈ºytkownika z arkusza:', userCurrentStatus);
                
                const targetDepartment = foundUser.currentDepartment || foundUser.department || foundDepartment;
                
                currentDepartment = targetDepartment;
                currentUser = foundUser;
                
                const departmentNames = {
                    'przyjecie': 'Przyjƒôcie dostaw',
                    'rozladunek': 'Roz≈Çadunek rƒôczny kontenera',
                    'zaladunek': 'Za≈Çadunek rƒôczny kontenera',
                    'relokacja': 'Relokacja',
                    'kompletacja': 'Kompletacja zam√≥wie≈Ñ',
                    'weryfikacja': 'Weryfikacja zam√≥wie≈Ñ',
                    'co-packing': 'Co-packing',
                    'operacje-porzadkowe': 'Operacje porzƒÖdkowe',
                    'inwentaryzacja': 'Inwentaryzacja'
                };
                
                const deptName = departmentNames[targetDepartment] || targetDepartment;

                // Funkcja pomocnicza - przejd≈∫ do panelu operatora
                function proceedToActionView() {
                    if (currentUser.status === 'Pracuje') {
                        workerState = 'logged-in-working';
                        userStatuses[currentUser.login] = 'logged-in-working';
                    } else if (currentUser.status === 'Na przerwie') {
                        workerState = 'logged-in-on-break';
                        userStatuses[currentUser.login] = 'logged-in-on-break';
                    } else {
                        workerState = 'not-logged-in';
                        userStatuses[currentUser.login] = 'not-logged-in';
                    }
                    
                    isLoggedIn = true;
                    
                    document.getElementById('welcomeHeader').classList.remove('show');
                    
                    document.getElementById('actionViewTitle').textContent = 
                        `Panel operatora - ${currentUser.login} (${deptName})`;
                    
                    showView('action');
                    updateButtonStates();
                    updateMyTicketsTileInActionView();
                    
                    if (currentUser.login !== 'jerzyd' && typeof google !== 'undefined' && google.script) {
                        google.script.run
                            .withSuccessHandler(function(count) {
                                unreadTicketRepliesCount = count;
                                updateMyTicketsTileInActionView();
                            })
                            .withFailureHandler(function(error) {
                                console.error('‚ùå B≈ÇƒÖd pobierania nieodczytanych:', error);
                            })
                            .getUnreadTicketsCount(currentUser.login);
                    }

                    showNotification(`${currentUser.login} - wybierz akcjƒô (${currentUser.status})`, 'success');
                }

                // ===== ZOPTYMALIZOWANY FLOW V2 - INSTANT UI + OG≈ÅOSZENIA BLOKUJƒÑ =====
                sessionStorage.setItem('currentEmployeeLogin', foundUser.login);
                
                // Funkcja pomocnicza - sprawd≈∫ tickety w tle (nie blokuje)
                function checkTicketsInBackground() {
                    if (typeof google !== 'undefined' && google.script) {
                        if (foundUser.login === 'jerzyd') {
                            google.script.run
                                .withSuccessHandler(function(criticalCount) {
                                    criticalTicketsCount = criticalCount;
                                    if (criticalCount > 0) {
                                        showCriticalTicketsModal();
                                    }
                                })
                                .getCriticalTicketsCount();
                        } else {
                            google.script.run
                                .withSuccessHandler(function(unreadCount) {
                                    unreadTicketRepliesCount = unreadCount;
                                    updateMyTicketsTileInActionView();
                                    if (unreadCount > 0) {
                                        showUnreadTicketsModal(foundUser.name, unreadCount);
                                    }
                                })
                                .getUnreadTicketRepliesCount(foundUser.login);
                        }
                    }
                }
                
                // SPRAWD≈π OG≈ÅOSZENIA - NAJPIERW PRELOADED CACHE (natychmiastowe)
                const preloadedAnnouncements = allAnnouncementsPreloaded[foundUser.login];

                if (preloadedAnnouncements && preloadedAnnouncements.length > 0) {
                    // ‚úÖ PRELOADED CACHE - NATYCHMIAST!
                    console.log('üì¢ Og≈Çoszenia z PRELOADED cache - instant!');
                    pendingAnnouncements = preloadedAnnouncements;
                    currentAnnouncementIndex = 0;
                    pendingRegistrationData = function() {
                        proceedToActionView();
                        checkTicketsInBackground();
                    };
                    showCurrentAnnouncement();
                } else if (announcementsCacheLoaded && announcementsCache.loginPracownika === foundUser.login) {
                    // ‚úÖ INDYWIDUALNY CACHE DOSTƒòPNY
                    console.log('üì¢ Og≈Çoszenia z indywidualnego cache - instant!');
                    const unreadAnnouncements = announcementsCache.visibleAnnouncements || [];
                    
                    if (unreadAnnouncements.length > 0) {
                        pendingAnnouncements = unreadAnnouncements;
                        currentAnnouncementIndex = 0;
                        pendingRegistrationData = function() {
                            proceedToActionView();
                            checkTicketsInBackground();
                        };
                        showCurrentAnnouncement();
                    } else {
                        proceedToActionView();
                        checkTicketsInBackground();
                    }
                } else {
                    // ‚ùå BRAK CACHE - sprawd≈∫ backend (fallback)
                    console.log('üì¢ Brak cache - sprawdzam backend...');
                    showNotification('‚è≥ Sprawdzanie og≈Çosze≈Ñ...', 'info');
                    
                    if (typeof google !== 'undefined' && google.script) {
                        google.script.run
                            .withSuccessHandler(function(result) {
                                announcementsCache = {
                                    visibleAnnouncements: result.success ? result.announcements : [],
                                    loginPracownika: foundUser.login
                                };
                                announcementsCacheLoaded = true;
                                
                                if (result.success && result.announcements && result.announcements.length > 0) {
                                    console.log('üì¢ SƒÑ OG≈ÅOSZENIA z backend!');
                                    pendingAnnouncements = result.announcements;
                                    currentAnnouncementIndex = 0;
                                    pendingRegistrationData = function() {
                                        proceedToActionView();
                                        checkTicketsInBackground();
                                    };
                                    showCurrentAnnouncement();
                                } else {
                                    proceedToActionView();
                                    checkTicketsInBackground();
                                }
                            })
                            .withFailureHandler(function(error) {
                                console.error('‚ùå B≈ÇƒÖd og≈Çosze≈Ñ:', error);
                                proceedToActionView();
                                checkTicketsInBackground();
                            })
                            .getUnreadAnnouncements(foundUser.login);
                    } else {
                        proceedToActionView();
                        checkTicketsInBackground();
                    }
                }
 
            } else {
                showNotification('Nieznany kod: ' + code, 'error');
            }
        }

        function updateManagerNotificationBadge() {
            if (typeof google === 'undefined' || !google.script) {
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(count) {
                    const oldCount = pendingVacationCount;
                    pendingVacationCount = count;
                    
                    const vacationBtn = document.getElementById('vacationBtn');
                    let badge = vacationBtn.querySelector('.vacation-btn-badge');
                    
                    if (count > 0) {
                        if (!badge) {
                            badge = document.createElement('div');
                            badge.className = 'vacation-btn-badge';
                            vacationBtn.appendChild(badge);
                        }
                        badge.textContent = count;
                    } else {
                        if (badge) {
                            badge.remove();
                        }
                    }
                    
                    if (currentView === 'user') {
                        generateUserTiles();
                    }
                    
                    if (count > oldCount && oldCount > 0) {
                        showNotification(`Nowy wniosek do zatwierdzenia! (${count} oczekujƒÖcych)`, 'info');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('B≈ÇƒÖd licznika:', error);
                })
                .getPendingAbsenceRequestsCount();
        }

        function loadVacationBalance() {
            if (typeof google === 'undefined' || !google.script) {
                document.getElementById('vacationBalance').style.display = 'block';
                document.getElementById('urlopPrzys≈ÇugujƒÖcy').textContent = '20';
                document.getElementById('urlopZaleg≈Çy').textContent = '0';
                document.getElementById('urlopWykorzystany').textContent = '5';
                document.getElementById('urlopPozosta≈Çy').textContent = '15';
                return;
            }
            
            if (!currentUser || !currentUser.login) {
                console.error('Brak currentUser lub login');
                return;
            }
            
            console.log('≈Åadowanie saldo dla u≈ºytkownika:', currentUser.login);
            
            google.script.run
                .withSuccessHandler(function(balance) {
                    console.log('Otrzymano saldo z serwera:', balance);
                    
                    if (balance) {
                        userVacationBalances[currentUser.login] = balance;
                        
                        document.getElementById('urlopPrzys≈ÇugujƒÖcy').textContent = balance.przys≈ÇugujƒÖcy || 0;
                        document.getElementById('urlopZaleg≈Çy').textContent = balance.zaleg≈Çy || 0;
                        document.getElementById('urlopWykorzystany').textContent = balance.wykorzystany || 0;
                        document.getElementById('urlopPozosta≈Çy').textContent = balance.pozosta≈Çy || 0;
                        document.getElementById('vacationBalance').style.display = 'block';
                        
                        console.log('Zaktualizowano interfejs saldo urlopowego');
                        
                    } else {
                        console.error('Otrzymano puste saldo');
                        document.getElementById('vacationBalance').style.display = 'block';
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('B≈ÇƒÖd ≈Çadowania saldo:', error);
                    document.getElementById('vacationBalance').style.display = 'block';
                })
                .getUserVacationBalance(currentUser.login);
        }

        function downloadVacationPDF(requestId) {
            console.log('Generowanie PDF dla wniosku:', requestId);
            showNotification('Generowanie PDF...', 'info');
            
            if (typeof google === 'undefined' || !google.script) {
                showNotification('PDF niedostƒôpne w trybie testowym', 'error');
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Wynik generowania PDF:', result);
                    
                    if (result.success) {
                        console.log('URL do pobrania:', result.downloadUrl);
                        
                        if (!result.downloadUrl) {
                            showNotification('B≈ÇƒÖd: Brak URL do pobrania PDF', 'error');
                            return;
                        }
                        
                        const newWindow = window.open(result.downloadUrl, '_blank');
                        
                        if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                            console.log('WyskakujƒÖce okno zablokowane - tworzƒô link do pobrania');
                            
                            const linkHTML = `
                                <div style="position: fixed; top: 100px; right: 20px; background: white; 
                                            padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); 
                                            z-index: 10000; max-width: 400px;">
                                    <h3 style="margin: 0 0 15px 0;">üìÑ PDF jest gotowy!</h3>
                                    <p style="margin-bottom: 15px;">Kliknij poni≈ºszy link aby pobraƒá:</p>
                                    <a href="${result.downloadUrl}" target="_blank" 
                                       style="display: inline-block; background: #007bff; color: white; 
                                              padding: 12px 24px; text-decoration: none; border-radius: 6px; 
                                              font-weight: bold;">
                                        üì• Pobierz PDF
                                    </a>
                                    <button onclick="this.parentElement.remove()" 
                                            style="display: block; margin-top: 15px; background: #6c757d; 
                                                   color: white; border: none; padding: 8px 16px; 
                                                   border-radius: 4px; cursor: pointer;">
                                        Zamknij
                                    </button>
                                </div>
                            `;
                            
                            const linkDiv = document.createElement('div');
                            linkDiv.innerHTML = linkHTML;
                            document.body.appendChild(linkDiv);
                            
                            showNotification('PDF gotowy - kliknij link aby pobraƒá', 'info');
                        } else {
                            showNotification('PDF wygenerowany! Otwarto w nowej karcie', 'success');
                        }
                    } else {
                        showNotification('B≈ÇƒÖd generowania PDF: ' + (result.message || 'Nieznany b≈ÇƒÖd'), 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('B≈ÇƒÖd generowania PDF:', error);
                    showNotification('B≈ÇƒÖd: ' + error.message, 'error');
                })
                .generateVacationRequestPDF(requestId);
        }

        /**
         * Pobiera PDF dla wniosku o dzie≈Ñ wolny
         */
        function downloadDayOffPDF(requestId) {
            console.log('Generowanie PDF dla dnia wolnego:', requestId);
            showNotification('Generowanie PDF...', 'info');
            
            if (typeof google === 'undefined' || !google.script) {
                showNotification('PDF niedostƒôpne w trybie testowym', 'error');
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Wynik generowania PDF:', result);
                    
                    if (result.success) {
                        if (!result.downloadUrl) {
                            showNotification('B≈ÇƒÖd: Brak URL do pobrania PDF', 'error');
                            return;
                        }
                        
                        const newWindow = window.open(result.downloadUrl, '_blank');
                        
                        if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                            const linkHTML = `
                                <div style="position: fixed; top: 100px; right: 20px; background: white; 
                                            padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); 
                                            z-index: 10000; max-width: 400px;">
                                    <h3 style="margin: 0 0 15px 0;">üìÑ PDF jest gotowy!</h3>
                                    <p style="margin-bottom: 15px;">Kliknij poni≈ºszy link aby pobraƒá:</p>
                                    <a href="${result.downloadUrl}" target="_blank" 
                                       style="display: inline-block; background: #2196f3; color: white; 
                                              padding: 12px 24px; text-decoration: none; border-radius: 6px; 
                                              font-weight: bold;">
                                        üì• Pobierz PDF
                                    </a>
                                    <button onclick="this.parentElement.remove()" 
                                            style="display: block; margin-top: 15px; background: #6c757d; 
                                                   color: white; border: none; padding: 8px 16px; 
                                                   border-radius: 4px; cursor: pointer;">
                                        Zamknij
                                    </button>
                                </div>
                            `;
                            
                            const linkDiv = document.createElement('div');
                            linkDiv.innerHTML = linkHTML;
                            document.body.appendChild(linkDiv);
                            
                            showNotification('PDF gotowy - kliknij link aby pobraƒá', 'info');
                        } else {
                            showNotification('PDF wygenerowany! Otwarto w nowej karcie', 'success');
                        }
                    } else {
                        showNotification('B≈ÇƒÖd generowania PDF: ' + (result.message || 'Nieznany b≈ÇƒÖd'), 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('B≈ÇƒÖd generowania PDF:', error);
                    showNotification('B≈ÇƒÖd: ' + error.message, 'error');
                })
                .generateDayOffPDF(requestId);
        }

        /**
         * Pobiera PDF dla urlopu okoliczno≈õciowego
         */
        function downloadOccasionalLeavePDF(requestId) {
            console.log('Generowanie PDF dla urlopu okoliczno≈õciowego:', requestId);
            showNotification('Generowanie PDF...', 'info');
            
            if (typeof google === 'undefined' || !google.script) {
                showNotification('PDF niedostƒôpne w trybie testowym', 'error');
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Wynik generowania PDF:', result);
                    
                    if (result.success) {
                        if (!result.downloadUrl) {
                            showNotification('B≈ÇƒÖd: Brak URL do pobrania PDF', 'error');
                            return;
                        }
                        
                        const newWindow = window.open(result.downloadUrl, '_blank');
                        
                        if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                            const linkHTML = `
                                <div style="position: fixed; top: 100px; right: 20px; background: white; 
                                            padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); 
                                            z-index: 10000; max-width: 400px;">
                                    <h3 style="margin: 0 0 15px 0;">üìÑ PDF jest gotowy!</h3>
                                    <p style="margin-bottom: 15px;">Kliknij poni≈ºszy link aby pobraƒá:</p>
                                    <a href="${result.downloadUrl}" target="_blank" 
                                       style="display: inline-block; background: #9c27b0; color: white; 
                                              padding: 12px 24px; text-decoration: none; border-radius: 6px; 
                                              font-weight: bold;">
                                        üì• Pobierz PDF
                                    </a>
                                    <button onclick="this.parentElement.remove()" 
                                            style="display: block; margin-top: 15px; background: #6c757d; 
                                                   color: white; border: none; padding: 8px 16px; 
                                                   border-radius: 4px; cursor: pointer;">
                                        Zamknij
                                    </button>
                                </div>
                            `;
                            
                            const linkDiv = document.createElement('div');
                            linkDiv.innerHTML = linkHTML;
                            document.body.appendChild(linkDiv);
                            
                            showNotification('PDF gotowy - kliknij link aby pobraƒá', 'info');
                        } else {
                            showNotification('PDF wygenerowany! Otwarto w nowej karcie', 'success');
                        }
                    } else {
                        showNotification('B≈ÇƒÖd generowania PDF: ' + (result.message || 'Nieznany b≈ÇƒÖd'), 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('B≈ÇƒÖd generowania PDF:', error);
                    showNotification('B≈ÇƒÖd: ' + error.message, 'error');
                })
                .generateOccasionalLeavePDF(requestId);
        }

        /**
         * Pobiera PDF dla wniosku o dzie≈Ñ wolny
         */
        function downloadDayOffPDF(requestId) {
            console.log('Generowanie PDF dla dnia wolnego:', requestId);
            showNotification('Generowanie PDF...', 'info');
            
            if (typeof google === 'undefined' || !google.script) {
                showNotification('PDF niedostƒôpne w trybie testowym', 'error');
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Wynik generowania PDF:', result);
                    
                    if (result.success) {
                        if (!result.downloadUrl) {
                            showNotification('B≈ÇƒÖd: Brak URL do pobrania PDF', 'error');
                            return;
                        }
                        
                        const newWindow = window.open(result.downloadUrl, '_blank');
                        
                        if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                            const linkHTML = `
                                <div style="position: fixed; top: 100px; right: 20px; background: white; 
                                            padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); 
                                            z-index: 10000; max-width: 400px;">
                                    <h3 style="margin: 0 0 15px 0;">üìÑ PDF jest gotowy!</h3>
                                    <p style="margin-bottom: 15px;">Kliknij poni≈ºszy link aby pobraƒá:</p>
                                    <a href="${result.downloadUrl}" target="_blank" 
                                       style="display: inline-block; background: #4caf50; color: white; 
                                              padding: 12px 24px; text-decoration: none; border-radius: 6px; 
                                              font-weight: bold;">
                                        üì• Pobierz PDF
                                    </a>
                                    <button onclick="this.parentElement.remove()" 
                                            style="display: block; margin-top: 15px; background: #6c757d; 
                                                   color: white; border: none; padding: 8px 16px; 
                                                   border-radius: 4px; cursor: pointer;">
                                        Zamknij
                                    </button>
                                </div>
                            `;
                            
                            const linkDiv = document.createElement('div');
                            linkDiv.innerHTML = linkHTML;
                            document.body.appendChild(linkDiv);
                            
                            showNotification('PDF gotowy - kliknij link aby pobraƒá', 'info');
                        } else {
                            showNotification('PDF wygenerowany! Otwarto w nowej karcie', 'success');
                        }
                    } else {
                        showNotification('B≈ÇƒÖd generowania PDF: ' + (result.message || 'Nieznany b≈ÇƒÖd'), 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('B≈ÇƒÖd generowania PDF:', error);
                    showNotification('B≈ÇƒÖd: ' + error.message, 'error');
                })
                .generateDayOffPDF(requestId);
        }

        /**
         * Pobiera PDF dla urlopu okoliczno≈õciowego
         */
        function downloadOccasionalLeavePDF(requestId) {
            console.log('Generowanie PDF dla urlopu okoliczno≈õciowego:', requestId);
            showNotification('Generowanie PDF...', 'info');
            
            if (typeof google === 'undefined' || !google.script) {
                showNotification('PDF niedostƒôpne w trybie testowym', 'error');
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Wynik generowania PDF:', result);
                    
                    if (result.success) {
                        if (!result.downloadUrl) {
                            showNotification('B≈ÇƒÖd: Brak URL do pobrania PDF', 'error');
                            return;
                        }
                        
                        const newWindow = window.open(result.downloadUrl, '_blank');
                        
                        if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                            const linkHTML = `
                                <div style="position: fixed; top: 100px; right: 20px; background: white; 
                                            padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); 
                                            z-index: 10000; max-width: 400px;">
                                    <h3 style="margin: 0 0 15px 0;">üìÑ PDF jest gotowy!</h3>
                                    <p style="margin-bottom: 15px;">Kliknij poni≈ºszy link aby pobraƒá:</p>
                                    <a href="${result.downloadUrl}" target="_blank" 
                                       style="display: inline-block; background: #9c27b0; color: white; 
                                              padding: 12px 24px; text-decoration: none; border-radius: 6px; 
                                              font-weight: bold;">
                                        üì• Pobierz PDF
                                    </a>
                                    <button onclick="this.parentElement.remove()" 
                                            style="display: block; margin-top: 15px; background: #6c757d; 
                                                   color: white; border: none; padding: 8px 16px; 
                                                   border-radius: 4px; cursor: pointer;">
                                        Zamknij
                                    </button>
                                </div>
                            `;
                            
                            const linkDiv = document.createElement('div');
                            linkDiv.innerHTML = linkHTML;
                            document.body.appendChild(linkDiv);
                            
                            showNotification('PDF gotowy - kliknij link aby pobraƒá', 'info');
                        } else {
                            showNotification('PDF wygenerowany! Otwarto w nowej karcie', 'success');
                        }
                    } else {
                        showNotification('B≈ÇƒÖd generowania PDF: ' + (result.message || 'Nieznany b≈ÇƒÖd'), 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('B≈ÇƒÖd generowania PDF:', error);
                    showNotification('B≈ÇƒÖd: ' + error.message, 'error');
                })
                .generateOccasionalLeavePDF(requestId);
        }

        function isWorkforcePlannerOpenNow() {
          const modal = document.getElementById('workforcePlannerModal');
          return !!(modal && modal.style.display === 'flex');
        }

        function ensureCodeInputFocus() {
          // Nie ustawiaj fokusa gdy panel og≈Çosze≈Ñ jest otwarty
          if (window.announcementsPanelOpen) return;

          // Nie ustawiaj fokusa gdy planer obsady jest otwarty
          if (isWorkforcePlannerOpenNow()) return;

          const input = document.getElementById('codeInput');
          if (input && currentView === 'department') {
            try { input.focus(); } catch (e) {}
          }
        }

        // ===== EVENT LISTENERY =====
        document.addEventListener('click', function(e) {

          // je≈õli planer jest otwarty, nie kradnij fokusu
          if (isWorkforcePlannerOpenNow()) return;

          if (currentView === 'department' && e.target.id !== 'codeInput') {
            ensureCodeInputFocus();
          }
        });


        document.addEventListener('keydown', function(e){
          const m = document.getElementById('workforcePlannerModal');
          if (m && m.style.display === 'flex') return;
          // ‚úÖ SPRAWD≈π CZY JESTE≈ö ZALOGOWANY
          if (!isLoggedIn) {
              return; // Nie przechwytuj klawiszy na ekranie logowania
          }
          
          // Nie przechwytuj klawiszy gdy panel og≈Çosze≈Ñ jest otwarty
          if (window.announcementsPanelOpen) {
              return;
          }
          
          // Nie przechwytuj gdy fokus jest na polu tekstowym (input, textarea, select)
          const activeTag = document.activeElement.tagName.toLowerCase();
          if (activeTag === 'textarea' || activeTag === 'select' || 
              (activeTag === 'input' && document.activeElement.id !== 'codeInput')) {
              return;
          }
          
          if (currentView === 'department' && document.activeElement.id !== 'codeInput') {
              const input = document.getElementById('codeInput');
              if (input) {
                  input.focus();
                  if (e.key.length === 1 && /[a-zA-Z0-9]/.test(e.key)) {
                      input.value += e.key;
                      e.preventDefault();
                  }
              }
          }
      });

        document.getElementById('confirmationCancelBtn').addEventListener('click', function() {
            const modal = document.getElementById('confirmationModal');
            modal.classList.remove('show');
            showNotification('Operacja anulowana - nie zapisano w arkuszu', 'info');
            console.log('Anulowano operacjƒô - modal zamkniƒôty bez zapisu');
        });

        document.getElementById('confirmationOkBtn').addEventListener('click', function() {
    const modal = document.getElementById('confirmationModal');
    const action = modal.getAttribute('data-action');
    
    // 1. NATYCHMIAST - zamknij modal i poka≈º sukces
    modal.classList.remove('show');
    
    if (action === 'wychodzi-przerwa') {
        showNotification('‚úÖ Wyj≈õcie na przerwƒô zapisane', 'success');
        workerState = 'logged-in-on-break';
        userStatuses[currentUser.login] = 'logged-in-on-break';
    } else if (action === 'wracam') {
        showNotification('‚úÖ Powr√≥t z przerwy zapisany', 'success');
        workerState = 'logged-in-working';
        userStatuses[currentUser.login] = 'logged-in-working';
    }
    
    const userToSave = currentUser.login;
    const deptToSave = currentDepartment;
    
    // 2. NATYCHMIAST - wr√≥ƒá do g≈Ç√≥wnego widoku
    setTimeout(() => {
        isLoggedIn = false;
        workerState = 'not-logged-in';
        currentUser = null;
        currentDepartment = null;
        document.getElementById('welcomeHeader').classList.remove('show');
        showView('department');
        ensureCodeInputFocus();
    }, 300);
    
    // 3. W TLE - zapis (Pages: API /scan + intent, GS: stary zapis)
    const hasAppsScript = (typeof google !== 'undefined' && google.script && google.script.run);
    
    if (!hasAppsScript) {
      const intentMap = {
        'wychodzi-przerwa': 'BREAK_START',
        'wracam': 'BREAK_END'
      };
    
      const intent = intentMap[action];
      if (!intent) {
        console.error('‚ùå Unknown break action:', action);
        return;
      }
    
      apiScanIntent(intent, { department: deptToSave })
        .catch(err => {
          console.error('‚ùå BREAK API error:', err);
          showNotification('‚ùå B≈ÇƒÖd zapisu przerwy: ' + (err?.message || err), 'error');
        });
    } else {
      sendToSpreadsheetAsync(userToSave, deptToSave, action);
    }
    });

        // ===== PANEL ZG≈ÅOSZE≈É KIEROWNIKA =====

let currentTicketFilter = 'all';
let allTicketsCache = [];
let currentTicketDetails = null;

// ===== FUNKCJA POMOCNICZA - KONTYNUACJA FLOW KIEROWNIKA PO SPRAWDZENIU URLOP√ìW =====
        function continueManagerFlowAfterVacationCheck(managerData, foundDepartment) {
            console.log('üîÑ continueManagerFlowAfterVacationCheck dla:', managerData.login);
            
            // Ustaw currentUser i currentDepartment
            currentUser = managerData;
            currentDepartment = managerData.currentDepartment;
            
            const departmentNames = {
                'przyjecie': 'Przyjƒôcie dostaw',
                'rozladunek': 'Roz≈Çadunek rƒôczny kontenera',
                'zaladunek': 'Za≈Çadunek rƒôczny kontenera',
                'relokacja': 'Relokacja',
                'kompletacja': 'Kompletacja zam√≥wie≈Ñ',
                'weryfikacja': 'Weryfikacja zam√≥wie≈Ñ',
                'co-packing': 'Co-packing',
                'operacje-porzadkowe': 'Operacje porzƒÖdkowe',
                'inwentaryzacja': 'Inwentaryzacja'
            };
            
            const deptName = departmentNames[currentDepartment] || currentDepartment;
            
            // Sprawd≈∫ krytyczne tickety (istniejƒÖca logika)
            if (typeof google !== 'undefined' && google.script) {
                google.script.run
                    .withSuccessHandler(function(criticalCount) {
                        criticalTicketsCount = criticalCount;
                        
                        if (criticalCount > 0) {
                            console.log('üî¥ Kierownik ma krytyczne tickety - pokazujƒô modal');
                            showCriticalTicketsModal();
                        } else {
                            console.log('‚úÖ Brak krytycznych ticket√≥w - panel operatora');
                            finishManagerLogin(managerData, deptName);
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå B≈ÇƒÖd sprawdzania krytycznych:', error);
                        finishManagerLogin(managerData, deptName);
                    })
                    .getCriticalTicketsCount();
            } else {
                finishManagerLogin(managerData, deptName);
            }
        }
        
        // Pomocnicza funkcja - zako≈Ñczenie logowania kierownika
        function finishManagerLogin(managerData, deptName) {
            // Ustaw stan
            if (managerData.status === 'Pracuje') {
                workerState = 'logged-in-working';
                userStatuses[managerData.login] = 'logged-in-working';
            } else if (managerData.status === 'Na przerwie') {
                workerState = 'logged-in-on-break';
                userStatuses[managerData.login] = 'logged-in-on-break';
            } else {
                workerState = 'not-logged-in';
                userStatuses[managerData.login] = 'not-logged-in';
            }
            
            isLoggedIn = true;
            
            document.getElementById('welcomeHeader').classList.remove('show');
            document.getElementById('actionViewTitle').textContent = 
                'Panel operatora - ' + managerData.login + ' (' + deptName + ')';
            
            showView('action');
            updateButtonStates();
            updateMyTicketsTileInActionView();
            
            showNotification(managerData.login + ' - wybierz akcjƒô (' + managerData.status + ')', 'success');
        }

/**
 * Pokazuje panel zg≈Çosze≈Ñ kierownika
 */
function showManagerTicketsView() {
    document.getElementById('criticalTicketsModal').classList.remove('show');
    showView('managerTickets');
    loadAllTickets();
}

function loadAllTickets() {
    const container = document.getElementById('managerTicketsList');
    
    if (!container) {
        console.error('‚ùå Nie znaleziono kontenera managerTicketsList');
        return;
    }
    
    container.innerHTML = '<p style="text-align: center; color: #666;">≈Åadowanie zg≈Çosze≈Ñ...</p>';
    
    if (typeof google === 'undefined' || !google.script) {
        container.innerHTML = '<p style="text-align: center; color: #666;">Tryb testowy - brak danych</p>';
        return;
    }
    
    console.log('üîµ Wywo≈Çujƒô getAllTickets...');
    
    google.script.run
        .withSuccessHandler(function(tickets) {
            console.log('‚úÖ SUCCESS - otrzymano dane:');
            console.log('Typ danych:', typeof tickets);
            console.log('Czy array?', Array.isArray(tickets));
            console.log('Warto≈õƒá tickets:', tickets);
            console.log('tickets.length:', tickets ? tickets.length : 'BRAK LENGTH');
            
            // WYPISZ KA≈ªDY TICKET
            if (tickets && tickets.length > 0) {
                console.log('üìã Pierwsze zg≈Çoszenie:', tickets[0]);
                console.log('üìã Wszystkie zg≈Çoszenia:', JSON.stringify(tickets, null, 2));
            }
            
            if (!tickets) {
                console.error('‚ùå tickets jest NULL lub undefined!');
                container.innerHTML = '<p style="text-align: center; color: red;">B≈ÇƒÖd: Brak danych</p>';
                return;
            }
            
            if (!Array.isArray(tickets)) {
                console.error('‚ùå tickets NIE JEST tablicƒÖ! Typ:', typeof tickets);
                container.innerHTML = '<p style="text-align: center; color: red;">B≈ÇƒÖd: Nieprawid≈Çowy format danych</p>';
                return;
            }
            
            if (tickets.length === 0) {
                console.warn('‚ö†Ô∏è tickets.length === 0 - tablica jest pusta!');
                container.innerHTML = '<p style="text-align: center; color: #666;">Brak zg≈Çosze≈Ñ</p>';
                allTicketsCache = [];
                updateTicketsCounts([]);
                return;
            }
            
            console.log('‚úÖ Dane prawid≈Çowe - zapisujƒô do cache');
            allTicketsCache = tickets;
            
            console.log('üìä Aktualizujƒô liczniki...');
            updateTicketsCounts(tickets);
            
            console.log('üé® Wywo≈Çujƒô displayFilteredTickets()...');
            displayFilteredTickets();
            console.log('‚úÖ Wszystko zako≈Ñczone!');
        })
        .withFailureHandler(function(error) {
            console.error('‚ùå FAILURE:', error);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            container.innerHTML = '<p style="color: red; text-align: center;">B≈ÇƒÖd: ' + (error.message || 'Nieznany') + '</p>';
        })
        .getAllTickets('all');
}

/**
 * Aktualizuje liczniki w filtrach
 */
function updateTicketsCounts(tickets) {
    const counts = {
        all: tickets.length,
        nowe: 0,
        wtrakcie: 0,
        zamkniete: 0,
        odrzucone: 0
    };
    
    tickets.forEach(ticket => {
        if (ticket.status.includes('Nowe')) counts.nowe++;
        else if (ticket.status.includes('W trakcie')) counts.wtrakcie++;
        else if (ticket.status.includes('Zamkniƒôte')) counts.zamkniete++;
        else if (ticket.status.includes('Odrzucone')) counts.odrzucone++;
    });
    
    document.getElementById('count-all').textContent = counts.all;
    document.getElementById('count-nowe').textContent = counts.nowe;
    document.getElementById('count-wtrakcie').textContent = counts.wtrakcie;
    document.getElementById('count-zamkniete').textContent = counts.zamkniete;
    document.getElementById('count-odrzucone').textContent = counts.odrzucone;
}

/**
 * Filtruje zg≈Çoszenia wed≈Çug statusu
 */
function filterTickets(status) {
    currentTicketFilter = status;
    
    // Zaktualizuj styl filtr√≥w
    document.querySelectorAll('.vacation-type-option').forEach(el => {
        el.classList.remove('selected');
    });
    
    const filterMap = {
        'all': 'filter-all',
        'Nowe': 'filter-nowe',
        'W trakcie': 'filter-wtrakcie',
        'Zamkniƒôte': 'filter-zamkniete',
        'Odrzucone': 'filter-odrzucone'
    };
    
    document.getElementById(filterMap[status]).classList.add('selected');
    
    displayFilteredTickets();
}

/**
 * Wy≈õwietla zg≈Çoszenia z aktualnym filtrem
 */
function displayFilteredTickets() {
    const container = document.getElementById('managerTicketsList');
    
    let filtered = allTicketsCache;
    if (currentTicketFilter !== 'all') {
        filtered = allTicketsCache.filter(t => t.status.includes(currentTicketFilter));
    }
    
    // ‚úÖ SORTUJ: najnowsze pierwsze (ID malejƒÖco)
    filtered.sort((a, b) => b.id - a.id);
    
    if (filtered.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">Brak zg≈Çosze≈Ñ w tej kategorii</p>';
        return;
    }
    
    let html = '';
    filtered.forEach(ticket => {
        const priorityColors = {
            'NISKI': '#28a745',
            '≈öREDNI': '#ffc107',
            'WYSOKI': '#fd7e14',
            'KRYTYCZNY': '#dc3545'
        };
        
        const priorityColor = priorityColors[ticket.priority] || '#6c757d';
        
        const statusEmoji = ticket.status.includes('Nowe') ? 'üîµ' :
                           ticket.status.includes('W trakcie') ? 'üü°' :
                           ticket.status.includes('Zamkniƒôte') ? 'üü¢' : 'üî¥';
        
        const categoryEmoji = ticket.category === 'pomys≈Ç' ? 'üí°' :
                             ticket.category === 'problem' ? '‚ö†Ô∏è' :
                             ticket.category === 'usterka' ? 'üîß' : 'üÜò';
        
        const titleEscaped = (ticket.title || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const nameEscaped = (ticket.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const locationEscaped = (ticket.location || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
        html += '<div class="vacation-request-item" style="cursor: pointer; border-left: 4px solid ' + priorityColor + ';" onclick="showTicketDetails(' + ticket.id + ')">';
        html += '<div style="display: flex; justify-content: space-between; align-items: start;">';
        html += '<div style="flex: 1;">';
        html += '<div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">';
        html += categoryEmoji + ' #' + ticket.id + ' - ' + titleEscaped;
        html += '</div>';
        html += '<div style="font-size: 14px; color: #666; margin-bottom: 8px;">';
        html += 'üë§ ' + nameEscaped + ' (' + ticket.login + ') | üìÖ ' + ticket.dateSubmitted;
        html += '</div>';
        html += '<div style="font-size: 13px; color: #888;">';
        html += 'üìç ' + locationEscaped + ' | ' + statusEmoji + ' ' + ticket.status;
        html += '</div>';
        html += '</div>';
        html += '<div style="text-align: right;">';
        html += '<span style="background: ' + priorityColor + '; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">';
        html += ticket.priority;
        html += '</span>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
    });
    
    container.innerHTML = html;
}

/**
 * Pokazuje szczeg√≥≈Çy zg≈Çoszenia w modalu
 */
function showTicketDetails(ticketId) {
    const ticket = allTicketsCache.find(t => t.id === ticketId);
    
    if (!ticket) {
        showNotification('Nie znaleziono zg≈Çoszenia', 'error');
        return;
    }
    
    currentTicketDetails = ticket;
    
    const priorityColors = {
        'NISKI': '#28a745',
        '≈öREDNI': '#ffc107',
        'WYSOKI': '#fd7e14',
        'KRYTYCZNY': '#dc3545'
    };
    
    const priorityColor = priorityColors[ticket.priority] || '#6c757d';
    
    const statusEmoji = ticket.status.includes('Nowe') ? 'üîµ' :
                       ticket.status.includes('W trakcie') ? 'üü°' :
                       ticket.status.includes('Zamkniƒôte') ? 'üü¢' : 'üî¥';
    
    const categoryEmoji = ticket.category === 'pomys≈Ç' ? 'üí°' :
                         ticket.category === 'problem' ? '‚ö†Ô∏è' :
                         ticket.category === 'usterka' ? 'üîß' : 'üÜò';
    
    const detailsHTML = `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 6px solid ${priorityColor};">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <h3 style="margin: 0; font-size: 22px;">${categoryEmoji} Zg≈Çoszenie #${ticket.id}</h3>
                <span style="background: ${priorityColor}; color: white; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: bold;">
                    ${ticket.priority}
                </span>
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong style="font-size: 18px;">${ticket.title}</strong>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
                <div>
                    <strong>Zg≈ÇaszajƒÖcy:</strong><br>
                    ${ticket.name} (${ticket.login})
                </div>
                <div>
                    <strong>Data zg≈Çoszenia:</strong><br>
                    ${ticket.dateSubmitted}
                </div>
                <div>
                    <strong>Kategoria:</strong><br>
                    ${categoryEmoji} ${ticket.category}
                </div>
                <div>
                    <strong>Status:</strong><br>
                    ${statusEmoji} ${ticket.status}
                </div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong>Lokalizacja:</strong><br>
                ${ticket.location}
            </div>
            
            <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 15px;">
                <strong>Szczeg√≥≈Çowy opis:</strong>
                <p style="margin: 10px 0 0 0; white-space: pre-wrap;">${ticket.description}</p>
            </div>
            
            ${ticket.managerComment ? `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #2196f3;">
                    <strong>üí¨ Tw√≥j poprzedni komentarz:</strong>
                    <p style="margin: 10px 0 0 0; white-space: pre-wrap;">${ticket.managerComment}</p>
                    ${ticket.dateStarted ? `<small style="color: #666;">Dodano: ${ticket.dateStarted}</small>` : ''}
                </div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('ticketDetailsContent').innerHTML = detailsHTML;
    document.getElementById('managerCommentInput').value = ticket.managerComment || '';
    
    // Poka≈º pole komentarza dla kierownika
    const commentSection = document.querySelector('#ticketDetailsModal textarea')?.parentElement;
    if (commentSection) commentSection.style.display = 'block';
    
    // ZAWSZE poka≈º przycisk "Wr√≥ƒá do listy" dla kierownika
    const backButton = document.querySelector('#ticketDetailsModal button[onclick*="closeTicketDetailsModal"]');
    if (backButton) backButton.style.display = 'block';
    
    // Poka≈º/ukryj przyciski AKCJI w zale≈ºno≈õci od statusu
    updateActionButtonsVisibility(ticket.status);
    
    document.getElementById('ticketDetailsModal').classList.add('show');
}

/**
 * Aktualizuje widoczno≈õƒá przycisk√≥w akcji w zale≈ºno≈õci od statusu
 */
function updateActionButtonsVisibility(currentStatus) {
    const btnWe≈∫WTrakcie = document.querySelector('button[onclick="changeTicketStatus(\'W trakcie\')"]');
    const btnZamknij = document.querySelector('button[onclick="changeTicketStatus(\'Zamkniƒôte\')"]');
    const btnOdrzuƒá = document.querySelector('button[onclick="changeTicketStatus(\'Odrzucone\')"]');
    
    // Reset
    [btnWe≈∫WTrakcie, btnZamknij, btnOdrzuƒá].forEach(btn => {
        if (btn) btn.style.display = 'block';
    });
    
    // Logika widoczno≈õci
    if (currentStatus.includes('Nowe')) {
        // Dla nowych: wszystkie przyciski dostƒôpne
    } else if (currentStatus.includes('W trakcie')) {
        // Dla w trakcie: ukryj "We≈∫ w trakcie"
        if (btnWe≈∫WTrakcie) btnWe≈∫WTrakcie.style.display = 'none';
    } else if (currentStatus.includes('Zamkniƒôte') || currentStatus.includes('Odrzucone')) {
        // Dla zamkniƒôtych/odrzuconych: ukryj wszystkie akcje opr√≥cz "Wr√≥ƒá"
        if (btnWe≈∫WTrakcie) btnWe≈∫WTrakcie.style.display = 'none';
        if (btnZamknij) btnZamknij.style.display = 'none';
        if (btnOdrzuƒá) btnOdrzuƒá.style.display = 'none';
    }
}

/**
 * Zamyka modal szczeg√≥≈Ç√≥w
 */
function closeTicketDetailsModal() {
    document.getElementById('ticketDetailsModal').classList.remove('show');
    currentTicketDetails = null;
}

/**
 * Zmienia status zg≈Çoszenia
 */
function changeTicketStatus(newStatus) {
    if (!currentTicketDetails) {
        showNotification('B≈ÇƒÖd: brak wybranego zg≈Çoszenia', 'error');
        return;
    }
    
    const comment = document.getElementById('managerCommentInput').value.trim();
    
    // Walidacja komentarza dla odrzucenia
    if (newStatus === 'Odrzucone' && !comment) {
        showNotification('‚ùå Musisz podaƒá pow√≥d odrzucenia!', 'error');
        return;
    }
    
    // Potwierdzenie dla zamkniƒôcia/odrzucenia
    if (newStatus === 'Zamkniƒôte' || newStatus === 'Odrzucone') {
        const confirmMsg = newStatus === 'Zamkniƒôte' ? 
            'Czy na pewno chcesz zamknƒÖƒá to zg≈Çoszenie?' :
            'Czy na pewno chcesz odrzuciƒá to zg≈Çoszenie?';
        
        if (!confirm(confirmMsg)) {
            return;
        }
    }
    
    if (typeof google === 'undefined' || !google.script) {
        showNotification('Status zmieniony (tryb testowy)', 'success');
        closeTicketDetailsModal();
        return;
    }
    
    console.log('Zmiana statusu ticketu:', currentTicketDetails.id, 'na:', newStatus);
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showNotification('‚úÖ ' + result.message, 'success');
                closeTicketDetailsModal();
                
                // Od≈õwie≈º listƒô
                loadAllTickets();
                
                // Od≈õwie≈º liczniki
                updateTicketsNotificationBadge();
                updateCriticalTicketsBadge();
            } else {
                showNotification('‚ùå ' + result.message, 'error');
            }
        })
        .withFailureHandler(function(error) {
            console.error('B≈ÇƒÖd zmiany statusu:', error);
            showNotification('‚ùå B≈ÇƒÖd: ' + error.message, 'error');
        })
        .updateTicketStatus(currentTicketDetails.id, newStatus, comment);
}

        // ===== PANEL "MOJE ZG≈ÅOSZENIA" DLA PRACOWNIKA =====

        let currentMyTicketFilter = 'all';
        let myTicketsCache = [];
        let currentMyTicketDetails = null;

        /**
         * Pokazuje panel "Moje zg≈Çoszenia" pracownika
         */
        function showMyTicketsView() {
            document.getElementById('unreadTicketsModal').classList.remove('show');
            showView('myTickets');
            loadMyTickets();
        }

        /**
         * ≈Åaduje zg≈Çoszenia zalogowanego pracownika
         */
        function loadMyTickets() {
            const container = document.getElementById('myTicketsList');
            
            if (!container) {
                console.error('‚ùå Nie znaleziono kontenera myTicketsList');
                return;
            }
            
            if (!currentUser || !currentUser.login) {
                container.innerHTML = '<p style="text-align: center; color: red;">B≈ÇƒÖd: Nie jeste≈õ zalogowany</p>';
                return;
            }
            
            container.innerHTML = '<p style="text-align: center; color: #666;">≈Åadowanie zg≈Çosze≈Ñ...</p>';
            
            if (typeof google === 'undefined' || !google.script) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Tryb testowy - brak danych</p>';
                return;
            }
            
            console.log('üîµ ≈Åadujƒô zg≈Çoszenia dla:', currentUser.login);
            
            google.script.run
                .withSuccessHandler(function(tickets) {
                    console.log('‚úÖ Pobrano zg≈Çoszenia pracownika:', tickets.length);
                    
                    if (!tickets || tickets.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666;">Nie masz jeszcze ≈ºadnych zg≈Çosze≈Ñ</p>';
                        myTicketsCache = [];
                        updateMyTicketsCounts([]);
                        return;
                    }
                    
                    myTicketsCache = tickets;
                    updateMyTicketsCounts(tickets);
                    displayFilteredMyTickets();
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå B≈ÇƒÖd ≈Çadowania zg≈Çosze≈Ñ:', error);
                    container.innerHTML = '<p style="color: red; text-align: center;">B≈ÇƒÖd: ' + (error.message || 'Nieznany') + '</p>';
                })
                .getMyTickets(currentUser.login);
        }

        /**
         * Aktualizuje liczniki w filtrach
         */
        function updateMyTicketsCounts(tickets) {
            const counts = {
                all: tickets.length,
                nowe: 0,
                wtrakcie: 0,
                zamkniete: 0,
                odrzucone: 0
            };
            
            tickets.forEach(ticket => {
                if (ticket.status.includes('Nowe')) counts.nowe++;
                else if (ticket.status.includes('W trakcie')) counts.wtrakcie++;
                else if (ticket.status.includes('Zamkniƒôte')) counts.zamkniete++;
                else if (ticket.status.includes('Odrzucone')) counts.odrzucone++;
            });
            
            document.getElementById('my-count-all').textContent = counts.all;
            document.getElementById('my-count-nowe').textContent = counts.nowe;
            document.getElementById('my-count-wtrakcie').textContent = counts.wtrakcie;
            document.getElementById('my-count-zamkniete').textContent = counts.zamkniete;
            document.getElementById('my-count-odrzucone').textContent = counts.odrzucone;
        }

        /**
         * Filtruje moje zg≈Çoszenia wed≈Çug statusu
         */
        function filterMyTickets(status) {
            currentMyTicketFilter = status;
            
            // Zaktualizuj styl filtr√≥w
            document.querySelectorAll('#myTicketsView .vacation-type-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            const filterMap = {
                'all': 'my-filter-all',
                'Nowe': 'my-filter-nowe',
                'W trakcie': 'my-filter-wtrakcie',
                'Zamkniƒôte': 'my-filter-zamkniete',
                'Odrzucone': 'my-filter-odrzucone'
            };
            
            document.getElementById(filterMap[status]).classList.add('selected');
            
            displayFilteredMyTickets();
        }

       /**
       * Wy≈õwietla przefiltrowane zg≈Çoszenia pracownika
       */
      function displayFilteredMyTickets() {
          console.log('üé® displayFilteredMyTickets - start');
          console.log('Cache zawiera:', myTicketsCache.length, 'zg≈Çosze≈Ñ');
          console.log('Aktualny filtr:', currentMyTicketFilter);
          
          const container = document.getElementById('myTicketsList');
          
          if (!container) {
              console.error('‚ùå Brak kontenera myTicketsList!');
              return;
          }
          
          let filtered = myTicketsCache;
          if (currentMyTicketFilter !== 'all') {
              filtered = myTicketsCache.filter(t => t.status.includes(currentMyTicketFilter));
          }
          
          if (filtered.length === 0) {
              container.innerHTML = '<p style="text-align: center; color: #666;">Brak zg≈Çosze≈Ñ w tej kategorii</p>';
              return;
          }
          
          console.log('‚úÖ Zg≈Çoszenia do wy≈õwietlenia:', filtered.length);
          console.log('üìã Pierwsze zg≈Çoszenie:', filtered[0]);
          
          let html = '';
          console.log('üî® Zaczynam budowaƒá HTML...');
          
          filtered.forEach((ticket, index) => {
              console.log('Przetwarzam zg≈Çoszenie #' + ticket.id);
              
              const priorityColors = {
                  'NISKI': '#28a745',
                  '≈öREDNI': '#ffc107',
                  'WYSOKI': '#fd7e14',
                  'KRYTYCZNY': '#dc3545'
              };
              
              const priorityColor = priorityColors[ticket.priority] || '#6c757d';
              
              const statusEmoji = ticket.status.includes('Nowe') ? 'üîµ' :
                                ticket.status.includes('W trakcie') ? 'üü°' :
                                ticket.status.includes('Zamkniƒôte') ? 'üü¢' : 'üî¥';
              
              const categoryEmoji = ticket.category === 'pomys≈Ç' ? 'üí°' :
                                  ticket.category === 'problem' ? '‚ö†Ô∏è' :
                                  ticket.category === 'usterka' ? 'üîß' : 'üÜò';
              
              
              // Badge - poka≈º je≈õli nieodczytane (z komentarzem LUB zmiana statusu)
              let unreadBadge = '';
              if (!ticket.readByEmployee) {
                  if (ticket.managerComment) {
                      unreadBadge = '<span style="background: #dc3545; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; margin-left: 10px;">üîî NOWA ODPOWIED≈π</span>';
                  } else if (ticket.status.includes('W trakcie') || ticket.status.includes('Zamkniƒôte') || ticket.status.includes('Odrzucone')) {
                      unreadBadge = '<span style="background: #17a2b8; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; margin-left: 10px;">üîî ZMIANA STATUSU</span>';
                  }
              }
              
              const titleEscaped = (ticket.title || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
              
              html += '<div class="vacation-request-item" style="cursor: pointer; border-left: 4px solid ' + priorityColor + ';" onclick="showMyTicketDetails(' + ticket.id + ')">';
              html += '<div style="display: flex; justify-content: space-between; align-items: start;">';
              html += '<div style="flex: 1;">';
              html += '<div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">';
              html += categoryEmoji + ' #' + ticket.id + ' - ' + titleEscaped + unreadBadge;
              html += '</div>';
              html += '<div style="font-size: 14px; color: #666; margin-bottom: 8px;">';
              html += 'üìÖ Zg≈Çoszono: ' + ticket.dateSubmitted + ' | ' + statusEmoji + ' ' + ticket.status;
              html += '</div>';
              html += '<div style="font-size: 13px; color: #888;">';
              html += 'üìç ' + ticket.location;
              html += '</div>';
              html += '</div>';
              html += '<div style="text-align: right;">';
              html += '<span style="background: ' + priorityColor + '; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">';
              html += ticket.priority;
              html += '</span>';
              html += '</div>';
              html += '</div>';
              html += '</div>';
          });
          
          console.log('üìù Wygenerowany HTML ma d≈Çugo≈õƒá:', html.length, 'znak√≥w');
          console.log('üì¶ Ustawiam innerHTML...');
          
          container.innerHTML = html;
          
          console.log('‚úÖ displayFilteredMyTickets - KONIEC');
      }

        /**
 * Pokazuje szczeg√≥≈Çy zg≈Çoszenia pracownika w modalu
 */
function showMyTicketDetails(ticketId) {
    const ticket = myTicketsCache.find(t => t.id === ticketId);
    
    if (!ticket) {
        showNotification('Nie znaleziono zg≈Çoszenia', 'error');
        return;
    }
    
    currentMyTicketDetails = ticket;
    
    const priorityColors = {
        'NISKI': '#28a745',
        '≈öREDNI': '#ffc107',
        'WYSOKI': '#fd7e14',
        'KRYTYCZNY': '#dc3545'
    };
    
    const priorityColor = priorityColors[ticket.priority] || '#6c757d';
    
    const statusEmoji = ticket.status.includes('Nowe') ? 'üîµ' :
                       ticket.status.includes('W trakcie') ? 'üü°' :
                       ticket.status.includes('Zamkniƒôte') ? 'üü¢' : 'üî¥';
    
    const categoryEmoji = ticket.category === 'pomys≈Ç' ? 'üí°' :
                         ticket.category === 'problem' ? '‚ö†Ô∏è' :
                         ticket.category === 'usterka' ? 'üîß' : 'üÜò';
    
    let detailsHTML = `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 6px solid ${priorityColor};">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <h3 style="margin: 0; font-size: 22px;">${categoryEmoji} Zg≈Çoszenie #${ticket.id}</h3>
                <span style="background: ${priorityColor}; color: white; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: bold;">
                    ${ticket.priority}
                </span>
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong style="font-size: 18px;">${ticket.title}</strong>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
                <div>
                    <strong>Data zg≈Çoszenia:</strong><br>
                    ${ticket.dateSubmitted}
                </div>
                <div>
                    <strong>Kategoria:</strong><br>
                    ${categoryEmoji} ${ticket.category}
                </div>
                <div>
                    <strong>Status:</strong><br>
                    ${statusEmoji} ${ticket.status}
                </div>
                <div>
                    <strong>Lokalizacja:</strong><br>
                    ${ticket.location}
                </div>
            </div>
            
            <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 15px;">
                <strong>Tw√≥j opis problemu:</strong>
                <p style="margin: 10px 0 0 0; white-space: pre-wrap;">${ticket.description}</p>
            </div>
    `;
    
    // Odpowied≈∫ kierownika lub zmiana statusu
    if (ticket.managerComment) {
        const isUnread = !ticket.readByEmployee;
        const bgColor = isUnread ? '#fff3cd' : '#e3f2fd';
        const borderColor = isUnread ? '#ffc107' : '#2196f3';
        const unreadBadge = isUnread ? '<span style="background: #dc3545; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-left: 10px;">üîî NOWA ODPOWIED≈π</span>' : '';
        
        detailsHTML += `
            <div style="background: ${bgColor}; padding: 15px; border-radius: 6px; margin-top: 15px; border-left: 4px solid ${borderColor};">
                <strong>üí¨ Odpowied≈∫ kierownika:${unreadBadge}</strong>
                <p style="margin: 10px 0 0 0; white-space: pre-wrap;">${ticket.managerComment}</p>
                ${ticket.dateResponse ? `<small style="color: #666;">Odpowiedziano: ${ticket.dateResponse}</small>` : ''}
            </div>
        `;
    } else if (ticket.status.includes('W trakcie') || ticket.status.includes('Zamkniƒôte') || ticket.status.includes('Odrzucone')) {
        // Zmiana statusu BEZ komentarza
        const isUnread = !ticket.readByEmployee;
        const bgColor = isUnread ? '#e3f2fd' : '#f8f9fa';
        const borderColor = isUnread ? '#2196f3' : '#dee2e6';
        const unreadBadge = isUnread ? '<span style="background: #17a2b8; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-left: 10px;">üîî ZMIANA STATUSU</span>' : '';
        
        const statusEmoji = ticket.status.includes('W trakcie') ? 'üü°' :
                          ticket.status.includes('Zamkniƒôte') ? 'üü¢' : 'üî¥';
        
        detailsHTML += `
            <div style="background: ${bgColor}; padding: 15px; border-radius: 6px; margin-top: 15px; border-left: 4px solid ${borderColor};">
                <strong>üìù Kierownik zmieni≈Ç status:${unreadBadge}</strong>
                <p style="margin: 10px 0 0 0; font-size: 16px;">${statusEmoji} ${ticket.status}</p>
                ${ticket.dateResponse ? `<small style="color: #666;">Zmieniono: ${ticket.dateResponse}</small>` : ''}
            </div>
        `;
    } else {
        // Poka≈º "Oczekiwanie..." TYLKO dla statusu Nowe
        if (ticket.status.includes('Nowe')) {
            detailsHTML += `
                <div style="background: #e9ecef; padding: 15px; border-radius: 6px; margin-top: 15px; text-align: center; color: #666;">
                    Oczekiwanie na odpowied≈∫ kierownika...
                </div>
            `;
        }
        // Dla Zamkniƒôte/Odrzucone bez komentarza - nie pokazuj nic
    }
    
    detailsHTML += '</div>';
    
    // Przyciski
    let buttonsHTML = '<div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">';
    
    // Przycisk "Przeczyta≈Çem" - je≈õli jest jakakolwiek zmiana od kierownika i nie przeczytane
    const hasManagerAction = ticket.managerComment || 
                            ticket.status.includes('W trakcie') || 
                            ticket.status.includes('Zamkniƒôte') || 
                            ticket.status.includes('Odrzucone');

    if (hasManagerAction && !ticket.readByEmployee) {
        buttonsHTML += `
            <button onclick="markTicketAsRead()" 
                    class="manager-btn approve" 
                    style="padding: 12px 20px; flex: 1; min-width: 150px;">
                ‚úÖ Przeczyta≈Çem
            </button>
        `;
    }
    
    buttonsHTML += `
        <button onclick="closeMyTicketDetailsModal()" 
                class="manager-btn" 
                style="background: #6c757d; color: white; padding: 12px 20px; flex: 1; min-width: 150px;">
            üîô Wr√≥ƒá do listy
        </button>
    `;
    
    buttonsHTML += '</div>';
    
    document.getElementById('ticketDetailsContent').innerHTML = detailsHTML + buttonsHTML;
    
    // Ukryj pole komentarza kierownika (dla pracownika nie jest potrzebne)
    const commentSection = document.querySelector('#ticketDetailsModal textarea')?.parentElement;
    if (commentSection) commentSection.style.display = 'none';
    
    // Ukryj przyciski akcji kierownika (dla pracownika)
    const managerButtons = document.querySelectorAll('#ticketDetailsModal button[onclick*="changeTicketStatus"]');
    managerButtons.forEach(btn => btn.style.display = 'none');
    
    // Ukryj przycisk "Wr√≥ƒá do listy" z HTML (bo mamy w≈Çasny w buttonsHTML)
    const backButton = document.querySelector('#ticketDetailsModal button[onclick*="closeTicketDetailsModal"]');
    if (backButton) backButton.style.display = 'none';
    
    document.getElementById('ticketDetailsModal').classList.add('show');
}

/**
 * Zamyka modal szczeg√≥≈Ç√≥w
 */
function closeMyTicketDetailsModal() {
    document.getElementById('ticketDetailsModal').classList.remove('show');
    currentMyTicketDetails = null;
}

/**
 * Oznacza zg≈Çoszenie jako przeczytane przez pracownika
 */
function markTicketAsRead() {
    if (!currentMyTicketDetails) {
        showNotification('B≈ÇƒÖd: brak wybranego zg≈Çoszenia', 'error');
        return;
    }
    
    if (typeof google === 'undefined' || !google.script) {
        showNotification('Oznaczono jako przeczytane (tryb testowy)', 'success');
        closeMyTicketDetailsModal();
        return;
    }
    
    console.log('Oznaczam jako przeczytane:', currentMyTicketDetails.id);
    
    google.script.run
    .withSuccessHandler(function(result) {
        if (result.success) {
            showNotification('‚úÖ Oznaczono jako przeczytane', 'success');
            
            // ‚úÖ NATYCHMIAST zmniejsz licznik (nie czekaj na backend)
            if (unreadTicketRepliesCount > 0) {
                unreadTicketRepliesCount--;
            }
            
            // ‚úÖ NATYCHMIAST zaktualizuj badge
            updateMyTicketsTileInActionView();
            
            closeMyTicketDetailsModal();
            
            // Od≈õwie≈º listƒô w tle
            loadMyTickets();
        } else {
            showNotification('‚ùå ' + result.message, 'error');
        }
    })
        .withFailureHandler(function(error) {
            console.error('B≈ÇƒÖd oznaczania jako przeczytane:', error);
            showNotification('‚ùå B≈ÇƒÖd: ' + error.message, 'error');
        })
        .markTicketAsReadByEmployee(currentMyTicketDetails.id);
}

// ===== SYSTEM OG≈ÅOSZE≈É =====

let pendingAnnouncements = [];
let currentAnnouncementIndex = 0;
let pendingRegistrationData = null;

function checkForAnnouncements(loginPracownika, afterCallback) {
  console.log('üîî checkForAnnouncements WYWO≈ÅANA z loginem:', loginPracownika);

  pendingRegistrationData = afterCallback;

  // 1) Je≈õli jeste≈õmy w Google Script (demo / stare ≈õrodowisko) ‚Äî zostawiamy stary tryb
  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success && result.announcements.length > 0) {
          pendingAnnouncements = result.announcements;
          currentAnnouncementIndex = 0;
          showCurrentAnnouncement();
        } else {
          if (pendingRegistrationData) {
            pendingRegistrationData();
            pendingRegistrationData = null;
          }
        }
      })
      .withFailureHandler(function(error) {
        console.error('B≈ÇƒÖd sprawdzania og≈Çosze≈Ñ:', error);
        if (pendingRegistrationData) {
          pendingRegistrationData();
          pendingRegistrationData = null;
        }
      })
      .getUnreadAnnouncements(loginPracownika);

    return;
  }

  // 2) TRYB PAGES/API
  apiGetUnreadAnnouncements(loginPracownika)
    .then((announcements) => {
      if (Array.isArray(announcements) && announcements.length > 0) {
        pendingAnnouncements = announcements;
        currentAnnouncementIndex = 0;
        showCurrentAnnouncement();
      } else {
        if (pendingRegistrationData) {
          pendingRegistrationData();
          pendingRegistrationData = null;
        }
      }
    })
    .catch((error) => {
      console.error('B≈ÇƒÖd sprawdzania og≈Çosze≈Ñ (API):', error);
      if (pendingRegistrationData) {
        pendingRegistrationData();
        pendingRegistrationData = null;
      }
    });
}

function showCurrentAnnouncement() {
    if (currentAnnouncementIndex >= pendingAnnouncements.length) {
        // Wszystkie przeczytane - kontynuuj rejestracjƒô
        document.getElementById('announcementScreen').classList.remove('show');
        if (pendingRegistrationData) {
            pendingRegistrationData();
            pendingRegistrationData = null;
        }
        return;
    }
    
    const ann = pendingAnnouncements[currentAnnouncementIndex];
    const total = pendingAnnouncements.length;
    const current = currentAnnouncementIndex + 1;
    
    // Ustaw typ i ikony
    const header = document.getElementById('announcementHeader');
    const icon = document.getElementById('announcementIcon');
    const title = document.getElementById('announcementTitle');
    
    header.className = 'announcement-card-header ' + ann.typ;
    
    if (ann.typ === 'pilne') {
        icon.textContent = 'üö®';
        title.textContent = 'Pilne og≈Çoszenie!';
    } else if (ann.typ === 'wazne') {
        icon.textContent = '‚ö†Ô∏è';
        title.textContent = 'Wa≈ºne og≈Çoszenie';
    } else {
        icon.textContent = 'üì¢';
        title.textContent = 'Og≈Çoszenie';
    }
    
    document.getElementById('announcementMessage').textContent = ann.tresc;
    document.getElementById('announcementMeta').textContent = 'Wa≈ºne do: ' + ann.dataWaznosci;
    
    if (total > 1) {
        document.getElementById('announcementCounter').textContent = current + ' z ' + total;
        document.getElementById('announcementCounter').style.display = 'inline-block';
    } else {
        document.getElementById('announcementCounter').style.display = 'none';
    }
    
    document.getElementById('announcementScreen').classList.add('show');
}

function markAsReadAndContinue() {
    const ann = pendingAnnouncements[currentAnnouncementIndex];
    const loginPracownika = sessionStorage.getItem('currentEmployeeLogin');
    
    removeAnnouncementFromCache(ann.id);
    
      // Google Script (stary tryb)
  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withFailureHandler(function(error) {
        console.error('B≈ÇƒÖd oznaczania odczytu:', error);
      })
      .markAnnouncementAsRead(ann.id, loginPracownika);
  } else {
    // Pages/API
    apiMarkAnnouncementAsRead(ann.id, loginPracownika)
      .catch((error) => console.error('B≈ÇƒÖd oznaczania odczytu (API):', error));
  }
    
    currentAnnouncementIndex++;
    showCurrentAnnouncement();
}

// ===== PANEL OG≈ÅOSZE≈É KIEROWNIKA =====

function openAnnouncementsPanel() {
    // Zatrzymaj auto-focus na pole EAN gdy panel jest otwarty
    window.announcementsPanelOpen = true;
    
    document.getElementById('announcementsPanelOverlay').classList.add('show');
    switchAnnouncementTab('new');
    loadEmployeesForRecipients();
    setDefaultValidDate();
}

function closeAnnouncementsPanel() {
    window.announcementsPanelOpen = false;
    document.getElementById('announcementsPanelOverlay').classList.remove('show');
}

function switchAnnouncementTab(tab) {
    document.getElementById('tabNew').classList.remove('active');
    document.getElementById('tabList').classList.remove('active');
    
    if (tab === 'new') {
        document.getElementById('tabNew').classList.add('active');
        document.getElementById('newAnnouncementForm').style.display = 'flex';
        document.getElementById('announcementsListView').style.display = 'none';
    } else {
        document.getElementById('tabList').classList.add('active');
        document.getElementById('newAnnouncementForm').style.display = 'none';
        document.getElementById('announcementsListView').style.display = 'block';
        loadAnnouncementsList();
    }
}

function setDefaultValidDate() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById('annValidUntil').value = yyyy + '-' + mm + '-' + dd;
}

async function loadEmployeesForRecipients() {
    const container = document.getElementById('recipientsList');
    container.innerHTML = '<p style="padding: 10px; color: #888;">‚è≥ ≈Åadowanie...</p>';

    try {
        const login = (sessionStorage.getItem('loggedInUser') || '').trim();
        if (!login) {
            container.innerHTML = '<p style="color: red;">‚ùå Brak loginu (zaloguj siƒô ponownie)</p>';
            return;
        }

        const employees = await apiGetEmployeesForRecipients(login);

        let html = '';
        employees.forEach(function(emp) {
            html += '<label>';
            html += '<input type="checkbox" class="recipient-checkbox" value="' + emp.login + '"> ';
            html += emp.name + ' (' + emp.login + ')';
            html += '</label>';
        });

        container.innerHTML = html || '<p style="padding:10px;color:#888;">Brak pracownik√≥w</p>';
    } catch (e) {
        container.innerHTML = '<p style="color: red;">‚ùå ' + (e.message || 'B≈ÇƒÖd') + '</p>';
    }
}

function toggleAllRecipients() {
    const allChecked = document.getElementById('annAllRecipients').checked;
    const checkboxes = document.querySelectorAll('.recipient-checkbox');
    
    checkboxes.forEach(function(cb) {
        cb.checked = false;
        cb.disabled = allChecked;
    });
    
    document.getElementById('recipientsList').style.opacity = allChecked ? '0.5' : '1';
}

async function submitAnnouncement() {
    const typ = document.getElementById('annType').value;
    const tresc = document.getElementById('annMessage').value.trim();
    const dataWaznosci = document.getElementById('annValidUntil').value;
    const allRecipients = document.getElementById('annAllRecipients').checked;

    if (!tresc) { showNotification('Wpisz tre≈õƒá og≈Çoszenia', 'error'); return; }
    if (!dataWaznosci) { showNotification('Wybierz datƒô wa≈ºno≈õci', 'error'); return; }

    let odbiorcy = 'WSZYSCY';
    if (!allRecipients) {
        const selected = [];
        document.querySelectorAll('.recipient-checkbox:checked').forEach(function(cb) {
            selected.push(cb.value);
        });
        if (selected.length === 0) {
            showNotification('Wybierz odbiorc√≥w lub zaznacz "Wszyscy"', 'error');
            return;
        }
        odbiorcy = selected.join(',');
    }

    const login = (sessionStorage.getItem('loggedInUser') || '').trim();
    const autor = login || 'kierownik';

    try {
        await apiCreateAnnouncement(login, typ, tresc, dataWaznosci, odbiorcy, autor);

        showNotification('Og≈Çoszenie zosta≈Ço wys≈Çane!', 'success');
        closeAnnouncementsPanel();

        document.getElementById('annMessage').value = '';
        document.getElementById('annAllRecipients').checked = false;
        document.getElementById('annType').value = 'info';
    } catch (e) {
        showNotification('B≈ÇƒÖd: ' + (e.message || 'B≈ÇƒÖd'), 'error');
    }
}

async function loadAnnouncementsList() {
    const container = document.getElementById('announcementsList');
    container.innerHTML = '<p style="text-align: center; padding: 40px; color: #888;">‚è≥ ≈Åadowanie...</p>';

    try {
        const login = (sessionStorage.getItem('loggedInUser') || '').trim();
        if (!login) {
            container.innerHTML = '<p style="color: red; text-align: center; padding: 40px;">‚ùå Brak loginu kierownika (zaloguj siƒô ponownie)</p>';
            return;
        }

        const announcements = await apiListAnnouncementsForManager(login);

        if (!announcements.length) {
            container.innerHTML = '<div class="announcements-empty">üì≠ Brak og≈Çosze≈Ñ</div>';
            return;
        }

        let html = '';
        announcements.forEach(function(ann) {
            html += '<div class="announcement-item ' + ann.typ + '">';
            html += '<div class="announcement-item-header">';
            html += '<span class="announcement-item-type ' + ann.typ + '">';
            if (ann.typ === 'pilne') html += 'üö® Pilne';
            else if (ann.typ === 'wazne') html += '‚ö†Ô∏è Wa≈ºne';
            else html += '‚ÑπÔ∏è Info';
            html += '</span>';
            html += '</div>';
            html += '<div class="announcement-item-text">' + ann.tresc + '</div>';
            html += '<div class="announcement-item-meta">';
            html += '<span>Dodano: ' + (ann.dataDodania || '-') + ' | Wa≈ºne do: ' + (ann.dataWaznosci || '-') + '</span>';
            html += '<span class="announcement-item-readers">üëÅÔ∏è Przeczyta≈Ço: ' + (ann.readCount ?? 0) + ' os√≥b</span>';
            html += '</div>';
            html += '<div style="font-size: 0.8rem; color: #888; margin-top: 5px;">Odbiorcy: ' + (ann.odbiorcy || 'WSZYSCY') + '</div>';
            html += '</div>';
        });

        container.innerHTML = html;

    } catch (e) {
        container.innerHTML = '<p style="color: red; text-align: center; padding: 40px;">‚ùå ' + (e.message || 'B≈ÇƒÖd') + '</p>';
    }
}

function deleteAnnouncementItem(id) {
    if (!confirm('Czy na pewno chcesz usunƒÖƒá to og≈Çoszenie?')) {
        return;
    }
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showNotification('Og≈Çoszenie usuniƒôte', 'success');
                loadAnnouncementsList();
            } else {
                showNotification('B≈ÇƒÖd: ' + result.message, 'error');
            }
        })
        .withFailureHandler(function(error) {
            showNotification('B≈ÇƒÖd: ' + error.message, 'error');
        })
        .deleteAnnouncement(id);
}

// ===== KTO JEST NA MAGAZYNIE =====

function showWhoIsWorking() {
    document.getElementById('whoIsWorkingModal').classList.add('show');
    refreshWhoIsWorking();
}

function closeWhoIsWorking() {
    document.getElementById('whoIsWorkingModal').classList.remove('show');
}

function refreshWhoIsWorking() {
    const content = document.getElementById('whoIsWorkingContent');
    content.innerHTML = '<p style="text-align: center; padding: 40px;">‚è≥ ≈Åadowanie...</p>';
    
    if (typeof google === 'undefined' || !google.script) {
        // Tryb testowy
        content.innerHTML = '<p style="text-align: center; padding: 40px;">Tryb testowy - brak po≈ÇƒÖczenia z arkuszem</p>';
        return;
    }
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                renderWhoIsWorking(result);
            } else {
                content.innerHTML = '<p style="text-align: center; padding: 40px; color: red;">‚ùå ' + result.message + '</p>';
            }
        })
        .withFailureHandler(function(error) {
            content.innerHTML = '<p style="text-align: center; padding: 40px; color: red;">‚ùå B≈ÇƒÖd: ' + error.message + '</p>';
        })
        .getActiveEmployees();
}

function renderWhoIsWorking(data) {
    const content = document.getElementById('whoIsWorkingContent');
    
    const operationIcons = {
        'przyjecie': 'üì¶',
        'Przyjƒôcie dostaw': 'üì¶',
        'rozladunek': 'üöõ',
        'Roz≈Çadunek rƒôczny kontenera': 'üöõ',
        'zaladunek': 'üì§',
        'Za≈Çadunek rƒôczny kontenera': 'üì§',
        'relokacja': 'üîÑ',
        'Relokacja': 'üîÑ',
        'kompletacja': 'üìã',
        'Kompletacja zam√≥wie≈Ñ': 'üìã',
        'weryfikacja': '‚úÖ',
        'Weryfikacja zam√≥wie≈Ñ': '‚úÖ',
        'co-packing': 'üéÅ',
        'Co-packing': 'üéÅ',
        'operacje-porzadkowe': 'üßπ',
        'Operacje porzƒÖdkowe': 'üßπ',
        'inwentaryzacja': 'üìä',
        'Inwentaryzacja': 'üìä'
    };
    
    let html = '';
    
    // Sekcja: PracujƒÖ
    html += '<div class="who-is-working-section">';
    html += '<div class="who-is-working-section-title working">üü¢ PracujƒÖ (' + data.working.length + ' os√≥b)</div>';
    
    if (data.working.length > 0) {
        data.working.forEach(function(emp) {
            const icon = operationIcons[emp.operation] || 'üë§';
            html += '<div class="who-is-working-employee">';
            html += '<div class="who-is-working-employee-icon">' + icon + '</div>';
            html += '<div class="who-is-working-employee-info">';
            html += '<div class="who-is-working-employee-name">' + emp.name + '</div>';
            html += '<div class="who-is-working-employee-operation">' + emp.operation + '</div>';
            html += '</div>';
            html += '<div class="who-is-working-employee-time">od ' + emp.startTime + '</div>';
            html += '</div>';
        });
    } else {
        html += '<div class="who-is-working-empty">Brak pracujƒÖcych os√≥b</div>';
    }
    html += '</div>';
    
    // Sekcja: Na przerwie
    html += '<div class="who-is-working-section">';
    html += '<div class="who-is-working-section-title on-break">üü° Na przerwie (' + data.onBreak.length + ' os√≥b)</div>';
    
    if (data.onBreak.length > 0) {
        data.onBreak.forEach(function(emp) {
            const icon = operationIcons[emp.operation] || 'üë§';
            html += '<div class="who-is-working-employee">';
            html += '<div class="who-is-working-employee-icon">' + icon + '</div>';
            html += '<div class="who-is-working-employee-info">';
            html += '<div class="who-is-working-employee-name">' + emp.name + '</div>';
            html += '<div class="who-is-working-employee-operation">' + emp.operation + '</div>';
            html += '</div>';
            html += '<div class="who-is-working-employee-time">przerwa</div>';
            html += '</div>';
        });
    } else {
        html += '<div class="who-is-working-empty">Brak os√≥b na przerwie</div>';
    }
    html += '</div>';
    
    // Sekcja: Nieobecni
    html += '<div class="who-is-working-section">';
    html += '<div class="who-is-working-section-title absent">‚ö™ Nieobecni dzi≈õ: ' + data.absentCount + ' os√≥b</div>';
    html += '</div>';
    
    content.innerHTML = html;
    
    // Aktualizuj timestamp
    document.getElementById('whoIsWorkingTimestamp').textContent = 'Ostatnia aktualizacja: ' + data.timestamp;
}

function toggleTheme() {
    const body = document.body;
    const icon = document.getElementById('themeIcon');
    const text = document.getElementById('themeText');
    
    if (body.classList.contains('light-mode')) {
        body.classList.remove('light-mode');
        body.classList.add('dark-mode');
        icon.textContent = '‚òÄÔ∏è';
        text.textContent = 'Tryb jasny';
        localStorage.setItem('dbk-theme', 'dark');
    } else {
        body.classList.remove('dark-mode');
        body.classList.add('light-mode');
        icon.textContent = 'üåô';
        text.textContent = 'Tryb ciemny';
        localStorage.setItem('dbk-theme', 'light');
    }
}

function loadSavedTheme() {
    const saved = localStorage.getItem('dbk-theme');
    const body = document.body;
    
    if (saved === 'dark') {
        body.classList.remove('light-mode');
        body.classList.add('dark-mode');
        document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
        document.getElementById('themeText').textContent = 'Tryb jasny';
    } else {
        body.classList.add('light-mode');
    }
}

// ===== LIVE WORKFORCE (badge na kafelkach + liczniki working/break) =====

function normalizeOperationToDeptId(op) {
  if (!op) return null;

  const s = String(op).trim();

  // je≈õli ju≈º jest ID (np. przyjecie / co-packing / operacje-porzadkowe) to zwr√≥ƒá
  const knownIds = new Set([
    'przyjecie', 'rozladunek', 'zaladunek', 'relokacja',
    'kompletacja', 'weryfikacja', 'co-packing',
    'operacje-porzadkowe', 'inwentaryzacja'
  ]);
  if (knownIds.has(s)) return s;

  // normalizacja nazw (z log√≥w / arkusza)
  const mapByName = {
    'Przyjƒôcie dostaw': 'przyjecie',
    'Roz≈Çadunek rƒôczny kontenera': 'rozladunek',
    'Za≈Çadunek rƒôczny kontenera': 'zaladunek',
    'Relokacja': 'relokacja',
    'Kompletacja zam√≥wie≈Ñ': 'kompletacja',
    'Weryfikacja zam√≥wie≈Ñ': 'weryfikacja',
    'Co-packing': 'co-packing',
    'Operacje porzƒÖdkowe': 'operacje-porzadkowe',
    'Inwentaryzacja': 'inwentaryzacja'
  };

  if (mapByName[s]) return mapByName[s];

  // awaryjnie: jak przyjdzie np. "operacje-porzadkowe" z innƒÖ wielko≈õciƒÖ liter
  const lower = s.toLowerCase();
  if (knownIds.has(lower)) return lower;

  return null;
}

function setupDepartmentTileBadges() {
  const tiles = document.querySelectorAll('#departmentView .tile');

  tiles.forEach(tile => {
    if (tile.querySelector('.dept-badge')) return;

    // uzupe≈Çnij deptId dla hardcoded kafelk√≥w (z onclick selectDepartment('...'))
    if (!tile.dataset.deptId) {
      const onclick = tile.getAttribute('onclick') || '';
      const m = onclick.match(/selectDepartment\(\s*['"](.+?)['"]\s*\)/);
      if (m && m[1]) tile.dataset.deptId = m[1];
    }

    const deptId = tile.dataset.deptId;
    if (!deptId) return;

    const badge = document.createElement('span');
    badge.className = 'dept-badge';
    badge.textContent = '0';
    badge.style.display = 'none'; // ukryty gdy 0

    tile.appendChild(badge);
  });
}

// ===== LIVE WORKFORCE CACHE + OPTYMISTYCZNE UI (jak w Sprint) =====
let liveWorkforceCache = {
  loaded: false,
  working: [],
  onBreak: []
};

function normLogin(x) {
  return String(x || '')
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '');
}

function empKey(emp) {
  const raw = (emp && (emp.login || emp.code || emp.userLogin)) || '';
  return normLogin(raw);
}

function upsertByLogin(arr, emp) {
  const key = empKey(emp);
  const idx = arr.findIndex(x => empKey(x) === key);
  if (idx >= 0) arr[idx] = { ...arr[idx], ...emp };
  else arr.push(emp);
}

function removeByLogin(arr, login) {
  const key = normLogin(login);
  const idx = arr.findIndex(x => empKey(x) === key);
  if (idx >= 0) arr.splice(idx, 1);
}

function optimisticUpdateLiveWorkforce(data) {
  if (!data || !data.login || !data.action) return;
  if (!currentUser || normLogin(currentUser.login) !== normLogin(data.login)) return;

  const actionRaw = String(data.action || '');
  const a = actionRaw
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '');

  const isBreak = a.includes('przerw');
  const isReturn =
    a.includes('wracam') ||
    a.includes('powrot') ||
    (isBreak && (a.includes('koniec') || a.includes('koncze')));

  const isBreakStart = isBreak && !isReturn;

  const isEnterWork =
    a.includes('wchodz') || a.includes('start') || a.includes('loguje') || a.includes('zaczynam');

  const isExitWork =
    a.includes('wychodz') || a.includes('wylog') || (a.includes('koniec') && !isBreak);

  const isChangeOp =
    a.includes('zmien') || a.includes('operac') || a.includes('operation');

  const emp = {
    login: currentUser.login,
    name: currentUser.name || currentUser.login,
    operation: data.department || currentDepartment || null
  };

  if (!liveWorkforceCache.working) liveWorkforceCache.working = [];
  if (!liveWorkforceCache.onBreak) liveWorkforceCache.onBreak = [];

  // (mo≈ºesz p√≥≈∫niej wy≈ÇƒÖczyƒá)
  console.log('[optimistic]', actionRaw, { isEnterWork, isExitWork, isBreakStart, isReturn, isChangeOp });

  if (isBreakStart) {
    // working -> onBreak
    removeByLogin(liveWorkforceCache.working, emp.login);
    upsertByLogin(liveWorkforceCache.onBreak, emp);
    applyLiveWorkforceToUI(liveWorkforceCache);
    return;
  }

  if (isReturn) {
    // onBreak -> working
    removeByLogin(liveWorkforceCache.onBreak, emp.login);
    upsertByLogin(liveWorkforceCache.working, emp);
    applyLiveWorkforceToUI(liveWorkforceCache);
    return;
  }

  if (isExitWork) {
    // usu≈Ñ z obu
    removeByLogin(liveWorkforceCache.working, emp.login);
    removeByLogin(liveWorkforceCache.onBreak, emp.login);
    applyLiveWorkforceToUI(liveWorkforceCache);
    return;
  }

  if (isEnterWork) {
    // dodaj do working
    removeByLogin(liveWorkforceCache.onBreak, emp.login);
    upsertByLogin(liveWorkforceCache.working, emp);
    applyLiveWorkforceToUI(liveWorkforceCache);
    return;
  }

  if (isChangeOp) {
    const key = normLogin(emp.login);

    const w = liveWorkforceCache.working.find(x => normLogin(x && x.login) === key);
    if (w) w.operation = emp.operation;

    const b = liveWorkforceCache.onBreak.find(x => normLogin(x && x.login) === key);
    if (b) b.operation = emp.operation;

    applyLiveWorkforceToUI(liveWorkforceCache);
    return;
  }
}

function applyLiveWorkforceToUI(data) {
  const workingArr = data.working || [];
  const breakArr = data.onBreak || data.break || [];

  // liczniki u g√≥ry
  const workingEl = document.getElementById('workingCount');
  const breakEl = document.getElementById('breakCount');
  if (workingEl) workingEl.textContent = workingArr.length;
  if (breakEl) breakEl.textContent = breakArr.length;

  // badge liczymy TYLKO z pracujƒÖcych (bez przerwy)
  const perDeptCount = {};
  workingArr.forEach(emp => {
    const deptId = normalizeOperationToDeptId(emp.operation);
    if (!deptId) return;
    perDeptCount[deptId] = (perDeptCount[deptId] || 0) + 1;
  });

  // je≈õli backend zwr√≥ci≈Ç workingArr, ale nie da siƒô wyliczyƒá ≈ºadnego deptId,
  // to NIE chowaj badge (zostaw ostatni stan, ≈ºeby nie "mruga≈Ço")
  if (workingArr.length > 0 && Object.keys(perDeptCount).length === 0) return;

  document.querySelectorAll('#departmentView .tile').forEach(tile => {
    const deptId = tile.dataset.deptId;
    if (!deptId) return;

    const badge = tile.querySelector('.dept-badge');
    if (!badge) return;

    const count = perDeptCount[deptId] || 0;
    if (count > 0) {
      badge.textContent = String(count);
      badge.style.display = 'inline-flex';
    } else {
      badge.style.display = 'none';
    }
  });
}


function refreshLiveWorkforce() {
  // 1) Preferuj API (bo GS wy≈ÇƒÖczony)
 if (typeof API_BASE !== 'undefined' && API_BASE) {
    const login = (sessionStorage.getItem('loggedInUser') || '').trim();

    fetch(`${API_BASE}/workforce/live-snapshot`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ login })
    })
    .then(r => r.json())
    .then(data => {
      if (!data || data.success !== true) return;

      const rows = Array.isArray(data.rows) ? data.rows : [];

      const working = [];
      const onBreak = [];

      rows.forEach(r => {
        const status = String(r.status || '').toUpperCase();
        const emp = {
          login: r.login,
          name: r.name || r.login,
          operation: r.dept || r.department || '-'   // wa≈ºne: operation zasila badge
        };

        if (status === 'PRACUJE') working.push(emp);
        else if (status === 'PRZERWA') onBreak.push(emp);
      });

      liveWorkforceCache = {
        loaded: true,
        working,
        onBreak
      };

      applyLiveWorkforceToUI(liveWorkforceCache);
    })
    .catch(err => console.log('refreshLiveWorkforce API error:', err));

    return;
  }

  // 2) Fallback na GS (gdyby≈õ kiedy≈õ odpala≈Ç starƒÖ wersjƒô)
  if (typeof google === 'undefined' || !google.script) return;

  google.script.run
    .withSuccessHandler(function(result) {
      if (!result) return;

      const ok = (result.success === undefined) ? true : !!result.success;
      if (!ok) return;

      const working = result.working || (result.data && result.data.working) || [];
      const onBreak = result.onBreak || (result.data && result.data.onBreak) ||
                      result.break || (result.data && result.data.break) || [];

      liveWorkforceCache = {
        loaded: true,
        working: working,
        onBreak: onBreak
      };

      applyLiveWorkforceToUI(liveWorkforceCache);
    })
    .withFailureHandler(function(err) {
      console.log('refreshLiveWorkforce GS error:', err);
    })
        .getActiveEmployees();
    }

        // ===== INICJALIZACJA =====
            document.addEventListener('DOMContentLoaded', function() {
              console.log('DOM za≈Çadowany - inicjalizujƒô aplikacjƒô...');
            
              loadSavedTheme();
              updateTime();
              setInterval(updateTime, 1000);
              updateButtonStates();
            
              const input = document.getElementById('codeInput');
              if (input) {
                input.addEventListener('keypress', handleKeyPress);
                input.addEventListener('input', handleInput);
                input.focus();
                console.log('Pole kodu zainicjalizowane');
              }
            
              const verificationInput = document.getElementById('verificationCodeInput');
              if (verificationInput) {
                verificationInput.addEventListener('keypress', function(e) {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmUserCode();
                  }
                });
              }
            
              const vacationCodeInput = document.getElementById('vacationVerificationCodeInput');
              if (vacationCodeInput) {
                vacationCodeInput.addEventListener('keypress', function(e) {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmVacationUserCode();
                  }
                });
              }
            
              const l4VerificationInput = document.getElementById('l4VerificationCodeInput');
              if (l4VerificationInput) {
                l4VerificationInput.addEventListener('keypress', function(e) {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmL4ManagerCode();
                  }
                });
              }
            
              const ticketVerificationInput = document.getElementById('ticketVerificationCodeInput');
              if (ticketVerificationInput) {
                ticketVerificationInput.addEventListener('keypress', function(e) {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmTicketUserCode();
                  }
                });
              }
            
              const startDateInput = document.getElementById('vacationStartDate');
              const endDateInput = document.getElementById('vacationEndDate');
            
              if (startDateInput) startDateInput.addEventListener('change', calculateVacationInfo);
              if (endDateInput) endDateInput.addEventListener('change', calculateVacationInfo);
            
              const l4StartDateInput = document.getElementById('l4StartDate');
              const l4EndDateInput = document.getElementById('l4EndDate');
            
              if (l4StartDateInput) l4StartDateInput.addEventListener('change', calculateL4WorkingDays);
              if (l4EndDateInput) l4EndDateInput.addEventListener('change', calculateL4WorkingDays);
            
              // ‚úÖ Apps Script rzeczy tylko je≈õli istnieje google.script.run
            const hasAppsScript = (typeof google !== 'undefined' && google.script && google.script.run);
            
            // üîπ To uruchamiamy ZAWSZE (r√≥wnie≈º na Cloudflare Pages)
            loadDepartmentsFromSpreadsheet();
            setupDepartmentTileBadges();
            
            refreshLiveWorkforce();
            setTimeout(refreshLiveWorkforce, 800);
            
            if (hasAppsScript) {
              updateManagerNotificationBadge();
              startAutoRefresh();
              console.log('Rejestrator uruchomiony w Apps Script!');
            } else {
              console.log('Tryb Cloudflare Pages: Apps Script wy≈ÇƒÖczony, ale dzia≈Çy za≈Çadowane');
            }
                
           }); 
                
        // ===== MODU≈Å L4 - ZWOLNIENIA LEKARSKIE =====

/**
 * Otwiera widok weryfikacji L4
 */
window.openL4Registration = function() {
    loadSavedTheme(); // Zastosuj dark mode
    console.log('Otwieranie rejestracji L4...');
    showView('l4Verification');
    
    setTimeout(() => {
        const input = document.getElementById('l4VerificationCodeInput');
        if (input) {
            input.value = '';
            input.focus();
        }
    }, 100);
};

/**
 * Weryfikacja kodu kierownika dla L4
 */
window.confirmL4ManagerCode = function() {
    const inputCode = document.getElementById('l4VerificationCodeInput').value.trim();
    
    if (!inputCode) {
        showNotification('Wpisz kod EAN', 'error');
        return;
    }
    
    const cleanCode = inputCode.replace(/^~+/, '').replace(/~+$/, '').trim();
    console.log('Weryfikacja L4 - kod:', cleanCode);
    
    // Tylko kod kierownika jerzyd
    if (cleanCode === '1236737459372') {
        console.log('‚úÖ Kod kierownika poprawny - otwieram formularz L4');
        showL4Form();
    } else {
        showNotification('‚ùå Tylko kierownik mo≈ºe rejestrowaƒá L4', 'error');
        document.getElementById('l4VerificationCodeInput').value = '';
        document.getElementById('l4VerificationCodeInput').focus();
    }
};

/**
 * Pokazuje formularz L4 po weryfikacji
 */
function showL4Form() {
    showView('l4Form');
    loadEmployeesForL4();
    
    // Wyczy≈õƒá formularz
    document.getElementById('l4EmployeeSelect').value = '';
    document.getElementById('l4StartDate').value = '';
    document.getElementById('l4EndDate').value = '';
    document.getElementById('l4Type').value = 'Choroba';
    document.getElementById('l4Note').value = '';
    document.getElementById('l4Info').style.display = 'none';
    
    showNotification('Formularz L4 - wybierz pracownika', 'info');
}

/**
 * ≈Åaduje listƒô pracownik√≥w do dropdown
 */
function loadEmployeesForL4() {
    const select = document.getElementById('l4EmployeeSelect');
    select.innerHTML = '<option value="">≈Åadowanie pracownik√≥w...</option>';
    
    if (typeof google === 'undefined' || !google.script) {
        // Tryb testowy
        select.innerHTML = `
            <option value="">-- Wybierz pracownika --</option>
            <option value="rafalk5">Rafa≈Ç test (rafalk5)</option>
            <option value="vadyma">Vadym A. (vadyma)</option>
        `;
        return;
    }
    
    // Za≈Çaduj z arkusza
    google.script.run
        .withSuccessHandler(function(employees) {
            console.log('‚úÖ Otrzymano pracownik√≥w z backendu:', employees);
            console.log('Liczba pracownik√≥w:', employees.length);
            
            select.innerHTML = '<option value="">-- Wybierz pracownika --</option>';
            
            if (!employees || employees.length === 0) {
                select.innerHTML = '<option value="">Brak pracownik√≥w w arkuszu</option>';
                showNotification('‚ö†Ô∏è Brak pracownik√≥w w arkuszu', 'error');
                return;
            }
            
            employees.forEach(emp => {
                console.log('Dodajƒô pracownika:', emp);
                const option = document.createElement('option');
                option.value = emp.login;
                option.textContent = `${emp.firstName} ${emp.lastName} (${emp.login})`;
                select.appendChild(option);
            });
            
            showNotification(`‚úÖ Za≈Çadowano ${employees.length} pracownik√≥w`, 'success');
        })
        .withFailureHandler(function(error) {
            console.error('‚ùå B≈ÇƒÖd ≈Çadowania pracownik√≥w:', error);
            select.innerHTML = '<option value="">B≈ÇƒÖd ≈Çadowania pracownik√≥w</option>';
            showNotification('‚ùå B≈ÇƒÖd ≈Çadowania pracownik√≥w: ' + error.message, 'error');
        })
        .getAllEmployees();
}

                  /**
         * Oblicza dni kalendarzowe dla L4
         */
        window.calculateL4WorkingDays = function() {
            const startDate = document.getElementById('l4StartDate').value;
            const endDate = document.getElementById('l4EndDate').value;
            
            if (!startDate || !endDate) {
                document.getElementById('l4Info').style.display = 'none';
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                document.getElementById('l4Info').style.display = 'none';
                return;
            }
            
            // Oblicz dni kalendarzowe (w≈ÇƒÖcznie z weekendami)
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 bo liczymy oba dni w≈ÇƒÖcznie
            
            document.getElementById('l4WorkingDaysCount').textContent = diffDays;
            document.getElementById('l4Info').style.display = 'block';
        };

          /**
 * Rejestruje L4 w arkuszu
 */
window.submitL4Registration = function() {
    const employeeLogin = document.getElementById('l4EmployeeSelect').value;
    const startDate = document.getElementById('l4StartDate').value;
    const endDate = document.getElementById('l4EndDate').value;
    const l4Type = document.getElementById('l4Type').value;
    const note = document.getElementById('l4Note').value;
    
    // Walidacja
    if (!employeeLogin) {
        showNotification('‚ùå Wybierz pracownika', 'error');
        return;
    }
    
    if (!startDate || !endDate) {
        showNotification('‚ùå Podaj daty od-do', 'error');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        showNotification('‚ùå Data ko≈Ñcowa nie mo≈ºe byƒá wcze≈õniejsza ni≈º poczƒÖtkowa', 'error');
        return;
    }
    
    // Tryb testowy
    if (typeof google === 'undefined' || !google.script) {
        showNotification('‚úÖ L4 zarejestrowane (tryb testowy)', 'success');
        setTimeout(() => {
            showView('department');
            showNotification('Powr√≥t do menu g≈Ç√≥wnego', 'info');
        }, 2000);
        return;
    }
    
    // Wywo≈Çanie backendu
    console.log('Wysy≈Çam L4 do backendu:', { employeeLogin, startDate, endDate, l4Type, note });
    
    // 1. NATYCHMIAST - poka≈º sukces
    showNotification('‚úÖ L4 zarejestrowane!', 'success');
    
    // 2. NATYCHMIAST - wr√≥ƒá do g≈Ç√≥wnego widoku
    setTimeout(() => {
        showView('department');
        ensureCodeInputFocus();
    }, 500);
    
    // 3. W TLE - zapisz do backendu
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                console.log('‚úÖ L4 zapisane w bazie');
            } else {
                showNotification('‚ö†Ô∏è ' + result.message, 'error');
            }
        })
        .withFailureHandler(function(error) {
            console.error('B≈ÇƒÖd rejestracji L4:', error);
            showNotification('‚ö†Ô∏è B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
        })
        .registerL4(employeeLogin, startDate, endDate, l4Type, note);
};

// ===== MODU≈Å ZG≈ÅOSZE≈É - TICKETY =====

/**
 * Otwiera system zg≈Çosze≈Ñ - wymaga weryfikacji kodem EAN
 */
window.openTicketSystem = function() {
    console.log('Otwieranie systemu zg≈Çosze≈Ñ...');
    showView('ticketVerification');
    
    setTimeout(() => {
        const input = document.getElementById('ticketVerificationCodeInput');
        if (input) {
            input.value = '';
            input.focus();
        }
    }, 100);
};

/**
 * Pokazuje formularz zg≈Çoszenia
 */
function showTicketForm() {
    if (!currentUser) {
        showNotification('B≈ÇƒÖd: brak wybranego u≈ºytkownika', 'error');
        return;
    }
    
    document.getElementById('ticketUserName').textContent = currentUser.name + ' (' + currentUser.login + ')';
    
    // Wyczy≈õƒá formularz
    document.getElementById('ticketTitle').value = '';
    document.getElementById('ticketDescription').value = '';
    document.getElementById('ticketLocation').value = '';
    document.getElementById('ticketPriority').value = '≈öREDNI';
    document.getElementById('ticketCategory').value = 'pomys≈Ç';
    
    // Reset kategorii
    document.querySelectorAll('.vacation-type-option').forEach(el => {
        el.classList.remove('selected');
    });
    document.getElementById('cat-pomys≈Ç').classList.add('selected');
    
    showView('ticket');
    showNotification('Wype≈Çnij formularz zg≈Çoszenia', 'info');
}

/**
 * Wyb√≥r kategorii ticketu
 */
window.selectTicketCategory = function(category) {
    document.getElementById('ticketCategory').value = category;
    
    document.querySelectorAll('.vacation-type-option').forEach(el => {
        el.classList.remove('selected');
    });
    document.getElementById('cat-' + category).classList.add('selected');
    
    showNotification('Wybrano kategoriƒô: ' + getCategoryName(category), 'info');
};

/**
 * Weryfikacja kodu dla ticketu
 */
window.confirmTicketUserCode = function() {
    const inputCode = document.getElementById('ticketVerificationCodeInput').value.trim();
    
    if (!inputCode) {
        showNotification('Wpisz kod EAN', 'error');
        return;
    }
    
    const cleanCode = inputCode.replace(/^~+/, '').replace(/~+$/, '').trim();
    console.log('Weryfikacja ticketu - kod:', cleanCode);
    
    // Znajd≈∫ u≈ºytkownika po kodzie
    let foundUser = null;
    for (const [deptId, dept] of Object.entries(departments)) {
        const user = dept.users.find(u => {
            const storedCode = u.code.toString().replace(/^~+/, '').replace(/~+$/, '').trim();
            return storedCode === cleanCode;
        });
        if (user) {
            foundUser = user;
            break;
        }
    }
    
    if (foundUser) {
        currentUser = foundUser;
        showTicketForm();
        showNotification('Weryfikacja pomy≈õlna - wype≈Çnij formularz', 'success');
    } else {
        showNotification('Nieprawid≈Çowy kod EAN', 'error');
        document.getElementById('ticketVerificationCodeInput').value = '';
        document.getElementById('ticketVerificationCodeInput').focus();
    }
};

/**
 * Wysy≈Ça zg≈Çoszenie do backendu
 */
window.submitTicket = function() {
    if (!currentUser) {
        showNotification('‚ùå B≈ÇƒÖd: brak wybranego u≈ºytkownika', 'error');
        return;
    }
    
    const title = document.getElementById('ticketTitle').value.trim();
    const description = document.getElementById('ticketDescription').value.trim();
    const location = document.getElementById('ticketLocation').value.trim();
    const priority = document.getElementById('ticketPriority').value;
    const category = document.getElementById('ticketCategory').value;
    
    // Walidacja
    if (!title) {
        showNotification('‚ùå Podaj tytu≈Ç zg≈Çoszenia', 'error');
        return;
    }
    
    if (!description) {
        showNotification('‚ùå Opisz problem lub pomys≈Ç', 'error');
        return;
    }
    
    if (title.length < 5) {
        showNotification('‚ùå Tytu≈Ç musi mieƒá min. 5 znak√≥w', 'error');
        return;
    }
    
    if (description.length < 10) {
        showNotification('‚ùå Opis musi mieƒá min. 10 znak√≥w', 'error');
        return;
    }
    
    // Tryb testowy
    if (typeof google === 'undefined' || !google.script) {
        showNotification('‚úÖ Zg≈Çoszenie wys≈Çane (tryb testowy)', 'success');
        setTimeout(() => {
            currentUser = null;
            window.ticketMode = false;
            showView('department');
            showNotification('Powr√≥t do menu g≈Ç√≥wnego', 'info');
        }, 2000);
        return;
    }
    
    // Wywo≈Çanie backendu
    console.log('Wysy≈Çam ticket do backendu:', {
        login: currentUser.login,
        title,
        description,
        location,
        priority,
        category
    });
    
    // Zapisz dane przed resetem
    const userLogin = currentUser.login;
    const userName = currentUser.name;
    
    // 1. NATYCHMIAST - poka≈º sukces
    showNotification('‚úÖ Zg≈Çoszenie wys≈Çane! Kierownik zostanie powiadomiony.', 'success');
    
    // 2. NATYCHMIAST - wr√≥ƒá do g≈Ç√≥wnego widoku
    setTimeout(() => {
        currentUser = null;
        window.ticketMode = false;
        showView('department');
        ensureCodeInputFocus();
    }, 500);
    
    // 3. W TLE - zapisz i od≈õwie≈º liczniki
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                console.log('‚úÖ Ticket zapisany');
                updateTicketsNotificationBadge();
                updateCriticalTicketsBadge();
            } else {
                showNotification('‚ö†Ô∏è ' + result.message, 'error');
            }
        })
        .withFailureHandler(function(error) {
            console.error('B≈ÇƒÖd zg≈Çoszenia:', error);
            showNotification('‚ö†Ô∏è B≈ÇƒÖd po≈ÇƒÖczenia', 'error');
        })
        .submitTicket(userLogin, userName, category, title, description, location, priority);
};

/**
 * Pomocnicza funkcja - nazwa kategorii
 */
function getCategoryName(category) {
    const names = {
        'pomys≈Ç': 'üí° Pomys≈Ç/usprawnienie',
        'problem': '‚ö†Ô∏è Problem operacyjny',
        'usterka': 'üîß Usterka techniczna',
        'pilne': 'üÜò PILNE/BHP'
    };
    return names[category] || category;
}

// Synchronizacja z innymi stanowiskami (raz na 60s)
setInterval(function () {
    refreshLiveWorkforce();
}, 300000); // 5 minut


    </script>

    <!-- MODAL: WY≈öWIETLANIE OG≈ÅOSZENIA DLA PRACOWNIKA -->
<div class="announcement-screen" id="announcementScreen">
    <div class="announcement-card">
        <div class="announcement-card-header info" id="announcementHeader">
            <h2><span id="announcementIcon">üì¢</span> <span id="announcementTitle">Og≈Çoszenie</span></h2>
            <div class="announcement-counter" id="announcementCounter"></div>
        </div>
        <div class="announcement-card-body">
            <div class="message" id="announcementMessage">Tre≈õƒá og≈Çoszenia...</div>
            <div class="meta" id="announcementMeta">Wa≈ºne do: --</div>
        </div>
        <div class="announcement-card-footer">
            <button class="announcement-read-btn" onclick="markAsReadAndContinue()">‚úì Przeczyta≈Çem</button>
        </div>
    </div>
</div>

<!-- MODAL: PANEL OG≈ÅOSZE≈É KIEROWNIKA -->
<div class="announcements-panel-overlay" id="announcementsPanelOverlay">
    <div class="announcements-panel">
        <div class="announcements-panel-header">
            <h2>üì¢ ZarzƒÖdzanie og≈Çoszeniami</h2>
            <button class="announcements-panel-close" onclick="closeAnnouncementsPanel()">‚úï</button>
        </div>
        <div class="announcements-panel-tabs">
            <div class="announcements-panel-tab active" id="tabNew" onclick="switchAnnouncementTab('new')">‚ûï Nowe og≈Çoszenie</div>
            <div class="announcements-panel-tab" id="tabList" onclick="switchAnnouncementTab('list')">üìã Lista og≈Çosze≈Ñ</div>
        </div>
        <div class="announcements-panel-content" id="announcementsPanelContent">
            <!-- Formularz nowego og≈Çoszenia -->
            <div id="newAnnouncementForm" class="announcement-form">
                <div class="announcement-form-group">
                    <label>Typ og≈Çoszenia:</label>
                    <select id="annType">
                        <option value="info">‚ÑπÔ∏è Informacja</option>
                        <option value="wazne">‚ö†Ô∏è Wa≈ºne</option>
                        <option value="pilne">üö® Pilne</option>
                    </select>
                </div>
                <div class="announcement-form-group">
                    <label>Tre≈õƒá og≈Çoszenia:</label>
                    <textarea id="annMessage" placeholder="Wpisz tre≈õƒá og≈Çoszenia..."></textarea>
                </div>
                <div class="announcement-form-group">
                    <label>Wa≈ºne do:</label>
                    <input type="date" id="annValidUntil">
                </div>
                <div class="announcement-form-group">
                    <label>Odbiorcy:</label>
                    <div style="margin-bottom: 10px;">
                        <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="annAllRecipients" onchange="toggleAllRecipients()"> 
                            <strong>Wszyscy pracownicy</strong>
                        </label>
                    </div>
                    <div class="recipients-checkboxes" id="recipientsList">
                        ≈Åadowanie listy pracownik√≥w...
                    </div>
                </div>
                <button class="announcement-submit-btn" onclick="submitAnnouncement()">üì§ Wy≈õlij og≈Çoszenie</button>
            </div>
            <!-- Lista og≈Çosze≈Ñ -->
            <div id="announcementsListView" style="display: none;">
                <div class="announcements-list" id="announcementsList">
                    ≈Åadowanie...
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- MODAL: KTO JEST NA MAGAZYNIE -->
<div class="who-is-working-overlay" id="whoIsWorkingModal">
    <div class="who-is-working-modal">
        <div class="who-is-working-header">
            <h2>üë• Kto jest na magazynie?</h2>
            <button onclick="closeWhoIsWorking()" class="who-is-working-close">‚úï</button>
        </div>
        <div class="who-is-working-content" id="whoIsWorkingContent">
            <p style="text-align: center; padding: 40px;">‚è≥ ≈Åadowanie...</p>
        </div>
        <div class="who-is-working-footer">
            <span id="whoIsWorkingTimestamp">Ostatnia aktualizacja: --:--:--</span>
            <button onclick="refreshWhoIsWorking()" class="who-is-working-refresh">üîÑ Od≈õwie≈º</button>
        </div>
    </div>
</div>

<!-- MODAL: PODGLƒÑD LIVE -->
<div class="who-is-working-overlay" id="workforceLiveModal">
  <div class="who-is-working-modal" style="max-width: 1100px;">
    <div class="who-is-working-header">
      <h2>üëÅÔ∏è PodglƒÖd LIVE</h2>
      <button onclick="closeWorkforceLiveModal()" class="who-is-working-close">‚úï</button>
    </div>

    <div class="who-is-working-content" style="padding: 18px;">
      
      <!-- Liczniki + filtr -->
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:14px;">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          
          <div id="liveTileWorking" onclick="liveSetFilter('WORKING')"
              style="background:#e8f5e9; padding:8px 12px; border-radius:10px; font-weight:900; cursor:pointer; user-select:none; border:1px solid rgba(0,0,0,0.08);">
            üü¢ Pracuje: <span id="liveCntWorking">0</span>
          </div>

          <div id="liveTileBreak" onclick="liveSetFilter('BREAK')"
              style="background:#fff3e0; padding:8px 12px; border-radius:10px; font-weight:900; cursor:pointer; user-select:none; border:1px solid rgba(0,0,0,0.08);">
            üü° Przerwa: <span id="liveCntBreak">0</span>
          </div>

          <div id="liveTileAlerts" onclick="liveSetFilter('ALERTS')"
              style="background:#fff7ed; padding:8px 12px; border-radius:10px; font-weight:900; cursor:pointer; user-select:none; border:1px solid rgba(0,0,0,0.08);">
            ‚ö† Alerty: <span id="liveCntAlerts">0</span>
          </div>

          <div id="liveTileAbsent" onclick="liveSetFilter('ABSENT')"
              style="background:#ffebee; padding:8px 12px; border-radius:10px; font-weight:900; cursor:pointer; user-select:none; border:1px solid rgba(0,0,0,0.08);">
            üî¥ Nieobecni: <span id="liveCntAbsent">0</span>
          </div>

        </div>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          
          <button class="dashboard-btn" onclick="refreshWorkforceLiveUI()" style="background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%);">
            üîÑ Od≈õwie≈º
          </button>
        </div>
      </div>

      <!-- Lista + szczeg√≥≈Çy -->
      <div id="workforceLiveGrid" style="display:grid; grid-template-columns: 1.6fr 1fr; gap:14px;">
        
        <!-- LISTA -->
        <div id="workforceLiveListCard" style="background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:14px; overflow:hidden;">
          <div style="padding:10px 12px; font-weight:900; display:grid; grid-template-columns: 1.4fr 1fr 0.9fr 0.9fr 1fr; gap:10px; opacity:0.9;">
            <div>Pracownik</div>
            <div>Dzia≈Ç</div>
            <div>Zmiana</div>
            <div>Status</div>
            <div>Od kiedy</div>
          </div>
          <div id="workforceLiveList" style="max-height: 55vh; overflow:auto;"></div>
        </div>

        <!-- SZCZEG√ì≈ÅY -->
        <div style="background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:14px; padding:12px;">
          <div style="font-weight:900; margin-bottom:10px;">Szczeg√≥≈Çy</div>

          <div id="workforceLiveDetails" style="opacity:0.9;">
            <div style="padding:12px; border-radius:12px; background: rgba(0,0,0,0.18);">
              Kliknij pracownika z listy po lewej.
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>

<!-- MODAL: PLANOWANIE OBSADY (ETAP 1 - MANUAL) -->
<div class="workforce-overlay" id="workforcePlannerModal">
  <div class="workforce-modal">
    <div class="workforce-header">
      <h2 style="margin:0;">üë• Planowanie obsady</h2>
      <button class="workforce-close" onclick="closeWorkforcePlanner()">‚úï</button>
    </div>

    <div class="workforce-grid">

  <!-- KARTA LEWA: ZAM√ìWIENIA + DOSTƒòPNI -->
  <div class="workforce-card">
    <div style="font-weight:900; margin-bottom:8px;">Zam√≥wienia</div>

    <div class="workforce-row">
      <label>Zam√≥wienia tygodniowo</label>
      <input id="wf_weeklyOrders" class="workforce-input" type="number" min="0" value="0">
    </div>

    <div class="workforce-row">
      <label>Wydajno≈õƒá (zam√≥wie≈Ñ/h/os.)</label>
      <input id="wf_productivity" class="workforce-input" type="number" min="1" value="33">
    </div>

    <div style="margin-top:14px; font-weight:900;">Dostƒôpni pracownicy</div>

    <div class="workforce-row">
      <label>Dzia≈Ç</label>
      <select id="wf_deptSelect" class="workforce-input" onchange="wfFetchFromSystem(true)">
        <option value="ALL">Wszyscy (magazyn)</option>
      </select>
    </div>

    <div class="workforce-row">
      <label>Tydzie≈Ñ (poniedzia≈Çek)</label>
      <input id="wf_weekMonday" class="workforce-input" type="date">
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 6px;">
      <button id="wf_fetchBtn" class="workforce-btn" onclick="wfFetchFromSystem()">Pobierz z systemu</button>

      <label style="display:flex; align-items:center; gap:8px; font-weight:700;">
        <input id="wf_autoMode" type="checkbox" checked onchange="wfApplyMode(); wfRunAutoHoursOnly();"> AUTO
      </label>

      <label style="display:flex; align-items:center; gap:8px;">
        <input id="wf_includePending" type="checkbox" checked onchange="wfFetchFromSystem(true)">
        Uwzglƒôdnij wnioski oczekujƒÖce
      </label>
    </div>

    <div class="workforce-mini" id="wf_sysInfo"></div>

    <div class="workforce-row compact"><label>Pon</label><input id="wf_av_mon" class="workforce-input" type="number" min="0" value="0"></div>
    <div class="workforce-row compact"><label>Wt</label><input id="wf_av_tue" class="workforce-input" type="number" min="0" value="0"></div>
    <div class="workforce-row compact"><label>≈ör</label><input id="wf_av_wed" class="workforce-input" type="number" min="0" value="0"></div>
    <div class="workforce-row compact"><label>Czw</label><input id="wf_av_thu" class="workforce-input" type="number" min="0" value="0"></div>
    <div class="workforce-row compact"><label>Pt</label><input id="wf_av_fri" class="workforce-input" type="number" min="0" value="0"></div>


    

        <div style="margin-top: 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button id="wf_calcBtn" class="workforce-btn" onclick="wfRecalc()">Przelicz</button>

          <button id="wf_saveBtn" class="workforce-btn" onclick="wfSaveSnapshot()" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
            üíæ Zapisz plan
          </button>

          <button id="wf_loadBtn" class="workforce-btn" onclick="wfLoadSnapshot()" style="background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%);">
            üì• Wczytaj zapis
          </button>

          <button id="wf_copyPrevBtn" class="workforce-btn" onclick="wfCopyFromPreviousWeek()" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);">
            ‚Ü© Kopiuj z poprzedniego tyg.
          </button>

          <button id="wf_agencyBtn" class="workforce-btn" onclick="wfOpenAgencyModal()" style="background: linear-gradient(135deg, #fb7185 0%, #e11d48 100%);">
           üßæ AGENCJE
          </button>

          <div id="wf_summary" style="font-weight:900;"></div>
        </div>
  </div>

  <!-- KARTA PRAWA: GODZINY + ROZK≈ÅAD -->
  <div class="workforce-card">
    <div style="font-weight:800; margin:6px 0;">Godziny pracy na osobƒô (max 11h/dzie≈Ñ)</div>
    <div class="workforce-row compact"><label>Pon</label><input id="wf_h_mon" class="workforce-input" type="number" min="0" max="11" value="8"></div>
    <div class="workforce-row compact"><label>Wt</label><input id="wf_h_tue" class="workforce-input" type="number" min="0" max="11" value="8"></div>
    <div class="workforce-row compact"><label>≈ör</label><input id="wf_h_wed" class="workforce-input" type="number" min="0" max="11" value="8"></div>
    <div class="workforce-row compact"><label>Czw</label><input id="wf_h_thu" class="workforce-input" type="number" min="0" max="11" value="8"></div>
    <div class="workforce-row compact"><label>Pt</label><input id="wf_h_fri" class="workforce-input" type="number" min="0" max="11" value="8"></div>


    <div class="workforce-mini" id="wf_hoursInfo"></div>

    <div style="font-weight:800; margin:12px 0 6px;">Rozk≈Çad tygodnia (suma = 100%)</div>
    <div class="workforce-row compact"><label>Pon</label><input id="wf_p_mon" class="workforce-input" type="number" min="0" value="20"></div>
    <div class="workforce-row compact"><label>Wt</label><input id="wf_p_tue" class="workforce-input" type="number" min="0" value="20"></div>
    <div class="workforce-row compact"><label>≈ör</label><input id="wf_p_wed" class="workforce-input" type="number" min="0" value="20"></div>
    <div class="workforce-row compact"><label>Czw</label><input id="wf_p_thu" class="workforce-input" type="number" min="0" value="20"></div>
    <div class="workforce-row compact"><label>Pt</label><input id="wf_p_fri" class="workforce-input" type="number" min="0" value="20"></div>

    <div class="workforce-mini" id="wf_percentInfo"></div>
    <div class="workforce-mini" style="margin-top:10px;">
      Procenty i godziny liczƒÖ siƒô na ≈ºywo. ‚ÄûPrzelicz‚Äù dzia≈Ça tylko gdy % = 100 i godziny ‚â§ 40.
    </div>
  </div>

</div>

<div class="workforce-card" style="margin-top:12px;">
  <div style="font-weight:900; margin-bottom:8px;">Wynik (ETAP 1.2 ‚Äì godziny)</div>

  <table class="workforce-table">
    <thead>
      <tr>
        <th>Dzie≈Ñ</th>
        <th>Zam√≥wienia</th>
        <th>Wymagane godziny</th>
        <th>Dostƒôpne osoby</th>
        <th>Godz./os.</th>
        <th>Dostƒôpne godziny</th>
        <th>Brak / Nadwy≈ºka (h)</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="wf_resultBody"></tbody>
  </table>

  <div id="wf_alerts" style="margin-top:10px;"></div>
</div>

<!-- ===== MODAL: AGENCJE ===== -->
<div id="wfAgencyOverlay" class="modal-overlay" style="display:none;">
  <div class="modal-card" style="max-width: 700px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div style="font-size:18px; font-weight:900;">AGENCJE</div>
      <button class="workforce-btn" onclick="wfCloseAgencyModal()">‚úï Zamknij</button>
    </div>

    <div style="margin-top:14px;">

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
    <div>
      <label style="font-weight:800;">Agencja</label>
      <select id="wfAgencySelect" class="code-input" style="width:100%; margin-top:6px;"></select>
      <div id="wfAgencyNote" style="margin-top:8px; font-size:12px; opacity:0.9;"></div>
    </div>

    <div>
      <label style="font-weight:800;">Tryb</label>
      <div style="display:flex; gap:12px; align-items:center; margin-top:8px; flex-wrap:wrap;">
        <label style="display:flex; gap:6px; align-items:center;">
          <input type="radio" name="wfAgencyAction" value="NEED" onchange="wfAgencyRecalc()">
          Potrzebujemy
        </label>
        <label style="display:flex; gap:6px; align-items:center;">
          <input type="radio" name="wfAgencyAction" value="RELEASE" onchange="wfAgencyRecalc()">
          Oddajemy
        </label>
      </div>
    </div>
  </div>

  <div style="margin-top:12px;">
    <label style="font-weight:800;">Dni (ptaszki w≈ÇƒÖczajƒÖ/wy≈ÇƒÖczajƒÖ liczenie)</label>
    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:8px;">
      <label><input type="checkbox" class="wfAgencyDay" value="Pon" onchange="wfAgencyRecalc()"> Pon</label>
      <label><input type="checkbox" class="wfAgencyDay" value="Wt" onchange="wfAgencyRecalc()"> Wt</label>
      <label><input type="checkbox" class="wfAgencyDay" value="≈ör" onchange="wfAgencyRecalc()"> ≈ör</label>
      <label><input type="checkbox" class="wfAgencyDay" value="Czw" onchange="wfAgencyRecalc()"> Czw</label>
      <label><input type="checkbox" class="wfAgencyDay" value="Pt" onchange="wfAgencyRecalc()"> Pt</label>
    </div>
    <div style="margin-top:6px; font-size:12px; opacity:0.9;">
      Zaznaczone dni liczƒÖ siƒô do zam√≥wienia. Odznacz dzie≈Ñ ‚Üí nie wp≈Çywa na godziny ani liczbƒô os√≥b.
    </div>
  </div>

  <div style="margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
    <div>
      <label style="font-weight:800;">Godziny do agencji (z zaznaczonych dni)</label>
      <input id="wfAgencyHoursTotal" type="number" class="code-input" style="width:100%; margin-top:6px;" value="0" step="0.1" readonly>
      <div id="wfAgencyAutoInfo" style="margin-top:6px; font-size:12px; opacity:0.9;"></div>
    </div>

    <div>
      <label style="font-weight:800;">Liczba os√≥b (MAX z dni)</label>
      <input id="wfAgencyPeople" type="number" class="code-input" style="width:100%; margin-top:6px;" value="0" min="0" step="1">
      <div style="margin-top:6px; font-size:12px; opacity:0.9;">
        Auto liczƒô ‚Äúod po≈Çowy w g√≥rƒô‚Äù na podstawie godzin danego dnia (Pon/Wt/≈ör/Czw/Pt).
      </div>
    </div>
  </div>

  <div id="wfAgencyBreakdown" style="margin-top:12px; font-size:13px;"></div>

  <div style="margin-top:12px;">
  <label style="font-weight:800;">Uwagi</label>
  <textarea id="wfAgencyNoteInput" class="code-input" style="width:100%; min-height:80px; margin-top:6px;" placeholder="Np. tylko zmiana dzienna, start od wtorku, itp."></textarea>
</div>

<div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
  <button class="workforce-btn"
          style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);"
          onclick="wfAgencySend()">
    ‚úâ Wy≈õlij do agencji
  </button>

  <div id="wfAgencyStatus" style="font-weight:900;"></div>
</div>

</div> <!-- koniec zawarto≈õci modala -->
</div> <!-- modal-card -->
</div> <!-- modal-overlay -->

</body>
</html>
